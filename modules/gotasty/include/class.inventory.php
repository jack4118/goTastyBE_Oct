<?php
	/**
     * @author TtwoWeb Sdn Bhd.
     * Date 10/12/2020.
    **/

    class Inventory {

    	function __construct(){

        }


       
        function generateUniqueChar(){
            $db = MysqliDb::getInstance();

            $permitted_chars = '0123456789abcdefghijklmnopqrstuvwxyz';
            while (1) {
                $uniqueChar =  substr(str_shuffle($permitted_chars), 0, 16);
                $db->where('name', array('Image', 'Video'), 'IN');
                $db->where('value', '%'.$uniqueChar.'%', 'LIKE');
                $count = $db->has("mlm_product_setting");

                if ($count == 0) break;
            }
            return $uniqueChar;
        }

        // -------- Delivery Charges -------- //
        public function getDeliveryChargesListing($params) {
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $searchData     = $params['searchData'];
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $seeAll         = $params['seeAll'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;

            $db->where("delivery_country", "1");
            $resultCountryList = $db->map("id")->get("country", NULL, "id, name, translation_code");

            // Add in country => Others
            // foreach ($resultCountryList as $key => $value) {
            //     $resultCountryList["999"] = array(
            //         "id"    => "999",
            //         "name"  => "Others",
            //         "translation_code"  => "D003520",
            //     );
            // }

            // Filter
            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {

                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'countryID':
                            $db->where("country_id", $dataValue);

                            break;

                        case 'date':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if($dateFrom <= 0 || $dateTo <= 0) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                            if ($dateFrom) $db->where("Date(created_at)", date('Y-m-d', $dateFrom), '>=');

                            if ($dateTo) {
                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);

                                $db->where("Date(created_at)", date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);

                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            // Set Limit
            if ($seeAll != "1") {
                $limit = General::getLimit($pageNumber);
            }

            // Get List
            $db->orderBy("country_id", "ASC");
            $db->orderBy("state_id", "ASC");
            $db->orderBy("priority", "ASC");
            $db->where('disabled', '0');
            $copyDb = $db->copy();
            $deliveryChargesRes = $db->get("inv_delivery", $limit, "id, country_id, state_id, weight, charges, creator_id, created_at");

            // Get Creator Username
            foreach ($deliveryChargesRes as $key => $value) {
                $creatorIDAry[$value["creator_id"]] = $value["creator_id"];
                $stateIDAry[$value["state_id"]] = $value["state_id"];
            }

            if($creatorIDAry){
                $db->where("id", $creatorIDAry, "IN");
                $creatorDataAry = $db->map("id")->get("admin", NULL, "id, username");
            }

            if($stateIDAry){
                $db->where("id", $stateIDAry, "IN");
                $stateDataAry = $db->map("id")->get("state", NULL, "id, translation_code");
            }

            //rearrange and add countryDisplay
            foreach ($deliveryChargesRes as $key => $row) {
                unset($deliveryRow);
                $deliveryRow = array(
                    "date"          => date($dateTimeFormat, strtotime($row["created_at"])),
                    "countryID"     => $row["country_id"],
                    "countryDisplay"=> $translations[$resultCountryList[$row["country_id"]]["translation_code"]][$language],
                    "stateID"       => $row["state_id"],
                    "stateDisplay"  => $translations[$stateDataAry[$row["state_id"]]][$language],
                    "charges"       => Setting::setDecimal($row["charges"]),
                    "weight"        => Setting::setDecimal($row["weight"], 2),
                    "doneBy"        => $creatorDataAry[$row["creator_id"]] ? : "-",
                );

                $countryDeliveryAry[] = $deliveryRow;
            }

            $totalRecord                 = $copyDb->getValue("inv_delivery", "COUNT(id)");
            $data["countryList"]         = $resultCountryList;
            $data['deliveryChargesList'] = $countryDeliveryAry;
            $data['pageNumber']          = $pageNumber;
            $data['totalRecord']         = $totalRecord;

            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            if(!$deliveryChargesRes){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getDeliveryCharges($params) {
            $db = MysqliDb::getInstance();

            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $db->where("delivery_country", "1");
            $resultCountryList = $db->map("id")->get("country", NULL, "id, name, translation_code");

            // Add in country => Others
            // foreach ($resultCountryList as $key => $value) {
            //     $resultCountryList["999"] = array(
            //         "id"    => "999",
            //         "name"  => "Others",
            //         "translation_code"  => "D003520",
            //     );
            // }

            foreach ($resultCountryList as $resultCountry) {
                $countryID[$resultCountry['id']] = $resultCountry['id'];
            }

            $db->orderBy("name", "ASC");
            $db->where("country_id", $countryID, "IN");
            $db->where("disabled", "0");
            $resultStateList = $db->map('id')->get("state", NULL, "id, name, translation_code, country_id");

            foreach ($resultStateList as $stateValue) {
                unset($countryID);
                $countryID = $stateValue['country_id'];
                $stateAry[$countryID][] = $stateValue;

            }

            // Get List
            $db->orderBy("country_id", "ASC");
            $db->orderBy("state_id", "ASC");
            $db->orderBy("priority", "ASC");
            $db->where("disabled", "0");
            $deliveryChargesAry = $db->get("inv_delivery");

            // Rearrange and add countryDisplay
            foreach ($deliveryChargesAry as $row) {
                $deliveryCountryAry[$row["country_id"]][] = $row;
            }

            if($deliveryCountryAry){
                foreach ($resultCountryList as $countryID => $value) {
                    foreach ($deliveryCountryAry[$countryID] as $deliveryRow) {
                        $row = array(
                            "countryID"     => $countryID,
                            "countryDisplay"=> $translations[$resultCountryList[$countryID]["translation_code"]][$language],
                            "stateID"       => $deliveryRow['state_id'],
                            "stateDisplay"  => $translations[$resultStateList[$deliveryRow['state_id']]["translation_code"]][$language],
                            "weight"        => Setting::setDecimal($deliveryRow["weight"], 2),
                            "charges"       => Setting::setDecimal($deliveryRow["charges"], 2),
                        );
                        $countryDeliveryAry[$countryID][$deliveryRow['state_id']][] = $row;
                    }
                }
            }else{
                foreach ($stateAry as $countryID => $stateDetails) {
                    foreach ($stateDetails as $details) {
                        $row = array(
                            "countryID"     => $countryID,
                            "countryDisplay"=> $translations[$resultCountryList[$countryID]["translation_code"]][$language],
                            "stateID"       => $details["id"],
                            "stateDisplay"  => $translations[$details["translation_code"]][$language],
                            "weight"        => 1,
                            "charges"       => 0,
                        );
                        $countryDeliveryAry[$countryID][$details['id']][] = $row;
                    }
                }
            }

            $data["countryList"] = $resultCountryList;
            $data["stateList"]   = $resultStateList;
            $data['deliveryChargesList'] = $countryDeliveryAry;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function updateDeliveryCharges($params) {
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $decimalPlaces   = Setting::$systemSetting["internalDecimalFormat"];
            $deliveryCharges = $params['deliveryCharges'];
            $clientID        = $db->userID;
            $dateTime        = date("Y-m-d H:i:s");

            foreach ($deliveryCharges as $chargeRow) {
                $updateList[$chargeRow["countryID"]][$chargeRow["stateID"]][] = $chargeRow;
            }

            // Get list from database
            $db->orderBy("state_id", "ASC");
            $db->orderBy("priority", "ASC");
            $db->where("disabled", "0");
            $deliveryChargesAry = $db->get("inv_delivery", NULL, "id, country_id, state_id, weight, charges, priority, creator_id");

            // Rearrange
            foreach ($deliveryChargesAry as $row) {
                $stateDeliveryRes[$row['country_id']][$row['state_id']][$row['priority']] = array(
                    "id"            => $row["id"],
                    "countryID"     => $row["country_id"],
                    "stateID"       => $row["state_id"],
                    "weight"        => $row["weight"],
                    "charges"       => $row["charges"],
                    "priority"      => $row["priority"],
                    "creatorID"     => $row["creator_id"],
                );
            }

            // Invalid input check
            foreach ($updateList as $countryID => $updateDetailRow) {
                unset($checkMax);

                // Check countryID
                // Get valid country id
                // if ($countryID != "999") {
                //     $db->where("id", $countryID);
                //     $db->where("delivery_country", "1");
                //     $validCountryID = $db->getValue("country", "id");
                //     if(!is_numeric($countryID) || empty($countryID) || !$validCountryID) {
                //         $errorFieldArr[] = array(
                //             'id'  => $countryID."countryIDError",
                //             'msg' => $translations['E00125'][$language]
                //         );
                //     }
                // }

                foreach ($updateDetailRow as $stateID => $updateDetail) {
                    foreach ($updateDetail as $updateKey => $updateRow) {
                        // Check min
                        if ($updateRow["weight"] <= 0 || strlen(substr(strrchr($updateRow["weight"], "."), 1)) > 2) {
                            $errorFieldArr[] = array(
                                'id'  => "c".$countryID."s".$stateID."minWeight".($updateKey+1)."Error",
                                'msg' => $translations['E00125'][$language]
                            );
                        }

                        if($updateKey > 0){
                            // Check charges
                            if ($updateRow["charges"] <= 0 || !is_numeric($updateRow["charges"])) {
                                $errorFieldArr[] = array(
                                    'id'  => "c".$countryID."s".$stateID."charges".($updateKey+1)."Error",
                                    'msg' => $translations['E00125'][$language]
                                );
                            }
                        }else{
                            // Check charges
                            if ($updateRow["charges"] < 0 || !is_numeric($updateRow["charges"])) {
                                $errorFieldArr[] = array(
                                    'id'  => "c".$countryID."s".$stateID."charges".($updateKey+1)."Error",
                                    'msg' => $translations['E00125'][$language]
                                );
                            }
                        }
                    }
                }
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            // Detect changes and insert new record
            foreach ($stateDeliveryRes as $oriCountryID => $stateDeliveryRow) {

                foreach ($stateDeliveryRow as $oriStateID => $stateDetailRow) {

                    foreach ($stateDetailRow as $detailKey => $stateDetail) {
                        $newDetail = $updateList[$oriCountryID][$oriStateID][$detailKey-1];
                        $oriDetail = $stateDetail;

                        $newWeight = Setting::setDecimal($newDetail['weight']);
                        $newCharges = Setting::setDecimal($newDetail['charges']);
                        $oriWeight = Setting::setDecimal($oriDetail['weight']);
                        $oriCharges = Setting::setDecimal($oriDetail['charges']);

                        if($newDetail){
                            if ($newWeight != $oriWeight || $newCharges != $oriCharges) {
                                $inactiveColumn = array(
                                    "disabled"   => "1",
                                    "created_at" => $dateTime,
                                );
                                $db->where("id", $oriDetail["id"]);
                                $db->where("country_id", $oriCountryID);
                                $db->where("state_id", $oriStateID);
                                $db->update("inv_delivery", $inactiveColumn);

                                $newRecord = array(
                                    "country_id"    =>  $newDetail['countryID'],
                                    "state_id"      =>  $newDetail['stateID'],
                                    "weight"        =>  $newDetail['weight'],
                                    "charges"       =>  $newDetail['charges'],
                                    "disabled"      =>  0,
                                    "priority"      =>  $detailKey,
                                    "created_at"    =>  $dateTime,
                                    "creator_id"    =>  $clientID,
                                );
                                $db->insert("inv_delivery", $newRecord);
                            }
                        } else {
                            if ($oriWeight != $newWeight || $oriCharges != $newCharges) {
                                $disableColumn = array(
                                    "disabled"   => "1",
                                    "created_at" => $dateTime,
                                );
                                $db->where("id", $oriDetail["id"]);
                                $db->where("country_id", $oriCountryID);
                                $db->where("state_id", $oriStateID);
                                $db->update("inv_delivery", $disableColumn);
                            }
                        }
                        unset($updateList[$oriCountryID][$oriStateID][$detailKey-1]);
                    }
                }
            }

            $newDetailList = $updateList[$countryID];

            foreach ($newDetailList as $newStateID => $newDetailRow) {
                foreach ($newDetailRow as $priority => $detailRow) {
                    unset($newRecord);

                    $newRecord = array(
                        "country_id"    =>  $detailRow['countryID'],
                        "state_id"      =>  $detailRow['stateID'],
                        "weight"        =>  $detailRow['weight'],
                        "charges"       =>  $detailRow['charges'],
                        "disabled"      =>  0,
                        "priority"      =>  $priority+1,
                        "created_at"    =>  $dateTime,
                        "creator_id"    =>  $clientID,
                    );
                    $db->insert("inv_delivery", $newRecord);
                }
            }

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
        }

        function calculateDeliveryFee($countryID, $stateID, $productWeight){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");

            $db->where('country_id', $countryID);
            $db->where('state_id', $stateID);
            $db->where('disabled', '0');
            $db->orderBy('priority', 'ASC');
            $deliveryChargesRes = $db->map('priority')->get('inv_delivery', null, 'priority, weight, charges');

            $i = 1;
            $chargeAmount = 0;
            $lastPriority = count($deliveryChargesRes);
            foreach ($deliveryChargesRes as $priority => $deliveryCharges) {
                $weight = $deliveryCharges['weight'];
                $charges = $deliveryCharges['charges'];

                if($i == $lastPriority){
                    $multiplier = ceil($productWeight / $weight);
                    $chargesAmount += ($multiplier * $charges);
                }else{
                    $productWeight = $productWeight - $weight;
                    $chargesAmount += $charges;
                }

                if($productWeight <= 0) break;

                $i++;
            }

            return $chargesAmount;
        }

        public function get3rdPartyDeliveryFees($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            // JNE
            $jneUsername = Setting::$configArray["jneUsername"];
            $jneAPIKey = Setting::$configArray["jneAPIKey"];
            $jneURL = Setting::$configArray["jneURL"];
            $from = Setting::$systemSetting['pickUpOrigins'];

            // ONDELIVERY
            $onDeliveryPath = Setting::$systemSetting["onServiceList"];
            $onDeliveryAuthKey = Setting::$configArray["onDeliveryAuthKey"];
            $onDeliveryURL = Setting::$configArray["onDeliveryURL"].$onDeliveryPath;

            // params
            $thru   = $params['thru'];
            $weight = $params['weight']; // in kg
            $destID = $params['destID'];

            // JNE Get Result
            $jneParams = array(
                "username" => $jneUsername,
                "api_key" => $jneAPIKey,
                "from" => $from,
                "thru" => $thru,
                'weight' => $weight, // in kg,
            );

            $jneData = http_build_query($jneParams);

            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $jneURL);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $jneData); // $response->setBody()
            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/x-www-form-urlencoded'));
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            $jneJsonResponse = curl_exec($ch);
            curl_close($ch);
            $jneResult = json_decode($jneJsonResponse, 1);

            if(!$jneResult['price']){
                return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to get Delivery Fee', 'data'=> $jneResult);
            }

            $acceptedCourrier = array('JTR', 'REG', 'CTC');

            foreach ($jneResult['price'] as $jneRow) {
                if(in_array($jneRow['service_display'], $acceptedCourrier)){
                    $jne['courier'] = $jneRow['service_display'];
                    if($jneRow['service_display'] == 'CTC'){
                        $jne['courier'] = 'REG';
                    }

                    $jne['price'] = $jneRow['price'];

                    $jneList[] = $jne;
                }
            }

            $data['JNE'] = $jneList;

            // ONDELIVERY Get Result

            /* COMMENTED AWAY TO HIDE ONDELIVERY, uncomment to open it back */

            // if($destID > 0){
            //     $onParams = array(
	        //         "origin_id" => $onDeliveryOriginId,
            //         "destination_id" => $destID,
            //         'weight' => ($weight >= 1) ? $weight : 1,
            //     );

            //     $ch = curl_init();
            //     curl_setopt($ch, CURLOPT_URL, $onDeliveryURL);
            //     curl_setopt($ch, CURLOPT_POST, 1);
            //     curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($onParams)); // $response->setBody()
            //     curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Authorization: '.$onDeliveryAuthKey));
            //     curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            //     curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            //     curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            //     $onDeliveryJsonResponse = curl_exec($ch);
            //     curl_close($ch);
            //     $onDeliveryResult = json_decode($onDeliveryJsonResponse, 1);

            //     if(!$onDeliveryResult){
            //         return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to get Delivery Fee', 'data'=> $onDeliveryResult);
            //     }

            //     foreach ($onDeliveryResult as $onDeliveryRow) {
            //         if($onDeliveryRow['service_cost'] > 0){
            //             $onDelivery['courier'] = $onDeliveryRow['service_name'];
            //             $onDelivery['price'] = $onDeliveryRow['service_cost'];
            //             $onDelivery['serviceID'] = $onDeliveryRow['service_id'];

            //             $onDeliveryList[] = $onDelivery;
            //         }
            //     }

            //     $data['ONDELIVERY'] = $onDeliveryList;
            // }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data'=> $data);
        }

        public function thirdPartyCreateJneWaybill($params){

            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            // ONDELIVERY
            $onDeliveryAuthKey = Setting::$configArray["jneAuthKey"];
            $onDeliveryURL = Setting::$configArray["jneApiPath"];


            // params
            $serviceID = $params['invID'];
            $senderName = $params['senderName'];
            $senderPhone = $params['senderPhone'];
            $senderAddress = $params['senderAddress'];
            $receiverName = $params['receiverName'];
            $receiverPhone = $params['receiverPhone'];
            $receiverAddress = $params['receiverAddress'];
            $receiverSubDistrict = $params['receiverSubDistrict'];
            $receiverDistrict = $params['receiverDistrict'];
            $receiverCity = $params['city'];
            $receiverState = $params['state'];
            $receiverCountryCode = $params['countryCode'];
            $goodsID = $params['goodsID'];
            $goodsWeight = $params['goodsWeight'];
            $goodsQuantity = $params['productQuantity'];
            $totalAmount = $params['totalAmount'];
            $quantity = $params['quantity'];
            $price = $params['price'];

            // ONDELIVERY Get Result
            $onParams = array(
                'username' => Setting::$configArray["jneUsername1"],
                'api_key' => Setting::$configArray["jneAuthKey"],
                'OLSHOP_BRANCH' => Setting::$configArray["jneBranch"],
                'OLSHOP_CUST' => Setting::$configArray["jneCustNo"],
                'OLSHOP_ORDERID' => $serviceID,
                'OLSHOP_SHIPPER_NAME' => Setting::$configArray["jneSenderName"],
                'OLSHOP_SHIPPER_ADDR1'=> Setting::$configArray["jneSenderAdd1"],
                'OLSHOP_SHIPPER_ADDR2' => Setting::$configArray["jneSenderAdd2"],
                'OLSHOP_SHIPPER_CITY' => Setting::$configArray["jneSenderCity"],
                'OLSHOP_SHIPPER_REGION' => Setting::$configArray["jneSenderRegion"],
                'OLSHOP_SHIPPER_ZIP' => Setting::$configArray["jneSenderZip"],
                'OLSHOP_SHIPPER_PHONE' => $senderPhone,
                'OLSHOP_RECEIVER_NAME' => $receiverName,
                'OLSHOP_RECEIVER_ADDR1' => $receiverAddress,
                'OLSHOP_RECEIVER_ADDR2' => $receiverSubDistrict,
                'OLSHOP_RECEIVER_ADDR3' => $receiverDistrict,
                'OLSHOP_RECEIVER_CITY' => $receiverCity,
                'OLSHOP_RECEIVER_REGION' => $receiverState,
                'OLSHOP_RECEIVER_ZIP' => $receiverCountryCode,
                'OLSHOP_RECEIVER_PHONE' => $receiverPhone,
                'OLSHOP_QTY' => $quantity,
                'OLSHOP_WEIGHT' => $goodsWeight,
                'OLSHOP_GOODSDESC' => 'Noting',
                'OLSHOP_GOODSVALUE' => $price,
                'OLSHOP_GOODSTYPE' => 1,
                'OLSHOP_INST' => 'TEST',
                'OLSHOP_INS_FLAG' => 'N',
                'OLSHOP_ORIG' => 'CGK10000',
                'OLSHOP_DEST' => 'BDO10000',
                'OLSHOP_SERVICE' => 'REG',
                'OLSHOP_COD_FLAG' => 'N',
                'OLSHOP_COD_AMOUNT' => $totalAmount,
            );

            //change to application/x-www-form-urlencoded format

            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $onDeliveryURL);
            curl_setopt($ch, CURLOPT_POST, 1);
//            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($onParams));
            curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($onParams));
            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/x-www-form-urlencoded'));
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            $onDeliveryJsonResponse = curl_exec($ch);
            curl_close($ch);
            $onDeliveryResult = json_decode($onDeliveryJsonResponse, 1);

            if(!$onDeliveryResult){
                return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to create waybill_jne', 'data'=> $onDeliveryResult);
            }

            $trackingNo = $onDeliveryResult['detail'][0]['cnote_no'];

            if(!$trackingNo){
                return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to create waybill', 'data'=> $onDeliveryResult);
            }

            $data['trackingNo'] = $trackingNo;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data'=> $data);

        }

        public function thirdPartyCreateWaybill($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            // ONDELIVERY
            $onDeliveryPath = Setting::$systemSetting["onCreateWaybill"];
            $onDeliveryAuthKey = Setting::$configArray["onDeliveryAuthKey"];
            $onDeliveryURL = Setting::$configArray["onDeliveryURL"].$onDeliveryPath;

            // params
            $destID = $params['destID'];
            $serviceID = $params['serviceID'];
            $senderName = $params['senderName'];
            $senderPhone = $params['senderPhone'];
            $senderAddress = $params['senderAddress'];
            $receiverName = $params['receiverName'];
            $receiverPhone = $params['receiverPhone'];
            $receiverAddress = $params['receiverAddress'];
            $goodsID = $params['goodsID'];
            $goodsWeight = $params['goodsWeight'];

            // ONDELIVERY Get Result
            $onParams = array(
                "destination_id" => $destID,
                "service_id" => $serviceID,
                "sender_name" => $senderName,
                "sender_phone" => $senderPhone,
                "sender_address" => $senderAddress,
                "receiver_name" => $receiverName,
                "receiver_phone" => $receiverPhone,
                "receiver_address" => $receiverAddress,
                "goods_id" => $goodsID,
                "goods_weight" => $goodsWeight,
            );

            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $onDeliveryURL);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($onParams)); // $response->setBody()
            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Authorization: '.$onDeliveryAuthKey));
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            $onDeliveryJsonResponse = curl_exec($ch);
            curl_close($ch);
            $onDeliveryResult = json_decode($onDeliveryJsonResponse, 1);

            if(!$onDeliveryResult){
                return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to create waybill', 'data'=> $onDeliveryResult);
            }

            $trackingNo = $onDeliveryResult['waybill_number'];

            if(!$trackingNo){
                return array('status' => "error", 'code' => 1, 'statusMsg' => 'Failed to create waybill', 'data'=> $onDeliveryResult);
            }

            $data['trackingNo'] = $trackingNo;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data'=> $data);
        }

        public function thirdPartyCancelWaybill($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            // ONDELIVERY
            $onDeliveryPath = Setting::$systemSetting["onCancelWaybill"];
            $onDeliveryAuthKey = Setting::$configArray["onDeliveryAuthKey"];
            $onDeliveryURL = Setting::$configArray["onDeliveryURL"].$onDeliveryPath;

            // params
            $trackingNo = $params['trackingNo'];
            $notes = $params['notes'];

            // ONDELIVERY Get Result
            $onParams = array(
                "waybill_number" => $trackingNo,
                "notes" => $notes,
            );

            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $onDeliveryURL);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($onParams)); // $response->setBody()
            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Authorization: '.$onDeliveryAuthKey));
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            $onDeliveryJsonResponse = curl_exec($ch);
            curl_close($ch);
            $onDeliveryResult = json_decode($onDeliveryJsonResponse, 1);

            if(!$onDeliveryResult){
                return "noResult";
            }

            $statusMsg = $onDeliveryResult['message'];

            if(in_array($statusMsg,array("success cancelling transaction","success canceling waybill"))){
                return "success";
            }

            return $statusMsg;
        }

        // -------- Product/Package Category --------//
        public function getCategoryInventory($params) {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $userID = $db->userID;
            $site = $db->userType;

            $searchData = $params['searchData'];
            $sortData       = $params['sortData'];
            $pageNumber = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll = $params['seeAll'] ? : 0;
            $limit = General::getLimit($pageNumber);

            if($seeAll) {
                $limit = NULL;
            }

            if(count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType  = trim($v['dataType']);

                    switch($dataName) {
                        case "status":
                            if($dataValue == "Active") {
                                $db->where("a.deleted", 0);
                            } else if($dataValue == "Inactive") {
                                $db->where("a.deleted", 1);
                            }
                            break;

                        case "parent_category":
                            $db->where('b.name', "%". $dataValue . "%", "LIKE");
                            $db->join('product_category b','a.parent_id = b.id','LEFT');
                            break;

                        case "name":
                            $db->where('a.name', "%". $dataValue . "%", "LIKE");
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                    unset($dataType);
                }
            }

            $sortOrder = "ASC";
            $sortField = 'name';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'DESC')
                    $sortOrder = 'DESC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
                $db->orderBy($sortField, $sortOrder);
            }

            $copyDB = $db->copy();
            $categoryRes = $db->get("product_category a", null, "a.id as id, a.name as name, a.parent_id as parent_id, a.deleted as deleted, a.created_at as created_at");

            if(!$categoryRes) {
                return array("status" => "ok", "code" => 0, "statusMsg" => $translations["B00101"][$language] /* No results found */, "data" => "");
            }

            foreach ($categoryRes as $categoryRow) {
                $categoryID[$categoryRow['id']] = $categoryRow['id'];
            }

            if($categoryID){
                $db->where('module_id', $categoryID, 'IN');
                $db->where('module', 'category');
                $db->where('type', 'name');
                $langRes = $db->get('inv_language', null, 'module_id, language, content');

                foreach ($langRes as $langRow) {
                    $lang[$langRow['module_id']][$langRow['language']] = $langRow['content'];
                }
            }

            foreach($categoryRes as $categoryRow) {
                $category["id"] = $categoryRow["id"];
                $category["name"] = $categoryRow["name"];
                $category["parent_id"] = $categoryRow["parent_id"];

                $db->where('id',$categoryRow["parent_id"]);
                $parentCategory = $db->getValue('product_category','name');
                if($parentCategory){
                    $category["parent_category"] = $parentCategory;
                }else{
                    $category["parent_category"] = "-";
                }

                $category["display"] = $lang[$categoryRow['id']][$language];
                // $category["type"] = General::getTranslationByName($categoryRow["type"]);

                switch($categoryRow["deleted"]) {
                    case "0":
                        $category["status"] = "Active";
                        $category["statusDisplay"] = General::getTranslationByName($category["status"]);
                        break;

                    case "1":
                        $category["status"] = "Inactive";
                        $category["statusDisplay"] = General::getTranslationByName($category["status"]);
                        break;

                    default:
                        break;
                }

                $categoryList[] = $category;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            // $db->groupBy('b.parent_id');
            // $db->join('product_category b','a.id = b.parent_id','INNER');
            // $db->where('b.parent_id != 0');
            $db->where('deleted', '0');
            $db->where('a.parent_id',0);
            $parentList = $db->get('product_category a', null ,'a.id as id, a.name as name, a.parent_id as parent_id');

            foreach($parentList as $parentRow){
                $parent["id"] = $parentRow["id"];
                $parent["name"] = $parentRow["name"];
                $parent["parent_id"] = $parentRow["parent_id"];

                $parentCategoryList[] = $parent;
            }

            $totalRecord = $copyDB->getValue('product_category a', "count(*)");
            $data["categoryList"] = $categoryList;
            $data["parentCategoryList"] = $parentCategoryList;
            $data["pageNumber"] = $pageNumber;
            $data["totalRecord"] = $totalRecord;
            if($seeAll == "1") {
                $data["totalPage"] = 1;
                $data["numRecord"] = $totalRecord;
            } else {
                $data["totalPage"] = ceil($totalRecord/$limit[1]);
                $data["numRecord"] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00114"][$language] /* Search Sucecssful */, 'data'=> $data);
        }

        public function getCategoryInventoryDetail($params){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $categoryInvId   = $params['categoryInvId'];

            $userID = $db->userID;
            $site = $db->userType;

            $db->where("disabled", 0);
            $availableLanguages = $db->get("languages", NULL, "id, language, language_code");

            foreach ($availableLanguages as $value) {
                $row = array(
                    "languageType" => $value["language"],
                    "languageDisplay" => $translations[$value["language_code"]][$language]
                );

                $languageList[] = $row;
            }

            $data["languageList"] = $languageList;

            if($categoryInvId) {
                $db->where("id", $categoryInvId);
                $categoryRes = $db->getOne("product_category", "id, name, parent_id, description, deleted");

                $db->groupBy('b.parent_id');
                $db->join('product_category b','a.id = b.parent_id','INNER');
                $db->where('b.parent_id != 0');
                $db->where('a.id',$categoryRes["id"]);
                $parent = $db->get('product_category a', 'a.id, a.name, a.parent_id');
                if($parent){
                    $categoryRes["isParent"] = "true";
                }else{
                    $categoryRes["isParent"] = "false";
                }

                if(!$categoryRes) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01043'][$language] /* Invalid ID */, 'data' => $categoryRes);
                } else {
                    $db->where("module_id", $categoryRes["id"]);
                    $db->where('module', 'category');
                    $db->where('type', 'name');
                    $nameTranslationList = $db->get("inv_language", NULL, "id, language, content");

                    if($categoryRes["deleted"] == 0) {
                        $categoryRes["status"] = "Active";
                    } else {
                        $categoryRes["status"] = "Inactive";
                    }
                    // $categoryRes['type'] = General::getTranslationByName($categoryRes['type']);

                    $db->where('module', 'category');
                    $db->where("module_id", $categoryRes["id"]);
                    $db->where('type', 'name');
                    // $categoryResChineseName = $db->get('inv_language');
                    $categoryResChineseName = $db->map('language')->get("inv_language", NULL, "id, language, content");

                    $data["categoryRes"] = $categoryRes;
                    $data['categoryRes']['nameChinese'] = $categoryResChineseName;
                    $data["nameTranslationList"] = $nameTranslationList;

                    $getCategory = $db->get("product_category a", null, "a.id as id, a.name as name, a.parent_id as parent_id, a.deleted as deleted, a.created_at as created_at");

                    foreach ($getCategory as $getCategoryRes) 
                    {
                        // store category that is haven't assign to any category yet.
                        if($getCategoryRes['parent_id'] == '0')
                        {
                            $menuLevelCategory[] = $getCategoryRes;
                        }
        
                        // store the submenu category
                        if($getCategoryRes['parent_id'] != '0')
                        {
                            $subMenuLevelCategory[] = $getCategoryRes;
                        }
                    }
                    foreach ($menuLevelCategory as $category) 
                    {
                        $categoryId = $category['id'];
                        
                        // Check if the category has matching subcategories in subMenuLevelCategory
                        $matchingSubcategories = array_filter($subMenuLevelCategory, function($subcategory) use ($categoryId) {
                            return $subcategory['parent_id'] == $categoryId;
                        });
                        
                        // If there are matching subcategories, store the category in the new array
                        if (!empty($matchingSubcategories)) {
                            $matchingCategories[] = $category;
                        }
                    }

                    // Check if the searchId matches any id in the matchingCategories array
                    $searchResult = array_filter($matchingCategories, function($category) use ($categoryInvId) {
                        return $category['id'] == $categoryInvId;
                    });

                    // If the searchId matches, print a success message
                    if (!empty($searchResult)) {
                        $data['matchingCategories'] = 'not match';
                    } else {
                        $data['matchingCategories'] = 'match';
                    }

                }
            }

            return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $data);
        }

        public function verifyCategoryInventory($params, $insertType){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $category       = $params['category'];
            $status         = trim($params['status']);

            $userID = $db->userID;

            if(!$userID) {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['A01078'][$language] /* Access denied. */, 'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if($insertType == "add"){
                foreach ($category as $v) {
                    $categoryName = trim($v['name']);
                    $languageType = $v['language'];

                    if(empty($categoryName) && $languageType == 'english')
                    {
                        $errorFieldArr[] = array(
                            'id' => "nameError",
                            'msg'=> $translations['E01214'][$language] /* Category name cannot be empty. */
                        );
                    }

                    if(!$categoryName && $languageType == "english"){
                        $errorFieldArr[] = array(
                            'id' => "name".$languageType."Error",
                            'msg'=> $translations['E01043'][$language] /* Please Choose English as default. */
                        );

                        // ($categoryName && !preg_match("/^[a-zA-Z]+[a-zA-Z0-9]+$/",$categoryName))
                    }elseif($categoryName == "-"){
                        $errorFieldArr[] = array(
                            'id' => "name".$languageType."Error",
                            'msg'=> $translations['E01012'][$language] /* Invalid Category. */
                        );
                    }

                    // Check Language Type Field
                    if(!$languageType) {
                        $errorFieldArr[] = array(
                            'id'  => "langTypeError",
                            'msg' => $translations['E01045'][$language] /* Please Select Language Type. */
                        );
                    }
                }
            }else{
                foreach ($category as $v) {
                    $categoryName = trim($v['name']);
                    $languageType = $v['language'];

                    if(empty($categoryName) && $languageType == 'english')
                    {
                        $errorFieldArr[] = array(
                            'id' => "nameError",
                            'msg'=> $translations['E01214'][$language] /* Category name cannot be empty. */
                        );
                    }

                    if(!$categoryName && $languageType == "english"){
                        $errorFieldArr[] = array(
                            'id' => "name".$languageType."Error",
                            'msg'=> $translations['E01043'][$language] /* Please Choose English as default. */
                        );

                    // ($categoryName && !preg_match("/^[a-zA-Z]+[a-zA-Z0-9]+$/",$categoryName))
                    }elseif($categoryName == "-"){
                        $errorFieldArr[] = array(
                            'id' => "name".$languageType."Error",
                            'msg'=> $translations['E01012'][$language] /* Invalid Category. */
                        );
                    }

                    // Check Language Type Field
                    if(!$languageType) {
                        $errorFieldArr[] = array(
                            'id'  => "langTypeError",
                            'msg' => $translations['E01045'][$language] /* Please Select Language Type. */
                        );
                    }
                }
            }

            // Check Status Field
            // $statusAry = array('Active', 'Inactive');
            // if(!$status || !in_array($status, $statusAry)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "statusError",
            //         'msg' => $translations['E00671'][$language] /* Please Select Status. */
            //     );
            // }

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            return array('status'=>"ok", 'code'=>0, 'statusMsg'=>"", 'data'=>"");
        }

        public function addCategoryInventory($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $category       = $params['category'];
            // $categoryName   = $params['name'];
            // $languageType   = $params['language'];
            // $description    = $params['description'];
            $parent_id      = $params['parent_id'];
            // $cateNameChinese      = $params['cateNameChinese'];

            $userID = $db->userID;

            $verify = self::verifyCategoryInventory($params, 'add');
            if ($verify["status"] != "ok") return $verify;

            foreach ($category as $v) {
                $v['name'] = trim($v['name']);
                $categoryName = $v['name'];
                $languageType = $v['language'];
                // $description  = $v['description'];
                // $parent_id    = $v['parent_id'];
                if($languageType == "english"){
                    $defaultName = $categoryName;
                }

                $languageTypeList[$languageType] = $v;

                // check got duplicate category name in the table
                $db->where('name', $v['name']);
                $result = $db->get('product_category');
                if(!empty($result))
                {
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["A01247"][$language] /* Duplicate Record */, 'data' => $v['name']);
                }
            }

            $insertCategory = array(
                'name'          => $defaultName,
                'parent_id'     => $parent_id,
                // 'description'   => $description,
                'deleted'       => 0,
                'created_at'    => $dateTime,
            );
            $categoryInvId = $db->insert('product_category', $insertCategory);

            // Get System Languages
            $db->where("disabled", 0);
            $languages = $db->map("language_code")->get("languages", NULL, "language_code, language");

            foreach($languages  as  $key => $row){

                if($row == 'chineseSimplified'){
                    $row = 'chinese';
                }

                $db->where('module', 'category');
                $db->where('content', $category[$key]['name']);
                $db->where('language', $row);
                $db->where('type', 'name');
                $resultInv = $db->get('inv_language');

                // return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["A01247"][$language] /* Duplicate Record */, 'data' => $languageTypeList['chinese']);


                // return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["A01247"][$language] /* Duplicate Record */, 'data' => $languageTypeList['chinese']);


                if($languageTypeList[$row]['language'] == $row && $languageTypeList[$row]['name']){
                    $insertCategoryNameTrans = array(
                        "module" => "category",
                        "module_id" => $categoryInvId,
                        "type" => "name",
                        "language" => $row,
                        "content" => $languageTypeList[$row]['name'],
                        "updated_at" => $dateTime,
                    );
                } else {
                    $insertCategoryNameTrans = array(
                        "module" => "category",
                        "module_id" => $categoryInvId,
                        "type" => "name",
                        "language" => $row,
                        "content" => $languageTypeList[$row]['name'],
                        "updated_at" => $dateTime,
                    );
                }
                $db->insert("inv_language", $insertCategoryNameTrans);
            }

            // return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["A01247"][$language] /* Duplicate Record */, 'data' => $category[0]);


            // Update system setting for process get product
            $db->where('name', 'processGetProduct');
            $db->update('system_settings', array('value' => 0));

            if(!$categoryInvId) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations['E01046'][$language] /* Failed to Insert Category Name */,'data'=>'');
            }else{
                return array('status'=>'ok','code'=>0,'statusMsg'=> $translations['B00416'][$language] /* Successful Insert Category Name */,'data'=>'');
            }
        }

        public function getCategoryList($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $userID = $db->userID;
            $db->where('parent_id', 0);
            $parentList = $db->get('product_category',null,'id, name');

            if($parentList){
                foreach($parentList as $pRow){
                    $category['id'] = $pRow['id'];
                    $category['name'] = $pRow['name'];
    
                    $parentCategory[] = $category;
                }
                $data['parentCategory']    = $parentCategory;

                return array('status' => "ok", 'code' => 0, 'msg' => "", 'statusMsg' => "", 'data' => $data);
            }else{
                return array('status' => "ok", 'code' => 0, 'msg' => "", 'statusMsg' => $translations['B00101'][$language] /* No Results Found. */, 'data' => "");
            } 
        }

        public function editCategoryInventory($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $categoryInvId  = trim($params['categoryInvId']);
            $category       = $params['category'];
            // $categoryName   = $params['name'];
            // $languageType   = $params['language'];
            $description    = $params['description'];
            $parent_id      = $params['parent_id'];
            $status         = trim($params['status']);         
            
            $userID = $db->userID;
            $site = $db->userType;
        
            $verify = self::verifyCategoryInventory($params, 'edit');
            if ($verify["status"] != "ok") return $verify;
        
            foreach ($category as $v) {
                $categoryName = $v['name'];
                $languageType = $v['language'];
                // $description  = $v['description'];
                // $parent_id    = $v['parent_id'];
                if($languageType == "english"){
                    $defaultName = $categoryName;
                }
                $languageTypeList[$languageType] = $v;
            }
        
            if(!$categoryInvId) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01047'][$language] /* Category not found */, 'data' => '');
            }
        
            $db->where("id", $categoryInvId);
            $categoryInvRecord = $db->getOne("product_category", "*");
        
            if(!$categoryInvRecord) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01048'][$language] /* Record not found */, 'data' => '');
            }
        
            //determined the status to 0 or 1
            if($status=='Active'){
                $status=0;
            }else{
                $status=1;
            }
        
            $editCategory = array(
                'name'          => $defaultName,
                'parent_id'     => $parent_id,
                'description'   => $description,
                'deleted'       => $status,
                'updated_at'    => $dateTime,
            );
        
            $db->where("id", $categoryInvId);
            $editInvRes = $db->update('product_category', $editCategory);
        
            if(!$editInvRes) {
                return array('status' => 'error', 'code' => 1,'statusMsg' => $translations['E01049'][$language] /* Failed to Update Category */ ,'data' => '');
            }
        
                $db->where("module_id", $categoryInvRecord['id']);
                $db->where("module", "category");
                $db->where("type", "name");
                $translationList = $db->get("inv_language", NULL, "id, language, content");

                // return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01047'][$language] /* Category not found */, 'data' => $languageTypeList);

                foreach ($languageTypeList as $key => $row) {
                    $db->where('module', 'category');
                    $db->where("module_id", $categoryInvRecord['id']);
                    $db->where("language", $row["language"]);
                    $db->where('type', 'name');
                    $resultInv = $db->get('inv_language');
                    

                    if(empty($resultInv))
                    {

                        $insertCategoryNameTrans = array(
                            "module" => "category",
                            "module_id" => $categoryInvRecord['id'],
                            "type" => "name",
                            "language" => $row["language"],
                            "content" => $languageTypeList[$row['language']]['name'],
                            "updated_at" => $dateTime,
                        );
                        $db->insert("inv_language", $insertCategoryNameTrans);

                    }
                }
        
                // Update language_translation
                foreach ($translationList as $key => $row) {

                    if($languageTypeList[$row['language']]['language'] == $row['language']) {
                        $updateTranslation = array(
                            "language" => $row["language"],
                            "content" => $languageTypeList[$row['language']]['name'],
                            "updated_at" => $dateTime,
                        );
                    } else {
                        $updateTranslation = array(
                            "language" => $row["language"],
                            "content" => $defaultName,
                            "updated_at" => $dateTime,
                        );
                    }
                    $db->where("module_id", $categoryInvRecord['id']);
                    $db->where("language", $row["language"]);
                    $db->where("module", "category");
                    $db->where("type", "name");
                    $db->update("inv_language", $updateTranslation);
                    $updateTranslationList['updateList'][] = $updateTranslation;
                }
        
                $insertInvLog = array(
                        "module"                    =>  "inv_category",
                        "module_id"                 =>  $categoryInvId,
                        "title_transaction_code"    =>  "T00065",
                        "title"                     =>  "Edit Category",
                        "transaction_code"          =>  "L00088",
                        "data"                      =>  json_encode(array("admin"=>$checkAdmin)),
                        "creator_type"              =>  $site,
                        "creator_id"                =>  $userID,
                        "created_at"                =>  $dateTime,
                );
        
                $db->insert("inv_log", $insertInvLog);
        
            // Update system setting for process get product
            $db->where('name', 'processGetProduct');
            $db->update('system_settings', array('value' => 0));
        
            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations['E00708'][$language] /* Successfully Edited */, 'data'=>"");
        }

        // -------- Cooking Suggestion Category --------//
        public function getCookingSuggestion($params) {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $userID = $db->userID;
            $site = $db->userType;

            $searchData = $params['searchData'];
            $sortData       = $params['sortData'];
            $pageNumber = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll = $params['seeAll'] ? : 0;
            $limit = General::getLimit($pageNumber);

            if($seeAll) {
                $limit = NULL;
            }

            if(count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType  = trim($v['dataType']);

                    switch($dataName) {
                        // case "type":
                        //     $db->where("type", $dataValue);
                        //     break;

                        case "status":
                            if($dataValue == "Active") {
                                $db->where("status", "Active");
                            } else if($dataValue == "Inactive") {
                                $db->where("status", "Inactive");
                            }
                            break;

                        case 'createdAt':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                $db->where('DATE(created_at)', date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language], 'data'=>$data);

                                $db->where('DATE(created_at)', date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;

                        case 'name':
                            $db->where('name', "%". $dataValue . "%", "LIKE");
                            break;

                        case 'time':
                            $db->where('cooking_time', "%". $dataValue . "%", "LIKE");
                            break;

                        case 'instruction':
                            $db->where('description', "%". $dataValue . "%", "LIKE");
                            break;

                        case 'url':
                            $db->where('defaultURL', "%". $dataValue . "%", "LIKE");
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                    unset($dataType);
                }
            }

            $sortOrder = "DESC";
            $sortField = 'created_at';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'ASC')
                    $sortOrder = 'ASC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
                $db->orderBy($sortField, $sortOrder);
            }

            $copyDB = $db->copy();
            // $db->orderBy("created_at", "DESC");
            $suggestRes = $db->get("cooking_suggestion", null, "id as id, name, status, cooking_time,description,defaultURL, created_at");

            if(!$suggestRes) {
                return array("status" => "ok", "code" => 0, "statusMsg" => $translations["B00101"][$language] /* No results found */, "data" => "");
            }

            foreach ($suggestRes as $suggestRow) {
                $suggestID[$suggestRow['id']] = $suggestRow['id'];
            }


            foreach($suggestRes as $suggestRow) {
                $suggest["id"] = $suggestRow["id"];
                $suggest["name"] = $suggestRow["name"];
                $suggest["url"] = $suggestRow["defaultURL"];
                $suggest["time"] = $suggestRow["cooking_time"];
                $suggest["description"] = $suggestRow["description"];
                $suggest["display"] = $lang[$suggestRow['id']][$language];
                // $suggest["type"] = General::getTranslationByName($suggestRow["type"]);

                switch($suggestRow["status"]) {
                    case "Active":
                        $suggest["status"] = "Active";
                        $suggest["statusDisplay"] = General::getTranslationByName($suggest["status"]);
                        break;

                    case "Inactive":
                        $suggest["status"] = "Inactive";
                        $suggest["statusDisplay"] = General::getTranslationByName($suggest["status"]);
                        break;

                    default:
                        break;
                }

                $suggest["createdAt"] = date($dateTimeFormat, strtotime($suggestRow['created_at']));

                $suggestList[] = $suggest;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $totalRecord = $copyDB->getValue('cooking_suggestion', "count(*)");
            $data["suggestList"] = $suggestList;
            $data["pageNumber"] = $pageNumber;
            $data["totalRecord"] = $totalRecord;
            if($seeAll == "1") {
                $data["totalPage"] = 1;
                $data["numRecord"] = $totalRecord;
            } else {
                $data["totalPage"] = ceil($totalRecord/$limit[1]);
                $data["numRecord"] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00114"][$language] /* Search Sucecssful */, 'data'=> $data);
        }

        public function getCookingSuggestionDetail($params){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $suggestId   = $params['suggestId'];
            $userID = $db->userID;
            $site = $db->userType;

            if($suggestId) {
                $db->where("id", $suggestId);
                $suggestRes = $db->getOne("cooking_suggestion", "id, name, cooking_time,defaultURL,description, status");

                $db->where("module_id", $suggestId);
                $db->where("module", 'cookingSuggestion');
                $suggestResLan = $db->get("inv_language",null, "id, module, type, language, content");

                // $db->where("suggestion_id	", $suggestId);
                // $suggestURL = $db->getValue("cooking_suggestion_details", "url");

                if(!$suggestRes) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01043'][$language] /* Invalid ID */, 'data' => $suggestRes);
                } else {
                    $data["suggestRes"] = $suggestRes;
                    $data["suggestResLan"] = $suggestResLan;
                    // $data["suggestURL"] = $suggestURL;
                }
            }

            return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $data);
        }

        public function addCookingSuggestion($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $inputArray       = $params['inputArray'];
            $userID = $db->userID;

            foreach ($inputArray as $v) {
                $methodName     = trim($v['methodName']);
                $instruction    = trim($v['instruction']);
                $methodURL      = trim($v['methodURL']);
                $methodTime     = ($v['methodTime']);
                $descriptionArr            = $v['descriptionArr'];
                $cookingSuggestNameArr     = $v['cookingSuggestNameArr'];
                
                if(!$methodName){
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations['E01220'][$language] /* Please enter Template Name */, 'data' => '');
                }

                if($methodTime != 0)
                {
                    if(empty($methodTime)){
                        return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations['E01219'][$language] /* Please enter Cooking Time */, 'data' => '');
                    }
                }

                if(!$instruction){
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations['E01217'][$language] /* Please enter Cooking Instruction */, 'data' => '');
                }

                if(!$methodURL){
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations['E01218'][$language] /* Please enter Default URL */, 'data' => '');
                }

                if (!preg_match('/^[0-9]+$/', $methodTime)) {
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations['E01221'][$language] /* Invalid Cooking Time, please make sure its digit input */, 'data' => '');
                } 

                // check got duplicate category name in the table
                $db->where('name', $methodName);
                $result = $db->get('cooking_suggestion');
                if(!empty($result))
                {
                    return array('status' =>"error", 'code' => 1, 'statusMsg' => $translations["A01247"][$language] /* Duplicate Record */, 'data' => $methodName);
                }
            }

            //Insert into inv_category
            $insertCategory = array(
                'name'          => $methodName,
                'description'   => $instruction,
                'status'        => "Active",
                'defaultURL'    => $methodURL,
                'cooking_time'  => $methodTime,
                'updated_at'    => $dateTime,
                'created_at'    => $dateTime,
            );
            $categoryInvId = $db->insert('cooking_suggestion', $insertCategory);

            if($cookingSuggestNameArr){
                foreach($cookingSuggestNameArr as $key => $value){
                    $insertInvLan = array(
                        "module"               => 'cookingSuggestion',
                        "module_id"            => $categoryInvId,
                        "type"                 => 'name',
                        "language"             => $value['language'],
                        "content"              => $value['name'],
                        "updated_at"           => $dateTime
                    );
                    $invLanID = $db->insert('inv_language', $insertInvLan);
                }
            }

            if($descriptionArr){
                foreach($descriptionArr as $key => $value){
                    $insertInvLan2 = array(
                        "module"               => 'cookingSuggestion',
                        "module_id"            => $categoryInvId,
                        "type"                 => 'description',
                        "language"             => $value['language'],
                        "content"              => $value['name'],
                        "updated_at"           => $dateTime
                    );
                    $invLanID = $db->insert('inv_language', $insertInvLan2);
                }
            }

            // Add Cooking URL
            // $insertCookingURL = array(
            //     'url'             => $methodURL,
            //     'suggestion_id'   => $categoryInvId,    
            //     'updated_at'      => $dateTime,
            //     'created_at'      => $dateTime,
            // );
            // $cookingURLID = $db->insert('cooking_suggestion_details', $insertCookingURL);
            
            if(!$categoryInvId) {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations['E01202'][$language] /* Failed to Insert New Cooking Suggestion */,'data'=>'');
            }else{
                return array('status'=>'ok','code'=>0,'statusMsg'=> $translations['B00529'][$language] /* Successful Insert Category Name */,'data'=>'');
            }
        }

        public function editCookingSuggestion($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $suggestId      = trim($params['suggestId']);
            $inputArray     = $params['inputArray'];        
            
            $userID = $db->userID;
            $site = $db->userType;

            foreach ($inputArray as $v) {
                $methodName     = trim($v['methodName']);
                $methodTime     = trim($v['methodTime']);
                $methodURL      = trim($v['methodURL']);
                $instruction    = trim($v['instruction']);
                $status         = trim($v['status']);
                $descriptionArr             = $v['descriptionArr'];
                $cookingSuggestNameArr      = $v['cookingSuggestNameArr'];
            }

            if(!$methodName) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01220'][$language] /* Please enter Template Name */, 'data' => '');
            }

            if($methodTime != 0)
            {
                if(empty($methodTime)) {
                    return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01219'][$language] /* Please enter Cooking Time */, 'data' => '');
                }
            }

            if(!$instruction) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01217'][$language] /* Please enter cooking instruction */, 'data' => '');
            }

            if(!$methodURL) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01218'][$language] /* Please enter Default URL. */, 'data' => '');
            }

            // if(!$suggestId) {
            //     return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01202'][$language] /* Failed to Insert New Cooking Suggestion */, 'data' => '');
            // }

            if (!preg_match('/^[0-9]+$/', $methodTime)) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01221'][$language] /* Invalid Cooking Time, please make sure its digit input. */, 'data' => '');
            } 

            $db->where("id", $suggestId);
            $cookingSuggestRecord = $db->getOne("cooking_suggestion", "*");

            if(!$cookingSuggestRecord) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01048'][$language] /* Record not found */, 'data' => '');
            }

            $editSuggest = array(
                'name'          => $methodName,
                'description'   => $instruction,
                'defaultURL'    => $methodURL,
                'cooking_time'  => $methodTime,
                'status'        => $status,
                'updated_at'    => $dateTime,
            );
            $db->where("id", $suggestId);
            $editInvRes = $db->update('cooking_suggestion', $editSuggest);

            if($cookingSuggestNameArr){
                foreach($cookingSuggestNameArr as $key => $value){

                    $db->where("module_id", $suggestId);
                    $db->where("module", 'cookingSuggestion');
                    $db->where("type", 'name');
                    $db->where("language", $value['language']);
                    $getDesc = $db->get('inv_language');

                    if(!$getDesc){
                        $insertInvLan = array(
                            "module"               => 'cookingSuggestion',
                            "module_id"            => $suggestId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanDesc2 = $db->insert('inv_language', $insertInvLan);

                    }else{
                        $insertInvLan = array(
                            "module"               => 'cookingSuggestion',
                            "module_id"            => $suggestId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $suggestId);
                        $db->where("module", 'cookingSuggestion');
                        $db->where("type", 'name');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan);
                    }
                }
            }

            if($descriptionArr){

                foreach($descriptionArr as $key => $value){

                    $db->where("module_id", $suggestId);
                    $db->where("module", 'cookingSuggestion');
                    $db->where("type", 'description');
                    $db->where("language", $value['language']);
                    $getDesc = $db->get('inv_language');

                    if(!$getDesc){
                        $insertInvLan2 = array(
                            "module"               => 'cookingSuggestion',
                            "module_id"            => $suggestId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanDesc2 = $db->insert('inv_language', $insertInvLan2);
                    }else{
                        $insertInvLan2 = array(
                            "module"               => 'cookingSuggestion',
                            "module_id"            => $suggestId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $suggestId);
                        $db->where("module", 'cookingSuggestion');
                        $db->where("type", 'description');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan2);
                    }
                }
            }


            if(!$editInvRes) {
                return array('status' => 'error', 'code' => 2,'statusMsg' => $translations['E01204'][$language] /* Failed to Update Cooking Suggestion */ ,'data' => '');
            }else{
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations['E00708'][$language] /* Successfully Edited */, 'data'=>"");
            }
        }

        // -------- Package -------- //
        public function getPackageListing($params, $starterKit){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;

            $searchData      = $params['searchData'];
            $sortData       = $params['sortData'];
            $pageNumber      = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll          = $params['seeAll'];
            $limit           = General::getLimit($pageNumber);
            $dateTimeFormat  = Setting::$systemSetting['systemDateTimeFormat'];
            if(!$starterKit) $starterKit = $params['starterKitFlag'];

            $userID = $db->userID;
            $site = $db->userType;

            if($seeAll){
                $limit = null;
            }
            
            if(!$seeAll){
                $limit = General::getLimit($pageNumber);
            }

            if($params['type'] == 'export') {
                $params['command'] = __FUNCTION__;
                $params['starterKitFlag'] = $starterKit;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            foreach ($searchData as $k => $v) {
                $dataName = trim($v['dataName']);
                $dataValue = trim($v['dataValue']);

                if($dataName == 'category'){
                    $db->where('deleted', '0');
                    $db->where('name', '%'. $dataValue .'%', 'LIKE');
                    $categoryId = $db->getOne('product_category');
                    $categoryId = $categoryId['id'];
                }
            }

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'productName':
                            $db->where('p.name', "%" . $dataValue . "%", "LIKE");
                            break;

                        case 'code':
                            $db->where("p.barcode", "%". $dataValue . "%" , "LIKE");
                            break;

                        case 'status':
                            if($dataValue == 'Sold Out'){
                                $db->where('status', 'Active');
                                $db->where('is_unlimited', '0');
                                $db->where('total_balance - total_sold', '0', '<=');
                            }else{
                                $db->where("status", $dataValue);
                            }
                            break;

                        case 'category' :
                            $db->where('p.categ_id','%"' . $categoryId . '"%', 'LIKE');
                            break;
                            
                        case 'isPublish':
                            if(strtolower($dataValue) == 'no')
                            {
                                $dataValue = '0';
                            }
                            else
                            {
                                $dataValue = '1';
                            }
                            $db->where('p.is_published', $dataValue);
                            break;
                            
                        case 'isArchive':
                            if(strtolower($dataValue) == 'no')
                            {
                                $dataValue = '0';
                            }
                            else
                            {
                                $dataValue = '1';
                            }
                            $db->where('p.is_archive', $dataValue);
                            break;
                        
                        case 'salePrice':
                            $db->where('p.sale_price','%' . $dataValue . '%', 'LIKE');
                            break;

                        case 'vendorName' :

                            $subProductIDAry = $db->subQuery();
                            $subProductIDAry->where('name', '%'.$dataValue.'%', 'LIKE');
                            $subProductIDAry->get('vendor', null, 'id');

                            $db->where('p.vendor_id', $subProductIDAry, 'IN');
                            break;

                        case 'createdAt':
                            $columnName = 'DATE(created_at)';

                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                $db->where($columnName, date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                // $dateTo += 86399;
                                $db->where($columnName, date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;

    
                        case 'updatedAt':
                            $columnName = 'DATE(updated_at)';

                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                $db->where($columnName, date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                $db->where($columnName, date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $packageDbCopy = $db->copy();
            $db->orderBy('p.created_at', 'DESC');
            $db->where('pi.deleted', '0');
            $db->where('p.product_type', 'Package');
            $db->join('package_item pi', 'pi.package_id = p.id', 'LEFT');

            $copyPackageDb = $db->copy();
            $packageRes = $db->get('product p', $limit, 'p.id, p.name, p.description, p.expired_day, p.sale_price, p.vendor_id, p.created_at, p.barcode as skuCode, p.categ_id, pi.product_id as package_item_id,  pi.quantity as package_quantity, p.is_published as publishStatus, p.is_archive as archiveStatus, p.product_type, p.description, p.cost, p.cooking_time');

            $sortOrder = "DESC";
            $sortField = 'p.created_at';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'ASC')
                    $sortOrder = 'ASC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
                $packageDbCopy->orderBy($sortField, $sortOrder);
            }

            $rule = array(
                array('col' => 'p.product_type', 'val' => 'Package')
            );
            
            foreach($rule as $v){
                $packageDbCopy->where($v['col'], $v['val']);
            }
            $packageDbCopy->join('vendor v', 'v.id = p.vendor_id', 'LEFT');
            $copyDb = $packageDbCopy->copy();
            $packageListing = $packageDbCopy->get('product p', $limit, 'p.id, p.name, p.description, p.expired_day, p.sale_price, p.vendor_id, p.created_at, p.barcode as skuCode, p.categ_id, p.is_published as publishStatus, p.is_archive as archiveStatus, p.product_type, p.description, p.cost, p.cooking_time, v.name as vendorName');

            if(empty($packageListing)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            $db->where('deleted', 0);
            $categoryAry = $db->map('id')->get('product_category', null, 'id');

            if($categoryAry) {
                $db->where('module_id', $categoryAry, 'IN');
                $db->where('language', $language);
                $db->where('module', 'category');
                $categoryLang = $db->map('module_id')->get('inv_language', null, 'module_id, content');
            }

            $copyPackageDb->where('pi.type', 'mystery');
            $packageItemListing = $copyPackageDb->get('product p', $limit, 'p.id, p.name, p.description, p.expired_day, p.sale_price, p.vendor_id, p.created_at, p.barcode as skuCode, p.categ_id, pi.product_id as package_item_id,  pi.quantity as package_quantity, pi.type, p.is_published as publishStatus, p.is_archive as archiveStatus, p.product_type, p.description, p.cost, p.cooking_time');

            $summedQuantities = [];

            if(!$packageItemListing)
            {
                $summedQuantities[$id]['quantity'] = 0;
            }
            else
            {
                foreach ($packageItemListing as $item) {
                    $id = $item['id'];
                    $quantity = $item['package_quantity'];
    
                    if (isset($summedQuantities[$id])) {
                        $summedQuantities[$id]['quantity'] += $quantity;
                    } else {
                        $summedQuantities[$id] = [
                            'id' => $id,
                            'quantity' => $quantity,
                        ];
                    }
                }
            }

            $summedQuantities = array_values($summedQuantities);

            foreach($packageListing as $productInvRow){

                $productDetail['id'] = $productInvRow['id'];
                $productDetail['skuCode'] = $productInvRow['skuCode'];
                $productDetail['name'] = $productInvRow['name'];

                unset($categoryDisplay);
                unset($productDetail['categoryDisplay']);
                foreach($productInvRow['categ_id'] as $val) {
                    $categoryDisplay[$category] = $categoryLang[$val];
                    $productDetail['categoryDisplay'][] = implode(', ', $categoryDisplay);
                }

                if(empty($productDetail['categoryDisplay'])) {
                    $productDetail['categoryDisplay'] = '';
                }
               

                if($productInvRow['status'] == 1) {
                    $productDetail['status'] = 'No';
                    $productDetail['statusDisplay'] = General::getTranslationByName($productDetail['status']);
                } else {
                    $productDetail['status'] = 'Yes';
                    $productDetail['statusDisplay'] = General::getTranslationByName($productDetail['status']);
                }

                $productDetail['productType'] = $productInvRow['product_type'];
                $productDetail['description'] = $productInvRow['description'];
                $productDetail['cost'] = $productInvRow['cost'];
                $productDetail['salePrice'] = $productInvRow['sale_price'];
                $productDetail['expiredDay'] = $productInvRow['expired_day'];
                $productDetail['cookingTime'] = $productInvRow['cooking_time'];
                $productDetail['vendorName'] = $productInvRow['vendorName'] ?: '-';
                if($productInvRow['publishStatus'] == '1')
                {
                    $productDetail['publishStatus'] = 'Yes';
                }
                else if($productInvRow['publishStatus'] == '0')
                {
                    $productDetail['publishStatus'] = 'No';
                }

                if($productInvRow['archiveStatus'] == '1')
                {
                    $productDetail['archiveStatus'] = 'Yes';
                }
                else if($productInvRow['archiveStatus'] == '0')
                {
                    $productDetail['archiveStatus'] = 'No';
                } 

                $productInvRow['categ_id'] = json_decode($productInvRow['categ_id'], true);
                
                unset($categoryDisplay);
                unset($productDetail['categoryDisplay']);
                foreach($productInvRow['categ_id'] as $val) {
                    $categoryDisplay[$category] = $categoryLang[$val];
                    $productDetail['categoryDisplay'][] = implode(', ', $categoryDisplay);
                }

                if(empty($productDetail['categoryDisplay'])) {
                    $productDetail['categoryDisplay'] = '';
                }

                if($summedQuantities)
                {
                    foreach ($summedQuantities as $summedQuantity) 
                    {
                        if ($summedQuantity['id'] == $productDetail['id']) {
                            $mysteryFoodQuantity = $summedQuantity['quantity'];
                            break;
                        }
                        else
                        {
                            $mysteryFoodQuantity = 0;
                        }
                    }
                }
                if (isset($mysteryFoodQuantity)) {
                    $productDetail['mysteryFoodQuantity'] = $mysteryFoodQuantity;
                }
                else
                {
                    $productDetail['mysteryFoodQuantity'] = 0;
                }

                $db->where('reference_id', $productInvRow['id']);
                $db->where('type', 'Image');
                $db->where('deleted', 0);
                $db->orderBy('id', 'ASC');
                $productImage = $db->getValue('product_media', 'url');

                if($productImage){
                    $productDetail['productImage'] = '<img src="' . $productImage . '" width="150" height="150">';
                    $productDetail['productImageUrl'] = $productImage;
                }else{
                    $productDetail['productImage'] = '-';
                    $productDetail['productImageUrl'] = '';
                }

                $productDetail['created_at'] = date($dateTimeFormat, strtotime($productInvRow['created_at']));
                $productDetail['updated_at'] = $productInvRow['updated_at'] > 0 ? date($dateTimeFormat, strtotime($productInvRow['updated_at'])) : '-';
                $productInvList[] = $productDetail;
            }

            if($updaterAry){
                $db->where("id", $updaterAry, "IN");
                $adminIDAry = $db->map("id")->get("admin", null, "id, username");
            }

            if($packageID){
                $db->where('product_id', $packageID, 'IN');
                $db->where('type', array('packageCategory'), 'IN');
                $packageDetailRes = $db->get('mlm_product_setting', null, 'product_id, name, value');

                foreach ($packageDetailRes as $packageDetailRow) {
                    $packageDetail[$packageDetailRow['product_id']][$packageDetailRow['name']][] = $packageDetailRow['value'];
                }

                $db->where('module_id', $packageID, 'IN');
                $db->where('module', 'mlm_product');
                $db->where('language', $language);
                $langAry = $db->get('inv_language', null, 'module_id, type, content');

                foreach ($langAry as $langRow) {
                    $lang[$langRow['module_id']][$langRow['type']] = $langRow['content'];
                }

                $db->where('product_id', $packageID, 'IN');
                $db->where('country_id', 100);
                $priceDetailRes = $db->map('product_id')->get('mlm_product_price', null, 'product_id, price, promo_price, m_price, ms_price');

                $db->where('value', $packageID, 'IN');
                $db->where('name', 'validPackage');
                $validPackageAry = $db->get('inv_product_detail', null, 'name, value, inv_product_id, reference');

                $db->where('status', 'Active');
                $productAry = $db->map('id')->get('inv_product', null, 'id, weight');

                foreach ($validPackageAry as $validPackageRow) {
                    $validPackageRow['weight'] = Setting::setDecimal($productAry[$validPackageRow['inv_product_id']] * $validPackageRow['reference']);

                    unset($validPackageRow['reference']);
                    $packageDetailAry[$validPackageRow['value']][$validPackageRow['inv_product_id']] = $validPackageRow;
                }
            }

            $db->where('disabled', 0);
            $db->where('type', 'package');
            $categoryAry = $db->getValue('inv_category', 'id', null);

            if($categoryAry) {
                $db->where('module_id', $categoryAry, 'IN');
                $db->where('module', 'inv_category');
                $db->where('language', $language);
                $categoryLang = $db->map('module_id')->get('inv_language', null, 'module_id, content');
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $totalRecord              = $copyDb->getValue("product p", "count(*)");
            $data['packageList']      = $productInvList;
            $data['pageNumber']       = $pageNumber;
            $data['totalRecord']      = $totalRecord;
            if($seeAll) {
                $data['totalPage']    = 1;
                $data['numRecord']    = $totalRecord;
            } else {
                $data['totalPage']    = ceil($totalRecord/$limit[1]);
                $data['numRecord']    = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00114"][$language] /* Search successful */, 'data' => $data);
        }

        public function getPackageDetail($params, $starterKit){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;

            $packageID = $params['packageID'];
            $vendorId  = $params['vendorId'];

            $userID = $db->userID;
            $site = $db->userType;

            $db->where("status","Active");
            $cookingSuggestRecord = $db->get("cooking_suggestion",NULL,"id, name,description,status,cooking_time");
            foreach ($cookingSuggestRecord as $value) {
                $row = array(
                    "name" => $value['name'],
                    "description" => $value['description'],
                    "cookingTime" => $value['cooking_time'],
                    "status" => $value['status']
                );
                $cookingSuggestList[] = $row;
            }
            $data['cookingSuggestList'] = $cookingSuggestList;

            $db->where("disabled", 0);
            $availableLanguages = $db->get("languages", NULL, "id, language, language_code");

            foreach ($availableLanguages as $value) {
                $row = array(
                    "languageType" => $value['language'],
                    "languageDisplay" => $translations[$value['language_code']][$language]
                );

                $languageList[] = $row;

                if($value['language'] == 'chineseSimplified'){
                    $languageArr = 'chinese';
                }else{
                    $languageArr = $value['language'];
                }
                $availableLanguageAry[] = $languageArr;
            }
            $data['languageList'] = $languageList;

            $db->where("b.parent_id", null , 'IS');
            $db->where('a.deleted', '0');
            $db->join("product_category b", "b.parent_id = a.id", "LEFT");
            $availableCategory = $db->get("product_category a",null,"a.id, a.name, a.parent_id");


            foreach($availableCategory as $value){
                $categoryIDAry[] = $value["id"];
            }

            if($categoryIDAry) {
                $db->where("module_id",$categoryIDAry,"IN");
                $db->where("module","category");
                $db->where("language",$language);
                $db->where("type","name");
                $categoryLang = $db->map('module_id')->get("inv_language",null,"module_id,content");
            }

            foreach($availableCategory as $value){
                if($value['parent_id'] != '0')
                {
                    $db->where('id', $value['parent_id']);
                    $parentName = $db->getOne('product_category', 'name');
                    $parentName = $parentName['name'];

                    $value['parentName'] = $parentName;
                    $value["categoryDisplay"] = $parentName . ' - ' . $categoryLang[$value["id"]];
                }
                else
                {
                    $value['parentName'] = '';
                    $value["categoryDisplay"] = $categoryLang[$value["id"]];
                }
                $categoryProductList[] = $value;
            }

            $data['packageCategoryList'] = $categoryProductList;

            if(!empty($vendorId))
            {
                $db->where('vendor_id', $vendorId);
                $availableProduct = $db->map('id')->get('product', null, 'id, name, sale_price');
    
                foreach ($availableProduct as $value) {
                    $productIDAry[$value['id']] = $value['id'];
                }
                $data['productList'] = $availableProduct;
            }

            unset($countryParams);
            $countryParams = array(
                "deliveryCountry" => "Yes"
            );
            $countryReturn = Country::getCountriesList($countryParams);
            $data["availableCountry"] = $countryReturn["data"]["countriesList"];

            if($packageID) {
                if($starterKit){
                    $db->where('is_starter_kit', 1);
                }
                $db->where('id', $packageID);
                $packageRes = $db->getOne("mlm_product", "id, code, name, weight, pv_price, total_balance, status, active_at");
                $packageRes['active_at'] = $packageRes['active_at'] > 0 ? date('d/m/Y', strtotime($packageRes['active_at'])) : '-';

                if(!$packageRes) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data' => "");
                } else {

                    $db->where("module_id", $packageID);
                    $db->where("module", "package");
                    $db->where("type", "name");
                    $db->where("language",$availableLanguageAry,"IN");
                    $nameTranslationList = $db->get("inv_language", null, "id, language, content");

                    $db->where("module_id",  $packageID);
                    $db->where("module", "package");
                    $db->where("type", "description");
                    $db->where("language",$availableLanguageAry,"IN");
                    $descrTranslationList = $db->get("inv_language", null, "id, language, content");

                    $db->where('deleted', '0');
                    $db->where('reference_id', $packageID);
                    // $db->where('type', 'Image');
                    $packageDetails = $db->get('product_media', null, 'id, name, url, type as uploadType');

                    foreach($packageDetails as $packageDetailsRow) {
                        if($packageDetailsRow['uploadType'] != 'video'){
                            $imageDetail['url']  = $packageDetailsRow;
                            $imageList[] = $imageDetail['url'];
                        }elseif (strtolower($packageDetailsRow['uploadType']) == 'video') {
                            $videoList[] = $packageDetailsRow;
                        }
                    }

                    $db->where('product_id', $packageID);
                    $db->where('type', array('packageCategory', 'bBasic', 'catalogue'), 'IN');
                    $packageDetailRes = $db->get("mlm_product_setting", null, "id, name, value");

                    // $data['bBasic'] = 0;
                    // $data['catalogue'] = 0;
                    if($packageDetailRes){
                        $countryName = $db->map("id")->get("country", null, "id, translation_code");

                        foreach ($packageDetailRes as $packageDetailRow) {
                            if($packageDetailRow['name'] == "packageCategory"){
                                $packageRes['category'][] = $categoryLang[$packageDetailRow['value']];
                            }
                            if($packageDetailRow['name'] == "bBasic" || $packageDetailRow['name'] == "catalogue"){
                                $data[$packageDetailRow['name']] = $packageDetailRow['value'];
                            }
                        }
                    }

                    $db->where('deleted', '0');
                    $db->where('package_id', $packageID);
                    $validProduct = $db->get("package_item", null, "id, package_id, product_id, quantity, cost, type");
                    $db->where('p.id', $packageID);
                    $db->where('p.product_type', 'Package');
                    $db->where('p.deleted', 0);
                    $db->join('product_media pm', 'pm.reference_id = p.id', 'LEFT');
                    $package = $db->getOne('product p', 'p.name, p.vendor_id, p.expired_day, p.categ_id, p.cost ,p.sale_price, p.description, pm.url as image, pm.name as image_name, p.is_published as publishStatus, p.is_archive as archiveStatus, p.ignore_stock_count as ignoreStatus, p.barcode as skucode, p.delivery_method');

                    if($package['ignoreStatus'] == '')
                    {
                        $package['ignoreStatus'] = 0;
                    }
                    if($validProduct){
                        foreach ($validProduct as $productRow) {
                            // $db->where('pi.type', 'product');
                            $db->where('p.id', $productRow['product_id']);
                            $db->where('pi.package_id', $productRow['package_id']);
                            $db->where('p.deleted', 0);
                            $db->where('pi.deleted', 0);
                            $db->join('package_item pi', 'pi.product_id = p.id', 'LEFT');
                            $productDetail = $db->getOne('product p', 'p.id as product_id, p.name, p.sale_price, p.vendor_id, p.categ_id, pi.quantity as quantity, pi.cost as cost');

                            if(empty($productDetail))
                            {
                                if($productRow['product_id'] == 0)
                                {
                                    $productDetail['id']         = $productRow['id'];
                                    $productDetail['product_id'] = $productRow['product_id'];
                                    $productDetail['name']       = '-';
                                    $productDetail['type']       = $productRow['type'];
                                    $productDetail['cost']       = $productRow['cost'];
                                    $productDetail['sale_price'] = 0;
                                    $productDetail['quantity']   = $productRow['quantity'];
                                }
                            }
                            $packageRes[] = $productDetail;
                        }
                    }

                    $db->where('p.disabled', 0);
                    $db->where('p.product_id', $packageID);
                    $priceDetails = $db->get('mlm_product_price p',null,'(SELECT c.name FROM country c WHERE c.id = p.country_id) AS countryName, p.price, p.promo_price AS promoPrice, p.m_price AS memberPrice, p.ms_price AS memberUpPrice');

                    $data['packageDetails'] = $packageRes;
                    $data['packageInfo'] = $package;
                    // $data['packagePriceDetails'] = $priceDetails;
                    $data['nameTranslationList'] = $nameTranslationList;
                    $data['descrTranslationList'] = $descrTranslationList;
                    if(empty($imageList))
                    {
                        $imageList = array();
                        $data['imageList'] = $imageList;
                    }
                    else
                    {
                        $data['imageList'] = $imageList;
                    }
                    $data['videoList'] = $videoList;

                    $db->join('cooking_suggestion cs','cs.id = csd.suggestion_id','INNER');
                    $db->where('product_id',$packageID);
                    $cookingSuggestDetails = $db->get('cooking_suggestion_details csd',null ,'csd.id AS id,url, cs.name AS name,remark,cs.description as description,suggestion_id,cs.cooking_time');

                    $db->where('module_id',$packageID);
                    $db->where('module','product');
                    $getInvLanProduct = $db->get('inv_language',null,'id, type, language, content');
                    $getInvLan['product'] = $getInvLanProduct;

                    foreach($cookingSuggestDetails as $key => $value){
                        $db->where('module_id',$cookingSuggestDetails[$key]['id']);
                        $db->where('module','cookingSuggestionDetails');
                        $getChinese = $db->get('inv_language',null,'id as cid, type, language, content');

                        $newArr[$key]['id'] = $value['id'];
                        $newArr[$key]['url'] = $value['url'];
                        $newArr[$key]['name'] = $value['name'];
                        $newArr[$key]['description'] = $value['description'];
                        $newArr[$key]['suggestion_id'] = $value['suggestion_id'];
                        $newArr[$key]['cooking_time'] = $value['cooking_time'];
                        $newArr[$key]['language'] = $getChinese;
                        $getInvLan['cookingSuggest'][$key] = $getChinese;
                        $data['invTranslationList'] = $getInvLan;

                        $data['cookingDetail'] = $newArr;                        
                    }
                }
            }

            # get FOC detail
            $db->where('product_id', $packageID);
            $db->where('deleted', '0');
            $focDetail = $db->getOne('delivery_method_detail');
            if($focDetail)
            {
                $isFOC = 1;
            }
            else
            {
                $isFOC = 0;
            }
            $data['focDetail'] = $isFOC;
            // vendor detail
            $db->where('deleted', 0);
            $vendorList = $db->get('vendor', null, 'id, name, vendor_code');

            $data['supplierList'] = $vendorList;

            $db->where('status', 'Active');
            $db->where('name', 'Self Pickup', 'NOT LIKE');
            $deliveryMethodList = $db->get('gotasty_delivery_method', null, 'id, name, price');
            
            $data['deliveryMethodList'] = $deliveryMethodList;
            return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations["A00114"][$language] /* Search successful */, 'data' => $data);
        }

        public function verifyPackageDetail($params, $type = "") {
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;

            $packageID          = $params['packageID'];
            $name            = trim($params['name']);
            $code            = trim($params['code']);
            $packageQuantity = trim($params['packageQuantity']);
            $product         = $params['product'];
            $category        = $params['category'];
            $priceSetting    = $params['priceSetting'];
            $pvPrice         = $params['pvPrice'];
            $activeDate      = $params['activeDate'];
            $nameLanguages   = $params['nameLanguages'];
            $descrLanguages  = $params['descrLanguages'];
            $uploadImage     = $params['uploadImage'];
            $uploadVideo     = $params['uploadVideo'];
            $status          = trim($params['status']);
            $statusAry       = array('Active', 'Inactive');
            $todayDate       = strtotime(date("Y-m-d"));
            $adminRoleList   = Setting::$systemSetting['InvEditableRoles'];
            $adminRoleListAry = explode("#", $adminRoleList);

            $clientID   = $db->userID;
            $site       = $db->userType;

            $createPackage   = $params['createPackage'];
            $productQuantity = $params['productQuantity'];
            $isStarterKit    = $params['isStarterKit'];
            $weight          = trim($params["weight"]);

            $db->where('role_id',$adminRoleListAry, 'IN');
            $availableAdminRes = $db->getValue('admin','id',null);

            $db->where('type','Upload Setting');
            $uploadSetting = $db->map('name')->get('system_settings',null,'name,value,reference');

            // Check Name Field
            if(empty($name)) {
                $errorFieldArr[] = array(
                    'id'  => "nameError",
                    'msg' => $translations['E00635'][$language] /* Please Enter Name. */
                );
            }

            // Check Code Field
            if(empty($code)) {
                $errorFieldArr[] = array(
                    'id'  => "codeError",
                    'msg' => $translations['E00928'][$language] /* Please Enter Code. */
                );
            } else if($type == 'add'){
                // check code avaibility
                $db->where('code', $code);
                $result = $db->has("mlm_product");

                if($result) {
                    $errorFieldArr[] = array(
                        'id'  => 'codeError',
                        'msg' => $translations["E00929"][$language] /* Code Existed. */
                    );
                }
            }

            // Check Category Field
            if(!$category) {
                $errorFieldArr[] = array(
                    'id'  => "categoryError",
                    'msg' => $translations['E00930'][$language] /* Please Enter Category. */
                );
            } else {
                $db->where('disabled', 0);
                $availableCategory = $db->getValue('inv_category', 'id', null);

                foreach ($category as $categoryData) {
                    if(!in_array($categoryData, $availableCategory)) {
                        $errorFieldArr[] = array(
                            'id'  => "categoryError",
                            'msg' => $translations['E01012'][$language]
                        );
                    }
                }
            }

            // Check Product Field
            if($createPackage == 1){
                /*if(!$productQuantity || !is_numeric($productQuantity) || $productQuantity < 0){
                    $errorFieldArr[] = array(
                        'id'  => "productQuantityError",
                        'msg' => $translations['E00999'][$language]
                    );
                }*/
            }else{
                if(!$product) {
                    $errorFieldArr[] = array(
                        'id'  => "productError",
                        'msg' => $translations['E00841'][$language] /* Please select product. */
                    );
                } else {
                    $db->where('status', 'Active');
                    $availableProduct = $db->getValue('inv_product', 'id', null);

                    foreach ($product as $key => $productData) {
                        $num = $key+1;

                        if(!in_array($productData['productID'], $availableProduct)) {
                            $errorFieldArr[] = array(
                                'id'  => "productError",
                                'msg' => str_replace("%%key%%", $num, $translations['E01059'][$language])
                            );
                        }

                        if(!$productData['quantity'] || !is_numeric($productData['quantity']) || $productData['quantity'] < 0){
                            $errorFieldArr[] = array(
                                'id'  => "quantityError",
                                'msg' => str_replace("%%key%%", $num, $translations['E01060'][$language])
                            );
                        }
                    }
                }
            }

            // Check Price Field
            //PV price && Price setting
            if($type == "edit"){
                if(!in_array($clientID, $availableAdminRes)){
                    if($isStarterKit == 1){
                        if($pvPrice){
                            if(!is_numeric($pvPrice) || $pvPrice < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "pvPriceError",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }
                        }
                    }else{
                        if(!$pvPrice || !is_numeric($pvPrice) || $pvPrice < 0){
                            $errorFieldArr[] = array(
                                'id'  => "pvPriceError",
                                'msg' => $translations['E00910'][$language] /* Invalid Price. */
                            );
                        }
                    }

                    if(!$priceSetting){
                        $errorFieldArr[] = array(
                            'id'  => "priceSettingError",
                            'msg' => $translations['E01087'][$language] /* Please fill in price setting. */
                        );
                    }else{
                        $db->where('delivery_country', '1');
                        $db->where('status', 'Active');
                        $availableCountry = $db->getValue('country', 'id', null);

                        foreach($priceSetting as $priceSettingID => $priceDetail){
                            $priceID = $priceSettingID+1;
                            // Check Country Field
                            if(!in_array($priceDetail['country'], $availableCountry)) {
                                $errorFieldArr[] = array(
                                    'id'  => "country".$priceID."Error",
                                    'msg' => $translations['E00568'][$language] /* Invalid Country. */
                                );
                            }

                            // Check retail price
                            if($priceDetail['retailPrice']){
                                if(!is_numeric($priceDetail['retailPrice']) || $priceDetail['retailPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "retailPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }

                            // check promo price
                            if($priceDetail['promoPrice']){
                                if(!is_numeric($priceDetail['promoPrice']) || $priceDetail['promoPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "promoPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }

                            if(($priceSetting['retailPrice'] || $priceSetting['promoPrice']) && !$isStarterKit){
                                // check member price
                                if(!$priceDetail['memberPrice'] || !is_numeric($priceDetail['memberPrice']) || $priceDetail['memberPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "memberPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }

                                // check member s price
                                if(!$priceDetail['memberUpPrice'] || !is_numeric($priceDetail['memberUpPrice']) || $priceDetail['memberUpPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "memberUpPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }
                        }
                    }
                }else{
                    if($isStarterKit == 1){
                        if($pvPrice){
                            if(!is_numeric($pvPrice) || $pvPrice < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "pvPriceError",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }
                        }
                    }else{
                        if(!$pvPrice || !is_numeric($pvPrice) || $pvPrice < 0){
                            $errorFieldArr[] = array(
                                'id'  => "pvPriceError",
                                'msg' => $translations['E00910'][$language] /* Invalid Price. */
                            );
                        }
                    }

                    if(!$priceSetting){
                        $errorFieldArr[] = array(
                            'id'  => "priceSettingError",
                            'msg' => $translations['E01087'][$language] /* Please fill in price setting. */
                        );
                    }else{
                        $db->where('delivery_country', '1');
                        $db->where('status', 'Active');
                        $availableCountry = $db->getValue('country', 'id', null);

                        foreach($priceSetting as $priceSettingID => $priceDetail){
                            $priceID = $priceSettingID+1;
                            // Check Country Field
                            if(!in_array($priceDetail['country'], $availableCountry)) {
                                $errorFieldArr[] = array(
                                    'id'  => "country".$priceID."Error",
                                    'msg' => $translations['E00568'][$language] /* Invalid Country. */
                                );
                            }

                            // Check retail price
                            if($priceDetail['retailPrice']){
                                if(!is_numeric($priceDetail['retailPrice']) || $priceDetail['retailPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "retailPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }

                            // check promo price
                            if($priceDetail['promoPrice']){
                                if(!is_numeric($priceDetail['promoPrice']) || $priceDetail['promoPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "promoPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }

                            if(($priceSetting['retailPrice'] || $priceSetting['promoPrice']) && !$isStarterKit){
                                // check member price
                                if(!$priceDetail['memberPrice'] || !is_numeric($priceDetail['memberPrice']) || $priceDetail['memberPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "memberPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }

                                // check member s price
                                if(!$priceDetail['memberUpPrice'] || !is_numeric($priceDetail['memberUpPrice']) || $priceDetail['memberUpPrice'] < 0){
                                    $errorFieldArr[] = array(
                                        'id'  => "memberUpPrice".$priceID."Error",
                                        'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                    );
                                }
                            }
                        }
                    }
                }
            }else{
                if($isStarterKit == 1){
                    if($pvPrice){
                        if(!is_numeric($pvPrice) || $pvPrice < 0){
                            $errorFieldArr[] = array(
                                'id'  => "pvPriceError",
                                'msg' => $translations['E00910'][$language] /* Invalid Price. */
                            );
                        }
                    }
                }else{
                    if(!$pvPrice || !is_numeric($pvPrice) || $pvPrice < 0){
                        $errorFieldArr[] = array(
                            'id'  => "pvPriceError",
                            'msg' => $translations['E00910'][$language] /* Invalid Price. */
                        );
                    }
                }

                if(!$priceSetting){
                    $errorFieldArr[] = array(
                        'id'  => "priceSettingError",
                        'msg' => $translations['E01087'][$language] /* Please fill in price setting. */
                    );
                }else{
                    $db->where('delivery_country', '1');
                    $db->where('status', 'Active');
                    $availableCountry = $db->getValue('country', 'id', null);

                    foreach($priceSetting as $priceSettingID => $priceDetail){
                        $priceID = $priceSettingID+1;
                        // Check Country Field
                        if(!in_array($priceDetail['country'], $availableCountry)) {
                            $errorFieldArr[] = array(
                                'id'  => "country".$priceID."Error",
                                'msg' => $translations['E00568'][$language] /* Invalid Country. */
                            );
                        }

                        // Check retail price
                        if($priceDetail['retailPrice']){
                            if(!is_numeric($priceDetail['retailPrice']) || $priceDetail['retailPrice'] < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "retailPrice".$priceID."Error",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }
                        }

                        // check promo price
                        if($priceDetail['promoPrice']){
                            if(!is_numeric($priceDetail['promoPrice']) || $priceDetail['promoPrice'] < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "promoPrice".$priceID."Error",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }
                        }

                        if(($priceSetting['retailPrice'] || $priceSetting['promoPrice']) && !$isStarterKit){
                            // check member price
                            if(!$priceDetail['memberPrice'] || !is_numeric($priceDetail['memberPrice']) || $priceDetail['memberPrice'] < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "memberPrice".$priceID."Error",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }

                            // check member s price
                            if(!$priceDetail['memberUpPrice'] || !is_numeric($priceDetail['memberUpPrice']) || $priceDetail['memberUpPrice'] < 0){
                                $errorFieldArr[] = array(
                                    'id'  => "memberUpPrice".$priceID."Error",
                                    'msg' => $translations['E00910'][$language] /* Invalid Price. */
                                );
                            }
                        }
                    }
                }
            }

            $countPriceSetting = count($priceSetting);
            if($countPriceSetting < 0){
                $errorFieldArr[] = array(
                                'id'  => "retailPriceError",
                                'msg' => $translations['E01092'][$language] /* Please insert at least 1 retail price. */
                            );
            }

            // Check Package Quantity
            if($type == "add"){
                if($packageQuantity){
                    if(!is_numeric($packageQuantity) || $packageQuantity < 0){
                        $errorFieldArr[] = array(
                            'id'  => "packageQuantityError",
                            'msg' => $translations['E00999'][$language] /* Invalid Quantity. */
                        );
                    }
                }
            }else if($type == "edit"){
                $db->where('id',$packageID);
                $isUnlimited = $db->getValue('mlm_product','is_unlimited');

                if($isUnlimited == "1"){
                    if($packageQuantity){
                        $errorFieldArr[] = array(
                            'id'  => "packageQuantityError",
                            'msg' => $translations['E01079'][$language] /* Quantity cannot be edit. */
                        );
                    }
                }else{
                    if(in_array($clientID, $availableAdminRes)){
                        if(!$packageQuantity || !is_numeric($packageQuantity) || $packageQuantity < 0){
                            $errorFieldArr[] = array(
                                'id'  => "packageQuantityError",
                                'msg' => $translations['E00999'][$language] /* Invalid Quantity. */
                            );
                        }
                    }else{
                        if($packageQuantity){
                            $errorFieldArr[] = array(
                                'id'  => "packageQuantityError",
                                'msg' => $translations['E01079'][$language] /* Quantity cannot be edit. */
                            );
                        }
                    }
                }
            }

            // Check Status Field
            if(empty($status) || !in_array($status, $statusAry)) {
                $errorFieldArr[] = array(
                    'id'  => "statusError",
                    'msg' => $translations['E00671'][$language] /* Please Select Status. */
                );
            }

            if(!is_numeric($weight) || !$weight || $weight <= 0){
                $errorFieldArr[] = array(
                    "id" => "weightError",
                    "msg" => $translations["E01010"][$language]
                );
            }

            /*// Check actived date
            if(!$activeDate || $activeDate < $todayDate) {
                $errorFieldArr[] = array(
                    'id'  => "activeDateError",
                    'msg' => $translations['E00156'][$language]
                );
            }*/

            $db->where('disabled', 0);
            $countLanguage = $db->getValue('languages', 'count(*)');

            // Check Name Language Field
            if(empty($nameLanguages)) {
                $errorFieldArr[] = array(
                    'id'  => "nameLanguagesError",
                    'msg' => $translations['E00635'][$language] /* Please Enter Name. */
                );
            }else{
                $nameLanguagesAry = count($nameLanguages);

                if($nameLanguagesAry > $countLanguage){
                    $errorFieldArr[] = array(
                        'id'  => "nameLanguagesError",
                        'msg' => str_replace("%%count%%", $countLanguage, $translations['E01077'][$language])
                    );
                }
            }

            // Check Name Language Field
            foreach($nameLanguages as $nameRow) {
                if(!$nameRow["languageType"]) {
                    $errorFieldArr[] = array(
                        'id'  => "nameLanguagesError",
                        'msg' => $translations['E00602'][$language] /* Please Select Language. */
                    );
                }

                if($nameRow["languageType"] == "english") {
                    if(empty($nameRow["content"])) {
                        $errorFieldArr[] = array(
                            'id'  => "nameLanguagesError",
                            'msg' => $translations['E00635'][$language] /* Please Enter Name. */
                        );
                    }
                }
            }

            // Check Description Language Field
            if(empty($descrLanguages)) {
                $errorFieldArr[] = array(
                    'id'  => "descrLanguagesError",
                    'msg' => $translations['E00662'][$language] /* Please Enter Description. */
                );
            }else{
                $descrLanguagesAry = count($descrLanguages);

                if($descrLanguagesAry > $countLanguage){
                    $errorFieldArr[] = array(
                        'id'  => "descrLanguagesError",
                        'msg' => str_replace("%%count%%", $countLanguage, $translations['01077'][$language])
                    );
                }
            }

            // check description language field
            foreach($descrLanguages as $descriptionRow) {
                if($descriptionRow["languageType"] == "english") {
                    if(empty($descriptionRow["content"])) {
                        $errorFieldArr[] = array(
                            'id'  => "descrLanguagesError",
                            'msg' => $translations['E00662'][$language] /* Please Enter Description. */
                        );
                    }
                }
            }

            foreach($uploadImage as $uploadImageRow) {
                $validImageSet  = $uploadSetting['validImageType'];
                $validImageType = explode("#", $validImageSet['value']);
                $validImageSize = $validImageSet['reference'];
                $sizeMB         = $validImageSize / 1024 / 1024;

                if(empty($uploadImageRow["imgName"]) || empty($uploadImageRow["imgType"])) {
                    $errorFieldArr[] = array(
                        'id'  => "imgError",
                        'msg' => $translations["E00925"][$language] /* No file chosen */
                    );
                }

                if(empty($uploadImageRow['uploadType']) || !in_array($uploadImageRow['uploadType'], array('image'))) {
                    $errorFieldArr[] = array(
                        'id'  => "uploadTypeError",
                        'msg' => $translations["E00741"][$language] /* Invalid Type */
                    );
                }

                if($type != 'add') {
                    if($uploadImageRow["imgFlag"]) {
                        if(!in_array($uploadImageRow["imgType"], $validImageType)) {
                            $errorFieldArr[] = array(
                                'id'  => "imgTypeError",
                                'msg' => $translations["E00899"][$language] /* Uploaded file is not a valid image or video. */
                            );
                        }

                        if(!$uploadImageRow['imgSize'] || $uploadImageRow['imgSize'] > $validImageSize){
                            $errorFieldArr[] = array(
                                'id'  => "imgTypeError",
                                'msg' => str_replace("%%maxSize%%", $sizeMB, $translations["E00976"][$language]) /* File size too big. (Only allow max 3MB) */
                            );
                        }
                    }
                } else {
                    if(!in_array($uploadImageRow["imgType"], $validImageType)) {
                        $errorFieldArr[] = array(
                            'id'  => "imgTypeError",
                            'msg' => $translations["E00899"][$language] /* Uploaded file is not a valid image or video. */
                        );
                    }

                    if(!$uploadImageRow['imgSize'] || $uploadImageRow['imgSize'] > $validImageSize){
                        $errorFieldArr[] = array(
                            'id'  => "imgTypeError",
                            'msg' => str_replace("%%maxSize%%", $sizeMB, $translations["E00976"][$language]) /* File size too big. (Only allow max 3MB) */
                        );
                    }
                }
            }

            foreach($uploadVideo as $uploadVideoRow) {
                if(!$uploadVideoRow['videoName']) continue;

                $validVideoSet = $uploadSetting['validVideoType'];
                $validVideoType = explode("#", $validVideoSet['value']);
                $validVideoSize = $validVideoSet['reference'];
                $sizeMB         = $validVideoSize / 1024 / 1024;

                if(empty($uploadVideoRow["videoName"]) || empty($uploadVideoRow["videoType"])) {
                    $errorFieldArr[] = array(
                        'id'  => "videoError",
                        'msg' => $translations["E00925"][$language] /* No file chosen */
                    );
                }

                if(empty($uploadVideoRow['uploadType']) || !in_array($uploadVideoRow['uploadType'], array('video'))) {
                    $errorFieldArr[] = array(
                        'id'  => "uploadTypeError",
                        'msg' => $translations["E00741"][$language] /* Invalid Type */
                    );
                }

                if($type != 'add') {
                    if($uploadVideoRow["videoFlag"]) {
                        if(!in_array($uploadVideoRow["videoType"], $validVideoType)) {
                            $errorFieldArr[] = array(
                                'id'  => "videoError",
                                'msg' => $translations["E00972"][$language] /* Uploaded file is not a valid video. */
                            );
                        }

                        if(!$uploadVideoRow['videoSize'] || $uploadVideoRow['videoSize'] > $validVideoSize){
                            $errorFieldArr[] = array(
                                'id'  => "videoError",
                                'msg' => str_replace("%%maxSize%%", $sizeMB, $translations["E00976"][$language]) /* File size too big. (Only allow max 15MB) */
                            );
                        }
                    }
                } else {
                    if(!in_array($uploadVideoRow["videoType"], $validVideoType)) {
                        $errorFieldArr[] = array(
                            'id'  => "videoError",
                            'msg' => $translations["E00972"][$language] /* Uploaded file is not a valid video. */
                        );
                    }

                    if(!$uploadVideoRow['videoSize'] || $uploadVideoRow['videoSize'] > $validVideoSize){
                        $errorFieldArr[] = array(
                            'id'  => "videoError",
                            'msg' => str_replace("%%maxSize%%", $sizeMB, $translations["E00976"][$language]) /* File size too big. (Only allow max 15MB) */
                        );
                    }
                }
            }

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> '', 'data'=>"");
        }

        public function addPackageDetail($params, $starterKit) {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $imageGroupUniqueChar   = self::generateUniqueChar();
            $dateTime               = date("Y-m-d H:i:s");

            $name            = trim($params['name']);
            $code            = trim($params['code']);
            $packageQuantity = trim($params['packageQuantity']);
            $product         = $params['product'];
            $category        = $params['category'];
            $priceSetting    = $params['priceSetting'];
            $pvPrice         = $params['pvPrice'];
            $activeDate      = $params['activeDate'];
            $nameLanguages   = $params['nameLanguages'];
            $descrLanguages  = $params['descrLanguages'];
            $uploadImage     = $params['uploadImage'];
            $uploadVideo     = $params['uploadVideo'];
            $status          = trim($params['status']);
            $statusAry       = array('Active', 'Inactive');
            $todayDate       = strtotime(date("Y-m-d"));

            $createPackage   = $params['createPackage'];
            $productInvID    = $params['productInvID'];
            $productQuantity = $params['productQuantity'];

            $catalogue       = $params['catalogue'];
            $bBasic          = $params['bBasic'];
            $weight          = trim($params["weight"]);

            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["A01078"][$language] /* Access denied. */,'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if($starterKit){
                $params['isStarterKit'] = $starterKit;
            }
            $verify = self::verifyPackageDetail($params, 'add');
            if($verify["status"] != "ok") return $verify;

            $isUnlimited = 1;
            if($packageQuantity > 0){
                $isUnlimited = 0;
            }

            // Insert mlm_product
            $insertPackage = array(
                "code"          => $code,
                "name"          => $name,
                "weight"        => $weight,
                "pv_price"      => $pvPrice,
                "total_balance" => $packageQuantity,
                "is_starter_kit"=> $starterKit ? 1 : 0,
                "is_unlimited"  => $isUnlimited,
                "status"        => $status,
                "active_at"     => $dateTime,
                "created_at"    => $dateTime,
                "updated_at"    => $dateTime
            );

            $packageID = $db->insert('mlm_product', $insertPackage);

            if (!$packageID) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00932"][$language] /* Failed to add product. */,'data'=>'');
            }

            // insert mlm_product_setting
            foreach ($category as $categoryRow) {
                $insertPackageCategory = array(
                    "product_id" => $packageID,
                    "name"  => "packageCategory",
                    "value" => $categoryRow,
                    "type"  => "packageCategory"
                );
                $db->insert('mlm_product_setting', $insertPackageCategory);
            }
            // temporary close catalogue - 20220114

            // if($catalogue){
            //     unset($insertData);
            //     $insertData = array(
            //         "product_id" => $packageID,
            //         "name"  => "catalogue",
            //         "value" => 1,
            //         "type"  => "catalogue"
            //     );
            //     $db->insert('mlm_product_setting', $insertData);
            // }

            if($bBasic){
                unset($insertData);
                $insertData = array(
                    "product_id" => $packageID,
                    "name"  => "bBasic",
                    "value" => 1,
                    "type"  => "bBasic"
                );
                $db->insert('mlm_product_setting', $insertData);
            }

            // Price checking
            foreach($priceSetting as $price){
                if($price['retailPrice'] <= 0){
                    continue;
                }
                if(!$price['promoPrice']){
                    $price['promoPrice'] = 0;
                }

                // insert mlm_product_price
                $insertPrice = array(
                    "product_id"    =>  $packageID,
                    "country_id"    =>  $price['country'],
                    "price"         =>  $price['retailPrice'],
                    "promo_price"   =>  $price['promoPrice'],
                    "m_price"       =>  $price['memberPrice'],
                    "ms_price"      =>  $price['memberUpPrice'],
                    "disabled"      =>  0,
                    "updated_at"    =>  $dateTime,
                );
                $db->insert('mlm_product_price', $insertPrice);

               $priceAry[] = $price['country'];
            }

            $db->where('id', $userID);
            $adminName = $db->getValue('admin', 'name');
            $db->where('id', $priceAry, 'IN');
            $countryNameList = $db->get('country', null, 'translation_code');
            foreach($countryNameList as $translationCodeForCountry){
                $nameOfCountry[] = $translations[$translationCodeForCountry['translation_code']][$language];
            }
            $logInvData = array_merge(array('admin' => $adminName,'country' => $nameOfCountry, 'package' => $name));

            // insert inv_log
            $invLog = array(
                "module"                    =>  "mlm_product_price",
                "module_id"                 =>  $packageID,
                "title_transaction_code"    =>  "T00059",
                "title"                     =>  "Add product price",
                "transaction_code"          =>  "L00085",
                "data"                      =>  json_encode($logInvData),
                "creator_type"              =>  $site,
                "creator_id"                =>  $userID,
                "created_at"                =>  $dateTime
            );
            $db->insert("inv_log", $invLog);

            // insert inv_product_detail
            if($createPackage == 1){
                $insertValidPackage = array(
                    "inv_product_id"    => $productInvID,
                    "name"              => "validPackage",
                    "value"             => $packageID,
                    "type"              => "validPackage",
                    "reference"         => 1,
                );
                $db->insert('inv_product_detail', $insertValidPackage);
            }else{
                foreach ($product as $productRow) {
                    $insertValidPackage = array(
                        "inv_product_id"    => $productRow['productID'],
                        "name"              => "validPackage",
                        "value"             => $packageID,
                        "type"              => "validPackage",
                        "reference"         => $productRow['quantity'],
                    );
                    $db->insert('inv_product_detail', $insertValidPackage);
                }
            }


            // Get System Languages
            $db->where("disabled", 0);
            $languages = $db->map("language_code")->get("languages", NULL, "language_code, language");

            // Insert language_translation
            foreach($nameLanguages as $nameRow) {
                $defaultName = $name;
                $nameLanguagesList[$nameRow['languageType']] = $nameRow;
            }

            foreach($languages as $languagesRow) {
                if($nameLanguagesList[$languagesRow]['languageType'] == $languagesRow) {
                    unset($insertPackageNameTrans);
                    $insertPackageNameTrans = array(
                        "module" => "mlm_product",
                        "module_id" => $packageID,
                        "type" => "name",
                        "language" => $languagesRow,
                        "content" => $nameLanguagesList[$languagesRow]['content'],
                        "updated_at" => $dateTime,
                    );
                    $insertPackageNameTransList['name'][] = $insertPackageNameTrans;
                    $db->insert('inv_language',$insertPackageNameTrans);
                } /*else {
                    $insertPackageNameTrans = array(
                        "module" => "mlm_product",
                        "module_id" => $packageID,
                        "type" => "name",
                        "language" => $languagesRow,
                        "content" => $defaultName,
                        "updated_at" => $dateTime,
                    );
                }*/
                // $insertPackageNameTransList['name'][] = $insertPackageNameTrans;
                // $db->insert('inv_language',$insertPackageNameTrans);
            }

            foreach($descrLanguages as $descriptionRow) {
                if($descriptionRow['content'] && !$defaultDescription) $defaultDescription = $descriptionRow['content'];
                $descLanguagesList[$descriptionRow['languageType']] = $descriptionRow;
            }

            foreach($languages as $languagesRow) {
                if($descLanguagesList[$languagesRow]['languageType'] == $languagesRow) {
                    unset($insertProductDescrTrans);
                    $insertProductDescrTrans = array(
                        "module" => "mlm_product",
                        "module_id" => $packageID,
                        "type" => "desc",
                        "language" => $languagesRow,
                        "content" => $descLanguagesList[$languagesRow]['content'],
                        "updated_at" => $dateTime,
                    );
                    $insertProductDescrTranList['desc'][] = $insertProductDescrTrans;
                    $db->insert('inv_language',$insertProductDescrTrans);
                } /*else {
                    $insertProductDescrTrans = array(
                        "module" => "mlm_product",
                        "module_id" => $packageID,
                        "type" => "desc",
                        "language" => $languagesRow,
                        "content" => $defaultDescription,
                        "updated_at" => $dateTime,
                    );
                }*/
                // $insertProductDescrTranList['desc'][] = $insertProductDescrTrans;
                // $db->insert('inv_language',$insertProductDescrTrans);
            }

            foreach($uploadImage as $key => $uploadImageRow) {
                $imageUniqueChar = self::generateUniqueChar();
                $imageAry = explode(".",$uploadImageRow['imgName']);
                $imageExt = end($imageAry);
                $storedImage[] = time()."_".$imageUniqueChar."_".$imageGroupUniqueChar.".".$imageExt;
            }

            foreach($storedImage as $storedImageRow) {

                // insert mlm_product_setting
                $insertInvDetails = array(
                    "product_id" => $packageID,
                    "name" => "Image",
                    "value" => $storedImageRow,
                    "type" => "Image",
                );

                $insertInvDetailsRes = $db->insert('mlm_product_setting', $insertInvDetails);
                $insertInvImage[] = $insertInvDetails['value'];
            }

            foreach($uploadVideo as $key => $uploadVideoRow) {
                if(!$uploadVideoRow['videoName']) continue;
                $videoUniqueChar = self::generateUniqueChar();
                $videoAry = explode(".",$uploadVideoRow['videoName']);
                $videoExt = end($videoAry);
                $storedVideo[] = time()."_".$videoUniqueChar."_".$imageGroupUniqueChar.".".$videoExt;
            }

            foreach($storedVideo as $storedVideoRow) {

                // insert mlm_product_setting
                $insertInvDetails = array(
                    "product_id" => $packageID,
                    "name" => "Video",
                    "value" => $storedVideoRow,
                    "type" => "Video",
                );

                $insertInvDetailsRes = $db->insert('mlm_product_setting', $insertInvDetails);
                $insertInvVideo[] = $insertInvDetails['value'];
            }

            // Update system setting for process get product
            $db->where('name', 'processGetProduct');
            $db->update('system_settings', array('value' => 0));

            if($insertInvImage && $insertInvVideo){
                $data["imgName"]    = $insertInvImage;
                $data["videoName"]  = $insertInvVideo;
            }elseif($insertInvImage){
                $data["imgName"]    = $insertInvImage;
            }elseif($insertInvVideo){
                $data["imgName"]    = $insertInvVideo;
            }

            $data["doRegion"]     = Setting::$configArray["doRegion"];
            $data["doEndpoint"]   = Setting::$configArray["doEndpoint"];
            $data["doAccessKey"]  = Setting::$configArray["doApiKey"];
            $data["doSecretKey"]  = Setting::$configArray["doSecretKey"];
            $data["doBucketName"] = Setting::$configArray["doBucketName"]."inv";
            $data["doProjectName"]= Setting::$configArray["doProjectName"];
            $data["doFolderName"] = Setting::$configArray["doFolderName"]."inv";

            if(empty($insertPackage)) $insertPackage = array();
            if(empty($insertInvDetails)) $insertInvDetails = array();
            if(empty($insertPackageCategory)) $insertPackageCategory = array();
            if(empty($insertValidCountry)) $insertValidCountry = array();
            if(empty($insertValidPackage)) $insertValidPackage = array();
            if(empty($insertProductNameTransList)) $insertProductNameTransList = array();
            if(empty($insertProductDescrTranList)) $insertProductDescrTranList = array();
            if(empty($invLog)) $invLog = array();
            if(empty($insertPrice)) $insertPrice = array();
            $activityData = array_merge(array('admin' => $checkAdmin, 'catalogue' => $catalogue, 'bBasic' => $bBasic), $insertPackage, $insertInvDetails, $insertPackageCategory, $insertValidCountry, $insertValidPackage, $insertProductNameTransList, $insertProductDescrTranList, $invLog, $insertPrice);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Add Package', 'T00056', 'L00076', $activityData, $userID, $userID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            if($insertInvImage && $insertInvVideo) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
            } else if($insertInvImage) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
            } else if($insertInvVideo) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
            } else {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
            }
        }

        public function editPackageDetail($params, $starterKit) {
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $dateTime        = date("Y-m-d H:i:s");

            $packageID       = trim($params['packageID']);
            $name            = trim($params['name']);
            $code            = trim($params['code']);
            $product         = $params['product'];
            $category        = $params['category'];
            $priceSetting    = $params['priceSetting'];
            $pvPrice         = $params['pvPrice'];
            $activeDate      = $params['activeDate'];
            $nameLanguages   = $params['nameLanguages'];
            $descrLanguages  = $params['descrLanguages'];
            $uploadImage     = $params['uploadImage'];
            $uploadVideo     = $params['uploadVideo'];
            $status          = trim($params['status']);
            $statusAry       = array('Active', 'Inactive');
            $todayDate       = strtotime(date("Y-m-d"));
            $adminRoleList   = Setting::$systemSetting['InvEditableRoles'];
            $adminRoleListAry = explode("#", $adminRoleList);

            $createPackage   = $params['createPackage'];
            $productInvID    = $params['productInvID'];
            $productQuantity = $params['productQuantity'];

            $catalogue       = $params['catalogue'];
            $bBasic          = $params['bBasic'];
            $weight          = trim($params["weight"]);

            $imageGroupUniqueChar = self::generateUniqueChar();

            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["A01078"][$language] /* Access denied. */,'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid admin */,'data'=>'');
                }
            }

            if($starterKit){
                $params['isStarterKit'] = $starterKit;
            }
            $verify = self::verifyPackageDetail($params, "edit");
            if($verify["status"] != "ok") return $verify;

            if(!$packageID) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E00933"][$language] /* Product not found */, 'data' => '');
            }

            $db->where("id", $packageID);
            $packageRecord = $db->getValue("mlm_product", "id");

            if(!$packageRecord) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E00933"][$language] /* Product not found */, 'data' => '');
            }

            $db->where('role_id',$adminRoleListAry, 'IN');
            $availableAdminRes = $db->getValue('admin','id',null);

            // Edit mlm_product
            if(in_array($userID, $availableAdminRes)){
                $editPackage = array(
                    "code"          => $code,
                    "name"          => $name,
                    "weight"        => $weight,
                    "pv_price"      => $pvPrice,
                    "total_balance" => $productQuantity,
                    "status"        => $status,
                    "active_at"     => $dateTime,
                    "updated_at"    => $dateTime
                );
            }else{
                $editPackage = array(
                    "code"          => $code,
                    "name"          => $name,
                    "weight"        => $weight,
                    "pv_price"      => $pvPrice,
                    "status"        => $status,
                    "active_at"     => $dateTime,
                    "updated_at"    => $dateTime
                );
            }
            $db->where("id", $packageID);
            $editPackageRes = $db->update("mlm_product", $editPackage);

            if (!$editPackageRes) {
                return array('status' => 'error', 'code' => 2,'statusMsg' => $translations["E00934"][$language] /* Failed to update product. */, 'data' => '');
            }

            // Get Original Product Category
            $db->where("product_id", $packageID);
            $db->where("type", "packageCategory");
            $oriCategory = $db->map("value")->get("mlm_product_setting", null, "value");

            // Update mlm_product_setting
            foreach ($category as $categoryRow) {
                $categoryAry[$categoryRow] = $categoryRow;
            }

            foreach ($oriCategory as $oriCategoryKey => $oriCategoryValue) {
                $newCategory = $categoryAry[$oriCategoryKey];

                if($oriCategoryValue != $newCategory){
                    $editDetail = array(
                        "type" => "invalidCategory",
                    );
                    $db->where("product_id", $packageID);
                    $db->where("value", $oriCategoryValue);
                    $db->where("type", "packageCategory");
                    $db->update("mlm_product_setting", $editDetail);
                }

                unset($categoryAry[$oriCategoryKey]);

                $newCategoryAry = $categoryAry;
            }

            foreach ($newCategoryAry as $newCategoryRow) {
                $insertNewCategory = array(
                    "product_id" => $packageID,
                    "name"  => "packageCategory",
                    "value" => $newCategoryRow,
                    "type"  => "packageCategory"
                );
                $db->insert('mlm_product_setting', $insertNewCategory);
            }

            // temporary close catalogue - 20220114

            // $db->where("product_id", $packageID);
            // $db->where("name", "catalogue");
            // $catalogueID = $db->getValue("mlm_product_setting", "id");
            // if($catalogueID){
            //     $db->where("id", $catalogueID);
            //     $db->update("mlm_product_setting", array('value' => $catalogue));
            // }else{
            //     if($catalogue){
            //         unset($insertData);
            //         $insertData = array(
            //             "product_id" => $packageID,
            //             "name"  => "catalogue",
            //             "value" => 1,
            //             "type"  => "catalogue",
            //         );
            //         $db->insert('mlm_product_setting', $insertData);
            //     }
            // }


            $db->where("product_id", $packageID);
            $db->where("name", "bBasic");
            $bBasicID = $db->getValue("mlm_product_setting", "id");
            if($bBasicID){
                $db->where("id", $bBasicID);
                $db->update("mlm_product_setting", array('value' => $bBasic));
            }else{
                if($bBasic){
                    unset($insertData);
                    $insertData = array(
                        "product_id" => $packageID,
                        "name"  => "bBasic",
                        "value" => 1,
                        "type"  => "bBasic"
                    );
                    $db->insert('mlm_product_setting', $insertData);
                }
            }

            // Country checking
            // if(in_array($userID, $availableAdminRes)){
                foreach($priceSetting as $countryAvailable){
                    $countryList['retailPrice'] = $countryAvailable['retailPrice'];
                    $countryList['promoPrice'] = $countryAvailable['promoPrice'];
                    $countryList['memberPrice'] = $countryAvailable['memberPrice'];
                    $countryList['memberUpPrice'] = $countryAvailable['memberUpPrice'];

                    $enabledCountry[$countryAvailable['country']] = $countryList;
                }

                $db->where('disabled', '0');
                $db->where('product_id', $packageID);
                $priceChecking = $db->map('country_id')->get('mlm_product_price', null, 'country_id, price, promo_price, m_price, ms_price');


                foreach($priceChecking as $priceCheckingKey => $priceCheckingValue){
                    $newCountryRetail   = $enabledCountry[$priceCheckingKey]['retailPrice'];
                    $newCountryPromo    = $enabledCountry[$priceCheckingKey]['promoPrice'];
                    $newCountryMember   = $enabledCountry[$priceCheckingKey]['memberPrice'];
                    $newCountryMemberUp = $enabledCountry[$priceCheckingKey]['memberUpPrice'];
                    $oriCountryRetail   = $priceCheckingValue['price'];
                    $oriCountryPromo    = $priceCheckingValue['promo_price'];
                    $oriCountryMember   = $priceCheckingValue['m_price'];
                    $oriCountryMemberUp = $priceCheckingValue['ms_price'];

                    if(empty($enabledCountry[$priceCheckingKey])){
                        continue;
                    }

                    if($newCountryRetail != $oriCountryRetail || $newCountryPromo != $oriCountryPromo || $newCountryMember != $oriCountryMember || $newCountryMemberUp != $oriCountryMemberUp){
                        $updatePrice = array(
                            "price"         =>  $newCountryRetail,
                            "promo_price"   =>  $newCountryPromo,
                            "m_price"       =>  $newCountryMember,
                            "ms_price"      =>  $newCountryMemberUp,
                            "updated_at"    =>  $dateTime
                        );
                        $db->where('country_id', $priceCheckingKey);
                        $db->where('product_id',$packageID);
                        $db->update('mlm_product_price', $updatePrice);
                    }
                    unset($enabledCountry[$priceCheckingKey]);
                    unset($priceChecking[$priceCheckingKey]);
                    $disabledCountry = $priceChecking;
                    $newEnabledCountry = $enabledCountry;
                    $priceAry[] = $priceCheckingKey;
                }

                foreach($disabledCountry as $key => $value){
                    $updatePrice = array(
                        "disabled" => 1,
                    );
                    $db->where('country_id', $key);
                    $db->update('mlm_product_price', $updatePrice);
                }

                foreach($newEnabledCountry as $newEnabledCountryKey => $newEnabledCountryValue){
                    $insertPrice = array(
                        "product_id"    =>  $packageID,
                        "country_id"    =>  $newEnabledCountryKey,
                        "price"         =>  $newEnabledCountryValue['retailPrice'],
                        "promo_price"   =>  $newEnabledCountryValue['promoPrice'],
                        "m_price"       =>  $newEnabledCountryValue['memberPrice'],
                        "ms_price"      =>  $newEnabledCountryValue['memberUpPrice'],
                        "disabled"      =>  0,
                        "updated_at"    =>  $dateTime,
                    );
                    $db->insert('mlm_product_price', $insertPrice);
                }

                if($priceAry){
                    $db->where('id', $priceAry, 'IN');
                    $countryNameList = $db->get('country', null, 'translation_code');
                    foreach($countryNameList as $translationCodeForCountry){
                        $nameOfCountry[] = $translations[$translationCodeForCountry['translation_code']][$language] ? : "-";
                    }
                }

                $logInvData = array_merge(array('admin' => $checkAdmin, 'country' => $nameOfCountry, 'package' => $name, 'pvPrice' => $pvPrice, 'productQuantity' => $productQuantity));

                // insert inv_log
                $invLog = array(
                    "module"                    =>  "mlm_product, mlm_product_price",
                    "module_id"                 =>  $packageID,
                    "title_transaction_code"    =>  "T00057",
                    "title"                     =>  "Edit Package",
                    "transaction_code"          =>  "L00089",
                    "data"                      =>  json_encode($logInvData),
                    "creator_type"              =>  $site,
                    "creator_id"                =>  $userID,
                    "created_at"                =>  $dateTime
                );
                $db->insert("inv_log", $invLog);
            // }

            // Get Original Product
            $db->where("value", $packageID);
            $db->where("type", "validPackage");
            $oriProductList = $db->map("inv_product_id")->get("inv_product_detail", null, "inv_product_id, value, reference");

            // Update inv_product_detail
            foreach ($product as $productRow) {
                $invProduct['productID'] = $productRow['productID'];
                $invProduct['quantity'] = $productRow['quantity'];

                $productAry[$productRow['productID']] = $invProduct;
            }

            foreach ($oriProductList as $oriProductKey => $oriProductValue) {
                $newProductID   = $productAry[$oriProductKey]['productID'];
                $newQuantity    = $productAry[$oriProductKey]['quantity'];
                $oriProductID   = $oriProductValue['inv_product_id'];
                $oriQuantity    = $oriProductValue['reference'];

                if($oriProductID != $newProductID){
                    $updateDetail = array(
                        "type" => "invalidPackage",
                    );
                    $db->where("inv_product_id", $oriProductID);
                    $db->where("value", $packageID);
                    $db->where("type", "validPackage");
                    $db->update("inv_product_detail", $updateDetail);
                }

                if($oriProductID == $newProductID && $oriQuantity != $newQuantity){
                    $editDetail = array(
                        "reference" => $newQuantity,
                    );
                    $db->where("inv_product_id", $oriProductID);
                    $db->where("value", $packageID);
                    $db->where("type", "validPackage");
                    $db->update("inv_product_detail", $editDetail);
                }

                unset($productAry[$oriProductKey]);

                $newProductAry = $productAry;
            }

            foreach ($newProductAry as $newProductRow) {
                $insertNewProduct = array(
                    "inv_product_id" => $newProductRow["productID"],
                    "name"  => "validPackage",
                    "value" => $packageID,
                    "type"  => "validPackage",
                    "reference" => $newProductRow["quantity"],
                );
                $db->insert('inv_product_detail', $insertNewProduct);
            }

            $editMediaCount = 0;

            foreach ($uploadImage as $uploadFileName) {
                $checkFileAry[$uploadFileName['imgName']] = $uploadFileName;
                $editMediaCount++;
            }

            $db->where('product_id', $packageID);
            $db->where("type", array('Image'), 'IN');
            $trashMediaNameAry = $db->get('mlm_product_setting', null, 'id, value');
            foreach ($trashMediaNameAry as $trashMediaRow) {
                if(!$checkFileAry[$trashMediaRow['value']]) {
                    // Insert media trash
                    $insertTrash = array(
                        'file_name' => $trashMediaRow["value"],
                        'created_at'=> $dateTime,
                        'deleted'   => '0'
                    );
                    $db->insert('media_trash', $insertTrash);

                    $oldImages['oldImages'][] = $insertTrash;

                    $db->where("id", $trashMediaRow["id"]);
                    $db->update("mlm_product_setting", array("type" => "Inactive Image"));
                } else {
                    unset($checkFileAry[$trashMediaRow["value"]]);
                }
            }

            if($checkFileAry) {
                foreach ($checkFileAry as $checkFileName) {
                    if($checkFileName['imgFlag'] == 0) {
                        unset($checkFileAry[$checkFileName["imgName"]]);
                    } else {
                        // Insert inv_product_detail
                        $imageUniqueChar = self::generateUniqueChar();
                        $imageAry = explode(".", $checkFileName['imgName']);
                        $imageExt = end($imageAry);
                        $newImage = time()."_".$imageUniqueChar."_".$imageGroupUniqueChar.".".$imageExt;

                        $newImageDetails = array(
                            "product_id" => $packageID,
                            "name" => "Image",
                            "value" => $newImage,
                            "type" => "Image"
                        );

                        $db->insert('mlm_product_setting', $newImageDetails);

                        $newImages[] = $newImageDetails["value"];
                    }
                }
            }

            unset($editMediaCount);
            unset($checkFileAry);
            $editMediaCount = 0;

            foreach ($uploadVideo as $uploadFileName) {
                if(!$uploadFileName['videoName']) continue;
                $checkFileAry[$uploadFileName['videoName']] = $uploadFileName;
                $editMediaCount++;
            }

            $db->where('product_id', $packageID);
            $db->where("type", array('Video'), 'IN');
            $trashMediaNameAry = $db->get('mlm_product_setting', null, 'id, value');

            foreach ($trashMediaNameAry as $trashMediaRow) {
                if(!$checkFileAry[$trashMediaRow['value']]) {
                    // Insert media trash
                    $insertTrash = array(
                        'file_name' => $trashMediaRow["value"],
                        'created_at'=> $dateTime,
                        'deleted'   => '0'
                    );
                    $db->insert('media_trash', $insertTrash);

                    $oldImages['oldImages'][] = $insertTrash;

                    $db->where("id", $trashMediaRow["id"]);
                    $db->update("mlm_product_setting", array("type" => "Inactive Video"));
                } else {
                    unset($checkFileAry[$trashMediaRow["value"]]);
                }
            }

            if($checkFileAry) {
                foreach ($checkFileAry as $checkFileName) {
                    if($checkFileName['videoFlag'] == 0) {
                        unset($checkFileAry[$checkFileName["videoName"]]);
                    } else {
                        // Insert inv_product_detail
                        $videoUniqueChar = self::generateUniqueChar();
                        $videoAry = explode(".", $checkFileName['videoName']);
                        $videoExt = end($videoAry);
                        $newVideo = time()."_".$videoUniqueChar."_".$imageGroupUniqueChar.".".$videoExt;

                        $newVideoDetails = array(
                            "product_id" => $packageID,
                            "name" => "Video",
                            "value" => $newVideo,
                            "type" => "Video"
                        );

                        $db->insert('mlm_product_setting', $newVideoDetails);

                        $newVideos[] = $newVideoDetails["value"];
                    }
                }
            }

            // Get System Languages
            $db->where("disabled", 0);
            $languages = $db->map("language_code")->get("languages", NULL, "language_code, language");

            $db->where("module_id", $packageRecord);
            $db->where("module", "mlm_product");
            $db->where("type", "name");
            $translationList = $db->get("inv_language", NULL, "id, language, content");

            // Update language_translation
            foreach ($nameLanguages as $nameRow) {
                $defaultName = $name;
                $nameLanguagesList[$nameRow['languageType']] = $nameRow;
            }

            foreach($translationList as $translationRow){
                $existingLangAry[] = $translationRow['language'];
            }

            foreach($languages as $languagesRow){
                if($nameLanguagesList[$languagesRow]['languageType'] == $languagesRow){
                    if(in_array($nameLanguagesList[$languagesRow]['languageType'], $existingLangAry)){
                        unset($updateTranslation);
                        $updateTranslation = array(
                            "content" => $nameLanguagesList[$languagesRow]['content'],
                            "updated_at" => $dateTime
                        );

                        $db->where("module_id", $packageRecord);
                        $db->where("module", "mlm_product");
                        $db->where("type", "name");
                        $db->where("language", $languagesRow);
                        $db->update("inv_language", $updateTranslation);

                        $updateTranslationList['updateList'][] = $updateTranslation;
                    } else{
                        unset($insertPackageNameTrans);
                        $insertPackageNameTrans = array(
                            "module" => "mlm_product",
                            "module_id" => $packageRecord,
                            "type" => "name",
                            "language" => $languagesRow,
                            "content" => $nameLanguagesList[$languagesRow]['content'],
                            "updated_at" => $dateTime,
                        );
                        $insertPackageNameTransList['name'][] = $insertPackageNameTrans;
                        $db->insert('inv_language',$insertPackageNameTrans);
                    }
                }
            }

            $db->where("module_id", $packageRecord);
            $db->where("module", "mlm_product");
            $db->where("type", "desc");
            $descrTranslationList = $db->get("inv_language", NULL, "id, language, content");
            // Update language_translation
            foreach ($descrLanguages as $descrLanguagesRow) {
                if($descrLanguagesRow['content'] && !$defaultDescrName) $defaultDescrName = $descrLanguagesRow['content'];
                $descrLanguagesList[$descrLanguagesRow['languageType']] = $descrLanguagesRow;
            }

            foreach($descrTranslationList as $descrTranslationRow){
                $existingDescrLangAry[] = $descrTranslationRow['language'];
            }

            foreach($languages as $languagesRow){
                if($descrLanguagesList[$languagesRow]['languageType'] == $languagesRow){
                    if(in_array($descrLanguagesList[$languagesRow]['languageType'], $existingDescrLangAry)){
                        $updateDescrTranslation = array(
                            "content" => $descrLanguagesList[$languagesRow]['content'],
                            "updated_at" => $dateTime
                        );
                        $db->where("module_id", $packageRecord);
                        $db->where("module", "mlm_product");
                        $db->where("type", "desc");
                        $db->where("language", $languagesRow);
                        $db->update("inv_language", $updateDescrTranslation);

                        $updateDescrTranslationList['updateDescList'][] = $updateDescrTranslation;
                    }else{
                        unset($insertProductDescrTrans);
                        $insertProductDescrTrans = array(
                            "module" => "mlm_product",
                            "module_id" => $packageRecord,
                            "type" => "desc",
                            "language" => $languagesRow,
                            "content" => $descrLanguagesList[$languagesRow]['content'],
                            "updated_at" => $dateTime,
                        );
                        $insertProductDescrTranList['desc'][] = $insertProductDescrTrans;
                        $db->insert('inv_language',$insertProductDescrTrans);
                    }
                }
            }

            // Update system setting for process get product
            $db->where('name', 'processGetProduct');
            $db->update('system_settings', array('value' => 0));

            if($newImages && $newVideos){
                $data["imgName"]    = $newImages;
                $data["videoName"]  = $newVideos;
            }elseif($newImages){
                $data["imgName"]    = $newImages;
            }elseif($newVideos){
                $data["videoName"]  = $newVideos;
            }

            $data["doRegion"]     = Setting::$configArray["doRegion"];
            $data["doEndpoint"]   = Setting::$configArray["doEndpoint"];
            $data["doAccessKey"]  = Setting::$configArray["doApiKey"];
            $data["doSecretKey"]  = Setting::$configArray["doSecretKey"];
            $data["doBucketName"] = Setting::$configArray["doBucketName"]."inv";
            $data["doProjectName"]= Setting::$configArray["doProjectName"];
            $data["doFolderName"] = Setting::$configArray["doFolderName"]."inv";

            if(empty($insertPackageNameTransList)) $insertPackageNameTransList = array();
            if(empty($insertProductDescrTranList)) $insertProductDescrTranList = array();

            if($oldImages && $newImages) {
                $activityData = array_merge(array('admin' => $checkAdmin), $editPackage, $editCategory, $editCountry, $editValidPackage, $oldImages, $newImages, $updateTranslationList, $updateDescrTranslationList, $insertProductDescrTranList, $insertProductDescrTranList, $disabledPrice, $updatePrice, $invLog);
            } else {
                $activityData = array_merge(array('admin' => $checkAdmin), $editPackage, $editCategory, $editCountry, $editValidPackage, $updateTranslationList, $updateDescrTranslationList, $insertProductDescrTranList, $insertProductDescrTranList, $disabledPrice, $updatePrice, $invLog);
            }

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Edit Package', 'T00057', 'L00077', $activityData, $userID, $userID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            if($newImages && $newVideos) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=> $data);
            } else if($newImages) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=> $data);
            } else if($newVideo) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=> $data);
            } else {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=> $data);
            }
        }

        // -------- Product --------//
        public function getProductInventory($params){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;

            $searchData      = $params['searchData'];
            $sortData        = $params['sortData'];
            $pageNumber      = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll          = $params['seeAll'];
            $limit           = General::getLimit($pageNumber);
            $dateTimeFormat  = Setting::$systemSetting['systemDateTimeFormat'];

            $userID = $db->userID;
            $site = $db->userType;

            if(!$seeAll){
                $limit = General::getLimit($pageNumber);
            }

            if($seeAll){
                $limit = null;
            }

            if (count($searchData) > 0) {
                
                $categoryCopy = $db->copy();
                $productCategoryCopy = $db->copy();
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'productName':
                            $db->where('p.name', "%" . $dataValue . "%", "LIKE");
                            break;

                        case 'code':
                            $db->where("p.barcode", "%". $dataValue . "%" , "LIKE");
                            break;

                        case 'status':
                            if($dataValue == 'active')
                            {
                                $dataValue = 0;
                            }
                            else
                            {
                                $dataValue = 1;
                            }
                            $db->where("p.deleted", $dataValue);
                            break;

                        case 'createdAt':
                            $columnName = 'DATE(p.created_at)';

                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                $db->where($columnName, date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                // $dateTo += 86399;
                                $db->where($columnName, date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;

                        case 'publishStatus':
                            if(strtolower($dataValue) == 'no')
                            {
                                $dataValue = '0';
                            }
                            else if(strtolower($dataValue) == 'yes')
                            {
                                $dataValue = '1';
                            }
                            else
                            {
                                $dataValue = '2';
                            }
                            $db->where('p.is_published', $dataValue);
                            break;
                        case 'archiveStatus':
                            if(strtolower($dataValue) == 'no')
                            {
                                $dataValue = '0';
                            }
                            else if(strtolower($dataValue) == 'yes')
                            {
                                $dataValue = '1';
                            }
                            else
                            {
                                $dataValue = '2';
                            }
                            $db->where('p.is_archive', $dataValue);
                            break;

                        case 'vendorName' :
                            $db->where("v.name", "%". $dataValue . "%" , "LIKE");
                            break;

                        case 'category' :


                            $categoryCopy->where('deleted', '0');
                            $categoryCopy->where('name', '%'. $dataValue .'%', 'LIKE');
                            $categoryId = $categoryCopy->getOne('product_category');
                            $categoryId = $categoryId['id'];



                            // check the sub category 
                            $productCategoryCopy->where('parent_id', $categoryId);
                            $productCategoryCopy->where('deleted', '0');
                            $subCategoryId = $productCategoryCopy->get('product_category');

                            if($subCategoryId)
                            {
                                foreach ($subCategoryId as $subCategory) {
                                    $subCategoryId = $subCategory['id'];
                                    $subCategoryIds[] = $subCategoryId;
                                }
                                $totalCategoryId = $categoryId . ',' . implode(', ', $subCategoryIds);
                            }
                            $db->where('p.categ_id','%"' . $categoryId . '"%', 'LIKE');
                            break;

                        case 'updatedAt':
                            $columnName = 'DATE(p.updated_at)';

                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                $db->where($columnName, date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");

                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                // $dateTo += 86399;
                                $db->where($columnName, date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $sortOrder = "ASC";
            $sortField = 'p.name';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'DESC')
                    $sortOrder = 'DESC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
                $db->orderBy($sortField, $sortOrder);
            }

            $rule = array(
                array('col' => 'p.product_type', 'val' => 'product')
            );

            // $db->orderBy('p.created_at', 'DESC');
            $db->join('vendor v', 'v.id = p.vendor_id', 'LEFT');
            foreach($rule as $v){
                $db->where($v['col'], $v['val']);
            }
            // $db->where('p.product_type', 'product');
            $copyDb = $db->copy();
            $copyDb2 = $db->copy();
            $productInv = $db->get("product p", $limit, "p.id, p.barcode as skuCode, p.name, p.product_type, p.description, p.categ_id, p.cost, p.sale_price, p.cooking_time, p.deleted as status, p.expired_day, p.created_at, p.updated_at, v.name as vendorName, p.is_published as publishStatus, p.is_archive as archiveStatus");

            if(empty($productInv)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }


            $productInvExcel = $copyDb2->get("product p", null, "p.id, p.barcode as skuCode, p.name, p.product_type, p.description, p.categ_id, p.cost, p.sale_price, p.cooking_time, p.deleted as status, p.expired_day, p.created_at, p.updated_at, v.name as vendorName, p.is_published as publishStatus, p.is_archive as archiveStatus");
            foreach($productInvExcel as $excelDetail)
            {
                $newExcelDetail['id'] = $excelDetail['id'];
                $newExcelDetail['skuCode'] = $excelDetail['skuCode'];
                $newExcelDetail['name'] = $excelDetail['name'];
                $newExcelDetail['product_type'] = $excelDetail['product_type'];
                $newExcelDetail['description'] = $excelDetail['description'];
                $newExcelDetail['cost'] = $excelDetail['cost'];
                $newExcelDetail['sale_price'] = $excelDetail['sale_price'];
                $newExcelDetail['cooking_time'] = $excelDetail['cooking_time'];
                $newExcelDetail['status'] = $excelDetail['status'];
                $newExcelDetail['expired_day'] = $excelDetail['expired_day'];
                $newExcelDetail['created_at'] = $excelDetail['created_at'];
                $newExcelDetail['updated_at'] = $excelDetail['updated_at'];
                $newExcelDetail['vendorName'] = $excelDetail['vendorName'];

                if($excelDetail['publishStatus'] == '1')
                {
                    $excelDetail['publishStatus'] = 'Yes';
                }
                else if($excelDetail['publishStatus'] == '0')
                {
                    $excelDetail['publishStatus'] = 'No';
                }

                if($excelDetail['archiveStatus'] == '1')
                {
                    $excelDetail['archiveStatus'] = 'Yes';
                }
                else if($excelDetail['archiveStatus'] == '0')
                {
                    $excelDetail['archiveStatus'] = 'No';
                } 
                $newExcelDetail['publishStatus'] = $excelDetail['publishStatus'];
                $newExcelDetail['archiveStatus'] = $excelDetail['archiveStatus'];

                $db->where('deleted', 0);
                $categoryAry = $db->map('id')->get('product_category', null, 'id');

                if($categoryAry) {
                    $db->where('module_id', $categoryAry, 'IN');
                    $db->where('language', $language);
                    $db->where('module', 'category');
                    $categoryLang = $db->map('module_id')->get('inv_language', null, 'module_id, content');
                }

                $excelDetail['categ_id'] = json_decode($excelDetail['categ_id'], true);

                unset($categoryDisplay);
                unset($categoryListing['categoryDisplay']);
                foreach($excelDetail['categ_id'] as $val) {
                    $categoryDisplay[$category] = $categoryLang[$val];
                    $categoryListing['categoryDisplay'][] = implode(', ', $categoryDisplay);
                }

                if(empty($categoryListing['categoryDisplay'])) {
                    $categoryListing['categoryDisplay'] = '';
                }

                $categoryDisplayFormatted = implode(", ", $categoryListing['categoryDisplay']);
                $newExcelDetail['categ_list'] = $categoryDisplayFormatted;

                $excelListing[] = $newExcelDetail;
            }
            $data['productInvExcel'] = $excelListing;
            if($params['type'] == "export"){
                // return array('status' => "error", 'code' => 110, 'statusMsg' => 'testing' , 'params' => $params);
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            // foreach($productInv as $productInvRow){
            //     if($productInvRow['updater_id']) $updaterAry[$productInvRow['updater_id']] = $productInvRow['updater_id'];
            //     $productInvID[$productInvRow['id']] = $productInvRow['id'];
            // }

            // if($updaterAry){
            //     $db->where("id", $updaterAry, "IN");
            //     $adminIDAry = $db->map("id")->get("admin", null, "id, username");
            // }

            // if($productInvID){
            //     $db->where('inv_product_id', $productInvID, 'IN');
            //     $db->where('type', 'productCategory');
            //     $categoryRes = $db->get('inv_product_detail', null, 'inv_product_id, value');

            //     foreach ($categoryRes as $categoryRow) {
            //         $categoryIDAry[$categoryRow['inv_product_id']][] = $categoryRow['value'];
            //     }

            //     $db->where('inv_product_id', $productInvID, 'IN');
            //     $db->groupBy('inv_product_id');
            //     $stockQuantity = $db->map('inv_product_id')->get('inv_stock',null,'inv_product_id, SUM(stock_in) as stock_in, SUM(stock_out) as stock_out');

            // }

            $db->where('deleted', 0);
            $categoryAry = $db->map('id')->get('product_category', null, 'id');

            if($categoryAry) {
                $db->where('module_id', $categoryAry, 'IN');
                $db->where('language', $language);
                $db->where('module', 'category');
                $categoryLang = $db->map('module_id')->get('inv_language', null, 'module_id, content');
            }

            foreach($productInv as $productInvRow){
                $productDetail['id'] = $productInvRow['id'];
                $productDetail['skuCode'] = $productInvRow['skuCode'];
                $productDetail['name'] = $productInvRow['name'];
               

                if($productInvRow['status'] == 1) {
                    $productDetail['status'] = 'No';
                    $productDetail['statusDisplay'] = General::getTranslationByName($productDetail['status']);
                } else {
                    $productDetail['status'] = 'Yes';
                    $productDetail['statusDisplay'] = General::getTranslationByName($productDetail['status']);
                }

                $productDetail['productType'] = $productInvRow['product_type'];
                $productDetail['description'] = $productInvRow['description'];
                $productDetail['cost'] = $productInvRow['cost'];
                $productDetail['salePrice'] = $productInvRow['sale_price'];
                $productDetail['expiredDay'] = $productInvRow['expired_day'];
                $productDetail['cookingTime'] = $productInvRow['cooking_time'];

                if($productInvRow['vendorName']){
                    $productDetail['vendorName'] = $productInvRow['vendorName'];
                }else{
                    $productDetail['vendorName'] = '-';
                }
                if($productInvRow['publishStatus'] == '1')
                {
                    $productDetail['publishStatus'] = 'Yes';
                }
                else if($productInvRow['publishStatus'] == '0')
                {
                    $productDetail['publishStatus'] = 'No';
                }

                if($productInvRow['archiveStatus'] == '1')
                {
                    $productDetail['archiveStatus'] = 'Yes';
                }
                else if($productInvRow['archiveStatus'] == '0')
                {
                    $productDetail['archiveStatus'] = 'No';
                } 

                $db->where('reference_id', $productInvRow['id']);
                $db->where('type', 'coverImg');
                $db->where('deleted', 0);
                $db->orderBy('id', 'ASC');
                $productImage = $db->getValue('product_media', 'url');

                if($productImage){
                    $productDetail['productImage'] = '<img src="' . $productImage . '" width="150" height="150">';
                    $productDetail['productImageURL'] = $productImage;
                }else{
                    $productDetail['productImage'] = '<img src="/images/logo-colour.png" width="150" height="100">';
                    $productDetail['productImageURL'] = "";
                }

                $productInvRow['categ_id'] = json_decode($productInvRow['categ_id'], true);
                
                unset($categoryDisplay);
                unset($productDetail['categoryDisplay']);
                foreach($productInvRow['categ_id'] as $val) {
                    $categoryDisplay[$category] = $categoryLang[$val];
                    $productDetail['categoryDisplay'][] = implode(', ', $categoryDisplay);
                }

                if(empty($productDetail['categoryDisplay'])) {
                    $productDetail['categoryDisplay'] = '';
                }

                // $productDetail['weight'] = Setting::setDecimal($productInvRow['weight'], 3) ? : '-';
                // $productDetail['totalStock'] = $stockQuantity[$productInvRow['id']]['stock_in'];
                // $productDetail['totalStockOut'] = $stockQuantity[$productInvRow['id']]['stock_out'];
                // $productDetail['quantity'] = $stockQuantity[$productInvRow['id']]['stock_in'] - $stockQuantity[$productInvRow['id']]['stock_out'];
                // $productDetail['isAdjustable'] = $productInvRow['status'] == "Active" ? 1 : 0;
                $productDetail['created_at'] = date($dateTimeFormat, strtotime($productInvRow['created_at']));
                // $productDetail['updater_id'] = $adminIDAry[$productInvRow['updater_id']] ? : '-';
                $productDetail['updated_at'] = $productInvRow['updated_at'] > 0 ? date($dateTimeFormat, strtotime($productInvRow['updated_at'])) : '-';
                $productInvList[] = $productDetail;
            }

            // if($params['type'] == "export"){
            //     $params['command'] = __FUNCTION__;
            //     $data = Excel::insertExportData($params);
            //     return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            // }

            $totalRecord              = $copyDb->getValue("product p", "count(p.id)");
            $data['productInventory'] = $productInvList;
            $data['pageNumber']       = $pageNumber;
            $data['totalRecord']      = $totalRecord;
            if($seeAll) {
                $data['totalPage']    = 1;
                $data['numRecord']    = $totalRecord;
            } else {
                $data['totalPage']    = ceil($totalRecord/$limit[1]);
                $data['numRecord']    = $limit[1];
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getProductInventoryDetails($params){
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            include('config.php');

            $productInvId = $params['productInvId'];

            $userID = $db->userID;
            $site = $db->userType;


            $db->where("status","Active");
            $cookingSuggestRecord = $db->get("cooking_suggestion",NULL,"id, name,description,status,cooking_time");
            foreach ($cookingSuggestRecord as $value) {
                $row = array(
                    "name" => $value['name'],
                    "description" => $value['description'],
                    "cookingTime" => $value['cooking_time'],
                    "status" => $value['status']
                );
                $cookingSuggestList[] = $row;
            }
            $data['cookingSuggestList'] = $cookingSuggestList;


            $db->where("b.parent_id", null , 'IS');
            $db->where('a.deleted', '0');
            $db->join("product_category b", "b.parent_id = a.id", "LEFT");
            $availableCategory = $db->get("product_category a",null,"a.id, a.name, a.parent_id");

            foreach($availableCategory as $value){
                $categoryIDAry[] = $value["id"];
            }

            if($categoryIDAry) {
                $db->where("module_id",$categoryIDAry,"IN");
                $db->where("module","category");
                $db->where("language",$language);
                $db->where("type","name");
                $categoryLang = $db->map('module_id')->get("inv_language",null,"module_id,content");
            }

            foreach($availableCategory as $value){
                if($value['parent_id'] != '0')
                {
                    $db->where('id', $value['parent_id']);
                    $parentName = $db->getOne('product_category', 'name');
                    $parentName = $parentName['name'];

                    $value['parentName'] = $parentName;
                    $value["categoryDisplay"] = $parentName . ' - ' . $categoryLang[$value["id"]];
                }
                else
                {
                    $value['parentName'] = '';
                    $value["categoryDisplay"] = $categoryLang[$value["id"]];
                }
                $categoryProductList[] = $value;
            }

            $data["categoryList"] = $categoryProductList;

            $db->where("deleted","0");
            $supplierRes = $db->get("vendor",null,"id,name,vendor_code");

            unset($supplierList);

            foreach($supplierRes as $supplierRow){
                unset($tempSupplier);

                $tempSupplier["supplierID"] = $supplierRow["id"];
                $tempSupplier["name"] = $supplierRow["name"];
                $tempSupplier["code"] = $supplierRow["vendor_code"];

                $supplierList[] = $tempSupplier;
            }

            $data["supplierList"] = $supplierList;

            unset($countryParams);
            $countryParams = array(
                "deliveryCountry" => "Yes"
            );
            $countryReturn = Country::getCountriesList($countryParams);
            $data["countryList"] = $countryReturn["data"]["countriesList"];

            $db->where('type', 'productType');
            $productType = $db->get('enumerators', null, 'name');

            $data['productType'] = $productType;

            $db->where("name","percentage");
            $marginPercen  = $db->getValue("system_settings","value");
            $data['discountPercentage'] = (int)$marginPercen;

            if($productInvId) {
                $db->where('id', $productInvId);
                $productInv = $db->getOne("product", "id, barcode as skuCode, name, product_type, description, cost, sale_price, cooking_time, expired_day, reminder_day, vendor_id, categ_id, is_published ,is_archive, ignore_stock_count ,deleted as status, cooking_suggestion, created_at, updated_at, delivery_method");

                if(!$productInv['ignore_stock_count'])
                {
                    $productInv['ignore_stock_count'] = 0;
                }
                if(!$productInv) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data' => "");
                } else {
                    if($productInv['status'] == 0) {
                        $productInv['status'] = 'Active';
                    } else {
                        $productInv['status'] = 'Inactive';
                    }

                    if(strpos($productInv['description'], '<p>') !== false) {
                        $productInv['description'] = '';
                    }

                    if(!empty($productInv['categ_id']) && $productInv['categ_id'] != '[]') {
                        $cateAry = json_decode($productInv['categ_id'], true);
                        $db->where('deleted', '0');
                        $db->where('id', $cateAry, 'IN');
                        $productCategory = $db->get('product_category', null, 'id, name');
                    } else {
                        $productCategory = '';
                    }

                    $db->where('deleted', 0);
                    $db->where('product_id', $productInvId);
                    $productVar = $db->get('product_template', null, 'product_attribute_value_id');

                    if(!empty($productVar)) {
                        // get all attribute value id in product template
                        $attrIdList = [];
                        foreach($productVar as $attr) {
                            foreach($attr as $val) {
                                foreach(json_decode($val, true) as $v) {
                                    if(empty($attrIdList)) {
                                        $attrIdList[] = $v;
                                    } else {
                                        if(!in_array($v, $attrIdList)) {
                                            $attrIdList[] = $v;
                                        }
                                    }
                                }
                            }
                        }

                        if(!empty($attrIdList)) {
                            // use the id in $attrIdList to find the product attribute and product attribute value
                            $db->where('pav.deleted', 0);
                            $db->where('pav.id', $attrIdList, 'IN');
                            $db->join('product_attribute pa', 'pa.id = pav.product_attribute_id', 'LEFT');
                            $productAttr = $db->get('product_attribute_value pav', null, 'pav.id, pav.name, pav.product_attribute_id as pa_id');

                            foreach($productAttr as $val) {
                                $attr[] = $val['pa_id'];

                                $attrVal[$val['pa_id']]['pa_id'] = $val['pa_id'];
                                $attrVal[$val['pa_id']]['id'][] = $val['id'];
                                $attrVal[$val['pa_id']]['name'][] = $val['name'];
                            }

                            $db->where('product_attribute_id', $attr, 'IN');
                            $attribute = $db->get('product_attribute_value', null, 'id, name, product_attribute_id');
                        }
                        $data['attrIdList'] = $attrVal;
                        $data['attribute'] = $attribute;
                        $data['productVar'] = $productVar;
                    } else {
                        $data['attrIdList'] = '';
                        $data['attribute'] = '';
                        $data['productVar'] = '';
                    }

                    if(strtolower($productInv['product_type']) == 'package') {
                        $db->where('deleted', 0);
                        $productList = $db->get('product', null, 'id, name');

                        $db->where('pi.deleted', 0);
                        $db->where('pi.package_id', $productInv['id']);
                        $db->join('product p', 'p.id = pi.product_id', 'LEFT');
                        $packageProduct = $db->get('package_item pi', null, 'pi.id, pi.package_id, pi.product_id, p.name');
                        
                        $data['packageProduct'] = $packageProduct;
                        $data['productList'] = $productList;
                    } else {
                        $data['packageProduct'] = '';
                    }

                    $db->where('deleted', 0);
                    $db->where('reference_id', $productInv['id']);
                    $productMedia = $db->get('product_media', null, 'id, type, url, reference_id');

                    if($productMedia) {
                        foreach($productMedia as $val) {
                            if($val['type'] == 'video') {
                                $media['id'] = $val['id'];
                                $media['url'] = $val['url'];
                                $media['type'] = $val['type'];
                                $media['reference_id'] = $val['reference_id'];
                            } else {
                                $media['id']   = $val['id'];
                                $media['url']  = $val['url'];
                                $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                                $media['type'] = $val['type'];
                                $media['reference_id'] = $val['reference_id'];
                            }
                            $mediaList[] = $media;
                        }
                    } else {
                        $mediaList = '';
                    }
                    $productInv['media'] = $mediaList;
                    
                    $db->where('product_id',$productInv['id']);
                    $getCookingSuggestDetails = $db->getValue('cooking_suggestion_details','suggestion_id',null);

                    foreach($getCookingSuggestDetails as $key=> $value){

                        $db->where('id',$getCookingSuggestDetails[$key]);
                        $getCookingDescription = $db->getValue('cooking_suggestion','description');

                        // $db->where('id',$getCookingSuggestDetails[$key]);
                        // $getCookingTime = $db->getValue('cooking_suggestion','cooking_time');

                        $data['cookingDescription'][$key] = $getCookingDescription;
                        // $data['cookingTime'][$key] = $getCookingTime;
                    }

                    $db->join('cooking_suggestion cs','cs.id = csd.suggestion_id','INNER');
                    $db->where('product_id',$productInv['id']);
                    $cookingSuggestDetails = $db->get('cooking_suggestion_details csd',null ,'csd.id AS id,url, cs.name AS name,remark,cs.description as description,suggestion_id,cs.cooking_time');

                    $db->where('module_id',$productInvId);
                    $db->where('module','product');
                    $getInvLanProduct = $db->get('inv_language',null,'id, type, language, content');
                    $getInvLan['product'] = $getInvLanProduct;

                    foreach($cookingSuggestDetails as $key => $value){
                        $db->where('module_id',$cookingSuggestDetails[$key]['id']);
                        $db->where('module','cookingSuggestionDetails');
                        $getChinese = $db->get('inv_language',null,'id as cid, type, language, content');

                        $newArr[$key]['id'] = $value['id'];
                        $newArr[$key]['url'] = $value['url'];
                        $newArr[$key]['name'] = $value['name'];
                        $newArr[$key]['description'] = $value['description'];
                        $newArr[$key]['suggestion_id'] = $value['suggestion_id'];
                        $newArr[$key]['cooking_time'] = $value['cooking_time'];
                        $newArr[$key]['language'] = $getChinese;

                        $getInvLan['cookingSuggest'][$key] = $getChinese;
                    }

                    foreach($cookingSuggestDetails as $details){
                        $db->where('module_id',$cookingSuggestDetails[$key]['id']);
                        $db->where('module','cookingSuggestionDetails');
                        $getInvLanCS = $db->get('inv_language',null,'id as cid, type, language, content');
                    }

                    $db->where('product_id', $productInvId);
                    $db->where('status', 'Active');
                    $availableStock = $db->getValue('stock', 'count(*)') ?? 0;

                    unset($dataIn);
                    $dataIn['product_id'] = $productInvId;
                    $stockInOutAmt = Admin::getStockMovementInOut($dataIn);

                    # get FOC detail
                    $db->where('product_id', $productInvId);
                    $db->where('deleted', '0');
                    $focDetail = $db->getOne('delivery_method_detail');
                    if($focDetail)
                    {
                        $isFOC = 1;
                    }
                    else
                    {
                        $isFOC = 0;
                    }

                    $data['cookingDetail'] = $newArr;
                    $data['focDetail'] = $isFOC;
                    $data['productDetails'] = $productInv;
                    $data['productCategory'] = $productCategory;
                    $data['nameTranslationList'] = array();
                    $data['descTranslationList'] = array();
                    $data['invTranslationList'] = $getInvLan;
                    $data['stockOnHand'] = $availableStock;
                    $data['stockInOutAmt'] = $stockInOutAmt;

                }
            }

            $db->where('deleted', '0');
            $productAttr = $db->get('product_attribute', null, 'id, name');

            $db->where('status', 'Active');
            $db->where('name', 'Self Pickup', 'NOT LIKE');
            $deliveryMethodList = $db->get('gotasty_delivery_method', null, 'id, name,price');
            
            $data['deliveryMethodList'] = $deliveryMethodList;
            $data['productAttrList'] = $productAttr;

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => '', 'data' => $data, $productVar);
        }

        public function verifyProductInventory($params, $type = "", $verify = false) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $productInvId   = $params['productInvId'];
            $productNameArr = $params['productNameArr'];
            $descriptionArr = $params['descriptionArr'];
            $skuCode        = trim($params['skuCode']);
            $status         = trim($params['status']);
            $category       = $params['category'];
            $statusAry      = array('Active', 'Inactive');
            $productType    = trim($params['productType']);
            $expired_day    = trim($params['expired_day']);
            $cost           = trim($params['cost']);
            $salePrice      = trim($params['salePrice']);
            $vendorId       = trim($params['vendorId']);
            $cookingTime    = trim($params['cookingTime']);
            $cookingSuggest = $params['cookingSuggest'];
            //
            $cookingSuggestName = $params['cookingSuggestionName'];
            $reminderDays    = trim($params['reminderDays']);
            //
            $fullInstruc    = $params['fullInstruc'];
            $deliveryMethod = $params['deliveryMethod'];

            $isPackage      = trim($params['isPackage']) ? : 0;
            $priceSetting   = $params["priceSetting"];
            $pvPrice        = $params["pvPrice"];
            $catalogue      = $params["catalogue"];
            $bBasic         = $params["bBasic"];
            $activeDate     = $params['activeDate'];
            $uploadImage    = $params['uploadImage'];
            $uploadVideo    = $params['uploadVideo'];
            $imageId        = $params['imageId'];
            $videoId        = $params['videoId'];
            $packageQuantity= $params['packageQuantity'];
            $productQuantity= $params['productQuantity'];
            $packageCategory= $params["packageCategory"];
            $packageNameLanguages  = $params['packageNameLanguages'];
            $packageDescrLanguages = $params['packageDescrLanguages'];

            // Stock
            $isStock = trim($params["isStock"]) ? 1 : 0;
            $stockDate = trim($params["stockDate"]);
            $stockSupplierID = trim($params["stockSupplierID"]);
            $stockSupplierDO = trim($params["stockSupplierDO"]); // Optional field
            $stockQty = trim($params["stockQty"]);
            $stockCost = trim($params["stockCost"]);
            $stockFee = trim($params["stockFee"]);

            $reminderDays     = $params['reminderDays'];
            $publishStatus    = $params['publishStatus'];
            $archiveStatus    = $params['archiveStatus'];
            $ignoreStatus     = $params['ignoreStatus'];
            $foc              = $params['foc'];

            if($productNameArr){
                foreach($productNameArr as $key => $value){
                    if($value['language'] == "english"){
                        $nameEnglish = $value['name'];
                    }
                }
            }

            if($descriptionArr){
                foreach($descriptionArr as $key => $value){
                    if($value['language'] == "english"){
                        $description = $value['name'];
                    }
                }
            }

            // Check Name Field
            if(!$nameEnglish) {
                $errorFieldArr[] = array(
                    'id'  => "invProductNameErrorEnglish",
                    'msg' => $translations['E01205'][$language] /* Please enter product name. */
                );
            }

            // Check Code Field
            // if(!$skuCode && $type != 'edit') {
                // $errorFieldArr[] = array(
                    // 'id'  => "skuCodeError",
                    // 'msg' => $translations['E00928'][$language] /* Please Enter Code. */
                // );
            // } else if($type === 'add'){
            if($type === 'add'){
                // check code avaibility
                $db->where('code', $skuCode);
                $result = $db->getOne("inv_product", 'id');

                if($result) {
                    $errorFieldArr[] = array(
                        'id'  => 'skuCodeError',
                        'msg' => $translations["E00929"][$language] /* Code Existed. */
                    );
                }
            }

            // Check Category Field
            if($category) {
                $db->where('deleted', 0);
                $availableCategory = $db->getValue('product_category', 'id', null);

                foreach($category as $val) {
                    if(!in_array($val, $availableCategory)) {
                        $errorFieldArr[] = array(
                            'id'  => "categoryError",
                            'msg' => $translations['E01012'][$language]
                        );
                    }
                }
            }

            if(!$productType) {
                $errorFieldArr[] = array(
                    'id'  => "productTypeError",
                    'msg' => $translations['E01172'][$language]
                );
            }

            if(!$description) {
                $errorFieldArr[] = array(
                    'id'  => "descriptionError",
                    'msg' => $translations['E01312'][$language] /* Please enter product description. */
                );
            }

            // if(!$expired_day && $type != 'edit') {
            if(!$expired_day ) {
                $errorFieldArr[] = array(
                    'id'  => "bestBeforeError",
                    'msg' => $translations['E01165'][$language] /* Please enter Best Before Days. */
                );
            }

            if(!$reminderDays  ) {
                $errorFieldArr[] = array(
                    'id'  => "reminderDaysError",
                    'msg' => $translations['E01165'][$language] /* Please enter Reminder Days. */
                );
            }

            if($reminderDays > $expired_day) {
                $errorFieldArr[] = array(
                    'id'  => "reminderDaysError",
                    'msg' => $translations['E01315'][$language] /* Please enter valid reminder days. */
                );
            }

            if(!$deliveryMethod) {
                $errorFieldArr[] = array(
                    'id'  => "deliveryMethodError",
                    'msg' => $translations['A01782'][$language] /* Please select a delivery method */
                );
            }

            if(!$category) {
                $errorFieldArr[] = array(
                    'id'  => "categoryError",
                    'msg' => $translations['E01206'][$language] /* Please select Category. */
                );
            }

            if($expired_day)
            {
                if(intval($expired_day) <= 0) {
                    $errorFieldArr[] = array(
                        'id'  => "bestBeforeError",
                        'msg' => $translations['E01225'][$language] /* Best before days must be at least 1. */
                    );
                }
            }

            if($reminderDays) {
                if(intval($reminderDays) <=0) {
                    $errorFieldArr[] = array(
                    'id' => "reminderDaysError",
                    'msg'=> $translations['E01225'][$language] /* Reminder days must be at least 1. */
                    );
                }
            }

            if(!$cost) {
                $errorFieldArr[] = array(
                    'id'  => "costError",
                    'msg' => $translations['E01166'][$language] /* Please enter cost. */
                );
            }

            if(!$salePrice) {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01167'][$language] /* Please enter sales price. */
                );
            }

            if($cost > $salePrice) {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01314'][$language] /* Please enter sales price. */
                );
            }

            if(!$vendorId) {
                $errorFieldArr[] = array(
                    'id'  => "vendorNameError",
                    'msg' => $translations['E01168'][$language]
                );
            } else {
                $db->where('deleted', 0);
                $availableVendor = $db->getValue('vendor', 'id', null);

                if(!in_array($vendorId, $availableVendor)) {
                    $errorFieldArr[] = array(
                        'id'  => "vendorNameError",
                        'msg' => $translations['E01168'][$language]
                    );
                }
            }

            if(!$uploadImage) {
                if($imageId){
                    //If not upload Image and got delete Image => need to check if got any image left, if no prompt error.
                    $db->where('id', $imageId, 'NOT IN');
                    $db->where('type', 'video', '!=');
                    $db->where('type', 'otherVid', '!=');
                    $db->where('deleted', '0');
                    $db->where('reference_id', $productInvId);
                    $checkImageLeft = $db->getValue('product_media', 'id');
                    if(!$checkImageLeft){
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        );
                    }
                }
                
                $db->where('reference_id', $productInvId);
                $db->where('deleted', '0');
                $db->where('type', 'video', '!=');
                $db->where('type', 'otherVid', '!=');
                $uploadImageList = $db->getOne('product_media');
                if(!$uploadImageList)
                {
                    $errorFieldArr[] = array(
                        'id'  => "imgError",
                        'msg' => $translations["E01069"][$language] /* Please upload image. */
                    );

                    
                    // return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01012"][$language] /* Please upload image */, 'data'=>'');
                }    
            }

            if (is_array($uploadImage)) {

                foreach ($uploadImage as $key => $value) {

                    if (!$value['uploadType']) {
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        
                        );
                    }
                }
            }

            // if(!$cookingTime) {
            //     $errorFieldArr[] = array(
            //         'id'  => "cookingTimeError",
            //         'msg' => $translations['E01169'][$language]
            //     );
            // }

            //-----

            // if(!$cookingSuggestName) {
            //     return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E01170"][$language] /* Please enter Cooking Suggestion */, 'data'=>'');
            // }

            // if($cookingSuggestName){
            //     foreach($cookingSuggestName as $key => $value){
            //         if($value['content'] == null){
            //         return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E01170"][$language] /* Please enter Cooking Suggestion */, 'data'=>'');
            //     }
            //     }            
            // }

            //-----


            // if(!$cookingSuggest) {
            //     $errorFieldArr[] = array(
            //         'id'  => "cookingSuggestionError",
            //         'msg' => $translations['E01170'][$language]
            //     );
            // }

            if(!$fullInstruc) {
                if($fullInstruc[0]) {
                    $errorFieldArr[] = array(
                        'id'  => "fullInstructionError",
                        'msg' => $translations['E01171'][$language]
                    );

                } else if ($fullInstruc[1]) {
                    $errorFieldArr[] = array(
                        'id'  => "fullInstruction2Error",
                        'msg' => $translations['E01171'][$language]
                    );
                }
            }

            if(!$uploadImage && $type != 'edit') {
                $errorFieldArr[] = array(
                    'id'  => "imgError",
                    'msg' => $translations['E01069'][$language]
                );
            }

            // Check Weight Field
            // if(!is_numeric($weight) || !$weight || $weight <= 0 ){
            //     $errorFieldArr[] = array(
            //         'id'  => "weightError",
            //         'msg' => $translations['E01010'][$language] /* Weight must be greater than 0 */
            //     );
            // }

            // Check Status Field
            // if(!$status || !in_array($status, $statusAry)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "statusError",
            //         'msg' => $translations['E00671'][$language] /* Please Select Status. */
            //     );
            // }

            $db->where('disabled', 0);
            $countLanguage = $db->getValue('languages', 'count(*)');

            if($isPackage == 1){
                $params['createPackage'] = $isPackage;
                $params['name'] = $nameEnglish;
                $params['category'] = $packageCategory;
                $params['code'] = $skuCode;
                $params['nameLanguages'] = $packageNameLanguages;
                $params['descrLanguages'] = $packageDescrLanguages;
                $package = self::verifyPackageDetail($params, "add");
                if($package["status"] != "ok") return $package;
            }

            // Stock

            if($isStock == 1 && $type == "add"){
                unset($stockParams);
                $stockParams = array(
                    "fromAddProduct" => $isStock,
                    "stockInDate" => $stockDate,
                    "supplierID" => $stockSupplierID,
                    "doNum" => $stockSupplierDO,
                    "quantity" => $stockQty,
                    "cost" => $stockCost,
                    "feeNCharges" => $stockFee,
                    "type" => "in",
                );

                $verifyStock = Self::adjustInvProduct($stockParams,"add");
                if($verifyStock["status"] != "ok") return $verifyStock;
            }

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            if($verify){
                $db->where("id",$category);
                $categoryData = $db->get("inv_category",null,"name");

                $db->where("id",$stockSupplierID);
                $supplierData = $db->get("inv_supplier",null,"name,code");

                unset($countryIDAry);

                foreach($priceSetting as $priceRow){
                    $countryIDAry[$priceRow["country"]] = $priceRow["country"];
                }

                if($countryIDAry){
                    $db->where("id",$countryIDAry,"IN");
                    $countryData = $db->map("id")->get("country",null,"id,name,translation_code,currency_code");
                }

                foreach($priceSetting as &$priceRow){
                    $priceRow["promoPrice"] = Setting::setDecimal($priceRow["promoPrice"]);
                    $priceRow["retailPrice"] = Setting::setDecimal($priceRow["retailPrice"]);
                    $priceRow["countryName"] = $countryData[$priceRow["country"]]["name"];
                    $priceRow["countryDisplay"] = $translations[$countryData[$priceRow["country"]]["translation_code"]][$language];
                    $priceRow["countryCurrency"] = $countryData[$priceRow["country"]]["currency_code"];

                    unset($priceRow["translation_code"]);
                }

                unset($dataOut);
                $dataOut = array(
                    "name" => $nameEnglish,
                    "skuCode" => $skuCode,
                    "status" => $status,
                    "statusDisplay" => General::getTranslationByName($status),
                    "category" => $category,
                    "categoryDisplay" => $categoryData,
                    "weight" => Setting::setDecimal($weight),

                    "isPackage" => $isPackage,
                    "priceSetting" => $priceSetting,
                    "activeDate" => date("d/m/Y",$activeDate),
                    "packageQuantity" => Setting::setDecimal($packageQuantity),
                    "productQuantity" => Setting::setDecimal($productQuantity),

                    "isStock" => $isStock,
                    "stockDate" => date("d/m/Y",$stockDate),
                    "stockSupplierID" => $stockSupplierID,
                    "stockSupplierData" => $supplierData,
                    "stockSupplierDO" => $stockSupplierDO,
                    "stockQty" => Setting::setDecimal($stockQty),
                    "stockCost" => Setting::setDecimal($stockCost),
                    "stockFee" => Setting::setDecimal($stockFee),
                );
                return array("status" => "ok", "code" => 0, "statusMsg"=> "", "data" => $dataOut);
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> '', 'data'=>"");
        }

        public function addProductInventory($params) {
            include('config.php');

            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $imageGroupUniqueChar   = self::generateUniqueChar();
            $dateTime               = date("Y-m-d H:i:s");

            $productNameArr             = $params['productNameArr'];
            $descriptionArr             = $params['descriptionArr'];
            $remarkArr                  = $params['remarkArray'];


            $productType    = trim($params['productType']);
            $expired_day    = $params['expired_day'];
            $reminderDays   = $params['reminderDays'];
            $skuCode        = trim($params['skuCode']);
            $cost           = trim($params['cost']);
            $salePrice      = trim($params['salePrice']);
            $vendorId       = trim($params['vendorId']);
            $category       = $params['category'];
            $cookingTime    = trim($params['cookingTime']);
            $videoList      = $params['videoList'];
            $uploadImage    = $params['uploadImage'];
            $uploadVideo    = $params['uploadVideo'];
            $cookingSuggestInput     = $params['cookingSuggestionName'];
            $cookingSuggestUrl       = $params['cookingSuggestionUrl'];
            $cookingSuggestRemark    = $params['cookingSuggestionRemark'];
            $publishStatus  = $params['publishStatus'];
            $archiveStatus  = $params['archiveStatus'];
            $deliveryMethod = $params['deliveryMethod'];
            // Variant
            $isVariant      = trim($params["isVariant"]) ? 1 : 0;
            $variant        = $params["variants"];

            //Package
            $packageList     = $params['packageProduct'];
            $publishStatus   = $params['publishStatus'];
            $archiveStatus   = $params['archiveStatus'];
            $ignoreStatus    = $params['ignoreStatus'];
            $foc             = $params['foc'];


            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["A01078"][$language] /* Access denied. */,'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            $db->where('id', $vendorId);
            $checkVendor = $db->getValue('vendor','id');

            if(!$checkVendor) {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00987"][$language] /* Invalid Vendor */, 'data'=>'');
            }
            $verify = self::verifyProductInventory($params, 'add');
            if($verify["status"] != "ok") return $verify;

            if(!$uploadImage) {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01069"][$language] /* Please upload image */, 'data'=>'');
            }

            if($productNameArr){
                foreach($productNameArr as $key => $value){
                    if($value['language'] == "english"){
                        $nameEnglish = $value['name'];
                    }
                }
            }

            if($descriptionArr){
                foreach($descriptionArr as $key => $value){
                    if($value['language'] == "english"){
                        $description = $value['name'];
                    }
                }
            }

            if(!$category)
            {
                $category = '[""]';
            }
            else
            {
                $category = json_encode($category);
            }

            // $db->startTransaction();
            
            // try{
                // Insert inv_product
                $insertInv = array(
                    "name"               => $nameEnglish,
                    "product_type"       => $productType,
                    "description"        => $description,
                    "expired_day"        => $expired_day,
                    "reminder_day"       => $reminderDays,
                    "barcode"            => $skuCode,
                    "cost"               => $cost,
                    "sale_price"         => $salePrice,
                    "delivery_method"    => $deliveryMethod,
                    "vendor_id"          => $vendorId,
                    "is_published"       => $publishStatus,
                    "is_archive"         => $archiveStatus,
                    "ignore_stock_count" => $ignoreStatus,
                    "categ_id"           => $category,
                    "created_at"         => $dateTime
                );
                $productInvId = $db->insert('product', $insertInv);

                if($foc == 1)
                {
                    $db->where('id', $productInvId);
                    $productDetail = $db->getOne('product');
                    $insertData = array(
                        'delivery_method_id' => $productDetail['delivery_method'],
                        'product_id' => $productInvId,
                        'quantity' => '0',
                        'amount' => '0',
                        'deleted' => '0',
                        'created_at' => $dateTime
                    );
                    $db->insert('delivery_method_detail', $insertData);
                }

                $db->where('name',$nameEnglish);
                $db->where('barcode',$skuCode);
                $productID = $db->getOne('product','id');
                $urlCount=0;
                foreach($cookingSuggestUrl as $url){
                    $urlCount+=1;
                    $suggestUrl[$urlCount] = $url;
                }
                $urlInputCount=0;

                if($productNameArr){
                    foreach($productNameArr as $key => $value){
                        $insertInvLan = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $invLanID = $db->insert('inv_language', $insertInvLan);
                    }
                }

                if($descriptionArr){
                    foreach($descriptionArr as $key => $value){
                        $insertInvLan2 = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $invLanID = $db->insert('inv_language', $insertInvLan2);
                    }
                }

                
                $cookingSuggestArr = array();
                for ($i = 0; $i < count($cookingSuggestInput); $i++) {
                    $cookingSuggestArr[] = array(
                        'name' => $cookingSuggestInput[$i]['content'],
                        'url' => $cookingSuggestUrl[$i]['content'],
                        'remark' => $cookingSuggestRemark[$i]['content']
                    );
                }

                foreach($cookingSuggestArr as $key => $value){
                    $db->where('name',  $cookingSuggestArr[$key]['name']);
                    $getCookingSuggestID = $db->getValue('cooking_suggestion','id');

                    $editCookingDetail = array(
                        "url"               => $cookingSuggestArr[$key]['url'],
                        "remark"            => $cookingSuggestArr[$key]['remark'],
                        "product_id"        => $productInvId,
                        "suggestion_id"     => $getCookingSuggestID,
                        "created_at"        => $dateTime,
                    );
                    $editCookingSuggestDetail = $db->insert("cooking_suggestion_details", $editCookingDetail);
                    $remarkIDList[$key] = $editCookingSuggestDetail;
                }

                if ($remarkArr) {
                    foreach ($remarkArr as $key1 => $value1) {
                        if (is_array($value1)) {
                            foreach ($value1 as $key2 => $value2) {

                                $editCookingSuggestDetail = $remarkIDList[$key1];
                                if (is_array($value2) && count($value2) === 2) {
                                    $insertInvLan3 = array(
                                        "module"       => 'cookingSuggestionDetails',
                                        "module_id"    => $editCookingSuggestDetail,
                                        "type"         => 'remark',
                                        "language"     => $value2['language'],
                                        "content"      => $value2['name'],
                                        "updated_at"   => $dateTime
                                    );
                                    $invLanID = $db->insert('inv_language', $insertInvLan3);
                                }
                            }
                        }
                    }
                }
                
                if (!$productInvId) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00932"][$language] /* Failed to add product. */,'data'=>'');
                }

                if(!empty($videoList)) {
                    $db->where('deleted', 0);
                    $db->where('reference_id', $productInvId);
                    $proVideo = $db->get('product_media', null, 'url');

                    if(empty($proVideo)) {
                        $proVideo = array();
                    }

                    foreach($videoList as $key => $val) {
                        if($val != '') {
                            if(!in_array($val, $proVideo)) {
                                $insertProMedia[] = array(
                                    "type"         => 'video',
                                    "url"          => $val, 
                                    "reference_id" => $productInvId,
                                    "created_at"   => $dateTime
                                );
                            }
                        }
                    }

                    if($insertProMedia) {
                        $proMedia = $db->insertMulti('product_media', $insertProMedia);
                    }
                }

                if(!empty($uploadImage)) {
                    foreach($uploadImage as $key => $val) {
                        //$imgSrc = json_decode($val['imgData'], true);
                        //$uploadParams['imgSrc'] = $imgSrc;
                        //$uploadRes = aws::awsUploadImage($uploadParams);

                        //if($uploadRes['status'] == 'ok') {
                            $imageUrl = $val['imgData'];

                            if($val['uploadType'] != '')
                            {
                                $uploadType = $val['uploadType'];
                            }
                            else
                            {
                                $uploadType = 'otherImg';
                            }
                            $imageName = $val['imgName'] != null ? $val['imgName'] : '';
                            // insert product_media
                            $insertImage = array(
                                "type" => $uploadType,
                                'name' => $imageName,
                                "url" => $imageUrl,
                                "reference_id" => $productInvId,
                                "created_at"   => $dateTime
                            );

                            $insertInvImage = $db->insert('product_media', $insertImage);

                            if(!$insertInvImage) {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        //} else {
                         //   return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                        //}
                    }
                }


                if(!empty($uploadVideo)) {
                    foreach($uploadVideo as $key => $val) {
                        //$vidSrc = json_decode($val['vidData'], true);
                        //$uploadVidParams['videoSrc'] = $vidSrc;
                        //$uploadRes = aws::awsUploadVideo($uploadVidParams);

                        //if($uploadRes['status'] == 'ok') {
                        $videoUrl = $val['vidData'];

                        if($val['uploadType'] != '')
                        {
                            $uploadType = $val['uploadType'];
                        }
                        else
                        {
                            $uploadType = 'otherVid';
                        }
                        // insert product_media
                        $insertVideo = array(
                            "type" => $uploadType,
                            "url" => $videoUrl,
                            "reference_id" => $productInvId,
                            "created_at"   => $dateTime
                        );

                        $insertInvVideo = $db->insert('product_media', $insertVideo);

                        if(!$insertInvVideo) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                        }
                        //} else {
                            //return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                        //}
                    }
                }

                if($isVariant == 1) {
                    foreach($variant[0] as $attr1) {
                        if(!empty($variant[1])) {
                            foreach($variant[1] as $val) {
                                $variantList = array($attr1, $val);
    
                                $insertProVar[] = array(
                                    "product_id"                 => $productInvId,
                                    "product_attribute_value_id" => json_encode($variantList),
                                    "deleted"                    => 0,
                                    "created_at"                 => $dateTime
                                );
                            }
                        } else {
                            $variantList = array($attr1);

                            $insertProVar[] = array(
                                "product_id"                 => $productInvId,
                                "product_attribute_value_id" => json_encode($variantList),
                                "deleted"                    => 0,
                                "created_at"                 => $dateTime
                            );
                        }
                    }
                    $proVar = $db->insertMulti('product_template', $insertProVar);
                } else {
                    $db->where('deleted', 0);
                    $db->where('product_id', $productInvId);
                    $db->where('product_attribute_value_id', '');
                    $checkEmptyTemplate = $db->getOne('product_template', 'id');

                    if(!$checkEmptyTemplate) {
                        $insertProVar = array(
                            "product_id"                 => $productInvId,
                            "product_attribute_value_id" => '',
                            "deleted"                    => 0,
                            "created_at"                 => $dateTime
                        );
                        $proVar = $db->insert('product_template', $insertProVar);
                    }
                }

                if(!empty($packageList)) {
                    foreach($packageList as $val) {
                        $insertPackageItemData[] = array(
                            'package_id' => $productInvId,
                            'product_id' => $val,
                            'deleted'    => 0,
                            'created_at' => $dateTime
                        );
                    }

                    if($insertPackageItemData) {
                        $insertPackageItem = $db->insertMulti('package_item', $insertPackageItemData);
                    }
                }
                // Insert inv_product_detail
                // $insertInvDetails = array(
                //     "inv_product_id" => $productInvId,
                //     "name"  => "productCategory",
                //     "value" => $category,
                //     "type"  => "productCategory"
                // );
                // $insertInvDetailsRes = $db->insert('inv_product_detail', $insertInvDetails);

                // if($isPackage == 1){
                //     $params['createPackage'] = $isPackage;
                //     $params['productInvID']  = $productInvId;
                //     $params["name"]          = $name;
                //     $params['category']      = $packageCategory;
                //     $params['code']          = $skuCode;
                //     $params['nameLanguages'] = $packageNameLanguages;
                //     $params['descrLanguages']= $packageDescrLanguages;

                //     $package = self::addPackageDetail($params);
                //     if($package["status"] != "ok") {
                //         $db->rollback();
                //         $db->commit();
                //         return $package;
                //     }
                //     $dataOut["packageData"] = $package["data"];
                // }

                // Stock
            //     if($isStock == 1){
            //         unset($stockParams);
            //         $stockParams = array(
            //             "stockInDate" => $stockDate,
            //             "invProductID" => $productInvId,
            //             "supplierID" => $stockSupplierID,
            //             "supplierDO" => $stockSupplierDO,
            //             "quantity" => $stockQty,
            //             "cost" => $stockCost,
            //             "feeNCharges" => $stockFee,
            //             "type" => "in",
            //         );
            //         $verifyStock = Self::adjustInvProduct($stockParams);
            //         if($verifyStock["status"] != "ok"){
            //             $db->rollback();
            //             $db->commit();
            //             return $verifyStock;
            //         }
            //     }
            // }catch(Exception $e){
            //     $db->rollback();
            //     $db->commit();
            //     return array("status" => "error", "code" => 2, "statusMsg" => "System Error", "data" => "");
            // }

            // $db->commit();

            // $activityData = array_merge(array('admin' => $checkAdmin), $insertInv, $insertInvDetails, $insertProductNameTransList, $insertProductDescrTranList);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Add Product', 'T00032', 'L00052', $activityData, $userID, $userID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            $data['productID'] = $productInvId;

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
        }

        public function editProductInventory($params) {
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $dateTime        = date("Y-m-d H:i:s");

            $productInvId    = trim($params['productInvId']);
            $name           = trim($params['invProductName']);
            $status         = trim($params['status']);
            $category       = $params['category'];
            $weight         = trim($params['weight']);
            $statusAry      = array('Active', 'Inactive');

            $descriptionArr       = $params['descriptionArr'];
            $remarkArray       = $params['remarkArray'];
            $productNameArr       = $params['productNameArr'];
            $invTranslationList       = $params['invTranslationList'];

            $productType    = trim($params['productType']);
            $description    = trim($params['description']);
            $expired_day    = trim($params['expired_day']);
            $skuCode        = trim($params['code']);
            $cost           = trim($params['cost']);
            $salePrice      = trim($params['salePrice']);
            $vendorId       = trim($params['vendorId']);
            $cookingTime    = trim($params['cookingTime']);
            $cookingSuggest = trim($params['cookingSuggest']);
            $fullInstruc    = $params['fullInstruc'];
            $videoList      = $params['videoList'];
            $videoId        = $params['videoId'];
            $uploadImage    = $params['uploadImage'];
            $uploadVideo    = $params['uploadVideo'];
            $imageId        = $params['imageId'];
            $cookingSuggestInput = $params['cookingSuggestionName'];
            $cookingSuggestUrl = $params['cookingSuggestionUrl'];
            $cookingSuggestRemark = $params['cookingSuggestionRemark'];
            $publishStatus    = $params['publishStatus'];
            $archiveStatus    = $params['archiveStatus'];
            $ignoreStatus     = $params['ignoreStatus'];
            $deliveryMethod   = $params['deliveryMethod'];
            $foc              = $params['foc'];

            // $cookingSuggestId = $params['cookingSuggest'];

            // $cookingSuggestId = array_column(array_map(function($item) {
            //     return array('id' => $item['id']);
            // }, $cookingSuggestId), 'id');

            $cookingSuggest = [];

            foreach ($cookingSuggestInput as $key => $value) {
                $cookingSuggest[$key] = [
                    'name' => $value['content']
                ];
                $cookingSuggest[$key]['url'] = $cookingSuggestUrl[$key]['content'];
                $cookingSuggest[$key]['remark'] = $cookingSuggestRemark[$key]['content'];
            }

            $cookingSuggestArr = array();
            for ($i = 0; $i < count($cookingSuggestInput); $i++) {

                // get their suggestion id
                $db->where('name', $cookingSuggestInput[$i]['content']);
                $db->where('status', 'Active');
                $suggestionId = $db->getValue('cooking_suggestion','id');

                $cookingSuggestArr[] = array(
                    'name' => $cookingSuggestInput[$i]['content'],
                    'url' => $cookingSuggestUrl[$i]['content'],
                    'remark' => $cookingSuggestRemark[$i]['content'],
                    'suggestion_id' => $suggestionId
                );
            }


            $db->where('product_id', $productInvId);
            $existData = $db->get('cooking_suggestion_details');
            if($existData)
            {
                // delete the existing data
                $db->where('product_id', $productInvId);
                $db->delete('cooking_suggestion_details');
            }


            foreach($existData as $key => $value){

                $db->where('module', 'cookingSuggestionDetails');
                $db->where('type', 'remark');
                $db->where('module_id', $value['id']);
                $existDataLan = $db->get('inv_language');

                if($existDataLan)
                {
                    // delete the existing data
                    $db->where('module_id', $value['id']);
                    $db->where('type', 'remark');
                    $db->where('module', 'cookingSuggestionDetails');
                    $db->delete('inv_language');
                }
                
            }

            if($cookingSuggestArr){

                foreach($cookingSuggestArr as $key => $details){

                    // insert new data
                    $insertData = array(
                        'url'           => $details['url'],
                        'remark'        => $details['remark'],
                        'product_id'    => $productInvId,
                        'suggestion_id' => $details['suggestion_id'],
                        'created_at'    => $dateTime,
                    );
    
                    $editCookingSuggestDetail = $db->insert('cooking_suggestion_details', $insertData);
                    $remarkIDList[$key] = $editCookingSuggestDetail;
                }
            }

            if ($remarkArray) {
                foreach ($remarkArray as $key1 => $value1) {
                    if (is_array($value1)) {
                        foreach ($value1 as $key2 => $value2) {

                            $editCookingSuggestDetail = $remarkIDList[$key1];
                            if (is_array($value2) && count($value2) === 2) {
                                $insertInvLan3 = array(
                                    "module"       => 'cookingSuggestionDetails',
                                    "module_id"    => $editCookingSuggestDetail,
                                    "type"         => 'remark',
                                    "language"     => $value2['language'],
                                    "content"      => $value2['name'],
                                    "updated_at"   => $dateTime
                                );
                                $invLanID = $db->insert('inv_language', $insertInvLan3);
                            }
                        }
                    }
                }
            }

            // foreach($cookingSuggestArr as $key => $value){
            //     $db->where('name',  $cookingSuggestArr[$key]['name']);
            //     $getCookingSuggestID = $db->getValue('cooking_suggestion','id');

            //     // check if there is existing cooking suggestion details
            //     $db->where('product_id', $productInvId);
            //     $db->where('suggestion_id', $getCookingSuggestID);
            //     $existSuggestion = $db->get('cooking_suggestion_details');
            //     // update array

            //     $editCookingDetail = array(
            //         "url"               => $cookingSuggestArr[$key]['url'],
            //         "remark"            => $cookingSuggestArr[$key]['remark'],
            //         "product_id"        => $productInvId,
            //         "suggestion_id"     => $getCookingSuggestID,
            //         "created_at"        => $dateTime,
            //     );
            //     $editCookingSuggestDetail = $db->insert("cooking_suggestion_details", $editCookingDetail);
            // }

            // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => $cookingSuggest);

            // Variant
            $isVariant      = trim($params["isVariant"]) ? 1 : 0;
            $variant        = $params["variants"];

            //Package
            $packageProduct = $params['packageProduct'];

            $imageGroupUniqueChar = self::generateUniqueChar();

            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid admin */,'data'=>'');
                }
            }

            $db->where('id', $vendorId);
            $checkVendor = $db->getValue('vendor','id');

            // if(!$checkVendor) {
            //     return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00987"][$language] /* Invalid Vendor */, 'data'=>'');
            // }

            if(!$checkVendor) {
                $errorFieldArr[] = array(
                    'id'  => "vendorNameError",
                    'msg' => $translations['E01168'][$language]
                );       
            }

            $db->where('id', $category);
            $checkCategory = $db->getValue('product_category','id');

            if(!$checkCategory) {
                // return array('status'=>'error','code'=>2,'statusMsg'=> "Invalid Category", 'data'=>'');
                $checkCategory = '[]';
            }

            if(!$category)
            {
                $category = '[""]';
            }
            else
            {
                $category = json_encode($category);
            }

            // return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid admin */,'data'=>$params['cookingSuggest']);

            $verify = self::verifyProductInventory($params, "edit");
            if($verify["status"] != "ok") return $verify;

            if(!$productInvId) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E00933"][$language] /* Product not found */, 'data' => '');
            }

            $db->where("id", $productInvId);
            $productInvRecord = $db->getOne("product", "id");

            if($status == "Inactive"){
                $delete = '1';
            } else {
                $delete = '0';
            }

            if ($salePrice <= 0)
            {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E01283"][$language] /* Please enter a valid sale price */, 'data' => '');
            }

            // Edit product
            $editInv = array(
                "name"               => $name,
                "product_type"       => $productType,
                "description"        => $description,
                "expired_day"        => $expired_day,
                "barcode"            => $skuCode,
                "cost"               => $cost,
                "sale_price"         => $salePrice,
                "vendor_id"          => $vendorId,
                "categ_id"           => $category,
                "delivery_method"    => $deliveryMethod,
                // "cooking_time"       => $cookingTime,
                "is_published"       => $publishStatus,
                "is_archive"         => $archiveStatus,
                "ignore_stock_count" => $ignoreStatus,
                // "cooking_suggestion" => $cookingSuggest,
                "full_instruction"   => $fullInstruc[0],
                "full_instruction2"  => $fullInstruc[1],
                "deleted"            => $delete,
                "updated_at"         => $dateTime,
            );

            $db->where("id", $productInvId);
            $editInvRes = $db->update("product", $editInv);

            if($descriptionArr){
                foreach($descriptionArr as $key => $value){

                    $db->where("module_id", $productInvId);
                    $db->where("module", 'product');
                    $db->where("type", 'description');
                    $db->where("language", $value['language']);
                    $getDesc = $db->get('inv_language');

                    if(!$getDesc){
                        $insertInvLanDesc = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanDesc2 = $db->insert('inv_language', $insertInvLanDesc);
                    }else{
                        $insertInvLan2 = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $productInvId);
                        $db->where("module", 'product');
                        $db->where("type", 'description');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan2);
                    }   
                }
            }

            if($productNameArr){
                foreach($productNameArr as $key => $value){

                    $db->where("module_id", $productInvId);
                    $db->where("module", 'product');
                    $db->where("type", 'name');
                    $db->where("language", $value['language']);
                    $getName = $db->get('inv_language');

                    if(!$getName){
                        $insertInvLanName = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanName2 = $db->insert('inv_language', $insertInvLanName);
                    }else{
                        $insertInvLan = array(
                            "module"               => 'product',
                            "module_id"            => $productInvId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $productInvId);
                        $db->where("module", 'product');
                        $db->where("type", 'name');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan);
                    }
                }
            }

            // $urlCount=0;
            // foreach($cookingSuggestUrl as $url){
            //     $urlCount+=1;
            //     $suggestUrl[$urlCount] = $url;
            // }
            // $urlInputCount=0;

            // foreach($cookingSuggest as $key => $value){
            //     $urlInputCount += 1;
            //     $insertInv = array(
            //         "url"           => $value['url'],
            //         "remark"        => $value['remark'],
            //         "created_at"    => $dateTime
            //     );
            //     $db->where('id', $value['id']);
            //     $editInv = $db->update('cooking_suggestion_details', $insertInv);
            // }
            

            if (!$editInvRes) {
                return array('status' => 'error', 'code' => 1,'statusMsg' => $translations["E00934"][$language] /* Failed to update product. */, 'data' => '');
            }

            if(!empty($uploadVideo)) {
                foreach($uploadVideo as $key => $val) {
                    //$vidSrc = json_decode($val['vidData'], true);
                    //$uploadVidParams['videoSrc'] = $vidSrc;

                    if (strpos($val['vidData'], 'https') !== false) {
                        //$uploadRes = aws::awsUploadVideo($uploadVidParams);

                        //if($uploadRes['status'] == 'ok') {
                            $videoUrl = $val['vidData'];

                            if($val['uploadType'] != '')
                            {
                                $uploadType = $val['uploadType'];
                            }
                            else
                            {
                                $uploadType = 'otherVid';
                            }
                            // insert product_media
                            $insertVideo = array(
                                "type" => $uploadType,
                                "url" => $videoUrl,
                                "reference_id" => $productInvId,
                                "created_at"   => $dateTime
                            );

                            $insertInvVideo = $db->insert('product_media', $insertVideo);

                            if(!$insertInvVideo) {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        //} else {
                            //return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                        //}
                    }
                }
            }

            if($videoId) {
                $db->where('id', $videoId, 'IN');
                $db->where('type', 'video');
                $db->where('reference_id', $productInvId);
                $editImageList = $db->update('product_media', array('deleted' => 1));
            }

            if(!empty($uploadImage)) {
                foreach($uploadImage as $key => $val) {
                    if($val['imgID'] == '') {
                        //$imgSrc = json_decode($val['imgData'], true);
                        //$uploadParams['imgSrc'] = $imgSrc;
                        //$uploadRes = aws::awsUploadImage($uploadParams);

                        if(strpos($val['imgData'], 'https') !== false) {
                            $imageUrl = $val['imgData'];
                            $imageName = $val['imgName'] != null ? $val['imgName'] : '';
                            // insert product_media
                            $insertImage[] = array(
                                "type" => $val['uploadType'],
                                'name' => $imageName,
                                "url" => $imageUrl,
                                "reference_id" => $productInvId,
                                "created_at"   => $dateTime,
                            );
                        //} else {
                        //    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                        }
                    } else {
                        $imgSrc = json_decode($val['imgData'], true);

                        if (strpos($imgSrc, "data:") !== false) {
                            $db->where('id', $val['imgID']);
                            $db->where('type', 'Image');
                            $editImage = $db->update('product_media', array('deleted' => 1));

                            $uploadParams['imgSrc'] = $imgSrc;
                            $uploadRes = aws::awsUploadImage($uploadParams);

                            if($uploadRes['status'] == 'ok') {
                                $imageUrl = $uploadRes['imageUrl'];
                                // insert product_media
                                $insertImage[] = array(
                                    "type" => "Image",
                                    "url" => $imageUrl,
                                    "reference_id" => $productInvId,
                                );
                            } else {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        }
                        else
                        {
                            if($val['imgData'] == '""')
                            {
                                // delete photo if imgdata is empty
                                $db->where('id', $val['imgID']);
                                $db->where('type', 'Image');
                                $db->where('deleted', '0');
                                $editImage = $db->update('product_media', array('deleted' => 1));
                            }
                        }
                    }
                }

                if(!empty($insertImage)) {
                    $insertInvImage = $db->insertMulti('product_media', $insertImage);

                    if(!$insertInvImage) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    }
                }

            }

            if($imageId) {
                $db->where('id', $imageId, 'IN');
                // $db->where('type', 'Image');
                $db->where('reference_id', $productInvId);
                $editImageList = $db->update('product_media', array('deleted' => 1));
            }

            if($isVariant == 1) {
                if(!empty($variant)) {
                    foreach($variant[0] as $attr1) {
                        if(!empty($variant[1])) {
                            foreach($variant[1] as $val) {
                                $variantList = array($attr1, $val);

                                $db->where('product_id', $productInvId);
                                $db->where('product_attribute_value_id', '%'.json_encode($variantList).'%', 'LIKE');
                                $getVariantId = $db->getOne('product_template', 'id, deleted');

                                if(empty($getVariantId)) {
                                    $insertProVar[] = array(
                                        "product_id"                 => $productInvId,
                                        "product_attribute_value_id" => json_encode($variantList),
                                        "deleted"                    => 0,
                                        "created_at"                 => $dateTime
                                    );
                                } else {
                                    if($getVariantId['deleted'] == 0) {
                                        $varList[] = $getVariantId['id'];
                                    } else {
                                        $varList2[] = $getVariantId['id'];
                                    }
                                }
                            }
                        } else {
                            $variantList = array($attr1);

                            $db->where('product_id', $productInvId);
                            $db->where('product_attribute_value_id', '%'.json_encode($variantList).'%', 'LIKE');
                            $getVariantId = $db->getOne('product_template', 'id, deleted');

                            if(empty($getVariantId)) {
                                $insertProVar[] = array(
                                    "product_id"                 => $productInvId,
                                    "product_attribute_value_id" => json_encode($variantList),
                                    "deleted"                    => 0,
                                    "created_at"                 => $dateTime
                                );
                            } else {
                                if($getVariantId['deleted'] == 1) {
                                    $varList[] = $getVariantId['id'];
                                } else {
                                    $varList2[] = $getVariantId['id'];
                                }
                            }
                        }
                    }

                    $updateProVarData = array(
                        "deleted"    => 1,
                        "updated_at" => $dateTime
                    );
                    $db->where('product_attribute_value_id', '');
                    $db->where('product_id', $productInvId);
                    $updateProVar = $db->update('product_template', $updateProVarData);
                } else {
                    $updateProVarData = array(
                        "deleted"    => 0,
                        "updated_at" => $dateTime
                    );
                    $db->where('product_attribute_value_id', '');
                    $db->where('product_id', $productInvId);
                    $updateProVar = $db->update('product_template', $updateProVarData);

                    $updateEmptyVarData = array(
                        "deleted"    => 1,
                        "updated_at" => $dateTime
                    );
                    $db->where('product_attribute_value_id', '', '!=');
                    $db->where('product_id', $productInvId);
                    $updateEmptyVar = $db->update('product_template', $updateEmptyVarData);
                }

                if(!empty($varList)) {
                    $updateProVarData = array(
                        "deleted"    => 1,
                        "updated_at" => $dateTime
                    );
                    $db->where('id', $varList, 'NOT IN');
                    $db->where('product_attribute_value_id', '', '!=');
                    $db->where('product_id', $productInvId);
                    $updateProVar = $db->update('product_template', $updateProVarData);
                }

                if(!empty($varList2)) {
                    $updateProVarData = array(
                        "deleted"    => 0,
                        "updated_at" => $dateTime
                    );
                    $db->where('id', $varList2, 'IN');
                    $db->where('product_attribute_value_id', '', '!=');
                    $db->where('product_id', $productInvId);
                    $updateProVar = $db->update('product_template', $updateProVarData);
                }

                if($insertProVar) {
                    $proVar = $db->insertMulti('product_template', $insertProVar);
                }
            }

            if($productType == 'Package') {
                if(!empty($packageProduct)) {
                    $updatePackageData = array(
                        "deleted"    => 1,
                        "updated_at" => $dateTime
                    );
                    $db->where('product_id', $packageProduct, 'NOT IN');
                    $db->where('deleted', 0);
                    $db->where('package_id', $productInvId);
                    $updatePackage = $db->update('package_item', $updatePackageData);

                    foreach($packageProduct as $val) {
                        $db->where('product_id', $val);
                        $checkPackage = $db->getOne('package_item', 'id');

                        if(!$checkPackage) {
                            $insertPackageItemData[] = array(
                                'package_id' => $productInvId,
                                'product_id' => $val,
                                'deleted'    => 0,
                                'created_at' => $dateTime
                            );
                        } else {
                            $updatePackageData = array(
                                "deleted"    => 0,
                                "updated_at" => $dateTime
                            );
                            $db->where('product_id', $val);
                            $db->where('deleted', 1);
                            $db->where('package_id', $productInvId);
                            $updatePackage = $db->update('package_item', $updatePackageData);
                        }
                    }

                    if($insertPackageItemData) {
                        $insertPackageItem = $db->insertMulti('package_item', $insertPackageItemData);
                    }
                }
            }

            # record FOC setting in delivery_method_detail
            $updateData = array(
                'deleted' => '1',
                'updated_at' => $dateTime
            );
            $db->where('product_id', $productInvId);
            $db->where('deleted', '0');
            $db->update('delivery_method_detail', $updateData);
            if($foc == 1)
            {
                $db->where('id', $productInvId);
                $productDetail = $db->getOne('product');
                $insertData = array(
                    'delivery_method_id' => $productDetail['delivery_method'],
                    'product_id' => $productInvId,
                    'quantity' => '0',
                    'amount' => '0',
                    'deleted' => '0',
                    'created_at' => $dateTime
                );
                $db->insert('delivery_method_detail', $insertData);
            }

            $activityData = array_merge(array('admin' => $checkAdmin), $editInv, $updateTranslationList, $updateDescrTranslationList);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Edit Product', 'T00033', 'L00053', $activityData, $userID, $userID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            $data['productID'] = $productInvId;
            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$data);
        }

        // -------- Stock Adjustment --------//
        public function packageAdjustment($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $packageID      = trim($params["packageID"]);
            $quantity       = trim($params["quantity"]);
            $type           = trim($params["type"]);
            $typeArr        = array("in","out");
            $subject        = $type == "in" ? "Adjust In" : "Adjust Out";
            $todayDate      = date("Y-m-d H:i:s");

            $userID = $db->userID;
            $site = $db->userType;

            if(!$packageID){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00841"][$language] /* Please Select Product */, 'data' => "");
            }else{
                $db->where("id",$packageID);
                $validPackage = $db->getOne("mlm_product", "id, SUM(total_balance - total_sold - total_holding) AS quantity");
                if(!$validPackage) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product */, 'data' => "");
            }

            if(!$type || !in_array($type, $typeArr)){
                $errorFieldArr[] = array(
                        'id'  => "typeError",
                        'msg' => $translations["E00741"][$language]
                    );
            }

            if(!$quantity || $quantity <= 0 || !is_numeric($quantity)){
                $errorFieldArr[] = array(
                        'id'  => "quantityError",
                        'msg' => $translations['E00941'][$language] /* Quantity must be greater than 0 */
                    );
            }elseif($type == "out"){
                $currentBalance = $validPackage['quantity'];

                if($quantity > $currentBalance){
                    $errorFieldArr[] = array(
                            'id'  => "quantityError",
                            'msg' => $translations['E01080'][$language] /* Current package quantity less than quantity wanna be deduct.  */
                        );
                }
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            // Update mlm product total balance
            if($type == 'in') {
                $data = array(
                    "admin"     =>  $userID,
                    "action"    =>  "add",
                    "quantity"  =>  $quantity,
                    "package"   =>  $packageID,
                );

                $updateData = array(
                    'total_balance' => $db->inc($quantity)
                );
            } else if($type == 'out') {
                $data = array(
                    "admin"     =>  $userID,
                    "action"    =>  "deduct",
                    "quantity"  =>  $quantity,
                    "package"   =>  $packageID,
                );

                $updateData = array(
                    'total_balance' => $db->dec($quantity)
                );
            }
            $db->where('id', $packageID);
            $db->update('mlm_product', $updateData);

            // insert inv log
            $invLog = array(
                    "module"                    =>  "mlm_product",
                    "module_id"                 =>  $packageID,
                    "title_transaction_code"    =>  "T00059",
                    "title"                     =>  $subject,
                    "transaction_code"          =>  "L00079",
                    "data"                      =>  json_encode($data),
                    "creator_type"              =>  $site,
                    "creator_id"                =>  $userID,
                    "created_at"                =>  $todayDate
            );
            $db->insert("inv_log", $invLog);

            // Update system setting for process get product
            $db->where('name', 'processGetProduct');
            $db->update('system_settings', array('value' => 0));

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00370"][$language], 'data' => "");
        }

        public function getPackageAdjustment($params){
            $db           = MysqliDb::getInstance();
            $translations = General::$translations;
            $language     = General::$currentLanguage;
            $searchData   = $params['searchData'];
            $seeAll       = $params['seeAll'];
            $pageNumber   = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit        = General::getLimit($pageNumber);
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $packageID    = $params["packageID"];

            $userID       = $db->userID;
            $site         = $db->userType;

            if(!$packageID){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01009"][$language] /* Invalid Package ID */, 'data' => "");
            }

            $db->where("id", $packageID);
            $packageData = $db->getOne("mlm_product", "id, SUM(total_balance - total_sold - total_holding) AS quantity");

            $db->where('module_id', $packageData['id']);
            $db->where('module', 'mlm_product');
            $db->where('language', $language);
            $db->where('type', 'name');
            $packageName = $db->getValue('inv_language', 'content');

            $data['packageName'] = $packageName;
            $data["quantity"] = $packageData['quantity'];

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function adjustInvProduct($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $dateTimeFormat = "Y-m-d H:i:s";
            $todayDate      = date($dateTimeFormat);

            $fromAddProduct = trim($params["fromAddProduct"]) ? 1 : 0;
            $invProductID   = trim($params["invProductID"]);
            $quantity       = trim($params["quantity"]);
            $cost           = trim($params["cost"]);
            $remark         = trim($params["remark"]);
            $stockInDate    = date($dateTimeFormat, $params["stockInDate"]) ? : $todayDate;
            $subject        = "Stock In";
            $doNum          = $params['doNum'];
            $supplierID     = $params['supplierID'];
            $feeNCharges    = $params['feeNCharges'];

            $userID = $db->userID;
            $site = $db->userType;

            if($site == "Member"){
                $clientID = $userID;
            }

            if(!$fromAddProduct){
                if(!$invProductID){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00841"][$language] /* Please Select Product */, 'data' => "");
                }else{
                    $db->where("id",$invProductID);
                    $validProduct = $db->has("inv_product");
                    if(!$validProduct) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product */, 'data' => "");
                }
            }

            if($doNum){
                $db->where("do_number",$doNum);
                $checkDoNum = $db->has("inv_stock");
                if($checkDoNum){
                    $errorFieldArr[] = array(
                        "id"  => "doNumError",
                        "msg" => $translations['E01085'][$language] /* DO Number duplicated */
                    );
                }
            }

            if(!$supplierID){
                $errorFieldArr[] = array(
                        'id'  => "supplierError",
                        'msg' => $translations['E00987'][$language] /* Invalid Supplier */
                    );
            }else{
                $db->where("id", $supplierID);
                $validSupplier = $db->has("inv_supplier");

                if(!$validSupplier){
                    $errorFieldArr[] = array(
                            'id'  => "supplierError",
                            'msg' => $translations['E00987'][$language] /* Invalid Supplier */
                        );
                }
            }

            if($feeNCharges){
                if(!is_numeric($feeNCharges) || $feeNCharges < 0){
                    $errorFieldArr[] = array(
                        'id'  => "quantityError",
                        'msg' => $translations['E00941'][$language] /* Quantity must be greater than 0 */
                    );
                }
            }

            if(!$quantity || $quantity <= 0 || !is_numeric($quantity)){
                $errorFieldArr[] = array(
                        'id'  => "quantityError",
                        'msg' => $translations['E00941'][$language] /* Quantity must be greater than 0 */
                    );
            }

            if(!$cost || $cost <= 0 || !is_numeric($cost)){
                $errorFieldArr[] = array(
                        'id'  => "costError",
                        'msg' => $translations['E01056'][$language] /* Cost must be greater than 0 */
                    );
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            if($fromAddProduct){
                return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => "");
            }

            // Update inv product total balance
            $updateData = array(
                'total_balance' => $db->inc($quantity)
            );
            $db->where('id', $invProductID);
            $copyDB = $db->copy();
            $db->update('inv_product', $updateData);

            $batchID  = $db->getNewID();
            $amountIn = $quantity;

            $stockCode = General::generateDynamicCode("K", 7, "inv_stock", "stock_code", true);
            // insert inv stock
            $insertStock = array(
                    "inv_product_id"    => $invProductID,
                    "stock_code"        => $stockCode,
                    "do_number"         => $doNum,
                    "supplier_id"       => $supplierID,
                    "fee_charges"       => $feeNCharges,
                    "cost"              => $cost,
                    "stock_in"          => $quantity,
                    "stock_in_date"     => $todayDate,
                    "created_at"        => $todayDate,
                    "remark"            => $remark,
            );
            $invStockID = $db->insert("inv_stock", $insertStock);

            // insert inv product transactions
            $insertProductTransaction = array(
                    "inv_product_id"    => $invProductID,
                    "client_id"         => $clientID,
                    "subject"           => $subject,
                    "amount_in"         => $amountIn,
                    "amount_out"        => $amountOut,
                    "data"              => $data,
                    "batch_id"          => $batchID,
                    "created_at"        => $todayDate,
                    "creator_id"        => $userID,
                    "creator_type"      => $site,
                    "remark"            => $remark,
            );
            $productTransaction = $db->insert("inv_product_transaction",$insertProductTransaction);

            // insert inv stock transactions
            $insertStockTransaction = array(
                    "inv_product_id"    => $invProductID,
                    "inv_stock_id"      => $invStockID,
                    "client_id"         => $clientID,
                    "subject"           => $subject,
                    "amount_in"         => $amountIn,
                    "amount_out"        => $amountOut,
                    "data"              => $data,
                    "batch_id"          => $batchID,
                    "created_at"        => $todayDate,
                    "creator_id"        => $userID,
                    "creator_type"      => $site,
                    "remark"            => $remark,
            );
            $stockTransaction = $db->insert("inv_stock_transaction",$insertStockTransaction);

            $lowStockAlert      = General::getSystemSettingAdmin('lowStockQuantity');

            if($lowStockAlert){
                $newestStockBalance = $copyDB->getOne('inv_product', 'id, total_balance, alert_at');
                $lowStockAlertValue = $lowStockAlert['lowStockQuantity']['value'];

                if($newestStockBalance['total_balance'] >= $lowStockAlertValue && $newestStockBalance['alert_at'] > 0){
                    $updateTime = array(
                        'alert_at'  =>  '0000-00-00 00:00:00',
                    );
                    $db->where('id', $newestStockBalance['id']);
                    $db->update('inv_product', $updateTime);
                }
            }

            if(!$invStockID || !$productTransaction || !$stockTransaction){
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01058"][$language] /* Failed to update stock. */,'data'=>'');
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00370"][$language], 'data' => "");
        }

        public function adjustInvStock($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $dateTimeFormat = "Y-m-d H:i:s";
            $todayDate      = date($dateTimeFormat);

            $stockID        = $params['stockID'];
            $quantity       = trim($params["quantity"]);
            $remark         = trim($params["remark"]);
            $type           = trim($params["type"]);
            $stockInDate    = date($dateTimeFormat, $params["stockInDate"]) ? : $todayDate;
            $typeArr        = array("in","out");
            $subject        = $type == "in" ? "Stock In" : "Stock Out";

            $userID = $db->userID;
            $site = $db->userType;

            if(!$stockID){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00841"][$language] /* Please Select Product */, 'data' => "");
            }else{
                $db->where('id',$stockID);
                $stock = $db->getOne('inv_stock','inv_product_id, stock_code');

                if(empty($stock)){
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
                }

                $invProductID = $stock['inv_product_id'];
                $stockCode = $stock['stock_code'];
            }

            if($site == "Member"){
                $clientID = $userID;
            }

            if(!$type || !in_array($type, $typeArr)){
                $errorFieldArr[] = array(
                        'id'  => "typeError",
                        'msg' => $translations["E00741"][$language]
                    );
            }

            if(!$quantity || $quantity <= 0 || !is_numeric($quantity)){
                $errorFieldArr[] = array(
                        'id'  => "quantityError",
                        'msg' => $translations['E00941'][$language] /* Quantity must be greater than 0 */
                    );
            }elseif($type == "out") {
                $db->where("stock_code", $stockCode);
                $currentBalance = $db->getValue("inv_stock", "SUM(stock_in - stock_out)");
                $stockBalance = ($currentBalance - $quantity);

                if($stockBalance < 0){
                    $errorFieldArr[] = array(
                            'id'  => "quantityError",
                            'msg' => $translations['E00955'][$language] /* Invalid product */
                        );
                }
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            // Update inv product total balance
            if($type == 'in') {
                $updateData = array(
                    'total_balance' => $db->inc($quantity)
                );
            } else if($type == 'out') {
                $updateData = array(
                    'total_balance' => $db->dec($quantity)
                );
            }
            $db->where('id', $invProductID);
            $copyDb = $db->copy();
            $db->update('inv_product', $updateData);

            if($type == 'in') {
                $amountIn = $quantity;

                $updateStock = array(
                        "stock_in"  => $db->inc($quantity),
                );
            } else if($type == 'out') {
                $amountOut = $quantity;

                $updateStock = array(
                        'stock_out' => $db->inc($quantity),
                );
            }
            $db->where('id',$stockID);
            $db->where('inv_product_id', $invProductID);
            $copyDB = $db->copy();
            $db->update('inv_stock', $updateStock);

            $invStockID = $copyDB->getValue("inv_stock", "id");

            $batchID    = $db->getNewID();

            // insert inv product transactions
            $insertProductTransaction = array(
                    "inv_product_id"    => $invProductID,
                    "client_id"         => $clientID,
                    "subject"           => $subject,
                    "amount_in"         => $amountIn,
                    "amount_out"        => $amountOut,
                    "data"              => $data,
                    "batch_id"          => $batchID,
                    "created_at"        => $todayDate,
                    "creator_id"        => $userID,
                    "creator_type"      => $site,
                    "remark"            => $remark,
            );
            $productTransaction = $db->insert("inv_product_transaction",$insertProductTransaction);

            // insert inv stock transactions
            $insertStockTransaction = array(
                    "inv_product_id"    => $invProductID,
                    "inv_stock_id"      => $invStockID,
                    "client_id"         => $clientID,
                    "subject"           => $subject,
                    "amount_in"         => $amountIn,
                    "amount_out"        => $amountOut,
                    "data"              => $data,
                    "batch_id"          => $batchID,
                    "created_at"        => $todayDate,
                    "creator_id"        => $userID,
                    "creator_type"      => $site,
                    "remark"            => $remark,
            );
            $stockTransaction = $db->insert("inv_stock_transaction",$insertStockTransaction);

            $lowStockAlert      = General::getSystemSettingAdmin('lowStockQuantity');

            if($lowStockAlert){
                $newestStockBalance = $copyDB->getOne('inv_product', 'id, total_balance, alert_at');
                $lowStockAlertValue = $lowStockAlert['lowStockQuantity']['value'];

                if($newestStockBalance['total_balance'] >= $lowStockAlertValue && $newestStockBalance['alert_at'] > 0){
                    $updateTime = array(
                        'alert_at'  =>  '0000-00-00 00:00:00',
                    );
                    $db->where('id', $newestStockBalance['id']);
                    $db->update('inv_product', $updateTime);
                }
            }

            if(!$invStockID || !$productTransaction || !$stockTransaction){
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E01058"][$language] /* Failed to update stock. */,'data'=>'');
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00370"][$language], 'data' => "");
        }

        public function getStockDetails($params){
            $db           = MysqliDb::getInstance();
            $translations = General::$translations;
            $language     = General::$currentLanguage;
            $searchData   = $params['searchData'];
            $seeAll       = $params['seeAll'];
            $pageNumber   = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit        = General::getLimit($pageNumber);
            $systemDateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $invProductID = $params["invProductID"];

            $userID       = $db->userID;
            $site         = $db->userType;

            if(!$invProductID){
                return array('status' => "ok", 'code' => 2, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            if($seeAll){
                $limit = NULL;
            }

            $db->where("inv_product_id",$invProductID);
            $copyDB = $db->copy();
            $db->orderBy("created_at", "DESC");
            $invStockRes = $db->get('inv_stock', $limit, "id, inv_product_id, supplier_id, stock_code, do_number, cost, stock_in, stock_out, stock_in_date, created_at, remark");

            if(!$invStockRes) {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            foreach($invStockRes as $invStockRow) {
                $supplierIDAry[$invStockRow["supplier_id"]] = $invStockRow["supplier_id"];
                $productID = $invStockRow["inv_product_id"];
            }

            if($supplierIDAry){
                $db->where("id", $supplierIDAry, "IN");
                $supplierNameAry = $db->map("id")->get("inv_supplier", null, "id, name, code");
            }

            foreach ($invStockRes as $invStockRow) {
                $value['id']            = $invStockRow['id'];
                $value['stockCode']       = $invStockRow['stock_code'];
                $value['doNumber']      = $invStockRow['do_number'] ? : '-';
                $value['cost']          = Setting::setDecimal($invStockRow['cost']);
                $value['quantity']      = Setting::setDecimal($invStockRow['stock_in'] - $invStockRow['stock_out']);
                $value['totalCost']     = Setting::setDecimal($invStockRow['cost'] * $value['quantity']);
                $value['stockInDate']   = $invStockRow['stock_in_date'] > 0 ? date($systemDateTimeFormat, strtotime($invStockRow['stock_in_date'])) : "-";
                $value['createdAt']     = date($systemDateTimeFormat, strtotime($invStockRow['created_at']));
                $value['remark']        = $invStockRow['remark'] ? : '-';
                $value['supplierName']  = $supplierNameAry[$invStockRow['supplier_id']]['name'];
                $value['supplierCode']  = $supplierNameAry[$invStockRow['supplier_id']]['code'];

                $productList[] = $value;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $totalRecord = $copyDB->getValue('inv_stock', 'COUNT(*)');
            $data['list']          = $productList;
            $data['pageNumber']    = $pageNumber;
            $data['totalRecord']   = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getStockTransactionHistory($params){
            $db           = MysqliDb::getInstance();
            $translations = General::$translations;
            $language     = General::$currentLanguage;
            $searchData   = $params['searchData'];
            $seeAll       = $params['seeAll'];
            $pageNumber   = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit        = General::getLimit($pageNumber);
            $systemDateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $invStockID = $params["invStockID"];

            $userID     = $db->userID;
            $site       = $db->userType;

            if(!$invStockID){
                return array('status' => "ok", 'code' => 2, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            if($seeAll){
                $limit = NULL;
            }

            $db->where("inv_stock_id",$invStockID);
            $copyDB = $db->copy();
            $db->orderBy("created_at", "DESC");
            $stockTransactionRes = $db->get('inv_stock_transaction', $limit, "inv_product_id, inv_stock_id, client_id, subject, amount_in, amount_out, created_at, creator_id, creator_type, remark, batch_id");

            if(!$stockTransactionRes) {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            foreach($stockTransactionRes as $stockTransactionRow) {
                $clientIDAry[$stockTransactionRow["client_id"]] = $stockTransactionRow["client_id"];
                $creatorIDAry[$stockTransactionRow["creator_id"]] = $stockTransactionRow["creator_id"];
                $stockIDAry[$stockTransactionRow["inv_stock_id"]] = $stockTransactionRow["inv_stock_id"];
                $batchIDAry[$stockTransactionRow["batch_id"]] = $stockTransactionRow['batch_id'];
            }

            if($clientIDAry) {
                $db->where("type", "Client");
                $db->where("id", $clientIDAry, "IN");
                $clientUsernameAry = $db->map("id")->get("client", null, "id, username");
            }

            if($creatorIDAry) {
                $db->where("id", $creatorIDAry, "IN");
                $creatorUsernameAry = $db->map("id")->get("admin", null, "id, username");
            }

            if($stockIDAry) {
                $db->where("id", $stockIDAry, "IN");
                $stockCodeAry = $db->map("id")->get("inv_stock", null, "id, stock_code, stock_in, stock_out");
            }

            if($batchIDAry) {
                $db->where("batch_id", $batchIDAry, "IN");
                $deliveryNoAry = $db->map("batch_id")->get("inv_delivery_order", null, "batch_id, reference_number");
            }

            foreach ($stockTransactionRes as $stockTransactionRow) {
                $value['stockCode']       = $stockCodeAry[$stockTransactionRow['inv_stock_id']]['stock_code'];
                $value['client']        = $stockTransactionRow['client_id'] > 0 ? $clientUsernameAry[$stockTransactionRow['client_id']] : '-';
                $value['subject']       = General::getTranslationByName($stockTransactionRow["subject"]);
                $value['amountIn']      = Setting::setDecimal($stockTransactionRow["amount_in"]);
                $value['amountOut']     = Setting::setDecimal($stockTransactionRow["amount_out"]);
                $value['createdBy']     = $stockTransactionRow['creator_id'] > 0 ? $creatorUsernameAry[$stockTransactionRow['creator_id']] : '-';
                $value['createrType']   = $stockTransactionRow['creator_type'] == "Admin" ? "Admin" : "System";
                $value['createdAt']     = date($systemDateTimeFormat, strtotime($stockTransactionRow['created_at']));

                $doNumber = $deliveryNoAry[$stockTransactionRow['batch_id']];
                $msg = str_replace(array("%%doNo%%", "%%name%%"), array($doNumber, $value['createdBy']), $translations['B00507'][$language]);
                if($stockTransactionRow['subject'] == 'Issue DO'){
                    $value['remark']    = $msg ? : '-';
                }else{
                    $value['remark']    = $stockTransactionRow['remark'] ? : '-';
                }

                $stockList[] = $value;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $totalRecord = $copyDB->getValue('inv_stock_transaction', 'COUNT(*)');
            $data['list']          = $stockList;
            $data['pageNumber']    = $pageNumber;
            $data['totalRecord']   = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getProductTransactionHistory($params){
            $db           = MysqliDb::getInstance();
            $translations = General::$translations;
            $language     = General::$currentLanguage;
            $searchData   = $params['searchData'];
            $seeAll       = $params['seeAll'];
            $pageNumber   = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit        = General::getLimit($pageNumber);
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $invProductID = $params["invProductID"];

            $userID       = $db->userID;
            $site         = $db->userType;

            if(!$invProductID){
                return array('status' => "ok", 'code' => 2, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            if($seeAll){
                $limit = NULL;
            }

            $db->where("inv_product_id",$invProductID);
            $copyDB = $db->copy();
            $db->orderBy("created_at", "DESC");
            $productTransactionRes = $db->get('inv_product_transaction', $limit, "inv_product_id, client_id, subject, amount_in, amount_out, created_at, creator_id, creator_type, remark, batch_id");

            if(!$productTransactionRes) {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => "");
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            foreach($productTransactionRes as $productTransactionRow) {
                $clientIDAry[$productTransactionRow["client_id"]] = $productTransactionRow["client_id"];
                $creatorIDAry[$productTransactionRow["creator_id"]] = $productTransactionRow["creator_id"];
                $batchIDAry[$productTransactionRow["batch_id"]] = $productTransactionRow['batch_id'];
                $productID = $productTransactionRow["inv_product_id"];
            }

            if($clientIDAry) {
                $db->where("type", "Client");
                $db->where("id", $clientIDAry, "IN");
                $clientUsernameAry = $db->map("id")->get("client", null, "id, username");
            }

            if($creatorIDAry) {
                $db->where("id", $creatorIDAry, "IN");
                $creatorUsernameAry = $db->map("id")->get("admin", null, "id, username");
            }

            if($batchIDAry) {
                $db->where("batch_id", $batchIDAry, "IN");
                $orderNoAry = $db->map("batch_id")->get("inv_order", null, "batch_id, reference_number");
            }

            foreach ($productTransactionRes as $productTransactionRow) {
                $value['client']        = $productTransactionRow['client_id'] > 0 ? $clientUsernameAry[$productTransactionRow['client_id']] : '-';
                $value['subject']       = General::getTranslationByName($productTransactionRow["subject"]);
                $value['amountIn']      = Setting::setDecimal($productTransactionRow["amount_in"]);
                $value['amountOut']     = Setting::setDecimal($productTransactionRow["amount_out"]);
                $value['createdBy']     = $productTransactionRow['creator_id'] > 0 ? $clientUsernameAry[$productTransactionRow['creator_id']] : '-';
                $value['createrType']   = $productTransactionRow['creator_type'] == "Admin" ? "Admin" : "System";
                $value['createdAt']     = date($dateTimeFormat, strtotime($productTransactionRow['created_at']));

                $poNumber = $orderNoAry[$productTransactionRow['batch_id']];
                $msg = str_replace(array("%%poNo%%", "%%name%%"), array($poNumber, $value['createdBy']), $translations['B00508'][$language]);
                if($productTransactionRow['subject'] == 'Buy Product'){
                    $value['remark']    = $msg ? : '-';
                }else{
                    $value['remark']    = $productTransactionRow['remark'] ? : '-';
                }

                $productList[] = $value;
            }

            $totalRecord = $copyDB->getValue('inv_product_transaction', 'COUNT(*)');
            $data['list']          = $productList;
            $data['pageNumber']    = $pageNumber;
            $data['totalRecord']   = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        function insertInvProductTransaction($invProduct, $clientID, $subject, $packageQuantity, $data, $batchID, $remark){
            $db = MysqliDb::getInstance();

            $userID     = $db->userID;
            $site       = $db->userType;
            $todayDate  = date("Y-m-d H:i:s");

            $decProductSubject = array("Buy Product");
            $incProductSubject = array("Cancel Product");
            $acceptedSubject = array_merge($decProductSubject, $incProductSubject);

            if($site == "Member"){
                $creatorType = "System";
            }

            if(!$invProduct || !in_array($subject, $acceptedSubject)){
                return false;
            }

            foreach ($invProduct as $invProductID => $invProductValue) {
                // Update inv product
                $quantity = $invProductValue * $packageQuantity;

                if(in_array($subject, $incProductSubject)) {
                    $amountIn = $quantity;

                    $updateData = array(
                        'total_balance' => $db->inc($quantity),
                        'total_pending' => $db->dec($quantity)
                    );
                } else if(in_array($subject, $decProductSubject)) {
                    $amountOut = $quantity;

                    $updateData = array(
                        'total_balance' => $db->dec($quantity),
                        'total_pending' => $db->inc($quantity)
                    );
                }
                $db->where('id', $invProductID);
                $db->update('inv_product', $updateData);

                // Insert inv product transactions
                $insertData = array(
                    "inv_product_id"    => $invProductID,
                    "client_id"         => $clientID,
                    "subject"           => $subject,
                    "amount_in"         => $amountIn,
                    "amount_out"        => $amountOut,
                    "data"              => $data,
                    "batch_id"          => $batchID,
                    "created_at"        => $todayDate,
                    "creator_id"        => $userID,
                    "creator_type"      => $site,
                    "remark"            => $remark,
                );
                $db->insert("inv_product_transaction",$insertData);
            }

            return true;
        }

        function insertInvStockTransaction($invProduct, $clientID, $subject, $data, $batchID, $remark, $type){
            $db = MysqliDb::getInstance();

            $userID     = $db->userID;
            $site       = $db->userType;
            $todayDate  = date("Y-m-d H:i:s");

            $decProductSubject = array("Issue DO");
            $incProductSubject = array("Cancel DO");
            $acceptedSubject = array_merge($decProductSubject, $incProductSubject);

            if($site == "Member"){
                $creatorType = "System";
            }

            if(!$invProduct || !in_array($subject, $acceptedSubject)){
                return false;
            }

            // Special handle for cancel DO
            if(in_array($type,array("cancelDelivery"))){
                foreach ($invProduct as $packageID => $packageDetail) {
                    foreach ($packageDetail as $invProductID => $stockDetail) {
                        foreach($stockDetail as $stockID => $invProductQuantity){
                            $invStockRes[$packageID][$invProductID]["quantity"] = $invProductQuantity;

                            $db->where("id",$stockID);
                            $invStock = $db->map("id")->get("inv_stock",null,"id,inv_product_id,stock_code,stock_in,stock_out");

                            $invStockRes[$packageID][$invProductID]["invStock"] = $invStock;
                        }
                    }
                }
            }else{
                foreach ($invProduct as $packageID => $packageDetail) {
                    foreach ($packageDetail as $invProductID => $invProductQuantity) {
                        $invStockRes[$packageID][$invProductID]['quantity'] = $invProductQuantity;

                        $db->where('inv_product_id', $invProductID);
                        $invStock = $db->map('id')->get('inv_stock', null, 'id, inv_product_id, stock_code, stock_in, stock_out');
                        $invStockRes[$packageID][$invProductID]['invStock'] = $invStock;
                    }
                }
            }

            unset($packageID);
            unset($packageDetail);

            foreach ($invStockRes as $packageID => $packageDetail) {
                unset($quantity);
                unset($realQuantity);
                foreach ($packageDetail as $invProductID => $invStockRow) {
                    if(in_array($subject, $decProductSubject)){
                        if(!$quantity) $quantity = $invStockRow['quantity'];
                        if(!$realQuantity) $realQuantity = $invStockRow['quantity'];
                    }else{
                        $quantity = $invStockRow['quantity'];
                    }

                    foreach ($invStockRow['invStock'] as $invStockID => $invStock) {
                        if(in_array($subject, $incProductSubject)){
                            $amountIn = $quantity;

                            $updateStock = array(
                                'stock_out' => $db->dec($quantity)
                            );
                        }elseif(in_array($subject, $decProductSubject)){
                            $currentStockBalance = $invStock['stock_in'] - $invStock['stock_out'];

                            if($currentStockBalance <= 0){
                                continue;
                            }

                            if($currentStockBalance <= $quantity){
                                $quantity = $currentStockBalance;
                                $quantityLeft = $realQuantity - $quantity;
                            }else{
                                $quantityLeft = 0;
                            }

                            $amountOut = $quantity;

                            $updateStock = array(
                                'stock_out' => $db->inc($quantity)
                            );
                        }
                        $db->where('id', $invStockID);
                        $db->where('inv_product_id', $invProductID);
                        $db->update('inv_stock', $updateStock);

                        // Insert Inv Product Transactions
                        $insertData = array(
                            "inv_product_id"    => $invProductID,
                            "inv_stock_id"      => $invStockID,
                            "client_id"         => $clientID,
                            "subject"           => $subject,
                            "amount_in"         => $amountIn,
                            "amount_out"        => $amountOut,
                            "data"              => $data,
                            "batch_id"          => $batchID,
                            "created_at"        => $todayDate,
                            "creator_id"        => $userID,
                            "creator_type"      => $site,
                            "remark"            => $remark,
                        );
                        $stockTransaction = $db->insert("inv_stock_transaction",$insertData);

                        // Update inv product total balance
                        switch ($type) {
                            case 'delivery':
                                if(in_array($subject, $decProductSubject)){
                                    $updateData = array(
                                        'total_pending' => $db->dec($quantity),
                                        'total_shipped' => $db->inc($quantity)
                                    );
                                }
                                break;

                            case 'pickup':
                                if(in_array($subject, $decProductSubject)){
                                    $updateData = array(
                                        'total_pending' => $db->dec($quantity),
                                        'total_received' => $db->inc($quantity)
                                    );
                                }
                                break;

                            case 'cancelDelivery':
                                if(in_array($subject, $incProductSubject)){
                                    $updateData = array(
                                        'total_pending' => $db->inc($quantity),
                                        'total_shipped' => $db->dec($quantity)
                                    );
                                }
                                break;

                            case 'cancelPickup':
                                if(in_array($subject, $incProductSubject)){
                                    $updateData = array(
                                        'total_pending' => $db->inc($quantity),
                                        'total_received' => $db->dec($quantity)
                                    );
                                }
                                break;
                        }
                        $db->where('id', $invProductID);
                        $invProduct = $db->update('inv_product', $updateData);

                        $invStockDetail[$packageID][$invProductID][$invStockID] = $invStockRow['quantity'];

                        if(in_array($subject, $decProductSubject)){
                            if($quantityLeft || $quantityLeft > 0){
                                $quantity = $quantityLeft;
                            }else{
                                break;
                            }
                        }
                    }
                }
            }

            return $invStockDetail;
        }

        // -------- Member Product -------- //
        public function getProductIDForSearch($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $search = trim($params['searchWord']);

            if(!$search) {
                return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => '');
            }

            $db->where('module', 'mlm_product');
            $db->where('content', '%'.$search.'%', 'LIKE');
            $db->where('type', 'name');
            $productID = $db->getValue('inv_language', 'module_id', null);
            if(!$productID) {
                return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => '');
            }

            $data['productID'] = $productID;
            return array('status' => 'ok', 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getBuyProductList($params, $onlyProduct){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");

            $searchData = $params['searchData'];
            $sortByData = $params['sortByData'];
            $pageNumber = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit = General::getLimit($pageNumber, 30);

            $userID = $db->userID;
            $site = $db->userType;

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {

                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'minPrice':
                            $db->where('price', $dataValue, ">=");
                            break;

                        case 'maxPrice':
                            $db->where('price', $dataValue, "<=");
                            break;

                        case 'category':

                            $subProductIDAry = $db->subQuery();
                            $subProductIDAry->where('value', '%'.$dataValue.'%', 'LIKE');
                            $subProductIDAry->where('name', 'packageCategory');
                            $subProductIDAry->get('mlm_product_setting', null, 'product_id');

                            $db->where('id', $subProductIDAry, 'IN');
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $db->where('status', 'Active');
            $db->where('active_at', $dateTime, '<=');
            $db->orderBy('created_at', 'DESC');
            $copyDB = $db->copy();

            $column = array(
                'id',
                'name',
                'code',
                'price'
            );
            $productRes = $db->get('mlm_product', $limit, $column);

            // category
            $categoryRes = $db->get('inv_category', null, 'id, type');
            foreach($categoryRes as $categoryRow) {
                $categoryIDAry[$categoryRow['id']] = $categoryRow['id'];
                $categoryData[$categoryRow['id']]['type'] = $categoryRow['type'];
            }

            if($categoryIDAry){
                $db->where('module_id', $categoryIDAry, 'IN');
                $db->where('module', 'inv_category');
                $db->where('language', $language);
                $db->where('type', 'name');
                $categoryDisplayRes = $db->get('inv_language', null, 'module_id, content');
                foreach($categoryDisplayRes as $cDisplayRow) {
                    $categoryDisplay[$cDisplayRow['module_id']]['id'] = $cDisplayRow['module_id'];
                    $categoryDisplay[$cDisplayRow['module_id']]['display'] = $cDisplayRow['content'];
                }
            }

            $data['categoryList'] = $categoryDisplay;
            if(!$productRes) {
                return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations['B00101'][$language] /* No Results Found */, 'data' => $data);
            }

            foreach($productRes as $productRow) {
                $productIDAry[$productRow['id']] = $productRow['id'];
                // $productIDLangCodeAry[$productRow['id']] = $productRow['translation_code'];
                // $productLangCodeAry[$productRow['translation_code']] = $productRow['translation_code'];
                // $descriptionLangCodeAry[$productRow['description']] = $productRow['description'];
            }

            if($productIDAry) {
                $db->where('product_id', $productIDAry, 'IN');
                $pSettingRes = $db->get('mlm_product_setting', null, 'product_id, name, value, type');

                $psetFilterAry = array('Inactive Image', 'Inactive Video');
                foreach($pSettingRes as $pSetRow) {
                    // do checking if is Image / Video
                    if(in_array($pSetRow['type'], $psetFilterAry)) continue;

                    $productDisplay[$pSetRow['product_id']][$pSetRow['name']] = $pSetRow['value'];

                    if($pSetRow['type'] == "packageCategory"){
                        $packageCategory[$pSetRow['product_id']][$pSetRow['name']][] = $pSetRow['value'];
                    }
                }

                $db->where('module_id', $productIDAry, 'IN');
                $db->where('module', 'mlm_product');
                $db->where('language', $language);
                $db->where('type', array('name', 'desc'), 'IN');
                $productDisplayRes = $db->get('inv_language', null, 'module_id, type, content');
                foreach($productDisplayRes as $pDisplayRow) {
                    $productDisplay[$pDisplayRow['module_id']][$pDisplayRow['type']] = $pDisplayRow['content'];
                }
            }

            foreach($productRes as $productRow) {
                $productRow['price'] = Setting::setDecimal($productRow['price']);

                $productRow['nameDisplay'] = $productDisplay[$productRow['id']]['name'];
                $productRow['description'] = $productDisplay[$productRow['id']]['desc'];

                $productRow['image'] = $productDisplay[$productRow['id']]['Image'];
                $productRow['video'] = $productDisplay[$productRow['id']]['Video'];

                unset($tmp);
                unset($category);

                $tmp = $packageCategory[$productRow['id']]['packageCategory'];
                foreach ($tmp as $value) {
                    $category[] = $categoryDisplay[$value]['display'];
                }
                $productRow['packageCategory'] = implode(', ', $category);

                $productList[] = $productRow;
            }

            $totalRecord = $copyDB->getValue("mlm_product", "count(*)");

            $data['productList'] = $productList;
            $data['categoryList'] = $categoryDisplay;
            $data['pageNumber'] = $pageNumber;
            $data['totalRecord'] = $totalRecord;
            $data['totalPage']    = ceil($totalRecord/$limit[1]);
            $data['numRecord']    = $limit[1];

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getBuyProductDetails($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");

            $clientID = $db->userID;
            $site = $db->userType;

            $productCode = trim($params['productCode']);

            if (!$productCode) {
                return array('status' => 'error', 'code' => 2, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product */, 'data' => '');
            }

            $db->where('code', $productCode);
            $db->where('status', 'Active');

            $productRes = $db->getOne('mlm_product', 'id, code, name, pv_price');
            if (!$productRes) {
                return array('status' => 'error', 'code' => 2, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product */, 'data' => '');
            }

            if($productRes['id']){
                $db->where('module_id', $productRes['id']);
                $db->where('module', 'mlm_product');
                $db->where('language', $language);
                $db->where('type', array('name', 'desc'), 'IN');
                $packageDisplayRes = $db->get('inv_language', null, 'module_id, type, content');
                foreach($packageDisplayRes as $pDisplayRow) {
                    $packageDisplay[$pDisplayRow['type']] = $pDisplayRow['content'];
                }
            }

            if($clientID){
                $db->where('id', $clientID);
                $countryID = $db->getValue('client', 'country_id');
            }

            if(!$countryID) $countryID = 100; // default indonesia

            $db->where('product_id', $productRes['id']);
            $db->where('country_id', $countryID);
            $db->where('disabled', '0');
            $productPriceRes = $db->getOne('mlm_product_price', 'price, promo_price, m_price, ms_price');
            if(!$productPriceRes){
                $countryID = 100;
                $db->where('product_id', $productRes['id']);
                $db->where('country_id', $countryID);
                $db->where('disabled', '0');
                $productPriceRes = $db->getOne('mlm_product_price', 'price, promo_price, m_price, ms_price');
            }

            $categoryRes = $db->get('inv_category', null, 'id, type');
            foreach($categoryRes as $categoryRow) {
                $categoryIDAry[$categoryRow['id']] = $categoryRow['id'];
                $categoryData[$categoryRow['id']]['type'] = $categoryRow['type'];
            }

            if($categoryIDAry){
                $db->where('module_id', $categoryIDAry, 'IN');
                $db->where('module', 'inv_category');
                $db->where('language', $language);
                $db->where('type', 'name');
                $categoryDisplayRes = $db->get('inv_language', null, 'module_id, content');
                foreach($categoryDisplayRes as $cDisplayRow) {
                    $categoryDisplay[$cDisplayRow['module_id']]['id'] = $cDisplayRow['module_id'];
                    $categoryDisplay[$cDisplayRow['module_id']]['display'] = $cDisplayRow['content'];
                }
            }

            $productDetailID = $productRes['id'];
            $db->where('product_id', $productDetailID);
            $pSettingRes = $db->get('mlm_product_setting', null, 'name, value, type');

            $psetFilterAry = array('Inactive Image', 'Inactive Video');
            foreach($pSettingRes as $pSetRow) {
                // do checking if is Image / Video
                if(in_array($pSetRow['type'], $psetFilterAry)) continue;
                $productDisplay[$pSetRow['name']][] = $pSetRow['value'];

                if($pSetRow['type'] == "packageCategory"){
                    $packageCategory[$pSetRow['name']][] = $pSetRow['value'];
                }
            }

            $db->where('module_id', $productDetailID);
            $db->where('module', 'mlm_product');
            $db->where('language', $language);
            $db->where('type', array('name', 'desc'), 'IN');
            $productDisplayRes = $db->get('inv_language', null, 'module_id, type, content');
            foreach($productDisplayRes as $pDisplayRow) {
                $productDisplay[$pDisplayRow['module_id']][$pDisplayRow['type']] = $pDisplayRow['content'];
            }

            $db->where('name', 'validPackage');
            $db->where('value', '%'.$productDetailID.'%', 'LIKE');
            $allProductIDAry = $db->getValue('inv_product_detail', 'inv_product_id', null);

            $db->where('module_id', $allProductIDAry, 'IN');
            $db->where('module', 'inv_product');
            $db->where('language', $language);
            $db->where('type', array('name', 'desc'), 'IN');
            $invProductDisplayRes = $db->get('inv_language', null, 'module_id, type, content');
            foreach($invProductDisplayRes as $ipDisplayRow) {
                $invProductDisplay[$ipDisplayRow['module_id']][$ipDisplayRow['type']] = $ipDisplayRow['content'];
            }

            $db->where('id', $allProductIDAry, 'IN');
            $db->where('status', 'Active');
            $productData = $db->map('id')->get('inv_product', null, 'id, code, name, weight');

            // prepare output data
            $data['id'] = $productRes['id'];
            $data['code'] = $productRes['code'];
            $data['name'] = $productRes['name'];
            $data['pvPrice'] = $productRes['pv_price'];
            $data['price'] = $productPriceRes['price'];
            $data['promoPrice'] = $productPriceRes['promo_price'];
            $data['mPrice'] = $productPriceRes['m_price'];
            $data['msPrice'] = $productPriceRes['ms_price'];
            $data['img'] = $productDisplay['Image'];
            $data['vid'] = $productDisplay['Video'];
            $data['nameDisplay'] = $packageDisplay['name'];
            $data['description'] = $packageDisplay['desc'];

            $tmp = $packageCategory['packageCategory'];
            foreach ($tmp as $value) {
                $category[] = $categoryDisplay[$value]['display'];
            }
            $data['category'] = $category;

            foreach ($productData as $key => &$value) {
                $value['nameDisplay'] = $invProductDisplay[$value['id']]['name'];
                $value['description'] = $invProductDisplay[$value['id']]['desc'];

                unset($value['id']);
            }
            $data['productList'] = $productData;

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        // -------- Member Address -------- //
        public function verifyAddress($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $isDefault          = trim($params["isDefault"]); // 1 or 0, pass into address table, column type
            $addressType        = trim($params["addressType"]); //  delivery or billing
            $fullname           = trim($params["fullname"]);
            $dialingArea        = trim($params['dialingArea']);
            $phone              = trim($params['phone']);
            $email              = trim($params['email']);
            $address            = trim($params["address"]);
            $district           = trim($params['districtID']);
            $subDistrict        = trim($params['subDistrictID']);
            $city               = trim($params['cityID']);
            $postalCode         = trim($params['postalCodeID']);
            $state              = trim($params['stateID']);
            $countryID          = trim($params["countryID"]);
            $disabled           = trim($params["disabled"]); // 1 or 0

            $isDefaultInput = array(1,0);
            if(!in_array($isDefault, $isDefaultInput)){
                $errorFieldArr[] = array(
                                    "id" => "isDefaultInput",
                                    "msg" => $translations["E00125"][$language],
                                );
            }

            $addressTypeInput = array("billing","delivery");
            if(empty($addressType) || !in_array($addressType, $addressTypeInput)) {
                $errorFieldArr[] = array(
                    'id'  => "addressTypeError",
                    'msg' => $translations["E01026"][$language]
                );
            }

            if(empty($fullname)) {
                $errorFieldArr[] = array(
                    'id'  => "fullnameError",
                    'msg' => $translations['E00296'][$language] // Please insert full name
                );
            }

            if(empty($dialingArea) || empty($phone)) {
                    $errorFieldArr[] = array(
                        'id' => 'phoneError',
                        'msg' => $translations["E00305"][$language] /* Please fill in phone number */
                    );
            }else {
                if(!preg_match('/^[0-9]*$/', $phone, $matches)) {
                    $errorFieldArr[] = array(
                        'id' => 'phoneError',
                        'msg' => $translations["E00858"][$language] /* Only number is allowed */
                    );
                }
            }

            if(empty($email)) {
                $errorFieldArr[] = array(
                    'id' => 'emailError',
                    'msg' => $translations["E00318"][$language] /* Please fill in email */
                );
            }else {
                if ($email) {
                    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                        $errorFieldArr[] = array(
                            'id' => 'emailError',
                            'msg' => $translations["E00319"][$language] /* Invalid email format. */
                            );
                    }
                }
            }

            if(empty($address)) {
                $errorFieldArr[] = array(
                    'id'  => "addressError",
                    'msg' => $translations['E00943'][$language]
                );
            }

            // if(empty($streetName)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "streetNameError",
            //         'msg' => $translations['E01027'][$language]
            //     );
            // }

            // if(empty($subDistrict)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "subDistrictError",
            //         'msg' => $translations['E01028'][$language]
            //     );
            // }

             // Validate district
            // if(!is_numeric($district) || empty($district)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "districtErrror",
            //         'msg' => $translations['E01113'][$language]
            //     );
            // }else {
            //     $db->where("id",$district);
            //     $db->where("country_id",$countryID);
            //     $db->where("disabled",0);
            //     $districtRes = $db->getOne("county","name,translation_code");
            //     if(!$districtRes){
            //         $errorFieldArr[] = array(
            //             "id"  => "districtErrror",
            //             "msg" => $translations["E01113"][$language]
            //         );
            //     }
            // }

            // Validate sub district
            // if(!is_numeric($subDistrict) || empty($subDistrict)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "subDistrictError",
            //         'msg' => $translations['E01028'][$language]
            //         );
            // }else{
            //     $db->where("id",$subDistrict);
            //     $db->where("country_id",$countryID);
            //     $db->where("disabled",0);
            //     $subDistrictRes = $db->getOne("sub_county","name,translation_code");
            //     if(!$subDistrictRes){
            //         $errorFieldArr[] = array(
            //             "id"  => "subDistrictError",
            //             "msg" => $translations["E01028"][$language]
            //         );
            //     }
            // }

            // Validate postalCode
            // if(!is_numeric($postalCode) || empty($postalCode)) {
            //     $errorFieldArr[] = array(
            //         'id'  => "postalCodeError",
            //         'msg' => $translations['E01030'][$language]
            //     );
            // }else{
            //     $db->where("id",$postalCode);
            //     $db->where("country_id",$countryID);
            //     $db->where("disabled",0);
            //     $postalCodeRes = $db->getOne("zip_code","name,translation_code");
            //     if(!$postalCodeRes){
            //         $errorFieldArr[] = array(
            //             "id"  => "postalCodeError",
            //             "msg" => $translations["E01029"][$language]
            //         );
            //     }
            // }

            // Validate city
            // if(!is_numeric($city) || empty($city)) {
            // if($city != '' || $city != null) {
            //     $errorFieldArr[] = array(
            //         'id'  => "cityError",
            //         'msg' => $translations['E01029'][$language]
            //     );
            // }else{
            //     $db->where("id",$city);
            //     $db->where("country_id",$countryID);
            //     $db->where("disabled",0);
            //     $cityRes = $db->getOne("city","name,translation_code");
            //     if(!$cityRes){
            //         $errorFieldArr[] = array(
            //             "id"  => "cityError",
            //             "msg" => $translations["E01029"][$language]
            //         );
            //     }
            // }

            // if(!is_numeric($state) || empty($state)) {
            // if($state != '' || $state != null) {
            //     $errorFieldArr[] = array(
            //         'id'  => "stateError",
            //         'msg' => $translations['E00667'][$language]
            //       );
            // }else{
            //     $db->where("id",$state);
            //     $db->where("country_id",$countryID);
            //     $db->where("disabled",0);
            //     $stateRes = $db->getOne("state","name,translation_code");
            //     if(!$stateRes){
            //         $errorFieldArr[] = array(
            //             "id"  => "stateError",
            //             "msg" => $translations["E01029"][$language]
            //         );
            //     }
            // }

            if(!is_numeric($countryID) || empty($countryID)) {
                $errorFieldArr[] = array(
                    'id'  => "countryIDError",
                    'msg' => $translations['E00947'][$language]
                );
            }else{
                $db->where("id",$countryID);
                $countryRes = $db->getOne("country","name,translation_code");
                if(!$countryRes){
                    $errorFieldArr[] = array(
                        "id"  => "countryIDError",
                         "msg" => $translations["E01029"][$language]
                    );
                 }
            }

            $disableInput = array(1,0);
            if(!in_array($disabled, $disableInput)){
                $errorFieldArr[] = array(
                            "id" => "disableInputError",
                            "msg" => $translations["E00125"][$language],
                );
            }

            return $errorFieldArr;
        }

        public function manageAddress($params,$type){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $todayDate = date("Y-m-d H:i:s");
            $db2 = $db->copy();
            $clientID = $db->userID;
            $site = $db->userType;
        
            if($site == 'Admin') $clientID = trim($params["clientID"]);
        
            $isDefault          = trim($params["isDefault"]); // 1 or 0, pass into address table, column type
            $addressType        = trim($params["addressType"]); //  delivery or billing
            $fullname           = trim($params["fullName"]);
            // $dialingArea        = trim($params['dialingArea']);
            $clientPhone        = trim($params['phone']);
            $email              = trim($params['email']);
            $address            = trim($params["address"]);
            $address2           = trim($params['address2']);
            // $subDistrict        = trim($params['subDistrictID']);
            $city               = trim($params['cityID']);
            $postalCode         = trim($params['postalCodeID']);
            $state              = trim($params['stateID']);
            // $countryID          = trim($params["countryID"]);
            $addressId          = trim($params["id"]);
            $countryID          = '129';
            $disabled           = trim($params["disabled"]); // 1 or 0
            $saleID             = $params['saleID'];

            // return array('status' => "error", 'code' => 1, 'statusMsg' => "Please add Address", 'data' => $clientPhone);
            if($clientID == null || $clientID == '')
            {
                $clientID              = trim($params['clientID']);
            }
        
            if($type == "edit" || $type == "delete"){
                $id = $params["clientID"];
                $db->where("client_id",$id);
                $db->where('id', $addressId);
                $id = $db->get("address",null,"id");
                foreach($id as $row)
                {
                    $addressId['id'] = $row['id'];
        
                    $addressIdList[] = $addressId['id'];
                }
                if(!$addressIdList) return array('status' => "error", 'code' => 1, 'statusMsg' => "Please add Address", 'data' => "");
            }
            // return array("code" => 110, "status" => "ok", "addressId" => $addressId, "addressIdList" => $addressIdList);
            if($type != "delete"){
                // $errorFieldArr = self::verifyAddress($params);
                if(empty($fullname)) {
                    $errorFieldArr[] = array(
                        'id'  => "fullNameError",
                        'msg' => $translations['E00296'][$language]/* Please insert full name */
                    );
                }
                if(empty($address)) {
                    $errorFieldArr[] = array(
                        'id'  => "addressError",
                        'msg' => $translations['E00943'][$language]
                    );
                }
                if(empty($address2)) {
                    $errorFieldArr[] = array(
                        'id'  => "addressError",
                        'msg' => $translations['E01273'][$language]
                    );
                }
                if(empty($city)) {
                    $errorFieldArr[] = array(
                        'id'  => "cityError",
                        'msg' => $translations['E01029'][$language] /* Please insert City */
                    );
                }
                if(empty($postalCode)) {
                    $errorFieldArr[] = array(
                        'id'  => "userZipCodeError",
                        'msg' => $translations['E00946'][$language]/* Please insert Post Code */
                    );
                }

                if(empty($state)) {
                    $errorFieldArr[] = array(
                        'id'  => "stateIDError",
                        'msg' => $translations['M03427'][$language]/* Please Select State */
                    );
                }
                if($email){
                    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                        $errorFieldArr[] = array(
                            'id'  => "userEmailAddressError",
                            'msg' => $translations['E00121'][$language]/* Invalid email format. */
                        );
                    } 
                }
                if($postalCode){
                    $pattern = '/^[0-9]{5}$/'; 
                    if (!preg_match($pattern, $postalCode)) {
                        $errorFieldArr[] = array(
                            'id'  => "userZipCodeError",
                            'msg' => $translations['E01239'][$language]/* Invalid zip code */
                        );
                    } 
                }
                if(!$clientPhone){
                    $errorFieldArr[] = array(
                        'id'  => "userPhoneError",
                        'msg' => $translations['E00305'][$language]/* Please fill in mobile number */
                    );
                }
                if($clientPhone){
                    $db->where('id',$clientID);
                    $clientDetail = $db->getOne('client','member_id, name, email, dial_code, phone');
                    $phone = $clientDetail['dial_code'].$clientPhone;

                    if (substr($phone, 0, 2) === '60') {
                        if (substr($phone, 2, 2) === '60') {
                            $phone = substr($phone, 2);
                        }
                    }
    
                    $mobileNumberCheck = General::mobileNumberInfo($phone, "MY");
                    if($mobileNumberCheck['isValid'] != 1){
                        $errorFieldArr[] = array(
                            'id'  => "userPhoneError",
                            'msg' => $translations['E01093'][$language]/* Invalid phone number */
                        );
                    }
    
                    $clientPhone = $mobileNumberCheck['phone'];
                }
                // $db->where('name',$state);
                // $state_id = $db->getOne('state','id');
                // if($state_id == '' || $state_id == null)
                // {
                //     // $state_id = 0;
                //     return array('status' => "error", 'code' => 1, 'statusMsg' => 'Cannot find the State', 'data' => $data);
                // }
                // else
                // {
                    // $state_id = intval($state_id);
                // }
            }
            if($errorFieldArr){
                 $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            // Error Checking 
        
            // $dialingArea = str_replace("+", "", $dialingArea);
            // if ($address2 != '' || $address2 != null)
            // {
            //     $address = $address.', '.$address2;
            // }
        
            // get client details
            $db->where('id',$clientID);
            $clientDetail = $db->getOne('client','member_id, name, email, dial_code, phone');
            // foreach($clientDetail as $detail)
            // {
            // $fullName = $clientDetail['name'];
            // $email = $clientDetail['email'];
            // $clientPhone = $clientDetail['dial_code'].$clientDetail['phone'];
            // }
            // if($fullName){
            //     $pattern = '/^[a-zA-Z0-9_]+$/';
    
            //     if (!preg_match($pattern, $fullName)) {
            //         return array('status' => 'error', 'code' => 1, 'statusMsg' => 'Invalid Name Format', 'data' => '');
            //     } 
            // }

            
        
            // check got existing address or not
            $db->where('client_id',$clientID);
            $db->where('name',$fullname);
            $existAddress = $db->get('address');            
            // if($type == "add")
            // {
            //     if($existAddress)
            //     {
            //         return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00740"][$language] /* Address Already Used. */, 'data' => $data);
            //     }
            // }

        
            $data = array(
                "type" => $isDefault,
                "client_id" => $clientID,
                "name" => $fullname,
                "email" => $email,
                "phone" => $clientPhone,
                "address" => $address,
                "address_2" => $address2,
                "state_id" => $state,
                "city" => $city,
                "post_code" => $postalCode,
                "country_id" => $countryID,
                "address_type" => $addressType,
                "disabled" =>$disabled,
                "updated_at" => $todayDate,
            );
        

            $addressChecking['clientID']            = $clientID;
            $addressChecking['billingName']         = $fullname;
            $addressChecking['billingEmail']        = $email;
            $addressChecking['billingPhone']        = $clientPhone;
            $addressChecking['billingAddress']      = $address;
            $addressChecking['billingAddressLine2'] = $address2;
            $addressChecking['billingPostCode']     = $postalCode;
            $addressChecking['billingCity']         = $city;
            $addressChecking['billingState']        = $state;
            $addressChecking['billingCountry']      = $countryID;

            $checkAddress = Admin::checkAddressDuplication($addressChecking);
            // check for default
            // only update all address to 0 if current address is set default
            if($isDefault){
                $db->where("client_id",$clientID);
                // $db->where("address_type",'billing','!=');
                $db->update("address",array("type"=>"0"));
            }
            if($type == "add"){
                $data["created_at"] = $todayDate;
                // check got existing billing address or not, if not , insert
                if($checkAddress['status'] != 'error'){
                    $addressID = $db->insert("address",$data);
                }
                $msg = $translations["B00422"][$language]; // Add Successfully
            }else {
                // delete or edit
                // $db->where("id",$id);
                // disable previous address with id $id
                // $db->update("address",array("disabled"=>"1", "updated_at"=>$todayDate));
                if($type == "edit"){

                    if($checkAddress['status'] == 'error' && $checkAddress['data'] != $addressId){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => "This address already exists in your address book", 'data' => '');
                    }
                    // return array("code" => 110, "status" => "ok", "clientID" => $clientID, "addressId" => $addressId);
                    //  return array("code" => 110, "status" => "ok", "clientID" => $clientID, "addressType" => $addressType, "fullname" => $fullname, "address" => $address);
                    $data["created_at"] = $todayDate;
                    $db->where("client_id",$clientID);
                    $db->where('id',$addressId);
                    // $db->where('address_type',$addressType);
                    // $db->where('name', $fullname);
                    // $db->where('address',$address);
                    // $db->where("id",$id);
                    $db->update("address",$data);

                }
                else if($type == "delete")
                {
                    $db->where('id',$addressId);
                    $db->where('client_id',$clientID);
                    $deleteStatus = $db->delete('address');
                    if($deleteStatus)
                    {
                        $msg = $translations["B00373"][$language]; // Update Successfully
                    }
                    else
                    {
                        $msg = $translations["E00743"][$language]; // Failed to Update
                    }
        
                }
            }

            if($saleID)
            {
                # update sale id address
                if($addressType == 'billing')
                {
                    $updateData = array(
                        'billing_name'      => $fullname,
                        'billing_phone'     => $clientPhone,
                        'billing_address'   => $address,
                        'billing_address2'  => $address2,
                        'billing_post_code' => $postalCode,
                        'billing_state_id'  => $state,
                        'billing_city'      => $city,
                    );
                    $db->where('id', $saleID);
                    $db->update('sale_order', $updateData);
                }
                else if ($addressType  == 'shipping')
                {
                    $updateData = array(
                        'shipping_name'      => $fullname,
                        'shipping_phone'     => $clientPhone,
                        'shipping_address'   => $address,
                        'shipping_address2'  => $address2,
                        'shipping_post_code' => $postalCode,
                        'shipping_state_id'  => $state,
                        'shipping_city'      => $city,
                    );
                    $db->where('id', $saleID);
                    $db->update('sale_order', $updateData);
                }
            }
            $data['address_id_shipping'] = $addressID;
            $data['address_id_billing'] = $addressIDBilling;
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $msg, 'data' => $data);
        }

        public function getAddress($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $addressID = $params['id'];

            $clientID = $db->userID;
            $site = $db->userType;

            $db->where("id", $addressID);
            $db->where("client_id",$clientID);

            $address = $db->getOne("address","id,name,email,phone,address,address_2,state_id AS stateID,district_id AS districtID ,sub_district_id AS subDistrictID,remarks,city AS cityID,post_code AS postCodeID,type,country_id AS countryID,address_type AS addressType");

            $resultStateList = Country::getState();
            foreach($resultStateList as $stateValue) {
                $stateList[$stateValue['country_id']][] = $stateValue;
            }

            $data["addressDetails"] = $address;
            $countryParams = array("pagination" => "No");
            $resultCountryList = Country::getCountriesList($countryParams);
            $data['countryList'] = $resultCountryList['data']['countriesList'];
            $data['stateList'] = $stateList;
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getAddressList($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $searchData     = $params['searchData'];
            $seeAll         = $params['seeAll'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit          = General::getLimit($pageNumber);
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $userID = $db->userID;
            $site = $db->userType;

            if (count($searchData) > 0) {

                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {

                        case "mainLeaderUsername":
                            $db->where('username', $dataValue);
                            $mainLeaderID  = $db->getValue('client', 'id');
                            $mainDownlines = Leader::getLeaderDownlines($mainLeaderID);

                            if(empty($mainDownlines)) return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
                            $db->where('client_id', $mainDownlines, "IN");

                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }

                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataType = trim($v['dataType']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'name':
                            if($dataType == "like"){
                                $db->where("name","%".$dataValue."%","LIKE");
                            }else{
                                $db->where("name", $dataValue);
                            }
                            break;
                        case 'username':
                            if ($dataType == "like") {
                                $sq = $db->subQuery();
                                $sq->where("username", $dataValue . "%", "LIKE");
                                $sq->get("client", NULL, "id");
                                $db->where("client_id", $sq, "IN");
                            } else{
                                $sq = $db->subQuery();
                                $sq->where("username", $dataValue);
                                $sq->getOne("client", "id");
                                $db->where("client_id", $sq);
                            }

                            break;
                        case 'phone':
                            $db->where("phone", $dataValue);
                            break;

                        case 'address':
                            $db->where('address', '%'.$dataValue.'%', 'LIKE');
                            break;
                    }

                    unset($dataName);
                    unset($dataValue);
                }
            }

            if($site == 'Member'){
                $db->where("client_id", $userID);
                $db->where("disabled", 0);
            }

            $copyDb = $db->copy();
            $totalRecord = $copyDb->getValue ("address", "count(*)");

            $db->orderBy("type", "DESC");
            $db->orderBy("created_at", "DESC");

            if($seeAll == "1"){
                $limit = array(0, $totalRecord);
            }

            $result = $db->get("address",$limit,"id,type,client_id,name,email,phone,address, address_2,district_id,sub_district_id,post_code,city,state_id,country_id,address_type,remarks,created_at,updated_at");

            if (empty($result))return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["E00714"][$language], 'data' => "");

            unset($clientIDAry,$districtIDAry,$subDistrictIDAry,$postCodeIDAry,$cityIDAry,$stateIDAry,$countryIDAry);

            foreach($result as $value){
                $clientIDAry[$value["client_id"]] = $value["client_id"];
                $districtIDAry[$value["district_id"]] = $value["district_id"];
                $subDistrictIDAry[$value["sub_district_id"]] = $value["sub_district_id"];
                $postCodeIDAry[$value["post_code"]] = $value["post_code"];
                $cityIDAry[$value["city"]] = $value["city"];
                $stateIDAry[$value["state_id"]] = $value["state_id"];
                $countryIDAry[$value["country_id"]] = $value["country_id"];
            }

            if($clientIDAry){
                $db->where("id",$clientIDAry,"IN");
                $clientRes = $db->map("id")->get("client",null,"id,member_id,username");
            }

            if($districtIDAry){
                $db->where("id",$districtIDAry,"IN");
                $districtRes = $db->map("id")->get("county",null,"id,name,translation_code");
            }

            if($subDistrictIDAry){
                $db->where("id",$subDistrictIDAry,"IN");
                $subDistrictRes = $db->map("id")->get("sub_county",null,"id,name,translation_code");
            }

            if($postCodeIDAry){
                $db->where("id",$postCodeIDAry,"IN");
                $postCodeRes = $db->map("id")->get("zip_code",null,"id,name,translation_code");
            }

            if($cityIDAry){
                $db->where("name",$cityIDAry,"IN");
                $cityRes = $db->map("id")->get("city",null,"id,name,translation_code");
            }

            if($stateIDAry){
                $db->where("id",$stateIDAry,"IN");
                $stateRes = $db->map("id")->get("state",null,"id,name,translation_code");
            }

            if($countryIDAry){
                $db->where("id",$countryIDAry,"IN");
                $countryRes = $db->map("id")->get("country",null,"id,name,translation_code,country_code");
            }

            foreach($result as $value) {
                unset($tempValue);
                if($site == "Admin"){
                    $tempValue['username'] = $clientRes[$value["client_id"]]['username']?:"-";
                }
                $tempValue['deliveryID'] = $value["id"];
                $tempValue['memberID'] = $clientRes[$value['client_id']]['member_id'];
                $tempValue['client_id'] = $value["client_id"];
                $tempValue['fullname'] = $value["name"];
                $tempValue['type'] = $value["type"];
                $tempValue['address_type'] = $value["address_type"];

                $district = $translations[$districtRes[$value["district_id"]]["translation_code"]][$language] ? $translations[$districtRes[$value["district_id"]]["translation_code"]][$language] : $districtRes[$value["district_id"]]["name"];
                $subDistrict = $translations[$subDistrictRes[$value["sub_district_id"]]["translation_code"]][$language] ? $translations[$subDistrictRes[$value["sub_district_id"]]["translation_code"]][$language] : $subDistrictRes[$value["sub_district_id"]]["name"];
                // $postCode = $translations[$postCodeRes[$value["post_code_id"]]["translation_code"]][$language] ? $translations[$postCodeRes[$value["post_code_id"]]["translation_code"]][$language] : $postCodeRes[$value["post_code_id"]]["name"];
                $postCode = $postCodeIDAry[$value['post_code']];
                // $city = $translations[$cityRes[$value["city_id"]]["translation_code"]][$language] ? $translations[$cityRes[$value["city_id"]]["translation_code"]][$language] : $cityRes[$value["city_id"]]["name"];
                $city = $cityIDAry[$value['city']];
                $state = $translations[$stateRes[$value["state_id"]]["translation_code"]][$language] ? $translations[$stateRes[$value["state_id"]]["translation_code"]][$language] : $stateRes[$value["state_id"]]["name"];
                $country = $translations[$countryRes[$value["country_id"]]["translation_code"]][$language] ? $translations[$countryRes[$value["country_id"]]["translation_code"]][$language] : $countryRes[$value["country_id"]]["name"];
                // $tempValue["address"] = $value["address"].", ".$district.", ".$subDistrict.", ".$postCode.", ".$city.", ".$state.", ".$country;
                $tempValue["address"] = $value["address"].", ".$value["address_2"].", ".$postCode.", ".$city.", ".$state.", ".$country;
                $tempValue["phone"] = "+".$countryRes[$value["country_id"]]["country_code"]." ".$value["phone"];
                $tempValue["postCode"] = $postCode;

                if($site == "Member"){
                    // if($value["address_type"] == "billing"){
                    //     $billingList[] = $tempValue;
                    // }else{
                    //     $list[] = $tempValue;
                    // }
                    $list[] = $tempValue;
                }else{
                    $list[] = $tempValue;
                }
            }

            if($params['type'] == "export") {
                 $params['command'] = __FUNCTION__;
                 $data = Excel::insertExportData($params);
                 return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }
            // if($billingList){
            //     $data['billingList']   = $billingList;
            // }
            $data['list']   = $list;
            $data['pageNumber']  = $pageNumber;
            $data['totalRecord'] = $totalRecord;

            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        // -------- Taxes -------- //
        public function setTaxes($params) {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $type = $params['type'];
            $rate = $params['rate'];

            $userID = $db->userID;

            if (!$userID) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");

            if (!$type) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00125"][$language] /* Invalid value. */, 'data' => "");

            if (!is_numeric($rate) || $rate < 0) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00125"][$language] /* Invalid value. */, 'data'=>"");

            $db->where('id', $userID);
            $creatorID = $db->getValue('admin', 'id');
            if (!$creatorID) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid user. */, 'data'=>"");

            $insertData = array(
                'type' => $type,
                'rate' => $rate,
                'created_at' => date('Y-m-d H:i:s'),
                'creator_id' => $creatorID
            );
            $insertRes = $db->insert('inv_tax_charges', $insertData);

            if (!$insertRes) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00131"][$language] /* Update failed. */, 'data' => "");

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => '');
        }

        public function getTaxes($params) {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $type = $params['type'];

            if (!$type) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00125"][$language] /* Invalid value. */, 'data' => "");

            $userID = $db->userID;

            if (!$userID) return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");

            $db->where('type', $type);
            $db->orderBy('id', 'DESC');
            $res = $db->getOne('inv_tax_charges', 'type, rate');

            if (!$res) {
                $data['type'] = $type ? : '-';
                $data['rate'] = 0;
            } else {
                $data['type'] = $res['type'] ? : '-';
                $data['rate'] = $res['rate'] ? Setting::setDecimal($res['rate']) : '-';
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getSOShoppingCart($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting::$systemSetting['deliveryFee'];
            $dateTime               = date("Y-m-d H:i:s");
            $amountDeliveryFee = 0;
            $applyQuantity = 0;

            $todayDate      = date('Y-m-d H:i:s');
            $bkendToken     = $params['bkend_token'];
            $step           = $params['step'];
            $promoCode      = $params['promo_code'];
            $deliveryMethod = $params['deliveryMethod'];

            $clientID = $db->userID;
            $site = $db->userType;

            $db->where('token', $bkendToken);
            $db->where('disabled', 0);
            $getProductListArray = $db->get('shopping_cart', null, 'product_id');

            foreach($getProductListArray as $key => $value){
                $db->where('id', $value['product_id']);
                $setMethodforDelivery = $db->getValue('product', 'delivery_method');

                $db->where('id', $setMethodforDelivery);
                $getDeliveryMethodName = $db->getValue('gotasty_delivery_method', 'name');

                $setMethodforDeliveryArry[] = $getDeliveryMethodName;
            }

            if ($setMethodforDeliveryArry) {
                foreach ($setMethodforDeliveryArry as $value) {
                    if ($value == 'Delivery Charges') {
                        $deliveryCharges++;
                    } else if ($value == 'Dry Delivery Charges') {
                        $dryDelivery++;
                    } else if ($value == 'Self Pickup') {
                        $pickUp++;
                    }
                }
            }

            if($deliveryCharges != 0 && $dryDelivery != 0){
                $deliveryFee = Setting::$systemSetting['deliveryFee'];
            }
            else if($deliveryCharges != 0 && $dryDelivery == 0){
                $deliveryFee = Setting::$systemSetting['deliveryFee'];
            }
            else if($deliveryCharges == 0 && $dryDelivery != 0){
                $deliveryFee = Setting::$systemSetting['dryDeliveryFee'];
            }
            else{
                $deliveryFee = Setting::$systemSetting['deliveryFee'];
            }

            // check redeemAmount is enough or not
            $creditBalance = Cash::getBalance($clientID, 'gotastyCredit');
            if($creditBalance >= 0)
            {
                $userPointAmount = round(intval($creditBalance) * 0.005, 2);
            }

            if($bkendToken)
            {
                // validate token
                $db->where('token', $bkendToken);
                $tokenValid = $db->getOne('guest_token');
            }

            if(empty($bkendToken) || !$tokenValid)
            {
                if(!empty($clientID))
                {
                    $db->orderBy('id', 'desc');
                    $db->where('client_id',$clientID);
                    $tokenExist = $db->getOne('guest_token');
                    if($tokenExist)
                    {
                        $bkendToken = $tokenExist['token'];
                    }
                }
            }

            // use token to get sale_id
            $db->where('token', $bkendToken);
            $saleID = $db->getOne('guest_token', 'sale_id');
            if($saleID)
            {
                $saleID = $saleID['sale_id'];
            }

            if($step != '1')
            {
                if(!$clientID) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                }else{
                    $db->where('id', $clientID);
                    $clientInfo = $db->getOne('client', 'id, country_id');
    
                    if(!$clientInfo){
                        return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                    }
                }
            }

            $db->where('a.sale_id', $saleID);
            $db->where('a.deleted', 0);
            // if(!empty($clientID))
            // {
            //     $db->where('client_id', $clientID);
            // }
            $db->orderBy('a.deleted', 'ASC');
            $db->join('product_template b', 'b.id = a.product_template_id', 'LEFT');
            $db->join('product p', 'p.id = a.product_id', 'LEFT');
            $shoppingCart = $db->get('sale_order_detail a', null, 'a.product_id, a.product_template_id, a.quantity, a.deleted, b.product_attribute_value_id, p.cost, p.sale_price, p.description, p.name');

            $totalSalePrice = 0;

            $product_attribute_value = $db->get('product_attribute_value a', null, 'id,name');

            // check auto apply promo code valid
            $db->where('disabled', '0');
            $db->where('apply_type', 'autoApply');
            $autoApplyPromoCodeList = $db->get('mlm_promo_code');

            if($autoApplyPromoCodeList)
            {
                foreach($autoApplyPromoCodeList as $key => $checkAutoApply)
                {
                    unset($paramIn);
                    $paramIn['promo_code'] = $checkAutoApply['code'];
                    $checkPromoCodeValidDate  = Inventory::checkPromoCodeValidDate($paramIn);
                    if(!$checkPromoCodeValidDate || $checkPromoCodeValidDate['status'] == 'ok')
                    {
                        $db->where('id', $checkAutoApply['id']);
                        $db->where('disabled', '0');
                        $db->where('status', 'Active');
                        $promoCodeResult = $db->getOne('mlm_promo_code');
    
                        if(($promoCodeResult['type'] == 'firstTimePurchase') && ($promoCodeResult['is_first_time_purchase'] == 1))
                        {
                            $db->where('client_id', $clientID);
                            $db->where('disabled', '0');
                            $db->where('promo_code_id', $promoCodeResult['id']);
                            $applyStatus = $db->getOne('so_service');
                            if($applyStatus)
                            {
                                unset($autoApplyPromoCodeList[$key]);
                            }
                        }
                    }
                }
            }

            foreach ($shoppingCart as &$cartRow) {
                $packageIDAry[$cartRow['product_id']] = $cartRow['product_id'];

                if (!empty($cartRow['product_attribute_value_id'])){
                    $string = $cartRow['product_attribute_value_id'];  
                    $array = json_decode($string);
                    $string = implode(",", $array);
                    $cartRow['product_attribute_value_id'] = $string;
                    // print_r("array:".json_encode($array)."\n");

                    $name_array = array();
                    foreach ($array as $id) {
                        foreach ($product_attribute_value as $value) {
                          if ($value['id'] == $id) {
                            $name_array[] = $value['name']; // Store name in array
                          }
                        }
                    }
                    $name_string = implode(", ", $name_array);
                    $cartRow['product_attribute_name'] = $name_string;
                }
                else{
                    $cartRow['product_attribute_value_id'] = '';
                    $cartRow['product_attribute_name'] = '';
                }
            }

            if($packageIDAry){
                $db->where("reference_id", array_keys($packageIDAry),"IN");
                $db->where("type",array("Image"),"IN");
                $imageData = $db->get("product_media",null,"reference_id,url");

                unset($imageDataAry);

                foreach($imageData as $imageRow){
                    $imageDataAry[$imageRow["reference_id"]][] = $imageRow["url"];
                }

                // Detect PickUP or Delivery
                $db->where('token', $bkendToken);
                $getSaleID = $db->getOne("guest_token", "sale_id");

                // $db->where("id", $getSaleID['sale_id']);
                // $getDeliveryMethod = $db->getValue("sale_order","delivery_method");

                if ($totalSalePrice > 280){
                    $deliveryFee = 'Free';
                    $amountDeliveryFee = 0;
                }else{
                    if(strtolower($deliveryMethod) == 'pickup')
                    {
                        $amountDeliveryFee = 0;
                        $deliveryFee = 0;
                    }
                    else
                    {
                        $amountDeliveryFee = $deliveryFee;
                    }
                    // if($getDeliveryMethod == 'Pickup'){
                    //     $deliveryFee = '0';
                    //     $amountDeliveryFee = 0;
                    // }else{
                    //     $amountDeliveryFee = $deliveryFee;

                    // }
                }
                
                $db->where("id", $packageIDAry,"IN");
                $pvPriceAry = $db->map("id")->get("product", null, "id, sale_price");
                // pricelist setting
                foreach ($pvPriceAry as $checkProductId => $price)
                {
                    $db->where('disabled', '0');
                    $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                    // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                    $db->where('product_id', $checkProductId);
                    $pricelist_detail = $db->getOne('pricelist_detail');

                    if($pricelist_detail)
                    {
                        // get product price
                        $db->where('id', $checkProductId);
                        $productInventoryDetail = $db->getOne('product');

                        if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                        {
                            $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                        }
                        if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                        {
                            $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($pricelist_detail['discount']);
                        }
                        $productDetail['salePrice']         = $productInventoryDetail['sale_price'];
                        $productDetail['latestPrice']       = $latestPrice;
                        $secondPriceAry[$checkProductId] = $latestPrice;
                    }
                    $priceList[] = $pricelist_detail;
                }
            }

            // $redeemAmount = 0;
            $params['userID']  = $clientID;
            $clientDetail = Admin::getMemberDetails($params);
            //$Point = $clientDetail['data']['userPointBalance'] ?: 0;
	        $Point = Cash::getBalance($clientID,'gotastyCredit');
            $autoApplyDiscount = 0;
            foreach ($shoppingCart as &$cartRow) {
                if($cartRow['product_id']!="0" && $cartRow['name']!='Redeemed Points'){
                    unset($cart);

                    if(!empty($promoCode))
                    {
                        // get promo code id
                        $db->where('code', $promoCode);
                        $db->where('status', 'Active');
                        $db->where('disabled', '0');
                        $promoCodeId = $db->getOne('mlm_promo_code');

                        if(!$promoCodeId)
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "");
                        }

                        $db->where('disabled', '0');
                        $db->where('promo_code_id', $promoCodeId['id']);
                        $db->where('product_id', $cartRow['product_id']);
                        $getPromoPrice = $db->getOne('promo_code_product');
                    }
                    if($getPromoPrice)
                    {
                        $ProductPrice = number_format($getPromoPrice['sale_price'],2);
                        $Total = bcmul(number_format($getPromoPrice['sale_price'],2),$cartRow['quantity'],2);
                    }
                    else
                    {
                        $ProductPrice = number_format($pvPriceAry[$cartRow['product_id']],2);
                        $Total = bcmul(number_format($pvPriceAry[$cartRow['product_id']],2),$cartRow['quantity'],2);
                    }

                    if($secondPriceAry)
                    {
                        $latestTotal = bcmul(number_format($secondPriceAry[$cartRow['product_id']],2),$cartRow['quantity'],2);
                    }
                    else
                    {
                        $latestTotal = 0;
                    }

                    if($autoApplyPromoCodeList)
                    {
                        foreach($autoApplyPromoCodeList as $key => $detailPromoChecking)
                        {
                            $db->where('pcd.disabled', '0');
                            $db->where('pcd.promo_code_id', $detailPromoChecking['id']);
                            $db->where('pcd.product_id', $cartRow['product_id']);
                            $db->join('product p', 'p.id = pcd.product_id', 'LEFT');
                            $getAutoPromoPrice = $db->getOne('promo_code_detail pcd');

                            if($detailPromoChecking['type'] != 'PWP2')
                            {
                                if($getAutoPromoPrice)
                                {   
                                    unset($latestSalePrice);
                                    unset($latestTotal);
                                    $db->where('id', $getAutoPromoPrice['promo_code_id']);
                                    $db->where('disabled', '0');
                                    $db->where('status', 'Active');
                                    $promoCodeDetail = $db->getOne('mlm_promo_code');

                                    if(($getAutoPromoPrice['product_id'] == $cartRow['product_id']) && ($getAutoPromoPrice['quantity'] <= $cartRow['quantity']))
                                    {
                                        if($promoCodeDetail['discount_type'] == 'percentage')
                                        {
                                            $discountPrice = (floatval($getAutoPromoPrice['sale_price']) * floatval($promoCodeDetail['discount'] / 100));
                                            $multipleDiscountPrice = $discountPrice * intval($cartRow['quantity']);
                                            if(!empty($promoCodeDetail['max_discount_amount']))
                                            {
                                                if($multipleDiscountPrice >= floatval($promoCodeDetail['max_discount_amount']))
                                                {
                                                    $multipleDiscountPrice = floatval($promoCodeDetail['max_discount_amount']);
                                                    $autoApplyDiscount = $multipleDiscountPrice + $autoApplyDiscount;
                                                }
                                                else
                                                {
                                                    $autoApplyDiscount = $autoApplyDiscount + $multipleDiscountPrice;
                                                    $multipleDiscountPrice = 0;
                                                }
                                            }
                                            $latestSalePrice = floatval($getAutoPromoPrice['sale_price']) - $discountPrice;
                                            if($multipleDiscountPrice > 0)
                                            {
                                                $latestTotal = bcmul(number_format($getAutoPromoPrice['sale_price'], 2), $cartRow['quantity'], 2) - $multipleDiscountPrice;
                                            }
                                            else
                                            {
                                                $latestTotal = bcmul(number_format($latestSalePrice, 2), $cartRow['quantity'], 2);
                                            }
                                        }
                                        else
                                        {
                                            $latestSalePrice = number_format($getAutoPromoPrice['sale_price'], 2) - $promoCodeDetail['discount'];
                                            $autoApplyDiscount = $autoApplyDiscount + $promoCodeDetail['discount'];
                                            $latestTotal = bcmul(number_format($latestSalePrice, 2), $cartRow['quantity'], 2);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                $db->where('pcp.disabled', '0');
                                $db->where('pcp.promo_code_id', $detailPromoChecking['id']);
                                // $db->where('pcp.product_id', $cartRow['product_id']);   
                                $db->join('product p', 'p.id = pcp.product_id', 'LEFT');
                                $getAutoPromoProductPrice = $db->getOne('promo_code_product pcp');

                                unset($paramIn);
                                $paramIn['promo_code'] = $detailPromoChecking['code'];
                                $checkPromoCodeValidDate  = Inventory::checkPromoCodeValidDate($paramIn);

                                if(!$checkPromoCodeValidDate || $checkPromoCodeValidDate['status'] != 'ok')
                                {
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $checkPromoCodeValidDate['statusMsg'], 'data'=> $paramIn);
                                }

                                $db->where('promo_code_id', $detailPromoChecking['id']);
                                $db->where('disabled', '0');
                                $promoCodeDetail = $db->get('promo_code_detail');

                                if(!$promoCodeDetail)
                                {
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
                                }

                                $cartProductIds = array_column($shoppingCart, 'product_id');
                                $promoProductIds = array_column($promoCodeDetail, 'product_id');
                                if (count(array_diff($promoProductIds, $cartProductIds)) <= 0) {
                                    // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "", 'promoProductIds' => $promoProductIds, 'cartProductIds' => $cartProductIds);
                                    $matchingDetail = null;
                                    foreach ($promoCodeDetail as $codeDetail) {
                                        if ($codeDetail['product_id'] == $cartRow['product_id']) {
                                            $matchingDetail = $codeDetail;
                                            break;
                                        }
                                    }
                                    if ($matchingDetail !== null && $matchingDetail['quantity'] <= $cartRow['quantity']) {
                                        // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "");
                                        $db->where('pcp.promo_code_id', $detailPromoChecking['id']);
                                        $db->where('pcp.disabled', '0');
                                        $db->where('mpc.type', 'PWP2');
                                        $db->join('mlm_promo_code mpc', 'mpc.id = pcp.promo_code_id');
                                        $promoCodeProduct = $db->get('promo_code_product pcp');
                                        if($promoCodeProduct)
                                        {
                                            foreach($promoCodeProduct as $promoProduct)
                                            {
                                                $db->where('product_id', $promoProduct['product_id']);
                                                $db->where('status', 'Active');
                                                $stockAvailable = $db->get('stock');
                                                // if(!$stockAvailable)
                                                // {
                                                //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "");
                                                // }
                                                $db->where('id', $detailPromoChecking['id']);
                                                $db->where('status', 'Active');
                                                $db->where('disabled', '0');
                                                $promoCodeId = $db->getOne('mlm_promo_code');
                                            }
                                        }
                                    }
        
                                }
                            }
                        }
                    }

                    $cart['productID']                     = $cartRow['product_id'];
                    $cart['productName']                   = $cartRow['name'];
                    $cart['product_template_id']           = $cartRow['product_template_id'];
                    $cart['product_attribute_value_id']    = $cartRow['product_attribute_value_id'];
                    $cart['product_attribute_name']        = $cartRow['product_attribute_name'];
                    $cart['quantity']                      = $cartRow['quantity'];
                    $cart['total']                         = $Total;
                    $cart['disabled']                      = $cartRow['disabled'];
                    $cart["img"]                           = $imageDataAry[$cartRow["product_id"]][0];
                    $cart["stockCount"]                    = 100;
                    $cart["price"]                         = $ProductPrice;
                    
                    if($latestTotal > 0)
                    {
                        $cart['latestTotal']                   = $latestTotal;
                    }
                    if(!$latestTotal || $latestTotal <= 0)
                    {
                        $totalSalePrice += $Total;
                    }
                    else
                    {
                        $totalSalePrice += $latestTotal;
                    }
                    if($promoCodeId['type'] == 'PWP2')
                    {
                        foreach($promoCodeProduct as $pwpDetailProduct) // reward product detail
                        {
                            if($cartRow['product_id'] == $pwpDetailProduct['product_id']) // if cart product id == reward product detail
                            {
                                $currentRewardQuantity = 0;
                                foreach($shoppingCart as $checkPWP2cartQuantity)
                                {
                                    foreach($promoCodeProduct as $checkPWPrewardProduct)
                                    {
                                        // check current total PWP reward product total quantity
                                        if($checkPWP2cartQuantity['product_id'] == $checkPWPrewardProduct['product_id'])
                                        {
                                            $currentRewardQuantity = intval($checkPWP2cartQuantity['quantity']) + $currentRewardQuantity;
                                        }
                                    }
                                }

                                $tempTotal = (intval($applyQuantity) + intval($cartRow['quantity']));
                                if(($tempTotal) <= $pwpDetailProduct['max_quantity'])
                                {
                                    $originalTotal = number_format($cart['price'], 2) * $cartRow['quantity'];
                                    $cart['total'] = $originalTotal;
                                    $Total           = bcmul(number_format($cart['price'],2),$promoCodeId['max_quantity'],2);
                                    $cart['latestTotal']   = bcmul(number_format($pwpDetailProduct['sale_price'],2),$cartRow['quantity'],2);
                                    $applyQuantity   = $applyQuantity + $cartRow['quantity'];
                                    $autoApplyDiscount = $autoApplyDiscount + (bcsub($originalTotal, $cart['latestTotal'], 2));
                                    // return array('status' => "error", 'code' => 345, 'statusMsg' => 'testing' , 'originalTotal' => $originalTotal, 'cart' => $cart, 'autoApplyDiscount' => $autoApplyDiscount);
                                }
                                else
                                {
                                    $originalTotal = number_format($cart['price'], 2) * $cartRow['quantity'];
                                    // return array('status' => "error", 'code' => 110, 'statusMsg' => 'testing' , 'applyQuantity' => $applyQuantity, 'tempTotal' => $tempTotal);
                                    $availableQuantity = $promoCodeId['max_quantity'] - $applyQuantity;
                                    $remainAmount = $cartRow['quantity'] - $availableQuantity;
                                    if($availableQuantity != 0)
                                    {
                                        $Total           = bcmul(number_format($cart['price'],2),$promoCodeId['max_quantity'],2);
                                        $ableAmount   = bcmul(number_format($pwpDetailProduct['sale_price'],2),$availableQuantity,2);
                                        // return array('status' => "error", 'code' => 110, 'statusMsg' => 'testing' , 'ableAmount' => $ableAmount);
                                    }
                                    if($remainAmount != 0)
                                    {
                                        $Total = bcmul(number_format($pvPriceAry[$cartRow['product_id']],2),$remainAmount,2);
                                    }
                                    $cart['total'] = $originalTotal;
                                    $cart['latestTotal'] = $Total + $ableAmount;
                                    $autoApplyDiscount = $autoApplyDiscount + (bcsub($originalTotal, $Total, 2));
                                    // return array('status' => "error", 'code' => 543, 'statusMsg' => 'testing' , 'originalTotal' => $originalTotal, 'cart' => $cart, 'Total' => $Total, 'ableAmount' => $ableAmount, 'autoApplyDiscount' => $autoApplyDiscount);
                                }
                            }
                        }
                    }
                    $cartList[] = $cart;
                }
            }

            if(!empty($promoCode))
            {
                unset($dataIn);
                $dataIn['promo_code'] = $promoCode;
                $dataIn['sale_id']    = $getSaleID['sale_id'];
                $promoCalculation = Cash::promoCodeCalculation($dataIn);
                if($promoCalculation['status'] == 'error')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
                }
            }
            // $subTotal = $totalSalePrice;
            // if($promoCalculation)
            // {
            //     $totalSalePrice = $totalSalePrice + $amountDeliveryFee - floatval($promoCalculation['data']);
            //     $data['promoApplyAmount'] = $promoCalculation['data'];
            // }
            // else
            // {
            //     $totalSalePrice = $totalSalePrice + $amountDeliveryFee;
            // }
            foreach ($cartList as $item) {
                if (isset($item["price"])) {
                    // $subTotal += $item["price"];
                    // $subTotal = bcmul(number_format([$item['price']],2),$item['quantity'],2);
                    // $subTotal += bcmul(number_format($item['price'], 2), $item['quantity'],2);
                    $subTotal += $item['total'];
                    // if($item['productID'] == '31')
                    // {
                    //     return array('status' => "error", 'code' => 110, 'statusMsg' => 'testing' , 'subTotal' => $subTotal);
                    // }
                }
            }
            if($promoCalculation)
            {
                $promoDiscount = round(floatval($promoCalculation['data']), 2) + $autoApplyDiscount;
                $data['promoApplyAmount'] = $promoDiscount;
            }
            else
            {
                $data['promoApplyAmount'] = 0 + $autoApplyDiscount;
            }
            $discount = round(intval($redeemAmount) * 0.005, 2);

            $totalSalePrice = $subTotal + $amountDeliveryFee - floatval($data['promoApplyAmount']);

            $data['cartList'] = $cartList;
            $data['userPointAmount'] = $userPointAmount;
            $data['subTotal'] = $subTotal;
            $data['totalSalePrice'] = $totalSalePrice;
            $data['Taxes'] = 0;
            $data['deliveryFee'] = $deliveryFee;
            $data['Point'] = $Point;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getShoppingCart2($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $redeemPointRatio = Setting::$systemSetting['redeemPoint'];
            $dateTime = date("Y-m-d H:i:s");

            $applyQuantity = 0;

            $todayDate  = date('Y-m-d H:i:s');

            $clientID = $db->userID;
            $site = $db->userType;

            $bkendToken = $params['bkend_token'];
            $promoCode = trim($params['promo_code']);
            $redeemAmount = $params['redeemAmount'];
            $deliveryMethod = trim($params['deliveryMethod']);
            $language   = $params['language'];
            $adminResetClientID   = $params['adminResetClientID'];
            $postcode   = trim($params['postcode']);
            $step = $params['step'];


            if($language == 'chineseSimplified' || $language == 'chineseTraditional') $inv_lang = 'chinese';
            else $inv_lang = 'english';

            if($adminResetClientID)
            {
                $clientID = $adminResetClientID;
            }

            ## get client info
            if($clientID)
            {
                $Point = Cash::getBalance($clientID,'gotastyCredit');
                $creditBalance = Cash::getBalance($clientID, 'gotastyCredit');
            }
            if(!$clientID) {
                if(!$bkendToken)
                {
                    $userPointAmount = 0;

                    $data['cartList'] = $cartList;
                    $data['redeemAmount'] = 0;
                    $data['subTotal'] = 0;
                    $data['subtotalAfterPromo'] = 0;
                    $data['totalSalePrice'] = 0;
                    $data['Taxes'] = 0;
                    $data['deliveryFee'] = 0;
                    $data['Point'] = $Point;
                    $data['userPointAmount'] = $userPointAmount;
                    $data['deliveryAvailability'] = 1;
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
                }
            }else{
                if(!$bkendToken)
                {
                    // check redeemAmount is enough or not
                    if($creditBalance >= 0)
                    {
                        $userPointAmount = round(intval($creditBalance) * $redeemPointRatio, 2);
                    }
                    else
                    { 
                        $userPointAmount = 0;
                    }

                    $data['cartList'] = $cartList;
                    $data['redeemAmount'] = 0;
                    $data['subTotal'] = 0;
                    $data['subtotalAfterPromo'] = 0;
                    $data['totalSalePrice'] = 0;
                    $data['Taxes'] = 0;
                    $data['deliveryFee'] = 0;
                    $data['Point'] = $Point;
                    $data['userPointAmount'] = $userPointAmount;
                    $data['deliveryAvailability'] = 1;
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
                }
                $db->where('id', $clientID);
                $clientInfo = $db->getOne('client', 'id, country_id');

                if(!$clientInfo){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                }
            }

            ## check apply promo code PWP auto add product 
            if($promoCode)
            {
               
                    unset($paramIn);
                    $paramIn['promo_code'] = $promoCode;
                    $paramIn['bkend_token'] = $bkendToken;
                    $resultOut = Inventory::applyPromoCode($paramIn);
                
            }

            ## step 1:  get user cart
            $db->where('disabled', 0);
            $db->where('token', $bkendToken);
            $db->orderBy('disabled', 'ASC');
            $dbData = $db->get('shopping_cart', null);

            foreach($dbData as $cartData){
                $cartProductIds[$cartData["id"]] = $cartData["product_id"];

                unset($cartData["token"]);
                $shoppingCart[$cartData["id"]] = $cartData;

                $sale_id = $cartData["sale_id"];
            }

            ## if empty cart, just return

            if(!count($shoppingCart)){

                $data["appliedPromo"] = [];
                $data['cartList'] = [];
                $data['redeemAmount'] = 0;
                $data['subTotal'] = 0;
                $data['subtotalAfterPromo'] = 0;
                $data['totalSalePrice'] = 0;
                $data['Taxes'] = 0;
                $data['deliveryFee'] = 0;
                $data['deliveryAvailability'] = 0;
                $data['delivery_method'] = "";
                $data['Point'] = $Point;
                $data['userPointAmount'] = 0;
                $data['deliveryAvailability'] = 1;
                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
            }

            ## get all cart product ##

            if(count($cartProductIds)){
                $db->where("id",$cartProductIds,"IN");
                $dbData = $db->get('product', null);
                foreach($dbData as $productDataTemp){
                    $productData[$productDataTemp["id"]] = $productDataTemp;
                }

                $db->where('deleted', 0);
                $db->where("reference_id", $cartProductIds,"IN");
                $db->where("type",array("coverImg"),"IN");
                $imageData = $db->get("product_media",null,"reference_id,url");

                unset($imageDataAry);
                foreach($imageData as $imageRow){
                    $productImageDataAry[$imageRow["reference_id"]][] = $imageRow["url"];
                }
            }

            unset($paramIn);
            $paramIn['bkend_token'] = $bkendToken;
            $resultOut = Inventory::getShoppingCartQuantity($paramIn);
            $cartListStockCount = $resultOut['data']['cartList'];
            foreach($cartListStockCount as $detailStockCount)
            {

                $cart["stockCount"] = $detailStockCount['inStockCount'];
                $cart["inStockCount"] = $detailStockCount['inStockCount'];
                $cart["availability"] = $detailStockCount['availability'];
                
                $productStockQtyAry[$detailStockCount['productID']] = $cart;
            }

            

            $db->where('module_id', $cartProductIds, 'IN');
            $db->where('module', ['product',"package"],"IN");
            $db->where('type', 'name');
            $langRes = $db->get('inv_language', null, 'module_id, language, content');

            foreach ($langRes as $langRow) {
                $lang[$langRow['module_id']][$langRow["language"]] = $langRow['content'];
            }

            ## load product Data to shopping cart ##
            foreach($shoppingCart as $i =>  $cartData){
                $shoppingCart[$i]["productName"] = $lang[$cartData["product_id"]][$inv_lang] ? $lang[$cartData["product_id"]][$inv_lang] : $lang[$cartData["product_id"]]["english"];
                $shoppingCart[$i]["productID"] = $productData[$cartData["product_id"]]["id"];
                $shoppingCart[$i]["img"] = $productImageDataAry[$cartData["product_id"]][0];
                $shoppingCart[$i]["price"] = $productData[$cartData["product_id"]]["sale_price"];
                $shoppingCart[$i]["total"] = bcmul(number_format($productData[$cartData["product_id"]]['sale_price'], 2), $cartData['quantity'], 2);
                $shoppingCart[$i]["stockCount"] = $productStockQtyAry[$cartData['product_id']]["stockCount"];
                $shoppingCart[$i]["inStockCount"] = $productStockQtyAry[$cartData['product_id']]["inStockCount"];
                $shoppingCart[$i]["availability"] = $productStockQtyAry[$cartData['product_id']]["availability"];



            }
            //print_r($shoppingCart);


            ## step 2 : get related priceList discount 
            $db->where('disabled', 0);
            $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
            $db->where("product_id",$cartProductIds,"IN");
            $dbData = $db->get('pricelist_detail', null);

            foreach($dbData as $priceListDataTemp){
                $priceListData[$priceListDataTemp["product_id"]] = $priceListDataTemp;
            }

            ## check if any product entitle pricelist
            foreach($shoppingCart as $i =>  $cartData){
                if($priceListData[$cartData["product_id"]]){
                    $pricelist_detail = $priceListData[$cartData["product_id"]];
                    $productInventoryDetail = $productData[$cartData["product_id"]];

                    if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                    {
                        $priceList_pricing = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                    }
                    if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                    {
                        $priceList_pricing = floatval($productInventoryDetail['sale_price']) - floatval($pricelist_detail['discount']);
                    }
                    $shoppingCart[$i]['salePrice']         = $productInventoryDetail['sale_price'];
                    $shoppingCart[$i]['latestPrice']       = $priceList_pricing;
                    $shoppingCart[$i]['latestTotal']       = bcmul($priceList_pricing,$cartData["quantity"],2);
                    $shoppingCart[$i]['promo_type']        = "pricelist";
                }
            }

            ## step 3 : load all applicable promo code
            if($promoCode)$manualApplyPromoValid = 0; 
            else $manualApplyPromoValid = 1;

            // get all auto apply promo code
            $autoApplyPromoCodeList = $db->rawQuery("SELECT * FROM `mlm_promo_code` WHERE disabled = '0' AND '".$dateTime."' BETWEEN start_date AND end_date AND (apply_type = 'autoApply' OR code = '".$promoCode."') and status = 'active'");

            foreach($autoApplyPromoCodeList as $key => $checkAutoApply)
            {
                $applicablePromoCode[$checkAutoApply["id"]] =  $checkAutoApply;
                if(($checkAutoApply['type'] == 'firstTimePurchase') && ($checkAutoApply['is_first_time_purchase'] == 1))
                {
                    ## SO userID only legit when in last step 
                    if(!$clientID && $step != "1" && $step != "2"){
                        $db->where('id', $sale_id);
                        $saleOrderRow = $db->getOne("sale_order");
                        $clientID = $saleOrderRow["client_id"];
                    }
                    if($clientID){
                        $db->where('client_id', $clientID);
                        $db->where('disabled', '0');
                        $db->where('promo_code_id', $checkAutoApply['id']);
                        $applyStatus = $db->getOne('so_service');
                        if(count($applyStatus))
                        {
                            unset($applicablePromoCode[$checkAutoApply["id"]]);
                            unset($autoApplyPromoCodeList[$key]);
                            continue;
                        }
                    }
                } 
                if($checkAutoApply["type"] == "PWP" || $checkAutoApply["type"] == "PWP2"){
                    $pwpPromoIDS[$checkAutoApply["id"]] = $checkAutoApply["id"];
                }


                #check if user applied promo code valid
                if(strtolower($promoCode) == strtolower($checkAutoApply["code"])){
                    $manualApplyPromoValid = 1;
                }
            }

            ## load pwp reward product

            if(count($pwpPromoIDS)){
                $db->where('promo_code_id', $pwpPromoIDS,"IN");
                $db->where('disabled', '0');
                $promoCodeProductDB = $db->get('promo_code_product');
            }

            foreach($promoCodeProductDB as $dbData){
                $rewardProduct[$dbData["promo_code_id"]][$dbData["product_id"]] = $dbData;
            }


            if(count($autoApplyPromoCodeList)){
                $db->where('promo_code_id', array_column($autoApplyPromoCodeList, 'id'),"IN");
                $db->where('disabled', '0');
                $promoCodeDetailDB = $db->get('promo_code_detail');
            }

            foreach($promoCodeDetailDB as $dbData){
                $conditionProduct[$dbData["product_id"]][$dbData["promo_code_id"]] = $dbData;

                if($dbData["product_id"] != 0)$conditionalPromoCodeID[$dbData["promo_code_id"]] = $dbData["promo_code_id"];
            }

            ## check if any unconditional promo code in list
            $unconditionalPromoCodeIds = array_diff(array_column($autoApplyPromoCodeList, 'id'),$conditionalPromoCodeID);
            


            ## step 4 : loop and check cart applicable with CONDITIONAL promo code
            foreach($shoppingCart as $i =>  $cartData){

                ## check if applicable for promote
                if(isset($conditionProduct[$cartData["product_id"]])){

                    foreach($conditionProduct[$cartData["product_id"]] as $appliedPromoID => $appliedPromoCodeDetailInfo){
                        $appliedPromoCodeInfo = $applicablePromoCode[$appliedPromoID];


                        ## if PWP, check if cart having matched reward product
                        if($appliedPromoCodeInfo["type"] == "PWP" || $appliedPromoCodeInfo["type"] == "PWP2"){
                            $maxAppliedQty = $appliedPromoCodeInfo["max_quantity"] * $cartData["quantity"];
                            foreach($shoppingCart as $k =>  $cartData2){
                                if(isset($rewardProduct[$appliedPromoID][$cartData2["product_id"]]) && !$shoppingCart[$k]['appliedPromoCode']){
                                    ## 0 means unlimited
                                    if($appliedPromoCodeInfo["max_quantity"] == 0 ){
                                        $latestTotal = bcmul(number_format($rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"], 2), $cartData2['quantity'], 2);
                                        $shoppingCart[$k]['latestPrice'] = $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"];
                                        $shoppingCart[$k]['latestTotal'] = $latestTotal;
                                        $shoppingCart[$k]['appliedPromoCode'] = $appliedPromoID;
                                        $shoppingCart[$k]['promo_type'] = "promo_code";
                                        

                                        $promoCodeTotalDiscount[$appliedPromoID] += (($productData[$cartData2["product_id"]]["sale_price"] - $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"])) * $cartData2["quantity"];
                                    }else{ // got limit 
                                        if($maxAppliedQty >= $cartData2["quantity"]){
                                            $latestTotal = bcmul(number_format($rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"], 2), $cartData2['quantity'], 2);
                                            $shoppingCart[$k]['latestPrice'] = $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"];
                                            $shoppingCart[$k]['latestTotal'] = $latestTotal;
                                            $shoppingCart[$k]['appliedPromoCode'] = $appliedPromoID;
                                            $shoppingCart[$k]['promo_type'] = "promo_code";

                                            $promoCodeTotalDiscount[$appliedPromoID] += (($productData[$cartData2["product_id"]]["sale_price"] - $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"])) * $cartData2["quantity"];

                                            $maxAppliedQty -= $cartData2["quantity"];

                                        }else{
                                            if($maxAppliedQty != 0){
                                                $applicableQty = $maxAppliedQty;
                                                $normalPriceQty = $cartData2['quantity'] - $applicableQty;
                                            
                                                ## calculate applicable qty with promotion, and the rest normal price 
                                                $latestTotal = bcmul(number_format($rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"], 2), $applicableQty, 2) + bcmul(number_format($productData[$cartData2["product_id"]]["sale_price"], 2), $normalPriceQty, 2);
                                                $shoppingCart[$k]['latestPrice'] = $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"];
                                                $shoppingCart[$k]['latestTotal'] = $latestTotal;
                                                $shoppingCart[$k]['appliedPromoCode'] = $appliedPromoID;
                                                $shoppingCart[$k]['promo_type'] = "promo_code";

                                                $promoCodeTotalDiscount[$appliedPromoID] += (($productData[$cartData2["product_id"]]["sale_price"] - $rewardProduct[$appliedPromoID][$cartData2["product_id"]]["sale_price"])) * $applicableQty;
                                                $maxAppliedQty = 0;
                                            }
                                        }
                                    }
                                }
                            }
                        }else if($appliedPromoCodeInfo["type"] == "firstTimePurchase"){
                            
                            if($appliedPromoCodeInfo['discount_type'] == 'percentage')
                            {
                                $discountPrice = (floatval($productData[$cartData["product_id"]]["sale_price"]) * floatval($appliedPromoCodeInfo['discount'] / 100));
                                $multipleDiscountPrice = $discountPrice * intval($cartData['quantity']);
                                if(!empty($appliedPromoCodeInfo['max_discount_amount']))
                                {
                                    if($multipleDiscountPrice >= floatval($appliedPromoCodeInfo['max_discount_amount']))
                                    {
                                        $multipleDiscountPrice = floatval($appliedPromoCodeInfo['max_discount_amount']);
                                    }
                                    else
                                    {
                                        $multipleDiscountPrice = 0;
                                    }
                                }
                                $latestSalePrice = floatval($productData[$cartData["product_id"]]["sale_price"]) - $discountPrice;
                                if($multipleDiscountPrice > 0)
                                {
                                    $latestTotal = bcmul(number_format($productData[$cartData["product_id"]]["sale_price"], 2), $cartData['quantity'], 2) - $multipleDiscountPrice;

                                }
                                else
                                {
                                    $latestTotal = bcmul(number_format($latestSalePrice, 2), $cartData['quantity'], 2);
                                }
                            }
                            else
                            {
                                $discountPrice = floatval($appliedPromoCodeInfo['discount']);
                                $multipleDiscountPrice = $discountPrice * intval($cartData['quantity']);
                                if(!empty($appliedPromoCodeInfo['max_discount_amount']))
                                {
                                    if($multipleDiscountPrice >= floatval($appliedPromoCodeInfo['max_discount_amount']))
                                    {
                                        $multipleDiscountPrice = floatval($appliedPromoCodeInfo['max_discount_amount']);
                                    }
                                    else
                                    {
                                        $multipleDiscountPrice = 0;
                                    }
                                }
                                $latestSalePrice = floatval($productData[$cartData["product_id"]]["sale_price"]) - $discountPrice;
                                if($multipleDiscountPrice > 0)
                                {
                                    $latestTotal = bcmul(number_format($productData[$cartData["product_id"]]["sale_price"], 2), $cartData['quantity'], 2) - $multipleDiscountPrice;

                                }
                                else
                                {
                                    $latestTotal = bcmul(number_format($latestSalePrice, 2), $cartData['quantity'], 2);
                                }
                            }

                            $shoppingCart[$i]['latestPrice'] = $latestSalePrice;
                            $shoppingCart[$i]['latestTotal'] = $latestTotal;
                            $shoppingCart[$i]['appliedPromoCode'] = $appliedPromoID;
                            $shoppingCart[$i]['promo_type'] = "promo_code";
                            $promoCodeTotalDiscount[$appliedPromoID] +=  bcmul(number_format($productData[$cartData["product_id"]]["sale_price"], 2), $cartData['quantity'], 2)  - $latestTotal;
                        }
                    }
                }
            }

            ## get shipping fee, need tune this part
            $db->orderBy('id', 'desc');
            $db->where('token', $bkendToken);
            $saleID = $db->getOne('guest_token');

            ## get subtotal 
            $subTotal = 0;
            foreach($shoppingCart as $i =>  $cartData){

                if($cartData["promo_type"] == "pricelist"){
                    $subTotal += $cartData["latestTotal"];
                }else{
                    $subTotal += bcmul(number_format($cartData["price"], 2), $cartData['quantity'], 2);
                }
            }
            ## loop and check any unconditional Promo Code to apply 
            foreach($unconditionalPromoCodeIds as $unconditionalID){
                $appliedPromoCodeInfo = $applicablePromoCode[$unconditionalID];
                if($appliedPromoCodeInfo["type"] == "billDiscount"){
                    if($appliedPromoCodeInfo['discount_type'] == 'percentage')
                    {
                        
                        $promoDiscount = (floatval($subTotal)) * (floatval($appliedPromoCodeInfo['discount']) / 100);
                    }
                    else if($appliedPromoCodeInfo['discount_type'] == 'amount')
                    {
                        $promoDiscount = floatval($appliedPromoCodeInfo['discount']);
                    }
                    ## check max cap 
                    if($promoDiscount > $appliedPromoCodeInfo['max_discount_amount'] && $appliedPromoCodeInfo['max_discount_amount'] > 0)$promoDiscount = $appliedPromoCodeInfo['max_discount_amount'];
                    $promoCodeTotalDiscount[$unconditionalID] +=  $promoDiscount;
                }else if($appliedPromoCodeInfo["type"] == "freeShipping"){
                    $freeShippingPromoData =  $appliedPromoCodeInfo;

                    /*$promoDiscount = $shippingFee;
                    ## check max cap 
                    if($promoDiscount > $appliedPromoCodeInfo['max_discount_amount'] && $appliedPromoCodeInfo['max_discount_amount'] > 0)$promoDiscount = $appliedPromoCodeInfo['max_discount_amount'];
                    $promoCodeTotalDiscount[$unconditionalID] +=  $promoDiscount;*/
                }
            }
            
            

            ## calculate redeem amount ##
            ## Check if the redeemAmount is an even number
            if ($redeemAmount % 2 != 0) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01283"][$language] /* Redeem amount must be an even number */, 'data' => $creditBalance, 'redeemAmount' => $redeemAmount);
            }

            
            $creditBalance = Cash::getBalance($clientID, 'gotastyCredit');
            $userPointAmount = round(intval($creditBalance) * $redeemPointRatio, 2);
            // check redeemAmount is enough or not
            if(intval($redeemAmount) != 0 || !empty($redeemAmount))
            {

                $redeemAmount = number_format($redeemAmount, 2, '.', '');
                if($creditBalance < floatval($redeemAmount))
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01201"][$language] /* Insufficient Point Balance */, 'data' => $creditBalance, 'redeemAmount' => $redeemAmount);
                }
            }
            if(!$redeemAmount)
            {
                $redeemAmount = 0;
            }

            # manual apply promo is not valid 
            if(!$manualApplyPromoValid )
            {
                $data["appliedPromoStatus"] = "invalid";
                $data["appliedPromoStatusMsg"] = $translations["E01229"][$language];
                //return array('status' => "ok", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
            }

            # get shipping fee amount
            $totalSalePriceExcludeShipping = $subTotal - array_sum($promoCodeTotalDiscount) - round(intval($redeemAmount) * $redeemPointRatio, 2);
            $paramIn['sale_id'] = $saleID['sale_id'];
            $paramIn['delivery_method'] = $deliveryMethod == "" ? "delivery" : $deliveryMethod;
            $paramIn['totalSaleAmount'] = $totalSalePriceExcludeShipping;
            $paramIn['postcode'] = $postcode;
            $shippingFeeAry = Cash::freeDeliveryCondition2($paramIn);
            $shippingFee = $shippingFeeAry['data']['delivery_fee'];
            $deliveryAvailability = $shippingFeeAry['data']['deliveryAvailability'];
            $data["shippingData"] = $shippingFeeAry;

            ##check if got free shipping ##
            if($freeShippingPromoData){
                $promoDiscount = $shippingFeeAry["data"]["shipping_fee"];
                ## check max cap 
                if($promoDiscount > $freeShippingPromoData['max_discount_amount'] && $freeShippingPromoData['max_discount_amount'] > 0)$promoDiscount = $freeShippingPromoData['max_discount_amount'];

                $shippingFee = $shippingFee - $promoDiscount + $shippingFeeAry["data"]["surcharge"];
                //if($promoDiscount > 0)$promoCodeTotalDiscount[$unconditionalID] +=  $promoDiscount;

            }

            ## add promo code row ##
            foreach($promoCodeTotalDiscount as $promoID => $totalDiscountAmount){
                $appliedPromoInfo[$promoID]["id"] = $promoID;
                $appliedPromoInfo[$promoID]["name"] = $applicablePromoCode[$promoID]["promo_code_name"];
                $appliedPromoInfo[$promoID]["code"] = $applicablePromoCode[$promoID]["code"];
                $appliedPromoInfo[$promoID]["type"] = $applicablePromoCode[$promoID]["type"];
                $appliedPromoInfo[$promoID]["totalDiscount"] = $totalDiscountAmount;
            }

            ## last step ,build output
            $totalSalePrice = $subTotal + $shippingFee - array_sum($promoCodeTotalDiscount) - round(intval($redeemAmount) * $redeemPointRatio, 2);
            $subtotalAfterPromo = $subTotal - array_sum($promoCodeTotalDiscount) - round(intval($redeemAmount) * $redeemPointRatio, 2);

            $data["appliedPromo"] = $appliedPromoInfo;
            $data['cartList'] = $shoppingCart;
            $data['redeemAmount'] = round(intval($redeemAmount) * $redeemPointRatio, 2);
            $data['subTotal'] = $subTotal;
            $data['subtotalAfterPromo'] = $subtotalAfterPromo;
            $data['totalSalePrice'] = $totalSalePrice;
            $data['Taxes'] = 0;
            $data['deliveryFee'] = $shippingFee;
            $data['deliveryAvailability'] = $deliveryAvailability;
            $data['delivery_method'] = $shippingFeeAry['data']['delivery_method'];
            $data['Point'] = $creditBalance?$creditBalance:0;
            $data['userPointAmount'] = $userPointAmount?$userPointAmount:0;
            $data['promoApplyAmount'] = array_sum($promoCodeTotalDiscount);


            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getShoppingCartQuantity($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting::$systemSetting['deliveryFee'];
            $amountDeliveryFee = 0;

            $todayDate  = date('Y-m-d H:i:s');
            $bkend_token = $params['bkend_token'];

            // $clientID = $db->userID;
            $site = $db->userType;

            // if(!$clientID) {
            //     return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
            // }else{
            //     $db->where('id', $clientID);
            //     $clientInfo = $db->getOne('client', 'id, country_id');

            //     if(!$clientInfo){
            //         return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
            //     }
            // }

            $db->where('disabled', 0);
            // $db->where('client_id', $clientID);
            $db->where('token', $bkend_token);
            $db->orderBy('disabled', 'ASC');
            $db->join('product_template b', 'b.id = a.product_template_id', 'LEFT');
            $db->join('product p', 'p.id = a.product_id', 'LEFT');
            $shoppingCart = $db->get('shopping_cart a', null, 'a.product_id, a.product_template_id, 
                                    b.product_attribute_value_id, a.quantity, a.disabled, p.cost, 
                                    p.sale_price, p.description, p.name');

            $totalSalePrice = 0;

            $product_attribute_value = $db->get('product_attribute_value a', null, 'id,name');
            
            foreach ($shoppingCart as &$cartRow) {
                $packageIDAry[$cartRow['product_id']] = $cartRow['product_id'];

                if (!empty($cartRow['product_attribute_value_id'])){
                    $string = $cartRow['product_attribute_value_id'];  
                    $array = json_decode($string);
                    $string = implode(",", $array);
                    $cartRow['product_attribute_value_id'] = $string;
                    // print_r("array:".json_encode($array)."\n");

                    $name_array = array();
                    foreach ($array as $id) {
                        foreach ($product_attribute_value as $value) {
                          if ($value['id'] == $id) {
                            $name_array[] = $value['name']; // Store name in array
                          }
                        }
                    }
                    $name_string = implode(", ", $name_array);
                    $cartRow['product_attribute_name'] = $name_string;
                }
                else{
                    $cartRow['product_attribute_value_id'] = '';
                    $cartRow['product_attribute_name'] = '';
                }
            }

            if($packageIDAry){
                $db->where("reference_id", array_keys($packageIDAry),"IN");
                $db->where("type",array("Image"),"IN");
                $imageData = $db->get("product_media",null,"reference_id,url");

                unset($imageDataAry);

                foreach($imageData as $imageRow){
                    $imageDataAry[$imageRow["reference_id"]][] = $imageRow["url"];
                }

                // Detect PickUP or Delivery
                // $db->where("client_id", $clientID);
                $db->where('token', $bkend_token);
                $db->where("disabled", '0');
                $getSaleID = $db->getOne("shopping_cart","sale_id");

                $db->where("id", $getSaleID['sale_id']);
                $getDeliveryMethod = $db->getValue("sale_order","delivery_method");

                if ($totalSalePrice > 280){
                    $deliveryFee = 'Free';
                    $amountDeliveryFee = 0;
                }else{
                    if($getDeliveryMethod == 'Pickup'){
                        $deliveryFee = '0';
                        $amountDeliveryFee = 0;
                    }else{
                        $amountDeliveryFee = $deliveryFee;

                    }
                }
                
                $db->where("id", $packageIDAry,"IN");
                $pvPriceAry = $db->map("id")->get("product", null, "id, sale_price");
            }

            $redeemAmount = 0;
            // $params['userID']  = $clientID;
            try
            {
                $clientDetail = Admin::getMemberDetails($params);
            }
            catch (Exception $e)
            {
                $clientDetail = '';
            }
            // $Point = $clientDetail['data']['userPointBalance'] ?: 0;
	        // $Point = Cash::getBalance($clientID,'gotastyCredit');

            // check redeemAmount is enough or not
            // $creditBalance = Cash::getBalance($clientID, 'gotastyCredit');
            if($creditBalance >= 0)
            {
                $userPointAmount = round(intval($creditBalance) * 0.005, 2);
            }
            else
            { 
                $userPointAmount = 0;
            }

            foreach ($shoppingCart as &$cartRow) {
                unset($cart);

                // $retailPrice = Setting::setDecimal($productPrice[$cartRow['product_id']]['sale_price']);
                $Total = bcmul(number_format($pvPriceAry[$cartRow['product_id']],2),$cartRow['quantity'],2);

                $cart['productID']                     = $cartRow['product_id'];
                $cart['productName']                   = $cartRow['name'];
                // $cart['product_template_id']           = $cartRow['product_template_id'];
                // $cart['product_attribute_value_id']    = $cartRow['product_attribute_value_id'];
                // $cart['product_attribute_name']        = $cartRow['product_attribute_name'];
                // $cart['quantity']                      = $cartRow['quantity'];
                // $cart['total']                         = $Total;
                $cart['disabled']                      = $cartRow['disabled'];
                // $cart["img"]                           = $imageDataAry[$cartRow["product_id"]][0];
                // $cart["stockCount"]                    = 100;
                // $cart["price"]                         = number_format($pvPriceAry[$cartRow['product_id']],2);

                unset($dataIn);
                $dataIn['product_id'] = $cartRow['product_id'];
                $dataIn['quantity'] = $cartRow['quantity'];
                $getstockQuantity=Inventory::checkStockQuantity($dataIn);

                $db->where('id', $cartRow['product_id']);
                $db->where('deleted', '0');
                $productIgnoreCount = $db->getOne('product', 'ignore_stock_count');

                if($getstockQuantity['status'] != 'ok'){
                    $cart["inStockCount"]           = 0;
                    $cart["availability"]           = 'no';
                }
                else{
                    $cart["inStockCount"]           = $getstockQuantity['data'];
                    $cart["availability"]           = 'yes';
                }
                if($productIgnoreCount['ignore_stock_count'] == '1')
                {
                    $cart["inStockCount"]           = 9999;
                    $cart["availability"]           = 'yes';
                }

                $totalSalePrice += $Total;

                // $promoPrice = Setting::setDecimal($productPrice[$cartRow['product_id']]['promo_price']);
                // $cart["retailPrice"] = $retailPrice;
                // if($discountPercentage == '25'){
                //     $cart["promoPrice"]  = Setting::setDecimal($productPrice[$cartRow['product_id']]['m_price']);
                // }elseif($discountPercentage == '30'){
                //     $cart["promoPrice"]  = Setting::setDecimal($productPrice[$cartRow['product_id']]['ms_price']);
                // }else{
                //     $cart["promoPrice"]  = ($promoPrice > 0) ? $promoPrice : $retailPrice;
                // }
                $cartList[] = $cart;
            }

            $subTotal = $totalSalePrice;
            $totalSalePrice = $totalSalePrice + $amountDeliveryFee;

            $data['cartList'] = $cartList;
            // $data['redeemAmount'] = $redeemAmount;
            // $data['subTotal'] = $subTotal;
            // $data['totalSalePrice'] = $totalSalePrice;
            // $data['Taxes'] = 0;
            // $data['deliveryFee'] = $deliveryFee;
            // $data['Point'] = $Point;
            // $data['userPointAmount'] = $userPointAmount;
            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        //herman
        function getReview($params){
            $db                 = MySqliDb::getInstance();
            $language           = General::$currentLanguage;
            $translations       = General::$translations;
            $dateTimeFormat     = Setting::$systemSetting['systemDateTimeFormat'];;
            $deliveryFee        = Setting::$systemSetting['deliveryFee'];
            $product_id         = $params['product_id'];
            $productDetailArr   = array();
            $clientID           = $db->userID;
            
            if($clientID==null){
                $clientID=$params['clientID'];
            }
            $db->where('pr.product_id',$product_id);
            $db->where('pr.is_approve',1);
            $db->where('pr.deleted',0);
            $db->join('client c','pr.client_id=c.id');
            $review= $db->get('product_review pr',null,'c.name as name,pr.msg as msg,pr.rating as rating, pr.created_ts as date, pr.is_anonymous as anonymousStatus');

            // Checking For frontend
            if($clientID){
                $db->where('so.product_id',$product_id);
                $db->where('so.client_id', $clientID);
                $db->where('deleted', '0');
                $db->join('sale_order s','s.id = so.sale_id', 'LEFT');
                $saleOrderDetail = $db->get('sale_order_detail so', null, 'so.product_id,so.client_id');
                   
                if($saleOrderDetail)
                {
                    $allow=1;
                    
                }
                else{
                    $allow=0;
                }
            }

            if($review){
                foreach($review as $value){
                    $reviewArr['clientName']        = $value['name'];
                    $reviewArr['clientMsg']         = $value['msg'];
                    $reviewArr['clientRating']      = $value['rating'];
                    $reviewArr['anonymousStatus']   = $value['anonymousStatus'];
                    $reviewArr['date']              = $value['date'];
                    $reviewList[] = $reviewArr;
                }
                $data['reviewList'] = $reviewList;
                $data['isallow'] = $allow;
                return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' =>$data);
            }else{
                $data['reviewList'] = [];
            }
            $data['isallow']=$allow;
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language]/* No Results Found */, 'data' =>$data);
        }

        function addReview($params){
            $db             = MySqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date('Y-m-d H:i:s');
            $product_id     = $params['product_id'];
            $action         = $params['action'];
            $msg            = $params['msg'];
            $rating         = $params['rating'];
            $clientID       = $params['clientID'];
            $is_anonymous   = $params['is_anonymous'];

            //$clientID = $db->userID;
            $allow=0;
           
            if($clientID==null){
                $clientID = $params['clientID'];
            }

            if(!$clientID){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
            }
            else
            {

                $db-> where('id',$clientID);
                $clientInfo =$db->getOne('client','id,name','country_id');
               
                if(!$clientInfo)
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                }
            }

            $db->where('so.product_id',$product_id);
            $db->where('so.client_id', $clientID);
            $db->where('deleted', '0');
            $db->join('sale_order s','s.id = so.sale_id', 'LEFT');
            $saleOrderDetail = $db->get('sale_order_detail so', null, 'so.product_id,so.client_id');
               
            if($saleOrderDetail)
            {
                $allow=1;
                
            }
            else{
                $allow=0;
                $data['isallow']=$allow;
                return array('status' => "ok", 'code' => 0, 'statusMsg' => "No Result", 'data' =>$data);
            }
           if($allow==1){
          //  if($action=='add'){
              // $db->where('product_id',$product_id);
               //$db->where('client_id', $clientID);
              // $db->where('deleted', 0);
             //  $db->orderby('id','desc');
               //$clientIDreview = $db->getone('product_review');
                
               
            //  if($clientIDreview){
               //   return array('status' => "ok", 'code' => 0, 'statusMsg' => "Review Submitted", 'data' =>"");
              // }
                
            
            $insertData = array(
                'product_id'    => $product_id,
                'client_id'     => $clientID,
                'created_ts'    => $dateTime,
                'deleted'       => '0',
                'is_approve'    => '0',
                'msg'           => $msg,
                'rating'        => $rating,
                'is_anonymous'  => $is_anonymous,
                'created_by'    => $clientInfo['name'],
                'status'        => 'Pending',
                
        
            );
            $insertProduct_review = $db->insert('product_review', $insertData);
            if(!$insertProduct_review){
            return array('status' => "error", 'code' => 1, 'statusMsg' => "Fail to Add Review", 'data' => "");
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A01766"][$language] /* Review Submitted */, 'data' => "");
           }
        }

        function getWishList($params)
        {
            $db = MySqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations =General::$translations;
            $dateTimeFormat =Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting :: $systemSetting['deliveryFee'];
            $dateTime    = date("Y-m-d H:i:s");
            $productLang = $language;

            $clientID = $db->userID;
            if($clientID==null){
                $clientID=$params['clientID'];
            }  


            if($language == 'chineseSimplified'){
                $productLang = 'chinese';
            }  

            if(!$clientID){

                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
            
            }
            else
            {
                $db-> where('id',$clientID);
                $clientInfo =$db->getOne('client','id','country_id');
                


                if(!$clientInfo){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                }

            }

            $productDetailArr = array();
            
            $db->groupBy('pw.id');
            // $db->where('pm.type','Image');
            $db->where('pw.deleted',0);
            $db->where('pw.client_id',$clientID);
            $db->orderBy('pw.id','ASC');
           // $db->groupBy("pw.product_id");
            $db->join('product p', 'p.id= pw.product_id ', 'LEFT');
            $db->join('product_media pm', "pm.reference_id = pw.product_id AND pm.type = 'Image'", 'LEFT');
           // $getProductDetails = $db->get('product_wishlist pw', null, 'COUNT(product_id),pw.product_id,pw.id,p.name,pm.url,p.sale_price');
           $getProductDetails = $db->get('product_wishlist pw', null, 'pw.product_id,pw.id,p.name,pm.url,p.sale_price,p.ignore_stock_count');

           $productIds = array_column($getProductDetails, 'product_id');

           ## load product name language ##
            if($productIds){
                $db->where('module', array('product','package'), 'IN');
                $db->where('module_id', $productIds, "IN");
                $db->where('type', 'name');
                $db->where('language', $productLang);
                $getInvLan = $db->get('inv_language',null, 'module,module_id,type,language,content');

                foreach($getInvLan as $tempData){
                    $productLangAry[$tempData["module_id"]] =  $tempData["content"];
                }
            }

           foreach($getProductDetails as $value){
                $productDetailArr['id']=$value['id'];
                $productDetailArr['product_id']=$value['product_id'];
                $productDetailArr['name']= $productLangAry[$value['product_id']] ?: $value['name'];
                $productDetailArr['url']=$value['url'];
                $productDetailArr['sale_price']=$value['sale_price'];
                
                $db->where('disabled', '0');
                $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                $db->where('product_id', $value['product_id']);
                $pricelist_detail = $db->getOne('pricelist_detail');
                if(!empty($pricelist_detail))
                {
                    // get product price
                    $db->where('id', $value['product_id']);
                    $productInventoryDetail = $db->getOne('product');

                    if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                    }
                    if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($pricelist_detail['discount']);
                    }
                    $latestPrice = number_format($latestPrice, 2);

                    $productDetailArr['latestPrice']  = $latestPrice;
                }
                else
                {
                    unset($productDetailArr['latestPrice']);
                }
              //  $productDetailArr['quantity']=$value['COUNT(product_id)'];
                unset($dataIn);
                $dataIn['product_id'] = $productDetailArr['product_id'];
                $dataIn['quantity'] = 0;
                $dataOut=Inventory::checkStockQuantity($dataIn);
                if($dataOut['data'][0]['finalAmount'] > 0 ){
                    $productDetailArr['stockQuantity'] = $dataOut['data'][0]['finalAmount'];
                    $productDetailArr['availability'] = 'yes';
                }
                else if($dataOut['data'] && $dataOut['status'] != 'error'){
                    $productDetailArr['stockQuantity'] = $dataOut['data'];
                    $productDetailArr['availability'] = 'yes';
                }
                else{
                    if($value['ignore_stock_count'] == '1'){
                        $productDetailArr['availability'] = 'yes';
                        $productDetailArr['stockQuantity']= 9999;
                    }
                    else{
                        $productDetailArr['stockQuantity'] = 0;
                        $productDetailArr['availability'] = 'no';
                    }
                }                 
              
                $productDetailList[$productDetailArr['product_id']] = $productDetailArr;
            }
           return array('status' => "ok", 'code' => 0, 'statusMsg' => 'Get Succesfully' , 'data' => $productDetailList);

        }
        function getProductFavouriteList($params)
        {
            $db = MySqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations =General::$translations;
            $dateTimeFormat =Setting::$systemSetting['systemDateTimeFormat'];;
            $deliveryFee = Setting :: $systemSetting['deliveryFee'];
            $dateTime    = date("Y-m-d H:i:s");
            $productLang = $language;
            $clientID = $db->userID;
            if($clientID==null){
                $clientID=$params['clientID'];
            }

            if($language == 'chineseSimplified'){
                $productLang = 'chinese';
            }  

            if(!$clientID){

                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
            
            }
            else
            {
                $db-> where('id',$clientID);
                $clientInfo =$db->getOne('client','id','country_id');
                


                if(!$clientInfo){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00105"][$language] /* Invalid User. */, 'data' => "");
                }

            }

            $productDetailArr = array();
            
            // $db->where('pm.type','Image');
            // $db->where('pf.deleted',0);
            // $db->where('pf.client_id',$clientID);
            // $db->orderBy('pf.id','ASC');
            // $db->join('product p', 'p.id= pf.product_id ', 'LEFT');
            // $db->join('product_media pm', 'pm.reference_id = pf.product_id', 'LEFT');
            // $getProductDetails = $db->get('product_favorite pf', null, 'pf.product_id,pf.id,p.name,pm.url,p.sale_price,p.ignore_stock_count');

            $db->where('pf.deleted',0);
            $db->where('pf.client_id',$clientID);
            $db->orderBy('pf.id','ASC');
            $dbData = $db->get('product_favorite pf', null);

            foreach($dbData as $listData){
                $listProductIds[$listData['id']] = $listData['product_id'];
                $getProductDetails[] = $listData;
            }

            if(count($listProductIds)){
                $db->where('id', $listProductIds, 'IN');
                $dbData = $db->get('product', null);
                foreach($dbData as $tempProductData) {
                    $productData[$tempProductData['id']] = $tempProductData;
                }

                $db->where('reference_id', $listProductIds, 'IN');
                $db->where('type', array('Image'), 'IN');
                $imageData = $db->get('product_media', null, 'reference_id, url');

                foreach($imageData as $imageRow) {
                    $productImageDataArr[$imageRow['reference_id']][] = $imageRow['url'];
                }
            }

            // $productIds = array_column($getProductDetails, 'product_id');

            ## load product name language ##
            if($listProductIds){
                $db->where('module', array('product','package'), 'IN');
                $db->where('module_id', $listProductIds, "IN");
                $db->where('type', 'name');
                $db->where('language', $productLang);
                $getInvLan = $db->get('inv_language',null, 'module,module_id,type,language,content');

                foreach($getInvLan as $tempData){
                    $productLangAry[$tempData["module_id"]] =  $tempData["content"];
                }
            }

            
           foreach($getProductDetails as $value){
                $productDetailArr['id']=$value['id'];
                $productDetailArr['product_id']=$value['product_id'];
                $productDetailArr['name']= $productLangAry[$value['product_id']] ?: $productData[$value['product_id']]['name'];
                $productDetailArr['url']=$productImageDataArr[$value['product_id']][0];
                // $productDetailArr['url']=$value['url'];
                $productDetailArr['sale_price']=$productData[$value['product_id']]['sale_price'];

                $db->where('disabled', '0');
                $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                $db->where('product_id', $value['product_id']);
                $pricelist_detail = $db->getOne('pricelist_detail');

                if($pricelist_detail)
                {
                    // get product price
                    // $db->where('id', $value['product_id']);
                    // $productInventoryDetail = $db->getOne('product');

                    if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                    {
                        $latestPrice = floatval($productData[$value['product_id']]['sale_price']) - (floatval($productData[$value['product_id']]['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                    }
                    if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                    {
                        $latestPrice = floatval($productData[$value['product_id']]['sale_price']) - floatval($pricelist_detail['discount']);
                    }
                    $latestPrice = number_format($latestPrice, 2);
                    $productDetailArr['latestPrice']       = $latestPrice;
                }
                else
                {
                    unset($productDetailArr['latestPrice']);
                }
                
                unset($dataIn);
                $dataIn['product_id'] = $productDetailArr['product_id'];
                $dataIn['quantity'] = 0;
                $dataIn['purchaseProduct'] = $dataIn;
                $dataOut=Inventory::checkStockQuantity($dataIn);
                if($dataOut['data'][0]['finalAmount'] > 0 ){
                    $productDetailArr['stockQuantity'] = $dataOut['data'][0]['finalAmount'];
                    $productDetailArr['availability'] = 'yes';
                }
                else if($dataOut['data'] && $dataOut['status'] != 'error'){
                    $productDetailArr['stockQuantity'] = $dataOut['data'];
                    $productDetailArr['availability'] = 'yes';
                }
                else{
                    if($productData[$value['product_id']]['ignore_stock_count'] == '1'){
                        $productDetailArr['availability'] = 'yes';
                        $productDetailArr['stockQuantity']= 9999;
                    }
                    else{
                        $productDetailArr['stockQuantity'] = 0;
                        $productDetailArr['availability'] = 'no';
                    }
                }
              
                $productDetailList[] = $productDetailArr;
            }
           return array('status' => "ok", 'code' => 0, 'statusMsg' => 'Get Succesfully' , 'data' => $productDetailList);
        }

        function addProductFavouriteList($params)
        {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting::$systemSetting['deliveryFee'];  
           
            $product_id  = $params['product_id'];
            $action      = $params['action'];
            $favoriteid  = $params['favid'];
            $dateTime=  date('Y-m-d H:i:s');
            $deleted = 0;
            $clientID = $db->userID; 
            
            if($clientID == null)
            {
                $clientID = $params['clientID'];
            }

            if(!$clientID) 
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
            }

             else
             {
                $db->where('id', $clientID);
                $clientInfo = $db->has('client');

                    if(!$clientInfo){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                    }
            }
            
           
            if($action=='add'){
             
                if(!$product_id ) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product. */, 'data' => "");
                }
                else{
                    
                    $db->where('id', $product_id);
                    $productInfo = $db->get('product');
                    
                    if(!$productInfo){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product. */, 'data' => "");
                    }
                }

                   ///
                   $db->where('product_id',$product_id );
                   $db->where('client_id', $clientID);
                   $db->where('deleted', 0);
                   $db->orderby('id','desc');
                   $clientIDpw = $db->getone('product_favorite');
                 
                   if($clientIDpw){
                       return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations['M04110'][$language] /* Added to Favourite List Successfully*/ , 'data' =>"");
                    }
                   

                $insertData = array(
                    'product_id'    => $product_id,
                    'client_id'     => $clientID,
                    'created_ts'    => $dateTime,
                    'deleted'       => $deleted,
            
                );
                $insertFavoriteList = $db->insert('product_favorite', $insertData);
                if(!$insertFavoriteList){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => "Fail to Add Favourite List", 'data' => "");
               
                }
                Client::sendWFNotification($clientID,0,'favourite','add');
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['M04110'][$language] /* Added to Favourite List Successfully*/, 'data' => "");
            }
            else if ($action=='remove'){

                $db->where('id',$favoriteid);
                $db->where('client_id', $clientID);
                $db->where('deleted', 1);
                $db->orderby('id','desc');
                $clientIDpw = $db->getone('product_favorite');
              
                if($clientIDpw){
                 
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['M04112'][$language] /* Remove from Favourite List Successfully*/, 'data' =>"");
                }
                $removeDataArray = array(
                    "deleted" => 1,
                    "updated_ts" => date("Y-m-d H:i:s"),
                );
              
                $db->where('id', $favoriteid);
                $db->where('client_id', $clientID);
                $updatetoFavoriteList = $db->update('product_favorite', $removeDataArray);
            if(!$updatetoFavoriteList){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations['M04111'][$language] /* Fail to remove Favourite List */, 'data' => "");
           
            }
            Client::sendWFNotification($clientID,0,'favourite','remove');
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['M04112'][$language] /* Remove from Favourite List Successfully*/, 'data' => "");
            }
         }

        function addWishList($params)
        {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting::$systemSetting['deliveryFee'];  
           
            $product_id  = $params['product_id'];
            $action      = $params['action'];
            $wishlistid  = $params['wishlistid'];
            $dateTime=  date('Y-m-d H:i:s');
            $deleted = 0;
            $clientID = $db->userID; 
            
            if($clientID == null)
            {
                $clientID = $params['clientID'];
            }

            if(!$clientID) 
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
            }
                else{
                    $db->where('id', $clientID);
                    $clientInfo = $db->has('client');

                    if(!$clientInfo){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                    }
                }
            
           
            if($action=='add'){
             
                if(!$product_id ) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product. */, 'data' => "");
                }
                else{
                    
                    $db->where('id', $product_id);
                    $productInfo = $db->get('product');
                    
                    if(!$productInfo){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00955"][$language] /* Invalid Product. */, 'data' => "");
                    }
                }

                   ///
                   $db->where('product_id',$product_id );
                   $db->where('client_id', $clientID);
                   $db->where('deleted', 0);
                   $db->orderby('id','desc');
                   $clientIDpw = $db->getone('product_wishlist');
                 
                   if($clientIDpw){
                       return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M04107"][$language] /* Successfully added to wishlist */ , 'data' =>"");
                    }
                   

                $insertData = array(
                    'product_id'    => $product_id,
                    'client_id'     => $clientID,
                    'created_ts'    => $dateTime,
                    'deleted'       => $deleted,
            
                );
                $insertWishList = $db->insert('product_wishlist', $insertData);
                if(!$insertWishList){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M04108"][$language] /* Failed to add to wishlist */, 'data' => "");
               
                }
                Client::sendWFNotification($clientID,0,'wishlist','add');
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M04107"][$language] /* Successfully added to wishlist */, 'data' => "");
            }
            else if ($action=='remove'){

                $db->where('id',$wishlistid);
                $db->where('client_id', $clientID);
                $db->where('deleted', 1);
                $db->orderby('id','desc');
                $clientIDpw = $db->getone('product_wishlist');
              
                if($clientIDpw){
                 
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M04109"][$language] /* Successfully remove from wishlist */, 'data' =>"");
                }
                $removeDataArray = array(
                    "deleted" => 1,
                    "updated_ts" => date("Y-m-d H:i:s"),
                );
              
                $db->where('id', $wishlistid);
                $db->where('client_id', $clientID);
                $updatetoWishList = $db->update('product_wishlist', $removeDataArray);
            if(!$updatetoWishList){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M04108"][$language] /* Failed to add to wishlist */, 'data' => "");
           
            }
            Client::sendWFNotification($clientID,0,'wishlist','remove');
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M04109"][$language] /* Successfully remove from wishlist */, 'data' => "");
            }
         }

        




        public function addShoppingCart($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee = Setting::$systemSetting['deliveryFee'];

            $packageID                = $params['packageID'];
            $quantity                 = $params['quantity'];
            $type                     = $params['type'];
            $product_template         = $params['product_template'];
            $acceptedType             = array('add', 'inc', 'dec', 'num');
            $excludeType              = array('inc', 'dec');
            $todayDate                = date('Y-m-d H:i:s');

            $bkend_token_temp   = trim($params['bkend_token']);
            $step               = $params['step'];
            $promoCode      = trim($params['promo_code']);
            $adminResetClientID   = $params['adminResetClientID'];
            $adminSaleID          = $params['adminSaleID']; // means admin edit SO

            $clientID = $db->userID;

            if($adminResetClientID)
            {
                $clientID = $adminResetClientID;
            }

            if($clientID == null)
            {
                $clientID = $params['clientID'];
            }
            $site = $db->userType;

            if(!empty($product_template)){
                $product_template = explode(',', $product_template);
                $product_template = array_map('trim', $product_template);

                $db->where('product_id', $packageID);
                $db->where('product_attribute_value_id',json_encode($product_template));
                $product_template_id = $db->getOne('product_template a');
                $product_template_id = $product_template_id['id'];
            }
            else{
                $db->where('product_id', $packageID);
                $db->where('product_attribute_value_id',$product_template);
                $product_template_id = $db->getOne('product_template a');
                $product_template_id = $product_template_id['id'];
            }
            
            if($step != '1')
            {
                // if(!$clientID) {
                //     return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                // }else{
                    if($clientID)
                    {
                        $db->where('id', $clientID);
                        $clientInfo = $db->has('client');
    
                        if(!$clientInfo){
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                        }
                    }
                // }
            }

            if(empty($bkend_token_temp))
            {
                // generate token pass to frontend
                $autoLoginTokenRes = General::generateAutoLoginToken($dateTime, $timeOut);
                if(!$dateTime) $dateTime = date('Y-m-d H:i:s');
                $wbToken = $autoLoginTokenRes['wbToken'];
                $bkendToken = $autoLoginTokenRes['bkendToken'];
                $expiredTS  = $autoLoginTokenRes['expiredTS'];

                // check got existing token or not
                if(empty($clientID))
                {
                    // insert into guest_token table
                    $insertData = array(
                        'token'         => $bkendToken,
                        'client_id'     => $clientID,
                        'sale_id'       => '',
                        'created_at'    => $todayDate,
                    );
                    $insertGuestToken = $db->insert('guest_token', $insertData);
                }
                else
                {
                    // check user have old token or not
                    // $db->orderBy('id', 'desc');
                    // $db->where('client_id', $clientID);
                    // $oldToken = $db->getOne('guest_token');
                    // $oldToken = $oldToken['token'];

                    // search existing token based on client ID
                    $db->orderBy('id', 'desc');
                    $db->where('client_id', $clientID);
                    $tokenExist = $db->getOne('guest_token');

                    // if($tokenExist)
                    // {
                    //     $db->orderBy('created_at','DESC');
                    //     $db->where('client_id', $clientID);
                        
                    //     $updateData = array(
                    //         'token'         => $bkendToken,
                    //         'sale_id'       => '',
                    //     );
                    //     $updateGuestToken = $db->update('guest_token', $updateData);
                    // }
                    if(!$tokenExist)
                    {
                        // insert into guest_token table
                        $insertData = array(
                            'token'         => $bkendToken,
                            'client_id'     => $clientID,
                            'sale_id'       => '',
                            'created_at'    => $todayDate,
                        );
                        $insertGuestToken = $db->insert('guest_token', $insertData);
                    }
                    else if(!empty($tokenExist['sale_id']))
                    {
                        $db->where('id', $tokenExist['sale_id']);
                        $saleOrderStatus = $db->getOne('sale_order');
                        if($saleOrderStatus)
                        {
                            if(strtolower($saleOrderStatus['status']) != 'draft')
                            {
                                // insert into guest_token table
                                $updateData = array(
                                    'token'         => $tokenExist['token'],
                                    'client_id'     => $clientID,
                                    'sale_id'       => '',
                                    'created_at'    => $todayDate,
                                );
                                $db->where('client_id', $clientID);
                                $updateGuestToken = $db->update('guest_token', $updateData);
                            }
                        }
                    }
                }
            }
            else
            {
                // if got token, use back existing token
                $db->orderBy('id', 'desc');
                $db->where('token',$bkend_token_temp);
                $bkendToken = $db->getOne('guest_token');
                // check sale order status
                $db->where('id', $bkendToken['sale_id']);
                $saleOrderStatus = $db->getOne('sale_order');
                if($saleOrderStatus['status'] != 'Draft')
                {
                    $updateData = array(
                        'sale_id' => '',
                    );
                    $db->where('token', $bkend_token_temp);
                    $db->update('guest_token', $updateData);
                }

                if(!empty($bkendToken))
                {
                    $bkendToken = $bkendToken['token'];
                }
                 
                if(empty($bkendToken))
                {
                    // if not in table, generate new token
                    $autoLoginTokenRes = General::generateAutoLoginToken($dateTime, $timeOut);
                    if(!$dateTime) $dateTime = date('Y-m-d H:i:s');
                    $wbToken = $autoLoginTokenRes['wbToken'];
                    $bkendToken = $autoLoginTokenRes['bkendToken'];
                    $expiredTS  = $autoLoginTokenRes['expiredTS'];
    
                    // insert into guest_token table
                    $insertData = array(
                        'token'         => $bkendToken,
                        'client_id'     => $clientID,
                        'created_at'    => $todayDate,
                    );
                    $insertGuestToken = $db->insert('guest_token', $insertData);
                }
               
            }
            if($tokenExist)
            {
                $bkendToken = $tokenExist['token'];
            }

            if(!$packageID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00518"][$language] /* Invalid Stock. */, 'data' => "");
            }
            else{
                $db->where('id', $packageID);
                $packageInfo = $db->has('product');

                if(!$packageInfo){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00518"][$language] /* Invalid Stock. */, 'data' => "");
                }
            }
            // check stock amount
            $db->where("token", $bkend_token_temp);
            $db->where("disabled", 0);
            $db->where("product_id", $packageID);
            $cartQuantity = $db->getValue("shopping_cart", "quantity") ?? 0;
            $demandQuantity = $quantity + $cartQuantity;

            unset($dataIn);
            $dataIn['product_id'] = $packageID;
            // check product type
            $db->where('id', $packageID);
            $db->where('deleted', '0');
            $productType = $db->getOne('product', 'product_type');
            if(strtolower($productType['product_type'] == 'product'))
            {
                $dataIn['text'] = 'cart';
            }
            else
            {
                unset($dataIn['text']);
            }
            // $dataIn['quantity'] = $demandQuantity;
            if($type == 'dec')
            {
                $dataIn['quantity'] = $cartQuantity - $quantity;
            }
            else if($type == 'inc')
            {
                $dataIn['quantity'] = $cartQuantity + 1;
            }
            else if($type == 'add')
            {
                $dataIn['quantity'] = $cartQuantity + $quantity;
            }
            else
            {
                $dataIn['quantity'] = $cartQuantity;
            }

            // $dataIn['purchaseProduct'] = $dataIn;
            $db->where('id', $packageID);
            $db->where('deleted', '0');
            $productIgnoreCount = $db->getOne('product', 'ignore_stock_count');
            if($productIgnoreCount['ignore_stock_count'] != '1')
            {
                if($step != 'reorder'){
                    $dataOut = Inventory::checkStockQuantity($dataIn);
    
                    if($dataOut['status'] != 'ok')
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03005"][$language] /* Out Of Stock */, 'data' => $dataOut['data']);
                    }
                }
            }

            if($type == 'dec')
            {
                $quantity = $dataOut['data'];
            }

            // check SO got this product b4 or not
            $db->where('token', $bkend_token_temp);
            $guestTokenDetail = $db->getOne('guest_token');
            if(!empty($guestTokenDetail['sale_id']))
            {
                $saleID = $guestTokenDetail['sale_id'];
                $db->where('sale_id', $saleID);
                $db->where('deleted', '0');
                $db->where('product_id', $packageID);
                $saleOrderDetails = $db->get('sale_order_detail');
            }

            $db->where('id', $packageID);
            $db->where('deleted', 0);
            $productType = $db->getOne('product');

            if(!$type || !in_array($type, $acceptedType)){
                return array('status' => "error", 'code' => 21, 'statusMsg' => $translations["B00519"][$language] /* Invalid Type. */, 'data'=>"");

            }elseif(!in_array($type, $excludeType)){
                if(!$quantity || !is_numeric($quantity) || $quantity <= 0) {
                    return array('status' => "error", 'code' => 21, 'statusMsg' => $translations["B00520"][$language] /* Quantity must be greater than 0. */, 'data'=>"");
                }
            }
            if(!empty($tokenExist))
            {
                $currentToken = $tokenExist['token'];
            }
            else
            {
                $currentToken = $bkendToken;
            }

            switch ($type) {
                case 'add':
                    $db->where('disabled', 0);
                    $db->where('product_id', $packageID);
                    $db->where('token', $bkendToken);
                    $copyDB = $db->copy();
                    $shoppingCart = $db->getOne('shopping_cart', 'id, quantity');

                    if($shoppingCart){
                        $updateData = array(
                            'client_id'                  => $clientID,
                            // 'sale_id'                    => $sale_id,
                            'quantity'                   => $db->inc($quantity),
                            'token'                      => $currentToken,
                            'disabled'                   => 0,
                            'updated_at'                 => $todayDate,
                        );
                        $copyDB->update('shopping_cart', $updateData);

                    }else{
                        $insertData = array(
                            'client_id'                  => $clientID,
                            'sale_id'                    => $sale_id,
                            'product_id'                 => $packageID,
                            'quantity'                   => $quantity,
                            'token'                      => $currentToken,
                            'disabled'                   => 0,
                            'updated_at'                 => $todayDate,
                        );
                        $db->insert('shopping_cart', $insertData);
                     
                    }
                    break;

                case 'inc':
                    $quantity = 1;

                    $updateData = array(
                        'quantity'    => $db->inc($quantity),
                        'token'       => $currentToken,
                        'updated_at'  => $todayDate,
                    );
                    $db->where('disabled', 0);
                    $db->where('product_id', $packageID);
                    $db->where('token', $currentToken);
                    $db->update('shopping_cart', $updateData);
                    break;

                case 'dec':
                    $quantity = 1;

                    $updateData = array(
                        'token'       => $currentToken,
                        'quantity'    => $db->dec($quantity),
                        'updated_at'  => $todayDate,
                    );
                    $db->where('disabled', 0);
                    $db->where('product_id', $packageID);
                    $db->where('token', $currentToken);
                    $db->update('shopping_cart', $updateData);
                    break;

                case 'num':
                    $updateData = array(
                        'token'       => $currentToken,
                        'quantity'    => $quantity,
                        'updated_at'  => $todayDate,
                    );
                    $db->where('disabled', 0);
                    $db->where('product_id', $packageID);
                    $db->where('token', $currentToken);
                    $db->update('shopping_cart', $updateData);
                    break;
            }
            
            
            $saleParams['clientID'] = $clientID;
            if($adminResetClientID)
            {
                $saleParams['adminSOID'] = $bkendToken;
            }
            $saleParams['bkend_token'] = $currentToken;
            $saleParams['promo_code'] = $promoCode;
            $saleParams['adminResetClientID'] = $adminResetClientID;
            $saleParams['adminSaleID'] = $adminSaleID;
            $purchase_id = self::InsertSO($saleParams);

            // after insert SO, update shopping cart again
            $db->where('token', $currentToken);
            $db->where('disabled', '0');
            $updateData = array(
                'token'       => $currentToken,
                'sale_id' => $purchase_id['data'],
                'updated_at'  => $todayDate,
            );
            $db->update('shopping_cart', $updateData);
            
            // assign sale id to guest_token table
            if(!empty($clientID))
            {
                $updateData = array(
                    'client_id' => $clientID,
                    'sale_id'   => $purchase_id['data'],
                );
            }
            else
            {
                $updateData = array(
                    'sale_id' => $purchase_id['data'],
                );
            }
            $db->where('token', $currentToken);
            $db->update('guest_token', $updateData);

            $data['bkend_token'] = $currentToken;
            $data['sale_id']     = $purchase_id['data'];
         
            Client::sendSalesOrderNotification($clientID,$purchase_id['data'],$type);
    
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00516"][$language] /* Added To Cart */, 'data' => $data, 'saleID' => $purchase_id, 'currentToken' => $currentToken, 'bkendToken' => $bkendToken);
        }

        public function updateShoppingCart($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $package    = $params['package'];
            $todayDate  = date('Y-m-d H:i:s');
            $type       = $params['type'];

            $clientID = $params['clientID'];
            $promoCode = $params['promo_code'];
            $site = $db->userType;

            // backend token
            $bkendToken = $params['bkend_token'];

            if(!$clientID) {
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
            }else{
                $db->where('id', $clientID);
                $clientInfo = $db->has('client');

                if(!$clientInfo){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                }
            }
               
            foreach ($package as $packageRow) {
                if(!$packageRow['packageID']) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["B00518"][$language] /* Invalid Stock. */, 'data' => "");
                }

                if(!$packageRow['quantity'] || !is_numeric($packageRow['quantity']) || $packageRow['quantity'] <= 0) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["B00520"][$language] /* Quantity must be greater than 0. */, 'data'=>"");
                }

                // if(!$packageRow['product_template']) {
                //     return array('status' => "error", 'code' => 2, 'statusMsg' => 'Invalid Product Template ID.' /* Invalid Product Template ID. */, 'data'=>"");
                // }
            }

            foreach ($package as $packageRow) {
                if(!empty($packageRow['product_template'])){
                    $product_template = explode(',', $packageRow['product_template']);
                    $product_template = array_map('trim', $product_template);
        
                    $db->where('product_id', $packageRow['packageID']);
                    $db->where('product_attribute_value_id',json_encode($product_template));
                    $product_template_id = $db->getOne('product_template a');
                    $product_template_id = $product_template_id['id'];
                }
                else{
                    $db->where('product_id', $packageRow['packageID']);
                    $db->where('product_attribute_value_id',$packageRow['product_template']);
                    $product_template_id = $db->getOne('product_template a');
                    $product_template_id = $product_template_id['id'];
                }
                    
                $db->where('disabled', 0);
                // if(!empty($clientID))
                // {
                //     $db->where('client_id', $clientID);
                // }
                $db->where('token', $bkendToken);
                $db->where('product_id', $packageRow['packageID']);
                $db->where('product_template_id', $product_template_id);
                $copyDB = $db->copy();
                $shoppingCart = $db->getOne('shopping_cart', 'id, quantity');

                if($shoppingCart){

                    if(!empty($clientID))
                    {
                        $updateData = array(
                            'client_id'  => $clientID,
                            'quantity'   => ($packageRow['quantity']),
                            'updated_at' => $todayDate,
                        );
                    }
                    else
                    {
                        $updateData = array(
                            'quantity' => ($packageRow['quantity']),
                            'updated_at' => $todayDate,
                        );
                    }
                    $copyDB->update('shopping_cart', $updateData);
                }else{
                    if (is_numeric($product_template_id))
                    {
                        $insertData = array(
                            'client_id'         => $clientID,
                            'product_id'        => $packageRow['packageID'],
                            'product_template_id'          => $product_template_id,
                            'quantity'          => $packageRow['quantity'],
                            'token'             => $bkendToken,
                            'disabled'          => 0,
                            'updated_at'        => $todayDate,
                        );
                        $db->insert('shopping_cart', $insertData);
                    }
                    // else{
                    //     return array('status' => "error", 'code' => 2, 'statusMsg' => 'Product Template ID empty.' /* Product Template ID empty. */, 'data'=>"");
                    // }
                }
            }

            $saleParams['clientID'] = $clientID;
            $saleParams['bkend_token'] = $bkendToken;
            $saleParams['promo_code'] = $promoCode;
            $purchase_id = self::InsertSO($saleParams);
            // return array("code" => 333, "status" => "ok", "data" => $purchase_id, 'saleParams' => $saleParams);

            $data['clientID'] = $clientID;
            $data['purchase_id'] = $purchase_id;
            $data['product_template_id'] = $product_template_id;

            Client::sendSalesOrderNotification($clientID,$saleID,'update');
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00521"][$language] /* Updated Cart */, 'data' => $data);
        }

        
        public function removeShoppingCart($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $packageID  = $params['packageID'];
            $product_template  = $params['product_template'];
            $todayDate  = date('Y-m-d H:i:s');

            $bkendToken = $params['bkend_token'];
            $step       = $params['step'];

            $clientID = $db->userID;
            $site = $db->userType;

            if(!empty($product_template)){
                $product_template = explode(',', $product_template);
                $product_template = array_map('trim', $product_template);
                
                $db->where('product_id', $packageID);
                $db->where('product_attribute_value_id',json_encode($product_template));
                $product_template_id = $db->getOne('product_template a');
                $product_template_id = $product_template_id['id'];
            }
            else{
                $db->where('product_id', $packageID);
                $db->where('product_attribute_value_id', $product_template);
                $product_template_id = $db->getOne('product_template a');
                $product_template_id = $product_template_id['id'];
            }

            if($step != '1')
            {
                // if(!$clientID) {
                //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                // }else{
                    if($clientID)
                    {
                        $db->where('id', $clientID);
                        $clientInfo = $db->has('client');
        
                        if(!$clientInfo){
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00517"][$language] /* Invalid User. */, 'data' => "");
                        }
                    }
                // }
            }

            if(empty($bkendToken))
            {
                if(!empty($clientID))
                {
                    if(!$bkendToken)
                    {
                        // get old token
                        $db->orderBy('id', 'desc');
                        $db->where('client_id', $clientID);
                        $oldToken = $db->getOne('guest_token');
                        if($oldToken)
                        {
                            $bkendToken = $oldToken['token'];
                        }
                    }
                }
            }

            if(!$packageID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00518"][$language] /* Invalid Stock. */, 'data' => "");
            }else{
                $db->where('id', $packageID);
                $packageInfo = $db->has('product');

                if(!$packageInfo){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00518"][$language] /* Invalid Stock. */, 'data' => "");
                }
            }

            // if(!$product_template_id) {
            //     return array('status' => "error", 'code' => 1, 'statusMsg' => 'Invalid product template id', 'data' => "");
            // }else{
            //     $db->where('id', $product_template_id);
            //     $packageInfo = $db->has('product_template');

            //     if(!$packageInfo){
            //         return array('status' => "error", 'code' => 1, 'statusMsg' => 'Invalid product template id', 'data' => "");
            //     }
            // }

            // $db->where('disabled', 0);
            // if(!empty($clientID))
            // {
            //     $db->where('client_id', $clientID);
            // }
            // $db->where('token', $bkendToken);
            // $db->where('product_id', $packageID);
            // $db->where('product_template_id', $product_template_id);
            // $saleOrderID = $db->getValue('shopping_cart','sale_id');

            // use token to get sale id
            $db->where('token', $bkendToken);
            $saleID = $db->getOne('guest_token', 'sale_id');
            if($saleID)
            {
                $saleID = $saleID['sale_id'];
            }

            $db->where('id', $saleID);
            $getDeliveryMtd = $db->getValue('sale_order','delivery_method');

            $params['deliveryMethod']    = $getDeliveryMtd;
            $params['userID']            = $clientID;

            // Update If remove from shopping cart
            $arrayData = array(
                "disabled" => 1,
                "updated_at" => date("Y-m-d H:i:s"),
            );
            $db->where('disabled', 0);
            if(!empty($bkendToken))
            {
                $db->where('token', $bkendToken);
            }
            else
            {
                $db->where('client_id', $clientID);
            }
            $db->where('product_id', $packageID);
            // $db->where('product_template_id', $product_template_id);
            $deleteShoppingCart = $db->update("shopping_cart", $arrayData);

            // Update Sale Order Details
            $arrayData3 = array(
                "deleted" => 1,
                "updated_at" => date("Y-m-d H:i:s"),
            );
            $db->where('sale_id', $saleID);
            $db->where('product_id', $packageID);
            $updateSODetailAmount = $db->update("sale_order_detail", $arrayData3);

            $getCartTotalAmt = Cash::CheckOutCalculation($params, $clientID);
            // return array('status' => "error", 'code' => 22, 'statusMsg' => 'Invalid product template id', 'data' => $getCartTotalAmt);

            // Update Sale Order Amount and Delivery Method
            $arrayData2 = array(
                "delivery_method" => NULL,
                "payment_amount"  => $ttlPaymentAmount,
                "updated_at" => date("Y-m-d H:i:s"),
            );
            $db->where('id', $saleID);
            $updateSOAmount = $db->update("sale_order", $arrayData2);

            // Previous  Code
            // $db->where('disabled', 0);
            // $db->where('client_id', $clientID);
            // $db->where('product_id', $packageID);
            // $db->where('product_template_id', $product_template_id);
            // $db->delete('shopping_cart');

            $saleParams['clientID'] = $clientID;
            $saleParams['bkend_token'] = $bkendToken;
            $purchase_id = self::InsertSO($saleParams);
            Client::sendSalesOrderNotification($clientID,$saleID,'delete');
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00454"][$language] /* Removed From Cart */, 'data' => $saleParams);
        }


        function CheckSaleOrderDraftStatus($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            // $clientID = $params['clientID'];
            $bkendToken = $params['bkend_token'];

            // get sale id from guest_token table
            $db->where('token', $bkendToken);
            $saleID = $db->getOne('guest_token', 'sale_id');
            if($saleID)
            {
                $saleID = $saleID['sale_id'];
            }

            // if(!empty($clientID))
            // {
            //     $db->where("client_id",$clientID);
            // }
            $db->where('id', $saleID);
            $db->where("status", array('Pending', 'Draft'), 'In');
            $resSaleOrder = $db->getOne("sale_order");
            // if(empty($resSaleOrder))
            // {
            //     $db->where('token', $bkendToken);
            //     $db->where('disabled', 0);
            //     $resSaleOrder = $db->getOne("shopping_cart", "sale_id");
                
            //     // get sale id, then check status
            //     if($resSaleOrder)
            //     {
            //         $db->where('id', $resSaleOrder['sale_id']);
            //         $db->where("status", array('Pending', 'Draft'), 'In');
            //         $resSaleOrder = $db->getOne("sale_order", "id");
            //     }
            // }

            if($resSaleOrder){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'saleID' => $resSaleOrder['id']);
            }
            else{
                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'saleID' => 0);
            }
        }

        function InsertSO($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $clientID = $params['clientID'];
            $bkendToken = $params['bkend_token'];
            $promoCode = $params['promo_code'];
            $dateTime = date("Y-m-d H:i:s");
            $adminResetClientID   = $params['adminResetClientID'];
            $adminSaleID = $params['adminSaleID'];

            if($adminResetClientID)
            {
                $clientID = $adminResetClientID;
            }

            $status = "Draft";
            $payment_tax = 0;
            $createdDate = date("Y-m-d H:i:s");

            $saleParams['clientID'] = $clientID;
            $saleParams['bkend_token'] = $bkendToken;

            $cartInfo = Inventory::getShoppingCart2($params);

            if(!empty($clientID))
            {
                $CheckSaleOrderDraftStatus = self::CheckSaleOrderDraftStatus($saleParams); // get saleID
            }
            if(empty($clientID))
            {
                // check token valid or not
                $db->where('token', $bkendToken);
                $validToken = $db->getOne('guest_token');
                $db->where('token', $validToken['token']);
                $db->where('disabled', '0');
                $saleIDResult = $db->getOne('shopping_cart');
                if(empty($saleIDResult))
                {
                    // if 0, insert new so
                    $CheckSaleOrderDraftStatus['saleID'] = 0;
                }
                else
                {
                    // if not 0, then update so
                    $CheckSaleOrderDraftStatus['saleID'] = $saleIDResult['sale_id'];
                }

                $db->where('id', $validToken['sale_id']);
                $saleOrderStatus = $db->getOne('sale_order');
                if(strtolower($saleOrderStatus['status']) == 'draft')
                {
                    $CheckSaleOrderDraftStatus['saleID'] = $validToken['sale_id'];
                }
            }
            // return array("code" => 231, "status" => "ok", "CheckSaleOrderDraftStatus" => $CheckSaleOrderDraftStatus, 'bkendToken' => $bkendToken);

            $payment_amount = 0;
            $discount_amount = 0;
            $promo_amount = 0;
            $shippingFee = $cartInfo['data']['deliveryFee'];

            if($adminSaleID)
            {
                $CheckSaleOrderDraftStatus['saleID'] = $adminSaleID;
            }

            if ($CheckSaleOrderDraftStatus['saleID'] == 0){

                foreach($cartInfo["data"]["cartList"] as $cartData)
                {
                    unset($Total);
                    unset($latestTotal);

                    if($cartData['promo_type'] == 'pricelist')
                    {
                        $Total = $cartData['latestTotal'];
                    }
                    else
                    {
                        $Total = $cartData['total'];
                    }

                    $payment_amount = $payment_amount + $Total;
                }

                if(isset($cartInfo["data"]["appliedPromo"])){
                    foreach($cartInfo["data"]["appliedPromo"] as $promoInfo){
                        $promo_amount = $promo_amount + $promoInfo['totalDiscount'];
                    }
                }

                $release_amount = $payment_amount - $promo_amount - $discount_amount;
                $discountAmount = $discount_amount + $promo_amount;

                $db->where("so_no LIKE 'S%'");
                $db->orderBy("CAST(SUBSTRING(so_no, 2) AS UNSIGNED)", "DESC");
                $lastSaleRecord = $db->getOne("sale_order");

                if($lastSaleRecord) {
                $last_sale_no = $lastSaleRecord["so_no"];
                } else {
                $last_sale_no = "S00000";
                }

                $last_sale_no = substr($last_sale_no, 1);
                $next_sale_no = "S".sprintf('%05d', ($last_sale_no + 1));
                // Client::sendSalesOrderNotification($clientID,$next_sale_no);

                //insert sale
                $field = array("so_no",
                    "client_id","package_id","payment_amount","redeem_amount",
                    "shipping_fee","payment_tax","release_amount",
                    "payment_expired_date","status",
                    "refund","remark","updated_at","created_at",
                    "promotion", "promotion_code", 'discount_amount' 
                    );

                $value = array($next_sale_no,
                        $clientID,$package_id,$payment_amount,$redeemAmount,
                        $shippingFee,$payment_tax,$release_amount,
                        date("Y-m-d H:i:s"),$status,
                        $refund,$remark,date("Y-m-d H:i:s"), $createdDate,
                        $isPromo, $promoCode, $discountAmount
                    );

                $arrayData = array_combine($field, $value);
                $purchase_id = $db->insert("sale_order",$arrayData); 
                $db->where('disabled', 0);
                $db->where('token', $bkendToken);
                $shopping_cart = $db->get('shopping_cart a', null, '');

                foreach ($shopping_cart as $detailRow) {
                    $product_idAry[$detailRow['product_id']] = $detailRow['product_id'];
                }

                if($product_idAry){
                    $db->where("id", $product_idAry, "IN" );
                    $productAry= $db->map('id')->get("product", NULL,"");
                }

                if ($purchase_id){
                    $createdDate = date("Y-m-d H:i:s");
                    $subtotal = 0;

                $db->where('id', $purchase_id);
                $soInfo = $db->getOne('sale_order');
                    foreach($cartInfo["data"]["cartList"] as $cartData)
                    {
                        $db->where('id', $cartData['product_id']);
                        $db->where('deleted', 0);
                        $productType = $db->getOne('product');

                        if($cartData["promo_type"] == "pricelist"){
                            $itemPrice = $cartData["latestPrice"];
                        }
                        else
                        {
                            $itemPrice = $cartData["price"];
                        }

                        unset($Total);
                        unset($latestTotal);

                        if($cartData['latestTotal'])
                        {
                            $latestTotal = $cartData['latestTotal'];
                        }

                        $Total = $cartData['total'];

                            $insertData = array(
                            'client_id'     => $res['client_id'],
                            'product_id'    => $cartData["product_id"],
                            'product_template_id'    => '',
                            'item_name'    => $cartData["productName"],
                            'item_price'    => $itemPrice,
                            'price_reduce' => $cartData['latestPrice'],
                            'quantity'    => $cartData['quantity'],
                            'subtotal'    => $Total,
                            'price_reduce_subtotal' => $latestTotal,
                            'sale_id'    => $purchase_id,
                            'type'    => $productType['product_type'],
                            'deleted'    => '0',
                            'created_at'    => date('Y-m-d H:i:s')
                        );
                        $soDetailID = $db->insert("sale_order_detail",$insertData);

                        $productQuantity = $cartData['quantity'];
                        for($loopQuantity = 0; $loopQuantity < intval($productQuantity); $loopQuantity++)
                        {
                            if(strtolower($productType['product_type']) == 'package')
                            {
                                $db->where('package_id', $cartData['product_id']);
                                $db->where('deleted', '0');
                                $packageItemDetail = $db->get('package_item');
                                # handle multitple quantity
                                $productsByQuantity = [];
                                foreach($packageItemDetail as $detailQuantity)
                                {
                                    if($detailQuantity['quantity'] >= 1)
                                    {
                                        for($loopQuantity1 = 0; $loopQuantity1 < $detailQuantity['quantity']; $loopQuantity1++)
                                        {
                                            $productsByQuantity[] = $detailQuantity;
                                        }
                                    }
                                    else
                                    {
                                        $productsByQuantity[] = $detailQuantity;
                                    }
                                }

                                foreach($productsByQuantity as $insertPackageProduct)
                                {
                                    $insertData = array(
                                        'so_no'         => $soInfo['so_no'],
                                        'so_details_id' => $soDetailID,
                                        'product_id'    => $insertPackageProduct['product_id'],
                                        'package_id'    => $cartData['product_id'],
                                        'is_package'    => '1',
                                        'remark'        => '',
                                        'deleted'       => '0',
                                    );
                                    $db->insert('sale_order_item', $insertData);
                                }
                            }
                            else if(strtolower($productType['product_type']) == 'product')
                            {
                                $insertData = array(
                                    'so_no'         => $soInfo['so_no'],
                                    'so_details_id' => $soDetailID,
                                    'product_id'    => $cartData['product_id'],
                                    'package_id'    => '',
                                    'is_package'    => '0',
                                    'remark'        => '',
                                    'deleted'       => '0',
                                );
                                $db->insert('sale_order_item', $insertData);
    
                            }
                        }
                    }

                    if(isset($cartInfo["data"]["appliedPromo"])){
                        foreach($cartInfo["data"]["appliedPromo"] as $promoInfo){
        
                            if(strtolower($promoInfo['type']) == 'billdiscount')
                            {
                                $promoDiscountType = 'Bill Discount (Promo Code Discount)';
                            }
                            else if(strtolower($promoInfo['type']) == 'freeshipping')
                            {
                                $promoDiscountType = 'Free Shipping (Promo Code Discount)';
                            }
                            else if(strtolower($promoInfo['type']) == 'pwp')
                            {
                                $promoDiscountType = 'PWP (Promo Code Discount)';
                            }else{
                                $promoDiscountType = $promoInfo['name'];
                            }
                            $insertData = array(
                                'client_id'     => $res['client_id'],
                                'product_id'    => '',
                                'product_template_id'    => '',
                                'item_name'    => $promoDiscountType,
                                'item_price'    => $promoInfo['totalDiscount'],
                                'quantity'    => '1',
                                'subtotal'    => $promoInfo['totalDiscount'],
                                'sale_id'    => $purchase_id,
                                'type'    => 'promo_code',
                                'deleted'    => '',
                                'created_at'    => date('Y-m-d H:i:s')
                            );
        
                            $db->insert("sale_order_detail",$insertData);
                        }
                    }

                    $updateData = array(
                        'sale_id' => $purchase_id,
                    );
                    $db->where('disabled', 0);
                    $db->where('client_id', $clientID);
                    $db->update('shopping_cart', $updateData);
                }
            }else{
                $purchase_id = $CheckSaleOrderDraftStatus['saleID'];
                
                $db->where('sale_id', $purchase_id);
                $db->where('deleted', '0');
                $shopping_cart = $db->get('sale_order_detail');

                foreach ($shopping_cart as $detailRow) {
                    $product_idAry[$detailRow['product_id']] = $detailRow['product_id'];
                }

                if($product_idAry){
                    $db->where("id", $product_idAry, "IN" );
                    $productAry= $db->map('id')->get("product", NULL,"");
                }

                $updateData = array(
                    'sale_id' => $purchase_id,
                );
                $db->where('disabled', 0);
                $db->where('token', $bkendToken);
                $db->update('shopping_cart', $updateData);

                $updateData = array(
                    "deleted"    => 1
                );
                $db->where('deleted', 0);
                $db->where('sale_id', $purchase_id);
                
                $db->update("sale_order_detail", $updateData);

                foreach($cartInfo["data"]["cartList"] as $cartData)
                {
                    unset($Total);
                    unset($latestTotal);

                    if($cartData['promo_type'] == 'pricelist')
                    {
                        $Total = $cartData['latestTotal'];
                    }
                    else
                    {
                        $Total = $cartData['total'];
                    }

                    $payment_amount = $payment_amount + $Total;
                }

                if(isset($cartInfo["data"]["appliedPromo"])){
                    foreach($cartInfo["data"]["appliedPromo"] as $promoInfo){
                        $promo_amount = $promo_amount + $promoInfo['totalDiscount'];
                    }
                }

                $release_amount = $payment_amount - $promo_amount - $discount_amount;
                $discountAmount = $discount_amount + $promo_amount;


                if(!empty($clientID))
                {
                    $updateData = array(
                        "client_id"         => $clientID,
                        "payment_amount"    => $payment_amount,
                        "shipping_fee"      => $shippingFee,
                        "release_amount"    => $release_amount,
                        "discount_amount"   => $discountAmount,
                        "updated_at"        => date("Y-m-d H:i:s")
                    );
                }
                else
                {
                    $updateData = array(
                        "payment_amount"    => $payment_amount,
                        "shipping_fee"      => $shippingFee,
                        "release_amount"    => $release_amount,
                        "discount_amount"   => $discountAmount,
                        "updated_at"        => date("Y-m-d H:i:s")
                    );
                }
                $db->where('id', $purchase_id);
                $db->update("sale_order", $updateData);
                
                // unset($shopping_cart);
                $db->where('sale_id', $purchase_id);
                $db->where('disabled', 0);
                $db->where('token', $bkendToken);
                $shopping_cart2 = $db->get('shopping_cart', null, '');
                if($shopping_cart2)
                {
                    $shopping_cart = $shopping_cart2;
                }
                
                $db->where('id', $purchase_id);
                $soInfo = $db->getOne('sale_order');

                $updateData = array(
                    'deleted' => '1'
                );
                $db->where('so_no', $soInfo['so_no']);
                $db->update('sale_order_item', $updateData);

                foreach($cartInfo["data"]["cartList"] as $cartData)
                {
                    $db->where('id', $cartData['product_id']);
                    $db->where('deleted', 0);
                    $productType = $db->getOne('product');

                    if($cartData["promo_type"] == "pricelist"){
                        $itemPrice = $cartData["latestPrice"];
                    }
                    else
                    {
                        $itemPrice = $cartData["price"];
                    }
    
                    unset($Total);
                    unset($latestTotal);
    
                    if($cartData['latestTotal'])
                    {
                        $latestTotal = $cartData['latestTotal'];
                    }
    
                    $Total = $cartData['total'];
    
                        $insertData = array(
                        'client_id'     => $res['client_id'],
                        'product_id'    => $cartData["product_id"],
                        'product_template_id'    => '',
                        'item_name'    => $cartData["productName"],
                        'item_price'    => $itemPrice,
                        'price_reduce' => $cartData['latestPrice'],
                        'quantity'    => $cartData['quantity'],
                        'subtotal'    => $Total,
                        'price_reduce_subtotal' => $latestTotal,
                        'sale_id'    => $purchase_id,
                        'type'    => $productType['product_type'],
                        'deleted'    => '0',
                        'created_at'    => date('Y-m-d H:i:s')
                    );
                    $soDetailID = $db->insert("sale_order_detail",$insertData);
                    $productQuantity = $cartData['quantity'];

                    for($loopQuantity = 0; $loopQuantity < intval($productQuantity); $loopQuantity++)
                    {
                        if(strtolower($productType['product_type']) == 'package')
                        {
                            $db->where('package_id', $cartData['product_id']);
                            $db->where('deleted', '0');
                            $packageItemDetail = $db->get('package_item');

                            # handle multitple quantity
                            $productsByQuantity = [];
                            foreach($packageItemDetail as $detailQuantity)
                            {
                                if($detailQuantity['quantity'] >= 1)
                                {
                                    for($loopQuantity1 = 0; $loopQuantity1 < $detailQuantity['quantity']; $loopQuantity1++)
                                    {
                                        $productsByQuantity[] = $detailQuantity;
                                    }
                                }
                                else
                                {
                                    $productsByQuantity[] = $detailQuantity;
                                }
                            }

                            foreach($productsByQuantity as $insertPackageProduct)
                            {
                                $insertData = array(
                                    'so_no'         => $soInfo['so_no'],
                                    'so_details_id' => $soDetailID,
                                    'product_id'    => $insertPackageProduct['product_id'],
                                    'package_id'    => $cartData['product_id'],
                                    'is_package'    => '1',
                                    'remark'        => '',
                                    'deleted'       => '0',
                                );
                                $db->insert('sale_order_item', $insertData);
                            }
                        }
                        else if(strtolower($productType['product_type']) == 'product')
                        {
                            $insertData = array(
                                'so_no'         => $soInfo['so_no'],
                                'so_details_id' => $soDetailID,
                                'product_id'    => $cartData['product_id'],
                                'package_id'    => '',
                                'is_package'    => '0',
                                'remark'        => '',
                                'deleted'       => '0',
                            );
                            $db->insert('sale_order_item', $insertData);
    
                        }
                    }
                }

                if(isset($cartInfo["data"]["appliedPromo"])){
                    foreach($cartInfo["data"]["appliedPromo"] as $promoInfo){
    
                        if(strtolower($promoInfo['type']) == 'billdiscount')
                        {
                            $promoDiscountType = 'Bill Discount (Promo Code Discount)';
                        }
                        else if(strtolower($promoInfo['type']) == 'freeshipping')
                        {
                            $promoDiscountType = 'Free Shipping (Promo Code Discount)';
                        }
                        else if(strtolower($promoInfo['type']) == 'pwp')
                        {
                            $promoDiscountType = 'PWP (Promo Code Discount)';
                        }else{
                            $promoDiscountType = $promoInfo['name'];
                        }
                        $insertData = array(
                            'client_id'     => $res['client_id'],
                            'product_id'    => '',
                            'product_template_id'    => '',
                            'item_name'    => $promoDiscountType,
                            'item_price'    => $promoInfo['totalDiscount'],
                            'quantity'    => '1',
                            'subtotal'    => $promoInfo['totalDiscount'],
                            'sale_id'    => $purchase_id,
                            'type'    => 'promo_code',
                            'deleted'    => '',
                            'created_at'    => date('Y-m-d H:i:s')
                        );
    
                        $db->insert("sale_order_detail",$insertData);
                    }
                }
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $purchase_id);
        }

        public function combineBillingAddress($params){
            $db           = MysqliDb::getInstance();
            $language     = General::$currentLanguage;
            $translations = General::$translations;
    
            $clientID = $params["clientID"]; 
            
            $db->where('client_id', $clientID);
            $getAddress = $db->get('address', null, 'name, phone, address, address_2, post_code, city, state_id, country_id, address_type');

            foreach ($getAddress as $addressRow){
                $db->where('id', $addressRow['state_id']);
                $getState = $db->getValue('state', 'name');
        
                $db->where('id', $addressRow['country_id']);
                $getCountry = $db->getValue('country', 'name');
                
                if($addressRow['address_type']=="shipping"){
                    $buildAddress['shipping_name'] = $addressRow['name'];
                    $buildAddress['shipping_phone'] = $addressRow['phone'];
                    $combineAdd = $addressRow['address'].', '.$addressRow['address_2'].', '.$addressRow['post_code'].', '.$addressRow['city'].', '.$getState.', '.$getCountry;
                    $buildAddress['shipping_address'] = $combineAdd; 
                    // $buildAddress['shipping_address'] = $addressRow['address'] . ',' .$addressRow['post_code'] . ',' .$addressRow['city'] . ','.$getState . ','.$getCountry;
                }else if($addressRow['address_type']=="billing"){
                    $buildAddress['billing_name'] = $addressRow['name'];
                    $buildAddress['billing_phone'] = $addressRow['phone'];
                    $combineAdd = $addressRow['address'].', '.$addressRow['address_2'].', '.$addressRow['post_code'].', '.$addressRow['city'].', '.$getState.', '.$getCountry;
                    $buildAddress['billing_address'] = $combineAdd;
                }
            }
            if($buildAddress['billing_name']==""){
                $buildAddress['billing_name'] = $buildAddress['shipping_name'];
                $buildAddress['billing_phone'] = $buildAddress['shipping_phone'];
                $buildAddress['billing_address'] = $buildAddress['shipping_address'];
            }

            return $buildAddress;
        }

        function validPackageVerification($countryID,$packageAry){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");

            $clientID = $db->userID;
            $site = $db->userType;

            if(!$clientID){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00361"][$language] /* Invalid Client */ , "data" => "");
            }

            if(!$packageAry){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01078"][$language] /* Invalid Package */, "data" => "");
            }

            $db->where('is_starter_kit', 1);
            $starterKitPackage = $db->getValue('mlm_product', 'id', null);

            if($starterKitPackage){
                $db->where('client_id', $clientID);
                $db->where('product_id', $starterKitPackage, 'IN');
                $starterPurchased = $db->getValue('mlm_client_portfolio', 'id');
            }

            unset($packageIDAry);

            foreach($packageAry as $packageRow){
                $packageIDAry[$packageRow["packageID"]] = $packageRow["quantity"];
            }

            $db->where("id",array_keys($packageIDAry),"IN");
            $db->where("status","Active");
            $db->where("active_at",$dateTime,"<=");
            $packageData = $db->map("id")->get("mlm_product",null,"id, name, weight, pv_price as bonusValue, total_balance, total_sold, is_unlimited, total_holding");

            foreach($packageIDAry as $packageID => $packageQty){
                if(!$packageData[$packageID]){
                    $errorFieldArr[] = array(
                        "id" => "package".$packageID."Error",
                        "msg" => $translations["E01090"][$language],
                    );
                }

                if(!$starterPurchased && (!in_array($packageID, $starterKitPackage))){
                    return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01114"][$language], "data" => "");
                }

                if($starterPurchased && (in_array($packageID, $starterKitPackage))){
                    return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01115"][$language], "data" => "");
                }

                if(in_array($packageID, $starterKitPackage) && $packageQty > 1){
                    return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01117"][$language], "data" => "");
                }

                if(in_array($packageID, $starterKitPackage)){
                    $startKitCount += 1;
                }
            }

            if($startKitCount > 1){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01117"][$language], "data" => "");
            }

            foreach($packageData as $packageID => $setting){
                $packageData[$packageID]["weight"] = Setting::setDecimal($setting["weight"]);
                $packageData[$packageID]["bonusValue"] = Setting::setDecimal($setting["bonusValue"]);
                $packageData[$packageID]["totalBalance"] = Setting::setDecimal($setting["total_balance"]);

                $totalBalance = $setting["total_balance"] - $setting["total_sold"] - $setting['total_holding'];
                $isUnlimited = $setting['is_unlimited'];

                if(($totalBalance < $packageIDAry[$packageID]) && $isUnlimited == 0){
                    $errorFieldArr[] = array(
                        "id" => "package".$packageID."Error",
                        "msg" => $translations["E01088"][$language],
                    );
                }

                if(in_array($packageID, $starterKitPackage)){
                    $packageData[$packageID]["isStarterKit"] = 1;
                }

                unset($packageData[$packageID]["total_balance"]);
                unset($packageData[$packageID]["total_sold"]);
            }

            $db->where("product_id",array_keys($packageIDAry),"IN");
            $db->where("type",array("Image"),"IN");
            $packageSetting = $db->get("mlm_product_setting",null,"product_id, type, value");

            if(!$packageSetting){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01078"][$language] /* Invalid Package */, "data" => "");
            }

            foreach($packageSetting as $setting){
                $packageData[$setting["product_id"]][$setting["type"]][] = $setting["value"];
            }

            $db->where("product_id",array_keys($packageIDAry),"IN");
            $db->where("country_id", $countryID);
            $db->where("disabled", 0);
            $packageSetting = $db->get("mlm_product_price",null,"product_id, price, promo_price as promoPrice, m_price as mPrice, ms_price as msPrice");

            unset($packagePriceAry);

            foreach($packageSetting as $setting){
                $packageData[$setting["product_id"]]['price'] = Setting::setDecimal($setting['price']);
                $packageData[$setting["product_id"]]['promoPrice'] = Setting::setDecimal($setting['promoPrice']);

                if(!in_array($setting["product_id"], $starterKitPackage)){
                    $packageData[$setting["product_id"]]['mPrice'] = Setting::setDecimal($setting['mPrice']);
                    $packageData[$setting["product_id"]]['msPrice'] = Setting::setDecimal($setting['msPrice']);
                }else{
                    $packageData[$setting["product_id"]]['mPrice'] = 0;
                    $packageData[$setting["product_id"]]['msPrice'] = 0;
                }

                $packagePriceAry[$setting["product_id"]] = $setting["product_id"];
            }

            foreach($packageIDAry as $packageID => $packageQty){
                if(!$packagePriceAry[$packageID]){
                    $errorFieldArr[] = array(
                        "id" => "package".$packageID."Error",
                        "msg" => $translations["E01091"][$language],
                    );
                }
            }

            if($errorFieldArr){
                $dataOut["errorFieldArr"] = $errorFieldArr;
            }

            $db->where("value",array_keys($packageIDAry),"IN");
            $db->where("type","validPackage");
            $productDetail = $db->get("inv_product_detail",null,"value as package_id, inv_product_id, reference as product_qty");

            unset($productIDAry);

            foreach($productDetail as $productRow){
                $productIDAry[$productRow["inv_product_id"]] = $productRow["inv_product_id"];
            }

            if($productIDAry){
                $db->where("id",$productIDAry,"IN");
                $db->where("status","Active");
                $productData = $db->map("id")->get("inv_product",null,"id,weight");

                foreach($productDetail as $productRow){
                    unset($tempProduct);

                    $tempProduct["productID"] = $productRow["inv_product_id"];
                    $tempProduct["quantity"] = Setting::setDecimal($productRow["product_qty"]);
                    $tempProduct["weight"] = Setting::setDecimal($productData[$productRow["inv_product_id"]], 3);

                    $packageData[$productRow["package_id"]]["product"][] = $tempProduct;
                }
            }

            $dataOut["packageData"] = $packageData;

            return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $dataOut);
        }

        function getClientActiveAddress(){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");

            $clientID = $db->userID;
            $site = $db->userType;

            if(!$clientID){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00361"][$language] /* Invalid Client */, "data" => "");
            }

            $db->where("name", "pickUpOrigins");
            $companyAddressRes = $db->get("system_settings", null, "name, value AS pickupID, reference as address");
            foreach ($companyAddressRes as &$companyAddressRow) {
                $companyAddressRow['name'] = 'HQ';
            }

            if(!$companyAddressRes){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01086"][$language] /* Invalid Address */, "data" => "");
            }

            /*foreach($companyAddressRes as $companyAddressRow){
                unset($tempAddress);

                $tempAddress["pickupID"] = $companyAddressRow["reference"];
                $tempAddress["name"] = $companyAddressRow["name"];
                $tempAddress["address"] = $companyAddressRow["value"];

                $pickupAddressData[] = $tempAddress;
            }*/

            $dataOut["pickupAddressData"] = $companyAddressRes;

            $db->where("client_id", $clientID);
            $db->where("disabled", "0");
            $db->orderBy("type", "DESC");
            $addressData = $db->get("address",null,"id, type, name, email, phone, address, state_id, district_id, sub_district_id, city, post_code, country_id, address_type");

            if(!$addressData){
                return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $dataOut);
            }

            unset($countryIDAry,$stateIDAry,$districtIDAry,$subDistrictIDAry,$cityIDAry,$postCodeIDAry);

            foreach($addressData as $addressRow){
                $countryIDAry[$addressRow["country_id"]] = $addressRow["country_id"];
                $stateIDAry[$addressRow["state_id"]] = $addressRow["state_id"];
                $districtIDAry[$addressRow["district_id"]] = $addressRow["district_id"];
                $subDistrictIDAry[$addressRow["sub_district_id"]] = $addressRow["sub_district_id"];
                $cityIDAry[$addressRow["city"]] = $addressRow["city"];
                $postCodeIDAry[$addressRow["post_code"]] = $addressRow["post_code"];
            }

            if($countryIDAry && $stateIDAry && $districtIDAry && $subDistrictIDAry && $cityIDAry && $postCodeIDAry){
                $db->where("id",$countryIDAry,"IN");
                $countryDisplay = $db->map("id")->get("country",null,"id,name,translation_code,country_code");

                $db->where("id",$stateIDAry,"IN");
                $stateDisplay = $db->map("id")->get("state",null,"id,name,translation_code");

                $db->where("id",$districtIDAry,"IN");
                $districtDisplay = $db->map("id")->get("county",null,"id,name");

                $db->where("id",$subDistrictIDAry,"IN");
                $subDistrictDisplay = $db->map("id")->get("sub_county",null,"id,name");

                $db->where("id",$cityIDAry,"IN");
                $cityDisplay = $db->map("id")->get("city",null,"id,name");

                $db->where("id",$postCodeIDAry,"IN");
                $postCodeDisplay = $db->map("id")->get("zip_code",null,"id,name");
            }

            unset($deliveryAddressData,$billingAddressData);

            foreach($addressData as $addressRow){
                unset($tempAddress);

                $tempAddress["addressID"] = $addressRow["id"];
                $tempAddress["isDefault"] = ($addressRow["type"] ? 1 : 0);
                $tempAddress["fullName"] = $addressRow["name"];
                $tempAddress["emailAddress"] = $addressRow["email"];
                $tempAddress["dialingArea"] = $countryDisplay[$addressRow["country_id"]]["country_code"];
                $tempAddress["phoneNumber"] = $addressRow["phone"];
                $tempAddress["address"] = $addressRow["address"];
                $tempAddress["stateID"] = $addressRow["state_id"];
                $tempAddress["stateName"] = $stateDisplay[$addressRow["state_id"]]["name"];
                $tempAddress["stateDisplay"] = $translations[$stateDisplay[$addressRow["state_id"]]["translation_code"]][$language];
                $tempAddress["districtID"] = $addressRow["district_id"];
                $tempAddress["district"] = $districtDisplay[$addressRow["district_id"]];
                $tempAddress["subDistrictID"] = $addressRow["sub_district_id"];
                $tempAddress["subDistrict"] = $subDistrictDisplay[$addressRow["sub_district_id"]];
                $tempAddress["cityID"] = $addressRow["city"];
                $tempAddress["city"] = $cityDisplay[$addressRow["city"]];
                $tempAddress["postalCodeID"] = $addressRow["post_code"];
                $tempAddress["postalCode"] = $postCodeDisplay[$addressRow["post_code"]];
                $tempAddress["countryID"] = $addressRow["country_id"];
                $tempAddress["countryName"] = $countryDisplay[$addressRow["country_id"]]["name"];
                $tempAddress["countryDisplay"] = $translations[$countryDisplay[$addressRow["country_id"]]["translation_code"]][$language];

                switch($addressRow["address_type"]){
                    case "delivery":
                        $deliveryAddressData[$addressRow["id"]] = $tempAddress;
                        break;

                    case "billing":
                        $billingAddressData[] = $tempAddress;
                        break;

                    default:
                        break;
                }
            }

            $dataOut["deliveryAddressData"] = $deliveryAddressData;
            $dataOut["billingAddressData"] = $billingAddressData;

            return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $dataOut);
        }

        public function checkValidVoucher($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $clientID = $db->userID;
            $site = $db->userType;
            $sessionData = $db->sessionID;

            if(!$clientID){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00361"][$language], "data" => "");
            }

            $voucherCode = trim($params["voucherCode"]);
            $packageIDAry = $params["packageIDAry"];
            $courierService = trim($params["courierService"]);

            $db->where("code",$voucherCode);
            $db->where("status","Active");
            $voucherData = $db->getOne("inv_voucher","id,type,total_balance,total_used,is_unlimited");

            $voucherID = $voucherData["id"];
            $voucherType = $voucherData["type"];
            $voucherQuantity = $voucherData["total_balance"];
            $voucherSold = $voucherData["total_used"];
            $voucherBalance = ($voucherQuantity - $voucherSold);
            $unlimitedVoucher = $voucherData["is_unlimited"];

            if(empty($voucherData)){
                $errorFieldArr[] = array(
                    "id" => "voucherCodeError",
                    "msg" => $translations["E01126"][$language],
                );
            }else{
                $db->where("inv_voucher_id",$voucherID);
                $db->where("type","validPackage");
                $voucherPackageIDAry = $db->getValue("inv_voucher_detail","value",null);

                $db->where("inv_voucher_id",$voucherID);
                $db->where("type","tieUpType");
                $voucherTieUpType = $db->getValue("inv_voucher_detail","value");

                if(($unlimitedVoucher == 0) && ($voucherBalance <= 0)){
                    $errorFieldArr[] = array(
                        "id" => "voucherCodeError",
                        "msg" => $translations["E01127"][$language],
                    );
                }else{
                    if(($voucherTieUpType) && ($voucherPackageIDAry)){
                        switch($voucherTieUpType){
                            case "normal":
                                if(($voucherPackageIDAry) && (empty(array_intersect($voucherPackageIDAry,$packageIDAry)))){
                                    $errorFieldArr[] = array(
                                        "id" => "voucherCodeError",
                                        "msg" => $translations["E01128"][$language],
                                    );
                                }
                                break;

                            case "single":
                                if($voucherPackageIDAry){
                                    foreach($packageIDAry as $packageID){
                                        if((!in_array($packageID,$voucherPackageIDAry))){
                                            $errorFieldArr[] = array(
                                                "id" => "voucherCodeError",
                                                "msg" => $translations["E01128"][$language],
                                            );
                                            break;
                                        }
                                    }
                                }
                                break;

                            default:
                                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E01126"][$language], "data" => "");
                                break;
                        }
                    }else{
                        if(($voucherPackageIDAry) && (empty(array_intersect($voucherPackageIDAry,$packageIDAry)))){
                            $errorFieldArr[] = array(
                                "id" => "voucherCodeError",
                                "msg" => $translations["E01128"][$language],
                            );
                        }
                    }
                }
            }

            if($errorFieldArr){
                $data["field"] = $errorFieldArr;
                return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00130"][$language], "data" => $data);
            }

            $db->where("inv_voucher_id",$voucherID);
            $db->where("name","discountBy");
            $discountByData = $db->getOne("inv_voucher_detail","value,type,reference");

            $discountType = $discountByData["type"];

            $isPercentage = 0;
            $isAmount = 0;
            switch($discountType){
                case "percentage":
                    $discountPercentage = $discountByData["value"];
                    $maxDiscountAmount = $discountByData["reference"];
                    $isPercentage = 1;
                    break;

                case "amount":
                    $discountAmount = $discountByData["value"];
                    $isAmount = 1;
                    break;

                default:
                    break;
            }

            switch($voucherType){
                case "delivery":
                    $db->where("token",$sessionData);
                    $sessionID = $db->getValue("client_session","id");

                    if($sessionID){
                        $db->where("session_id",$sessionID);
                        $db->where("client_id",$clientID);
                        $db->where("type","shippingFee");
                        $shippingFeeData = $db->getValue("session_data","data");

                        if(empty($shippingFeeData)){
                            $errorFieldArr[] = array(
                                "id" => "courierServiceError",
                                "msg" => $translations["E01129"][$language],
                            );
                        }else{
                            $shippingFeeData = json_decode($shippingFeeData,true);

                            unset($courierData);
                            foreach ($shippingFeeData as $shippingFeeRow) {
                                foreach ($shippingFeeRow as $shippingFee) {
                                    $courierData[$shippingFee['courier']] = $shippingFee;
                                }
                            }

                            unset($courierDataAry);
                            foreach($courierData as $courierRow){
                                $courierDataAry[$courierRow["courier"]] = $courierRow["price"];
                            }

                            $amount = $courierDataAry[$courierService];

                            if(empty($amount) || empty($courierService)){
                                $errorFieldArr[] = array(
                                    "id" => "courierServiceError",
                                    "msg" => $translations["E01129"][$language],
                                );
                            }
                        }
                    }
                    break;

                default:
                    return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00741"][$language], "data" => "");
                    break;
            }

            if($errorFieldArr){
                $data["field"] = $errorFieldArr;
                return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00130"][$language], "data" => $data);
            }

            if($isPercentage){
                $discountAmount = Setting::setDecimal(($amount * ($discountPercentage/100)));
                if(($maxDiscountAmount > 0) && ($discountAmount >= $maxDiscountAmount)){
                    $discountAmount = $maxDiscountAmount;
                }
            }

            $data["voucherType"] = $voucherType;
            $data["discountAmount"] = $discountAmount;

            return array("status" => "ok", "code" => 0, "statusMsg" => $translations["B00484"][$language], "data" => $data);
        }

        public function insertOrderVoucher($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $invOrderID = trim($params["invOrderID"]);
            $voucherCode = trim($params["voucherCode"]);
            $realDiscountAmount = trim($params["realDiscountAmount"]);

            $db->where("code",$voucherCode);
            $invVoucherData = $db->getOne("inv_voucher","id,type");

            $invVoucherID = $invVoucherData["id"];
            $invVoucherType = $invVoucherData["type"];

            if($invVoucherID){
                $db->where("inv_voucher_id",$invVoucherID);
                $db->where("name","discountBy");
                $invVoucherDetail = $db->getOne("inv_voucher_detail","value,type,reference");

                $discountType = $invVoucherDetail["type"];

                switch($discountType){
                    case "percentage":
                        $discountPercentage = $invVoucherDetail["value"];
                        $discountAmount = $invVoucherDetail["reference"];
                        break;

                    case "amount":
                        $discountAmount = $invVoucherDetail["value"];
                        break;

                    default:
                        break;
                }
            }

            unset($insertData);

            $insertData = array(
                "inv_order_id" => $invOrderID,
                "inv_voucher_id" => $invVoucherID,
                "type" => $invVoucherType,
                "discount_type" => $discountType,
                "discount_percentage" => Setting::setDecimal($discountPercentage),
                "discount_amount" => Setting::setDecimal($discountAmount),
                "real_discount_amount" => Setting::setDecimal($realDiscountAmount),
            );

            $insertVoucher = $db->insert("inv_order_voucher",$insertData);

            if(!$insertVoucher){
                return false;
            }

            unset($updateData);

            $updateData = array(
                "total_used" => $db->inc(1),
            );

            $db->where("id",$invVoucherID);
            $updateVoucher = $db->update("inv_voucher",$updateData);

            if(!$updateVoucher){
                return false;
            }

            return true;
        }

        public function purchasePackageVerification($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $deliveryOptions = Setting::$systemSetting["deliveryOption"];
            $deliveryOptions = explode("#",$deliveryOptions);
            $dateTime = date("Y-m-d H:i:s");

            $clientID = $db->userID;
            $site = $db->userType;
            $sessionData = $db->sessionID;

            $packageAry = $params["packageAry"];
            $deliveryOption = trim($params["deliveryOption"]);
            $courierCompany = $params['courierCompany'];
            $courierService = $params['courierService'];
            // $pickupID = trim($params["pickupID"]);

            $addressID = trim($params["addressID"]);
            $fullName = trim($params["fullName"]);
            $countryID = trim($params["countryID"]);
            $address = trim($params["address"]);
            $district = trim($params["district"]);
            $subDistrict = trim($params["subDistrict"]);
            $city = trim($params["city"]);
            $stateID = trim($params["stateID"]);
            $postalCode = trim($params["postalCode"]);
            $dialingArea = trim($params["dialingArea"]);
            $phoneNumber = trim($params["phoneNumber"]);
            $emailAddress = trim($params["emailAddress"]);
            $isBillingAddress = trim($params["isBillingAddress"]);
            $makePaymentMethod = trim($params["makePaymentMethod"]);
            $nicepayBankCode = trim($params["nicepayBankCode"]);
            $submitCreditCard = trim($params["submitCreditCard"]);

            $ccNo           = trim($params["ccNo"]);
            $ccExpiry       = trim($params["ccExpiry"]);
            $ccCvv          = trim($params["ccCvv"]);
            $ccHolderName   = trim($params["ccHolderName"]);

            //Placement Option
            $placementPosition    = trim($params["placementPosition"]);

            /*$billingFullName = trim($params["billingFullName"]);
            $billingCountryID = trim($params["billingCountryID"]);
            $billingAddress = trim($params["billingAddress"]);
            $billingDistrict = trim($params["billingDistrict"]);
            $billingSubDistrict = trim($params["billingSubDistrict"]);
            $billingCity = trim($params["billingCity"]);
            $billingStateID = trim($params["billingStateID"]);
            $billingPostalCode = trim($params["billingPostalCode"]);
            $billingDialingArea = trim($params["billingDialingArea"]);
            $billingPhoneNumber = trim($params["billingPhoneNumber"]);
            $billingEmailAddress = trim($params["billingEmailAddress"]);*/

            $voucherCode = trim($params["voucherCode"]); // Optional
            $spendCredit = $params["spendCredit"];
            $purchaseSpecialNote = trim($params["purchaseSpecialNote"]); // Optional
            $purchaseRemark = trim($params["purchaseRemark"]); // Optional
            $step = trim($params["step"]);

            if(!$step) $step = 1;

            if(!$clientID){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations['E00679'][$language] /* Invalid User */ , "data" => "");
            }

            $tmpParams['type'] = "purchase";
            $checkMemberKYC = Client::checkMemberKYCStatus($tmpParams);
            if(!(empty($checkMemberKYC))){
                foreach($checkMemberKYC as &$kycDoc){
                    $kycDoc = General::getTranslationByName($kycDoc);
                }
                $kycErr = implode(", ",$checkMemberKYC);
                return array("status" => "error", "code" => 2, "statusMsg" => str_replace("%%kyc%%",$kycErr,$translations["E01094"][$language]), "data" => "");
            }

            if($step == 1){
                foreach($deliveryOptions as $delOption){
                    unset($tempOption);

                    $tempOption["option"] = $delOption;
                    $tempOption["optionDisplay"] = General::getTranslationByName($delOption);

                    $deliveryOption[] = $tempOption;
                }

                /*unset($countryParams);
                $countryParams = array(
                    "deliveryCountry" => "Yes",
                );
                $countryReturn = Country::getCountriesList($countryParams);
                $data["countryList"] = $countryReturn["data"]["countriesList"];

                $stateList = Country::getState();
                $data["stateList"] = $stateList;*/
            }

            $isAddDeliveryAddress = 0;
            $subTotal = 0;
            $shippingFee = 0;
            $taxPercentage = 0;
            $taxes = 0;
            $totalPrice = 0;
            $totalBV = 0;
            $totalWeight = 0;

            $db->where("id", $clientID);
            $clientDetails      = $db->getOne("client", "country_id, member_id, email,sponsor_id");
            $clientMemberID     = $clientDetails['member_id'];
            $clientCountryID    = $clientDetails['country_id'];
            $clientEmail        = $clientDetails['email'];
            $clientSponsorID    = $clientDetails['sponsor_id'];

            $db->where("id",$clientSponsorID);
            $sponsorDetails     = $db->getOne("client", "member_id, name");
            $sponsorMemberID    = $sponsorDetails['member_id'];
            $sponsorName        = $sponsorDetails['name'];

            if(!$packageAry){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations['E01078'][$language] /* Invalid Package */ , "data" => "");
            }else{
                $validPackageReturn = Inventory::validPackageVerification($clientCountryID,$packageAry);

                if(strtolower($validPackageReturn["status"]) != "ok"){
                    return $validPackageReturn;
                }

                $packageData = $validPackageReturn["data"]["packageData"];
                $errorFieldArr = $validPackageReturn["data"]["errorFieldArr"];
            }

            $db->where('name', 'Indonesia');
            $payCurrenyCode = $db->getValue('country', 'currency_code');

            $activeAddressReturn = Inventory::getClientActiveAddress();
            $deliveryAddressData = $activeAddressReturn["data"]["deliveryAddressData"];
            $billingAddressData = $activeAddressReturn["data"]["billingAddressData"];
            $pickupAddressData = $activeAddressReturn["data"]["pickupAddressData"];

            $clientRank = Bonus::getClientRank('Bonus Tier', array($clientID), '', 'discount');
            $clientDiscountPercentage = $clientRank[$clientID]['percentage'];

            if($step >= 2){
                if((!in_array($deliveryOption,$deliveryOptions))){
                    $errorFieldArr[] = array(
                        "id" => "deliveryOptionError",
                        "msg" => $translations["E00125"][$language],
                    );

                }/*elseif($deliveryOption == "pickup"){

                    if(!$pickupID){
                        $errorFieldArr[] = array(
                            "id" => "pickupIDError",
                            "msg" => $translations["E01103"][$language],
                        );
                    }else{
                        foreach ($pickupAddressData as $pickupAddressRow) {
                            $pickupAddressIDAry[$pickupAddressRow['pickupID']] = $pickupAddressRow['pickupID'];
                        }

                        if(!in_array($pickupID, $pickupAddressIDAry)){
                            $errorFieldArr[] = array(
                                "id" => "pickupIDError",
                                "msg" => $translations["E01104"][$language],
                            );
                        }
                    }

                }*/elseif($deliveryOption == "delivery"){

                    if($addressID){
                        $db->where("id",$addressID);
                        $db->where("disabled",0);
                        $db->where("address_type","delivery");
                        $addressRes = $db->getOne("address","*");

                        $countryID = $addressRes["country_id"];
                        $stateID = $addressRes["state_id"];

                        if(!$addressRes){
                            $errorFieldArr[] = array(
                                "id" => "addressError",
                                "msg" => $translations["E00125"][$language],
                            );
                        } else {
                            $db->where("id", $addressRes["post_code_id"]);
                            $postalCodeRes = $db->getOne("zip_code","name, tariff_code, destination_id");
                        }

                        $deliveryAddressID = $addressID;

                    }else{

                        $isAddDeliveryAddress = 1;

                        if(!$fullName){
                            $errorFieldArr[] = array(
                                "id" => "fullNameError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }

                        if(!$address){
                            $errorFieldArr[] = array(
                                "id" => "addressError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }

                        if(!$countryID){
                            $errorFieldArr[] = array(
                                "id" => "countryIDError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }else{
                            $db->where("id",$countryID);
                            $db->where("status","Active");
                            $countryRes = $db->getOne("country","id,name,translation_code");
                            $countryID = $countryRes["id"];

                            if(!$countryID){
                                $errorFieldArr[] = array(
                                    "id" => "countryIDError",
                                    "msg" => $translations["E00125"][$language],
                                );
                            }
                        }

                        if(!$stateID){
                            $errorFieldArr[] = array(
                                "id" => "stateIDError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }else{
                            $db->where("id",$stateID);
                            $db->where("country_id",$countryID);
                            $db->where("disabled",0);
                            $stateRes = $db->getOne("state","id,name,translation_code");
                            $stateID = $stateRes["id"];

                            if(!$stateID){
                                $errorFieldArr[] = array(
                                    "id" => "stateIDError",
                                    "msg" => $translations["E00125"][$language],
                                );
                            }
                        }

                        if(!$city){
                            $errorFieldArr[] = array(
                                "id" => "cityError",
                                "msg" => $translations["E01029"][$language],
                            );
                        }else{
                            $db->where("id",$city);
                            $db->where("state_id",$stateID);
                            $db->where("country_id",$countryID);
                            $db->where("disabled",0);
                            $cityRes = $db->getOne("city","name");
                            if(!$cityRes){
                                $errorFieldArr[] = array(
                                    "id"  => "cityError",
                                    "msg" => $translations["E01029"][$language]
                                );
                            }
                        }

                        if(!$district){
                            $errorFieldArr[] = array(
                                "id" => "districtError",
                                "msg" => $translations["E01113"][$language],
                            );
                        }else{
                            $db->where("id",$district);
                            $db->where("city_id",$city);
                            $db->where("country_id",$countryID);
                            $db->where("disabled",0);
                            $districtRes = $db->getOne("county","name");
                            if(!$districtRes){
                                $errorFieldArr[] = array(
                                    "id"  => "districtErrror",
                                    "msg" => $translations["E01113"][$language]
                                );
                            }
                        }

                        if(!$subDistrict){
                            $errorFieldArr[] = array(
                                "id" => "subDistrictError",
                                "msg" => $translations["E01028"][$language]
                            );
                        }else{
                            $db->where("id",$subDistrict);
                            $db->where("county_id",$district);
                            $db->where("country_id",$countryID);
                            $db->where("disabled",0);
                            $subDistrictRes = $db->getOne("sub_county","name");
                            if(!$subDistrictRes){
                                $errorFieldArr[] = array(
                                    "id"  => "subDistrictError",
                                    "msg" => $translations["E01028"][$language]
                                );
                            }
                        }

                        if(!$postalCode){
                            $errorFieldArr[] = array(
                                "id" => "postalCodeError",
                                "msg" => $translations["E01029"][$language],
                            );
                        }else{
                            $db->where("id",$postalCode);
                            $db->where("sub_county_id",$subDistrict);
                            $db->where("country_id",$countryID);
                            $db->where("disabled",0);
                            $postalCodeRes = $db->getOne("zip_code","name, tariff_code, destination_id");
                            if(!$postalCodeRes){
                                $errorFieldArr[] = array(
                                    "id"  => "postalCodeError",
                                    "msg" => $translations["E01029"][$language]
                                );
                            }
                        }

                        if(!$dialingArea || !$phoneNumber){
                                $errorFieldArr[] = array(
                                    "id" => "phoneNumberError",
                                    "msg" => $translations["E00305"][$language],
                                );
                        }else{
                            if(!preg_match("/^[0-9]*$/",$phoneNumber,$matches)){
                                $errorFieldArr[] = array(
                                    "id" => "phoneNumberError",
                                    "msg" => $translations["E00858"][$language]
                                );
                            }
                        }

                        if(!$emailAddress){
                            $errorFieldArr[] = array(
                                "id" => "emailAddressError",
                                "msg" => $translations["E00318"][$language],
                            );
                        }else{
                            if($emailAddress){
                                if(!filter_var($emailAddress,FILTER_VALIDATE_EMAIL)){
                                    $errorFieldArr[] = array(
                                        "id" => "emailAddressError",
                                        "msg" => $translations["E00319"][$language],
                                    );
                                }
                            }
                        }
                    }

                    $isBillingAddressInput = array(1,0);
                    if((!in_array($isBillingAddress,$isBillingAddressInput))){
                        $errorFieldArr[] = array(
                            "id" => "isBillingAddressError",
                            "msg" => $translations["E00125"][$language],
                        );
                    }

                    /*if(!$isBillingAddress){
                        if(!$billingFullName){
                            $errorFieldArr[] = array(
                                "id" => "billingFullNameError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }

                        if(!$billingAddress){
                            $errorFieldArr[] = array(
                                "id" => "billingAddressError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }

                        if(!$billingCountryID){
                            $errorFieldArr[] = array(
                                "id" => "billingCountryIDError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }else{
                            $db->where("id",$billingCountryID);
                            $db->where("status","Active");
                            $billingCountryRes = $db->getOne("country","id,name,translation_code");
                            $billingCountryID = $billingCountryRes["id"];

                            if(!$billingCountryID){
                                $errorFieldArr[] = array(
                                    "id" => "billingCountryIDError",
                                    "msg" => $translations["E00125"][$language],
                                );
                            }
                        }

                        if(!$billingStateID){
                            $errorFieldArr[] = array(
                                "id" => "billingStateIDError",
                                "msg" => $translations["E00125"][$language],
                            );
                        }else{
                            $db->where("id",$billingStateID);
                            $db->where("disabled",0);
                            $billingStateRes = $db->getOne("state","id,name,translation_code");
                            $billingStateID = $billingStateRes["id"];

                            if(!$billingStateID){
                                $errorFieldArr[] = array(
                                    "id" => "billingStateIDError",
                                    "msg" => $translations["E00125"][$language],
                                );
                            }
                        }

                        if(!$billingCity){
                            $errorFieldArr[] = array(
                                "id" => "billingCityError",
                                "msg" => $translations["E01029"][$language],
                            );
                        }else{
                            $db->where("id",$billingCity);
                            $db->where("state_id",$billingStateID);
                            $db->where("country_id",$billingCountryID);
                            $db->where("disabled",0);
                            $billingCityRes = $db->getOne("city","name");
                            if(!$billingCityRes){
                                $errorFieldArr[] = array(
                                    "id"  => "billingCityError",
                                    "msg" => $translations["E01029"][$language]
                                );
                            }
                        }

                        if(!$billingDistrict){
                            $errorFieldArr[] = array(
                                "id" => "billingDistrictError",
                                "msg" => $translations["E01113"][$language],
                            );
                        }else{
                            $db->where("id",$billingDistrict);
                            $db->where("city_id",$billingCity);
                            $db->where("country_id",$billingCountryID);
                            $db->where("disabled",0);
                            $billingDistrictRes = $db->getOne("county","name");
                            if(!$billingDistrictRes){
                                $errorFieldArr[] = array(
                                    "id"  => "billingDistrictError",
                                    "msg" => $translations["E01113"][$language]
                                );
                            }
                        }

                        if(!$billingSubDistrict){
                            $errorFieldArr[] = array(
                                "id" => "billingSubDistrictError",
                                "msg" => $translations["E01028"][$language]
                            );
                        }else{
                            $db->where("id",$billingSubDistrict);
                            $db->where("county_id",$billingDistrict);
                            $db->where("country_id",$billingCountryID);
                            $db->where("disabled",0);
                            $billingSubDistrictRes = $db->getOne("sub_county","name");
                            if(!$billingSubDistrictRes){
                                $errorFieldArr[] = array(
                                    "id"  => "billingSubDistrictError",
                                    "msg" => $translations["E01028"][$language]
                                );
                            }
                        }

                        if(!$billingPostalCode){
                            $errorFieldArr[] = array(
                                "id" => "billingPostalCodeError",
                                "msg" => $translations["E01029"][$language],
                            );
                        }else{
                            $db->where("id",$billingPostalCode);
                            $db->where("sub_county_id",$billingSubDistrict);
                            $db->where("country_id",$billingCountryID);
                            $db->where("disabled",0);
                            $billingPostalCodeRes = $db->getOne("zip_code","name");
                            if(!$billingPostalCodeRes){
                                $errorFieldArr[] = array(
                                    "id"  => "billingPostalCodeError",
                                    "msg" => $translations["E01029"][$language]
                                );
                            }
                        }

                        if(!$billingDialingArea || !$billingPhoneNumber){
                                $errorFieldArr[] = array(
                                    "id" => "billingPhoneNumberError",
                                    "msg" => $translations["E00305"][$language],
                                );
                        }else{
                            if(!preg_match("/^[0-9]*$/",$billingPhoneNumber,$matches)){
                                $errorFieldArr[] = array(
                                    "id" => "billingPhoneNumberError",
                                    "msg" => $translations["E00858"][$language]
                                );
                            }
                        }

                        if(!$billingEmailAddress){
                            $errorFieldArr[] = array(
                                "id" => "billingEmailAddressError",
                                "msg" => $translations["E00318"][$language],
                            );
                        }else{
                            if($billingEmailAddress){
                                if(!filter_var($billingEmailAddress,FILTER_VALIDATE_EMAIL)){
                                    $errorFieldArr[] = array(
                                        "id" => "billingEmailAddressError",
                                        "msg" => $translations["E00319"][$language],
                                    );
                                }
                            }
                        }
                    }*/
                }

                foreach($packageAry as &$packageRow){
                    $packageID = $packageRow["packageID"];
                    $isStarterKit = $packageData[$packageID]["isStarterKit"];
                }

                if($isStarterKit){
                    $db->where('client_id',$clientID);
                    $placementExist = $db->getOne('tree_placement');

                    if(!$placementExist){
                        $db->where("id", $clientID);
                        $placementID = $db->getValue("client", "sponsor_id");

                        if($placementID){
                            if (empty($placementPosition)) {
                                $errorFieldArr[] = array(
                                    "id"  => "placementPositionError",
                                    "msg" => $translations["E00325"][$language]
                                );
                            } else if (!in_array($placementPosition,[1,2])) {
                                $errorFieldArr[] = array(
                                    "id"  => "placementPositionError",
                                    "msg" => $translations["E00325"][$language]
                                );
                            }

                            // valid octopus username
                            $db->where("client_id", $placementID);
                            $db->where("trace_key", "%".$placementID."%", "LIKE");
                            $isUnderPlacementID = $db->getOne("tree_placement", "id");
                            if(!$isUnderPlacementID) {
                                $errorFieldArr[] = array(
                                    "id"  => "placementUsernameError",
                                    "msg" => $translations["E00579"][$language]
                                );
                            }

                            // if placement 2 leg full, loop until downline leg empty
                            $placementDownlineID = $placementID;

                            do {
                                if($placementValid) $placementDownlineID = $placementValid;
                                $db->where("upline_id",$placementDownlineID);
                                $db->where("client_position",$placementPosition);
                                $placementValid = $db->getOne("tree_placement","client_id")['client_id'];
                            } while (!empty($placementValid));

                            $db->where('id',$placementDownlineID);
                            $placementDownline = $db->getOne('client','id, username');
                        }else{
                            $errorFieldArr[] = array(
                                "id"  => "placementUsernameError",
                                "msg" => $translations["E00579"][$language]
                            );
                        }
                    }
                }

                $billingAddressID = $billingAddressData[0]["addressID"];
            }

            if($errorFieldArr){
                $data["field"] = $errorFieldArr;
                return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00130"][$language], "data" => $data);
            }

            foreach($packageAry as &$packageRow){
                $packageID = $packageRow["packageID"];
                $packageQty = $packageRow["quantity"];
                $packageIDAry[] = $packageRow["packageID"];

                $packageWeight = $packageData[$packageID]["weight"];
                $bonusValue = $packageData[$packageID]["bonusValue"];
                $packageProductAry = $packageData[$packageID]["product"];
                $price = $packageData[$packageID]["promoPrice"] > 0 ? $packageData[$packageID]["promoPrice"] : $packageData[$packageID]["price"];
                $mPrice = $packageData[$packageID]["mPrice"];
                $msPrice = $packageData[$packageID]["msPrice"];

                if($clientDiscountPercentage){
                    if(($mPrice > 0 && $clientDiscountPercentage == 25)){
                        $packagePrice = Setting::setDecimal(($mPrice * $packageQty));
                        $pricePerUnit = $mPrice;
                    }else if(($msPrice > 0 && $clientDiscountPercentage == 30)){
                        $packagePrice = Setting::setDecimal(($msPrice * $packageQty));
                        $pricePerUnit = $msPrice;
                    }else{
                        $packagePrice = Setting::setDecimal(($price - (($price * $clientDiscountPercentage) / 100)) * $packageQty);
                        $pricePerUnit = Setting::setDecimal((($price * $clientDiscountPercentage) / 100));
                    }
                }else{
                    $packagePrice = Setting::setDecimal(($price * $packageQty));
                    $pricePerUnit = $price;
                }
                $packageRow['pricePerUnit'] = $pricePerUnit;
		        $packageRow['packagePrice'] = $packagePrice;

                $subTotal = Setting::setDecimal(($subTotal + $packagePrice));

                $packageBV = Setting::setDecimal(($bonusValue * $packageQty));
                $totalBV = Setting::setDecimal(($totalBV + $packageBV));

                if(($packageWeight > 0)){
                    $subWeight = Setting::setDecimal(($packageQty * $packageWeight));
                    $totalWeight = Setting::setDecimal(($totalWeight + $subWeight));
                }else{
                    foreach($packageProductAry as $packageProductRow){
                        $productQty = $packageProductRow["quantity"];
                        $productWeight = $packageProductRow["weight"];
                        $subWeight = Setting::setDecimal(($packageQty * $productQty * $productWeight));
                        $totalWeight = Setting::setDecimal(($totalWeight + $subWeight));
                    }
                }
            }

            $totalPrice = Setting::setDecimal(($subTotal));

            $db->where("type","SST");
            $db->orderBy("created_at","DESC");
            $taxPercentage = $db->getValue("inv_tax_charges","rate");
            if(!$taxPercentage) $taxPercentage = 0;

            $taxes = Setting::setDecimal(($totalPrice * ($taxPercentage / 100)));
            $totalPrice = Setting::setDecimal(($totalPrice + $taxes));

            if($step >= 3){
                if(!in_array($deliveryOption,array("pickup"))){
                    $db->where('token', $sessionData);
                    $sessionID = $db->getValue('client_session', 'id');

                    if($sessionID){
                        $db->where('session_id', $sessionID);
                        $db->where('client_id', $clientID);
                        $db->where('type', 'shippingFee');
                        $shippingFeeData = $db->getValue('session_data', 'data');
                    }

                    $addShippingFee = 0;
                    $updateShippingFee = 0;

                    if($shippingFeeData){
                        $shippingFeeData = json_decode($shippingFeeData, true);
                        $courierListRes = $shippingFeeData;

                        if($step == 3){
                            if($countryID && $stateID){
                                // $shippingFee = Inventory::calculateDeliveryFee($countryID,$stateID,$totalWeight);
                                $dfParams = array(
                                    'destID' => $postalCodeRes['destination_id'],
                                    'thru'   => $postalCodeRes['tariff_code'],
                                    'weight' => $totalWeight,
                                );
                                $shippingFeeRes = self::get3rdPartyDeliveryFees($dfParams);
                                if($shippingFeeRes['status'] != 'ok'){
                                    return $shippingFeeRes;
                                }

                                $courierListRes = $shippingFeeRes['data'];

                                $updateShippingFee = 1;
                            }
                        }

                    }else{
                        if($countryID && $stateID){
                            // $shippingFee = Inventory::calculateDeliveryFee($countryID,$stateID,$totalWeight);
                            $dfParams = array(
                                'destID' => $postalCodeRes['destination_id'],
                                'thru'   => $postalCodeRes['tariff_code'],
                                'weight' => $totalWeight,
                            );
                            $shippingFeeRes = self::get3rdPartyDeliveryFees($dfParams);
                            if($shippingFeeRes['status'] != 'ok'){
                                return $shippingFeeRes;
                            }

                            $courierListRes = $shippingFeeRes['data'];

                            $addShippingFee = 1;
                        }
                    }

                    foreach ($courierListRes as $companyName => $serviceList) {
                        $acceptedCompany[$companyName] = $companyName;

                        foreach ($serviceList as $serviceRow) {
                            $acceptedServiceAry[$companyName][] = $serviceRow['courier'];
                            $deliveryFeeRes[$companyName][$serviceRow['courier']] = $serviceRow['price'];

                            if($serviceRow['serviceID']){
                                $serviceIDAry[$companyName][$serviceRow['courier']] = $serviceRow['serviceID'];
                            }
                        }
                    }

                    if($addShippingFee){
                        $insertData = array(
                            'session_id'    => $sessionID,
                            'client_id'     => $clientID,
                            'type'          => 'shippingFee',
                            'data'          => json_encode($courierListRes),
                            'created_at'    => $dateTime
                        );
                        $db->insert('session_data', $insertData);
                    }

                    if($updateShippingFee){
                        unset($shippingFeeData);
                        unset($updateData);

                        $updateData = array(
                            "data" => json_encode($courierListRes),
                            "created_at" => $dateTime
                        );
                        $db->where("session_id",$sessionID);
                        $db->where("client_id",$clientID);
                        $db->where("type","shippingFee");
                        $db->update("session_data",$updateData);
                    }
                }

                unset($deliveryAddressDataAry);
                unset($billingAddressDataAry);

                if(($deliveryAddressID && !$isAddDeliveryAddress)){
                    $deliveryAddressDataAry[] = $deliveryAddressData[$deliveryAddressID];
                    $deliveryAddressData = $deliveryAddressDataAry;
                }else{
                    unset($deliveryAddressData);
                    unset($tempDelivery);

                    $tempDelivery["fullName"] = $fullName;
                    $tempDelivery["countryID"] = $countryID;
                    $tempDelivery["countryName"] = $countryRes["name"];
                    $tempDelivery["countryDisplay"] = $translations[$countryRes["translation_code"]][$language];
                    $tempDelivery["address"] = $address;
                    $tempDelivery["districtID"] = $district;
                    $tempDelivery["district"] = $districtRes["name"];
                    $tempDelivery["subDistrictID"] = $subDistrict;
                    $tempDelivery["subDistrict"] = $subDistrictRes["name"];
                    $tempDelivery["cityID"] = $city;
                    $tempDelivery["city"] = $cityRes["name"];
                    $tempDelivery["stateID"] = $stateID;
                    $tempDelivery["stateName"] = $stateRes["name"];
                    $tempDelivery["stateDisplay"] = $translations[$stateRes["translation_code"]][$language];
                    $tempDelivery["postalCodeID"] = $postalCode;
                    $tempDelivery["postalCode"] = $postalCodeRes["name"];
                    $tempDelivery["dialingArea"] = $dialingArea;
                    $tempDelivery["phoneNumber"] = $phoneNumber;
                    $tempDelivery["emailAddress"] = $emailAddress;

                    $deliveryAddressDataAry[] = $tempDelivery;
                    $deliveryAddressData = $deliveryAddressDataAry;
                }
                if($isBillingAddress){
                    unset($billingAddressData);
                    $billingAddressData = $deliveryAddressData;
                }/*else{
                    unset($billingAddressData);
                    unset($tempBilling);

                    $tempBilling["fullName"] = $fullName;
                    $tempBilling["countryID"] = $billingCountryID;
                    $tempBilling["countryName"] = $billingCountryRes["name"];
                    $tempBilling["countryDisplay"] = $translations[$billingCountryRes["translation_code"]][$language];
                    $tempBilling["address"] = $billingAddress;
                    $tempBilling["districtID"] = $billingDistrict;
                    $tempBilling["district"] = $billingDistrictRes["name"];
                    $tempBilling["subDistrictID"] = $billingSubDistrict;
                    $tempBilling["subDistrict"] = $billingSubDistrictRes["name"];
                    $tempBilling["cityID"] = $billingCity;
                    $tempBilling["city"] = $billingCityRes["name"];
                    $tempBilling["stateID"] = $billingStateID;
                    $tempBilling["stateName"] = $billingStateRes["name"];
                    $tempBilling["stateDisplay"] = $translations[$billingStateRes["translation_code"]][$language];
                    $tempBilling["postalCodeID"] = $billingPostalCode;
                    $tempBilling["postalCode"] = $billingPostalCodeRes["name"];
                    $tempBilling["dialingArea"] = $billingDialingArea;
                    $tempBilling["phoneNumber"] = $billingPhoneNumber;
                    $tempBilling["emailAddress"] = $billingEmailAddress;

                    $billingAddressDataAry[] = $tempBilling;
                    $billingAddressData = $billingAddressDataAry;
                }*/

                $db->where('name', 'nicepaySetting');
                $nicepaySetting = $db->getOne('system_settings', 'value, type, description');
                $nicepayBankAry = json_decode($nicepaySetting['description'], true);
                foreach ($nicepayBankAry as $npBankCode => $npBankName) {
                    $tempBank['code'] = $npBankCode;
                    $tempBank['name'] = $npBankName;
                    $data["nicepayBankAry"][] = $tempBank;
                }
            }

            if($step >= 4){
                $acceptedService = $acceptedServiceAry[$courierCompany];

                if(!in_array($deliveryOption,array("pickup"))){
                    if(!$courierCompany || !in_array($courierCompany, $acceptedCompany)){
                        $errorFieldArr[] = array(
                                                    "id" => "courierCompanyError",
                                                    "msg" => $translations["E01125"][$language],
                                                );
                    }

                    if(!$courierService || !in_array($courierService, $acceptedService)){
                        $errorFieldArr[] = array(
                                                    "id" => "courierServiceError",
                                                    "msg" => $translations["E01125"][$language],
                                                );
                    }

                    $shippingFee = $deliveryFeeRes[$courierCompany][$courierService];
                    $serviceID = $serviceIDAry[$courierCompany][$courierService] ? : 0;

                    if(!$shippingFee){
                        $shippingFee = 0;
                    }

                    if($params['insuranceOption'] == 1){
                        $insuranceTax = 0.2;

                        $insuranceTaxes = Setting::setDecimal((($totalPrice * ($insuranceTax / 100))) + 5000);

                        $totalPrice = Setting::setDecimal(($totalPrice + $shippingFee + $insuranceTaxes));
                    }
                    else{
                        $totalPrice = Setting::setDecimal(($totalPrice + $shippingFee));
                    }
                }

                if($makePaymentMethod == 'nicepay'){
                     if(!$nicepayBankCode){
                        $errorFieldArr[] = array(
                            "id" => "bankCodeError",
                            "msg" => $translations["E01144"][$language],
                        );
                    } else {
                        $db->where('name', 'nicepaySetting');
                        $nicepaySetting = $db->getOne('system_settings', 'value, type, description');
                        $nicepayBankAry = json_decode($nicepaySetting['description'], true);
                        if(!in_array($nicepayBankCode, array_keys($nicepayBankAry))){
                            $errorFieldArr[] = array(
                                "id" => "bankCodeError",
                                "msg" => $translations["E01145"][$language],
                            );
                        }
                    }
                }

                if($errorFieldArr){
                    $data["field"] = $errorFieldArr;
                    return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00130"][$language], "data" => $data);
                }

                $paymentType = "Purchase Package";
                $paymentSetting = Cash::getPaymentDetail($clientID,$paymentType,$totalPrice,$packageAry);
                $paymentMethod = $paymentSetting["data"]["paymentData"];

                if(($type != "free") && (count($paymentMethod) == 1)){
                    foreach($paymentMethod as $creditType => $paymentValue){
                        $spendCredit[$creditType]["amount"] = $totalPrice;
                    }

                    $data["spendCredit"] = $spendCredit;
                }
            }

            if($step >= 5){
                if($voucherCode){

                    if($params["isNicepayCallback"]==true && $params["tx_id"]!="" ) {

                        $db->where("tx_id", $params["tx_id"] );
                        $discountAmount = $db->getValue("mlm_pending_payment", "discount_amount");

                        $db->where("code", $voucherCode);
                        $voucherType = $db->getValue("inv_voucher", "type");

                    } else {

                        unset($voucherParams);
                        $voucherParams = array(
                            "voucherCode" => $voucherCode,
                            "packageIDAry" => $packageIDAry,
                            "courierService" => $courierService
                        );
                        $validVoucherReturn = Self::checkValidVoucher($voucherParams);

                        if(strtolower($validVoucherReturn["status"]) != "ok"){
                            return $validVoucherReturn;
                        }
                        $voucherType = $validVoucherReturn["data"]["voucherType"];
                        $discountAmount = $validVoucherReturn["data"]["discountAmount"];

                    }

                    switch($voucherType){
                        case "delivery":
                            $totalPrice = Setting::setDecimal(($totalPrice - $discountAmount));
                            break;

                        default:
                            break;
                    }

                    $paymentSetting = Cash::getPaymentDetail($clientID,$paymentType,$totalPrice,$packageAry);
                    $paymentMethod = $paymentSetting["data"]["paymentData"];

                    unset($spendCredit);

                    if(($type != "free") && (count($paymentMethod) == 1)){
                        foreach($paymentMethod as $creditType => $paymentValue){
                            $spendCredit[$creditType]["amount"] = $totalPrice;
                        }

                        $data["spendCredit"] = $spendCredit;
                    }
                }

                if(!in_array($makePaymentMethod, array('nicepay', 'creditCard'))){
                    $validateCreditReturn = Cash::paymentVerification($clientID,$paymentType,$spendCredit,$packageAry,$totalPrice);
                    if(strtolower($validateCreditReturn["status"]) != "ok"){
                        return $validateCreditReturn;
                    }
                } elseif($makePaymentMethod == 'creditCard' && $submitCreditCard == true){
                    // check Credit card detail
                    if(empty($ccHolderName)) {
                        $errorFieldArr[] = array(
                            'id'    => 'ccHolderNameError',
                            'msg'   => 'Credit Card Holder Name Not Found'
                        );
                    } else {
                        if (strlen($ccHolderName) > 50) {
                            $errorFieldArr[] = array(
                                'id'    => 'ccHolderNameError',
                                'msg'   => 'Invalid Credit Card Holder Name'
                            );
                        }
                    }

                    if (empty($ccNo)) {
                        $errorFieldArr[] = array(
                            'id' => 'ccNoError',
                            'msg' => 'Credit Card No Not Found'
                        );
                    } else {
                        if (!preg_match('/^[0-9]*$/', $ccNo, $matches) || strlen($ccNo) > 20) {
                            $errorFieldArr[] = array(
                                'id' => 'ccNoError',
                                'msg' => 'Invalid Credit Card No'
                            );
                        }
                    }

                    if (empty($ccExpiry)) {
                        $errorFieldArr[] = array(
                            'id' => 'ccExpiryError',
                            'msg' => 'Credit Card Expiry Not Found'
                        );
                    } else {
                        if (!preg_match('/^[0-9]*$/', $ccExpiry, $matches) || strlen($ccExpiry) > 4) {
                            $errorFieldArr[] = array(
                                'id' => 'ccNoError',
                                'msg' => 'Invalid Credit Card Expiry'
                            );
                        }
                    }

                    if (empty($ccCvv)) {
                        $errorFieldArr[] = array(
                            'id' => 'ccExpiryError',
                            'msg' => 'Credit Card Expiry Not Found'
                        );
                    } else {
                        if (!preg_match('/^[0-9]*$/', $ccCvv, $matches) || strlen($ccCvv) > 4) {
                            $errorFieldArr[] = array(
                                'id' => 'ccCvvError',
                                'msg' => 'Invalid Credit Card CVV'
                            );
                        }
                    }

                    if($errorFieldArr){
                        $data["field"] = $errorFieldArr;
                        return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00130"][$language], "data" => $data);
                    }
                }

                $invoiceSpendData = $validateCreditReturn["data"]["invoiceSpendData"];
            }

            $data["packageAry"] = $packageAry;
            $data["packageData"] = $packageData;
            $data["isStarterKit"] = $isStarterKit ? : 0;
            if($isStarterKit){
                $data['placementID'] = $placementDownlineID;
                $data['placementPosition'] = $placementPosition;
                $data['placementDownline'] = $placementDownline;
            }
            $data["deliveryOption"] = $deliveryOption;
            $data["paymentCredit"] = $paymentMethod;
            $data["subTotal"] = Setting::setDecimal($subTotal);
            $data["shippingFee"] = Setting::setDecimal($shippingFee);
            $data["serviceID"] =  $serviceID;
            $data["courierCompany"] = $acceptedCompany;
            $data["courierList"] = $courierListRes;
            $data["taxPercentage"] = Setting::setDecimal($taxPercentage);
            $data["taxes"] = Setting::setDecimal($taxes);
            $data["insuranceTaxes"] = Setting::setDecimal($insuranceTaxes);
            $data["totalPrice"] = Setting::setDecimal($totalPrice);
            $data["totalBV"] = Setting::setDecimal($totalBV);
            $data["totalWeight"] = Setting::setDecimal($totalWeight);
            $data["payCurrenyCode"] = $payCurrenyCode;
            $data["cvRate"] = Setting::setDecimal($cvRate);
            $data["paymentType"] = $paymentType;
            $data["invoiceSpendData"] = $invoiceSpendData;
            $data["isAddDeliveryAddress"] = $isAddDeliveryAddress;
            $data["deliveryAddressID"] = $deliveryAddressID;
            $data["billingAddressID"] = $billingAddressID;
            $data["deliveryAddressData"] = $deliveryAddressData;
            $data["billingAddressData"] = $billingAddressData;
            $data["pickupAddressData"] = $pickupAddressData;
            $data["purchaseSpecialNote"] = $purchaseSpecialNote;
            $data["purchaseRemark"] = $purchaseRemark;
            $data["discountAmount"] = $discountAmount;
            $data["nicepayBankCode"] = $nicepayBankCode;
            $data["clientMemberID"] = $clientMemberID;
            $data["clientEmail"] = $clientEmail;
            $data["sponsorMemberID"] = $sponsorMemberID;
            $data["sponsorName"] = $sponsorName;
            return array("status" => "ok", "code" => 0, "statusMsg" => "", "data" => $data);
        }

        public function purchasePackageConfirmation($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");

            $clientID = $db->userID;
            $site = $db->userType;
            $sessionData = $db->sessionID;

            $packageAry = $params["packageAry"];
            $deliveryOption = trim($params["deliveryOption"]);
            $courierCompany = $params['courierCompany'];
            $courierService = $params['courierService'];
            // $pickupID = trim($params["pickupID"]);

            $addressID = trim($params["addressID"]);
            $fullName = trim($params["fullName"]);
            $countryID = trim($params["countryID"]);
            $address = trim($params["address"]);
            $district = trim($params["district"]);
            $subDistrict = trim($params["subDistrict"]);
            $city = trim($params["city"]);
            $stateID = trim($params["stateID"]);
            $postalCode = trim($params["postalCode"]);
            $dialingArea = trim($params["dialingArea"]);
            $phoneNumber = trim($params["phoneNumber"]);
            $emailAddress = trim($params["emailAddress"]);
            $isBillingAddress = trim($params["isBillingAddress"]);
            $makePaymentMethod = trim($params["makePaymentMethod"]);

            //Placement Option
            $placementPosition    = trim($params["placementPosition"]);

            /*$billingFullName = trim($params["billingFullName"]);
            $billingCountryID = trim($params["billingCountryID"]);
            $billingAddress = trim($params["billingAddress"]);
            $billingDistrict = trim($params["billingDistrict"]);
            $billingSubDistrict = trim($params["billingSubDistrict"]);
            $billingCity = trim($params["billingCity"]);
            $billingStateID = trim($params["billingStateID"]);
            $billingPostalCode = trim($params["billingPostalCode"]);
            $billingDialingArea = trim($params["billingDialingArea"]);
            $billingPhoneNumber = trim($params["billingPhoneNumber"]);
            $billingEmailAddress = trim($params["billingEmailAddress"]);*/

            $voucherCode = trim($params["voucherCode"]); // Optional
            $spendCredit = $params["spendCredit"];
            $purchaseSpecialNote = trim($params["purchaseSpecialNote"]); // Optional
            $purchaseRemark = trim($params["purchaseRemark"]); // Optional
            $params["step"] = 5;


            $verificationReturn = self::purchasePackageVerification($params);

            if($verificationReturn["status"] != "ok"){
                return $verificationReturn;
            }

            $packageAry = $verificationReturn["data"]["packageAry"];
            $packageData = $verificationReturn["data"]["packageData"];
            $deliveryOption = $verificationReturn["data"]["deliveryOption"];
            $paymentCredit = $verificationReturn["data"]["paymentCredit"];
            $subTotal = $verificationReturn["data"]["subTotal"];
            $insuranceTaxes = $verificationReturn["data"]["insuranceTaxes"];
            $shippingFee = $verificationReturn["data"]["shippingFee"];
            $taxPercentage = $verificationReturn["data"]["taxPercentage"];
            $taxes = $verificationReturn["data"]["taxes"];
            $totalPrice = $verificationReturn["data"]["totalPrice"];
            $totalBV = $verificationReturn["data"]["totalBV"];
            $totalWeight = $verificationReturn["data"]["totalWeight"];
            $payCurrenyCode = $verificationReturn["data"]["payCurrenyCode"];
            $cvRate = $verificationReturn["data"]["cvRate"];
            $paymentType = $verificationReturn["data"]["paymentType"];
            $invoiceSpendData = $verificationReturn["data"]["invoiceSpendData"];
            $isAddDeliveryAddress = $verificationReturn["data"]["isAddDeliveryAddress"];
            $deliveryAddressID = $verificationReturn["data"]["deliveryAddressID"];
            $billingAddressID = $verificationReturn["data"]["billingAddressID"];
            $discountAmount = $verificationReturn["data"]["discountAmount"];
            $serviceID = $verificationReturn["data"]["serviceID"];
            $isStarterKit = $verificationReturn["data"]["isStarterKit"];

            if($isStarterKit){
                $placementID = $verificationReturn['data']['placementID'];
                $placementPosition = $verificationReturn['data']['placementPosition'];
            }
            // $billingAddressData = $verificationReturn["data"]["billingAddressData"];

            $unitPrice = General::getLatestUnitPrice();

            //Get Package ID Array
            foreach($packageAry as $packageRow) {
                $packageIDRes[$packageRow['packageID']] = $packageRow['packageID'];
            }
            if(!$packageIDRes){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E00955'][$language], 'data'=>"");
            }

            $db->startTransaction();

            $db->where('id',$packageIDRes,"IN");
            $db->where('status',"Active");
            $packageRes = $db->setQueryOption("FOR UPDATE")->get("mlm_product", null,"total_sold, total_balance, total_holding, is_unlimited, status");
            if(COUNT($packageRes) != COUNT($packageIDRes)){
                $db->rollback();
                $db->commit();
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01088'][$language] /* Insufficient Package. */, 'data'=>"");
            }

            if(!in_array($makePaymentMethod, array('nicepay', 'creditCard'))){
                foreach ($packageRes as $packageBal) {
                    if($packageBal['is_unlimited']) continue;

                    if($packageBal['total_balance'] <= ($packageBal['total_sold'] + $packageBal['total_holding'])){
                        $db->rollback();
                        $db->commit();
                        return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01088'][$language] /* Insufficient Package. */, 'data'=>"");
                    }
                }
            } else{
                if($params['isNicepayCallback'] != true){
                    $db->rollback();
                    $db->commit();
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01088'][$language] /* Insufficient Package. */, 'data'=>"");
                }
            }

            try{
                $batchID = $params['batch_id'] ?: $db->getNewID();
                $belongID = $params['belong_id'] ?: $db->getNewID();


                if(!in_array($makePaymentMethod, array('nicepay', 'creditCard'))){
                    $paymentResult = Cash::paymentConfirmation($clientID,$paymentType,$invoiceSpendData,$packageAry,$portfolioID,$totalPrice,$dateTime,$batchID,$belongID);

                    if(!$paymentResult){
                        $db->rollback();
                        $db->commit();
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00948"][$language], "data" => "");
                    }
                }

                if($isAddDeliveryAddress){
                    unset($deliveryParams);

                    $deliveryParams = array(
                        "isDefault" => 0,
                        "addressType" => "delivery",
                        "fullname" => $fullName,
                        "dialingArea" => $dialingArea,
                        "phone" => $phoneNumber,
                        "email" => $emailAddress,
                        "address" => $address,
                        "address2" => $address2,
                        "districtID" => $district,
                        "subDistrictID" => $subDistrict,
                        "cityID" => $city,
                        "postalCodeID" => $postalCode,
                        "stateID" => $stateID,
                        "countryID" => $countryID,
                        "disabled" => 0,
                    );

                    $deliveryAddressReturn = Inventory::manageAddress($deliveryParams,"add");

                    if($deliveryAddressReturn["status"] != "ok"){
                        $db->rollback();
                        $db->commit();
                        return $deliveryAddressReturn;
                    }

                    $db->where("address_type","delivery");
                    $db->orderBy("id","DESC");
                    $deliveryAddressID = $db->getValue("address","id");

                    /*if(!$isBillingAddress){
                        unset($billingParams);

                        $billingParams = array(
                            "id" => $billingAddressID,
                            "isDefault" => 0,
                            "addressType" => "billing",
                            "fullname" => $billingFullName,
                            "dialingArea" => $billingDialingArea,
                            "phone" => $billingPhoneNumber,
                            "email" => $billingEmailAddress,
                            "address" => $billingAddress,
                            "districtID" => $billingDistrict,
                            "subDistrictID" => $billingSubDistrict,
                            "cityID" => $billingCity,
                            "postalCodeID" => $billingPostalCode,
                            "stateID" => $billingStateID,
                            "countryID" => $billingCountryID,
                            "disabled" => 0,
                        );
                    }else{
                        $deliveryParams["id"] = $billingAddressID;
                        $deliveryParams["addressType"] = "billing";
                        $billingParams = $deliveryParams;
                    }

                    $billingAddressReturn = Inventory::manageAddress($billingParams,"edit");

                    if($billingAddressReturn["status"] != "ok"){
                        $db->rollback();
                        $db->commit();
                        return $billingAddressReturn;
                    }

                    $db->where("address_type","billing");
                    $db->orderBy("id","DESC");
                    $billingAddressID = $db->getValue("address","id");*/
                }

                $totalPackage = 0;
                $totalBonusValue = 0;
                $clientRank = Bonus::getClientRank("Bonus Tier",array($clientID),"","discount");
                $clientDiscountPercentage = $clientRank[$clientID]["percentage"];

                foreach($packageAry as $packageRow){
                    $packageID = $packageRow["packageID"];
                    $packageQty = $packageRow["quantity"];

                    $totalPackage += $packageQty;

                    $bonusValue = $packageData[$packageID]["bonusValue"];
                    $price = ($packageData[$packageID]["promoPrice"] > 0) ? $packageData[$packageID]["promoPrice"] : $packageData[$packageID]["price"];
                    $mPrice = $packageData[$packageID]["mPrice"];
                    $msPrice = $packageData[$packageID]["msPrice"];

                    if($clientDiscountPercentage){
                        if(($mPrice > 0 && $clientDiscountPercentage == 25)){
                            $packagePrice = Setting::setDecimal(($mPrice * $packageQty));
                        }else if(($msPrice > 0 && $clientDiscountPercentage == 30)){
                            $packagePrice = Setting::setDecimal(($msPrice * $packageQty));
                        }else{
                            $packagePrice = Setting::setDecimal(($price - (($price * $clientDiscountPercentage) / 100)) * $packageQty);
                        }
                    }else{
                        $packagePrice = Setting::setDecimal(($price * $packageQty));
                    }

                    $totalBonusValue += (($packageData[$packageID]["bonusValue"]) * $packageQty);

                    $portfolioID = $db->getNewID();

                    unset($insertData);

                    $insertData = array(
                        "portfolioID" => $portfolioID,
                        "clientID" => $clientID,
                        "productID" => $packageID,
                        "price" => $packagePrice,
                        "bonusValue" => ($bonusValue * $packageQty),
                        "type" => $paymentType,
                        "belongID" => $belongID,
                        "batchID" => $batchID,
                        "status" => "Active",
                        "purchaseAt" => $dateTime,
                        "unitPrice" => $unitPrice,
                    );
                    $insertPortfolioRes = Subscribe::insertClientPortfolio($insertData);

                    if(!$insertPortfolioRes){
                        $db->rollback();
                        $db->commit();
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00948"][$language], "data" => "");
                    }

                    unset($insertData);

                    $insertData = array(
                        "clientID" => $clientID,
                        "mainID" => $clientID,
                        "type" => $paymentType,
                        "productID" => $packageID,
                        "belongID" => $belongID,
                        "batchID" => $batchID,
                        "bonusValue" => ($bonusValue * $packageQty),
                        "dateTime" => $dateTime,
                    );

                    $insertBonusValue = Bonus::insertBonusValue($insertData);

                    if(!$insertBonusValue){
                        $db->rollback();
                        $db->commit();
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00948"][$language], "data" => "");
                    }

                    $updateData = array(
                        'total_sold' => $db->inc($packageQty)
                    );
                    $db->where('id', $packageID);
                    $db->update('mlm_product', $updateData);

                    $packageIDAry[] = $packageID;
                }

                $db->where('id', $packageIDAry, 'IN');
                $checkQuantityRes = $db->get('mlm_product', null, 'id, (total_balance - total_sold) AS quantity');

                foreach ($checkQuantityRes as $checkQuantityRow) {
                    if($checkQuantityRow['quantity'] <= 0){
                        $soldOutPackage[$checkQuantityRow['id']] = $checkQuantityRow['id'];
                    }
                }

                // Update system setting for process get product
                if($soldOutPackage){
                    $db->where('name', 'processGetProduct');
                    $db->update('system_settings', array('value' => 0));
                }

                $isActivate = Custom::maintainActiveMember($clientID, $totalBonusValue, $dateTime);

                $getInvoiceNoFormat = 'INV'.DATE('y').'/FIZ/'.DATE('m').'/';
                $getPONumberFormat = DATE('y').'/SO/FIZ/'.DATE('m').'/';

                $db->where('po_number', $getPONumberFormat.'%', 'LIKE');
                $db->where('reference_number', $getInvoiceNoFormat.'%', 'LIKE');
                $maxID = $db->getValue('inv_order', 'MAX(id)');

                $db->where('id', $maxID);
                $getLatestNumber = $db->getValue('inv_order', "reference_number");

                if($getLatestNumber){
                    $getLatestNo = explode("/", $getLatestNumber);
                    $referenceNo = str_pad(end($getLatestNo)+1, 4, '0', STR_PAD_LEFT);
                }else{
                    $referenceNo = str_pad(1, 4, '0', STR_PAD_LEFT);
                }
                // $referenceNo = General::generateAllReferenceNo("inv_order","reference_number");

                unset($insertData);
                switch ($makePaymentMethod) {
                    case 'nicepay':
                        $invPaymentMethod = 'VirtualAccount';
                        break;

                    case 'creditCard':
                        $invPaymentMethod = 'CreditCard';
                        break;

                    default:
                        $invPaymentMethod = 'Credit';
                        break;
                }

                $insertData = array(
                    "client_id" => $clientID,
                    "reference_number" => $getInvoiceNoFormat.$referenceNo,
                    "po_number" => $getPONumberFormat.$referenceNo,
                    "delivery_option" => $deliveryOption,
                    "billing_add_id" => ($isBillingAddress == 1) ? $deliveryAddressID : $billingAddressID,
                    "delivery_add_id" => (!in_array($deliveryOption,array("pickup"))) ? $deliveryAddressID : '',
                    "courier_company" => (!in_array($deliveryOption,array("pickup"))) ? $courierCompany : '-',
                    "courier_service" => (!in_array($deliveryOption,array("pickup"))) ? $courierService : '-',
                    "service_id" => ($serviceID > 0) ? $serviceID : '0',
                    "pay_currency_code" => $payCurrenyCode,
                    "total_package" => $totalPackage,
                    "total_weight" => $totalWeight,
                    "total_pv" => $totalBonusValue,
                    "total_price" => $subTotal,
                    "delivery_fee" => $shippingFee,
                    "tax_charges" => $taxes,
                    "insurance_tax" => $insuranceTaxes,
                    "payment_type" => $invPaymentMethod,
                    "paid_amount" => $totalPrice,
                    "status" => "Paid",
                    "batch_id" => $batchID,
                    "special_note" => $purchaseSpecialNote,
                    "remark" => $purchaseRemark,
                    "created_at" => $dateTime,
                );
                $orderID = $db->insert("inv_order",$insertData);

                foreach($packageAry as $packageRow){
                    $packageID = $packageRow["packageID"];
                    $packageQty = $packageRow["quantity"];

                    $price = ($packageData[$packageID]["promoPrice"] > 0) ? $packageData[$packageID]["promoPrice"] : $packageData[$packageID]["price"];
                    $mPrice = $packageData[$packageID]["mPrice"];
                    $msPrice = $packageData[$packageID]["msPrice"];

                    if($clientDiscountPercentage){
                        if(($mPrice > 0 && $clientDiscountPercentage == 25)){
                            $packagePrice = Setting::setDecimal(($mPrice));
                        }else if(($msPrice > 0 && $clientDiscountPercentage == 30)){
                            $packagePrice = Setting::setDecimal(($msPrice));
                        }else{
                            $packagePrice = Setting::setDecimal(($price - (($price * $clientDiscountPercentage) / 100)));
                        }
                    }else{
                        $packagePrice = Setting::setDecimal(($price));
                    }

                    $packageProductAry = $packageData[$packageID]["product"];
                    $packageWeight = $packageData[$packageID]["weight"];

                    foreach($packageProductAry as $packageProductRow){
                        unset($productInvAry);

                        $productID = $packageProductRow["productID"];
                        $productQty = $packageProductRow["quantity"];
                        $productWeight = $packageProductRow["weight"];

                        $totalWeight = Setting::setDecimal(($packageQty * $productQty * $productWeight));

                        unset($insertData);

                        $insertData = array(
                            "inv_order_id" => $orderID,
                            "mlm_product_id" => $packageID,
                            "inv_product_id" => $productID,
                            "price" => $packagePrice,
                            "pv_price" => $packageData[$packageID]["bonusValue"],
                            "weight" => ($packageWeight > 0) ? $packageWeight : $productWeight,
                            "quantity" => $packageQty,
                            "stock_quantity" => ($packageQty * $productQty),
                            "left_stock_quantity" => ($packageQty * $productQty),
                        );
                        $db->insert("inv_order_detail",$insertData);

                        $productInvAry[$productID] = $productQty;

                        $insertProductTrxn = Inventory::insertInvProductTransaction($productInvAry,$clientID,"Buy Product",$packageQty,$data,$batchID);

                        if(!$insertProductTrxn){
                            $db->rollback();
                            $db->commit();
                            return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00948"][$language], "data" => "");
                        }
                    }
                }

                foreach($invoiceSpendData as $creditType => $creditAmount){
                    if($creditAmount["amount"] <= 0){
                        continue;
                    }

                    unset($insertData);

                    $insertData = array(
                        "inv_order_id" => $orderID,
                        "credit_type" => $creditType,
                        "amount" => $creditAmount["amount"],
                        "created_at" => $dateTime,
                    );
                    $db->insert("inv_order_payment",$insertData);
                }

                if($voucherCode && $discountAmount){
                    unset($voucherParams);
                    $voucherParams = array(
                        "invOrderID" => $orderID,
                        "voucherCode" => $voucherCode,
                        "realDiscountAmount" => $discountAmount,
                    );
                    $insertOrderVoucher = Self::insertOrderVoucher($voucherParams);

                    if(!$insertOrderVoucher){
                        $db->rollback();
                        $db->commit();
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00948"][$language], "data" => "");
                    }
                }

                $db->where('client_id', $clientID);
                $emailVerified = $db->getValue('client_detail', 'email_verified');
                if($emailVerified == 1){
                    $db->where('id', $clientID);
                    $recipientEmail = $db->getValue('client', 'email');
                }
                $sendECatelog = self::buyPackageSendNotice($packageIDAry, $recipientEmail);

                if(in_array($makePaymentMethod, array('nicepay', 'creditCard'))){
                    foreach ($packageAry as $packageInfo) {
                        $updateData = array(
                            'total_holding' => $db->dec($packageInfo['quantity']),
                            'total_sold' => $db->inc($packageInfo['quantity'])
                        );
                        $db->where('id', $packageInfo['packageID']);
                        $db->update('mlm_product', $updateData);
                    }
                } else {
                    $db->where('mlm_product_id', $packageIDAry, 'IN');
                    $db->where('client_id', $clientID);
                    $updateShoppingCart = $db->delete('shopping_cart');

                    $db->where('client_id', $clientID);
                    $updateSessionData = $db->delete('session_data');
                }

                //Add to placement
                if($placementID){
                    $placementTree = Tree::insertPlacementTree($clientID, $placementID,$placementPosition);
                    if (!$placementTree) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00334"][$language]  /* Failed to register member.  */, 'data' => "");
                    }
                }

                //Instant calculate rank if purchase starterkit / join pack
                $isStarterCheck = 0;
                foreach($packageAry as $packageRow){
                    $packageID = $packageRow["packageID"];
                    $db->where('id',$packageID);
                    $db->where('status','Active');
                    $db->where('is_starter_kit','1');
                    $isStarterKitChecking = $db->getOne('mlm_product');

                    if($isStarterKitChecking){
                        $isStarterCheck ++;
                    }
                }

                if($isStarterCheck >= 1){
                    $calClientRank = Bonus::calculateBonusTier($clientID,$dateTime, 'starterKit', 'Bonus Tier');

                    if(!$calClientRank){
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00150"][$language], "data" => "");
                    }

                    $db->where('id',$clientID);
                    $sponsorID = $db->getValue('client','sponsor_id');

                    $calSponsorRank = Bonus::calculateBonusTier($sponsorID,$dateTime, 'fizMemberUpgrade', 'Bonus Tier');

                    if(!$calClientRank && !$calSponsorRank){
                        return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00150"][$language], "data" => "");
                    }
                } else {
                    $calClientRank = Bonus::calculateBonusTier($clientID,$dateTime, 'fizMemberUpgrade', 'Bonus Tier');
                }


                // //Insert Rank Queue
                // unset($insertData,$jsonData);
                // $jsonData['dateTime'] = $dateTime;
                // if($isActivate == true){
                //     $jsonData['moduleType'] = "activate";
                // }
                // $insertData = array(
                //     "queue_type" => "calculateRank",
                //     "client_id"  => $clientID,
                //     "data"       => json_encode($jsonData),
                //     "created_at" => $dateTime,
                // );
                // $db->insert('queue',$insertData);

            }catch(Exception $e){
                $db->rollback();
                $db->commit();
                return array("status" => "error", "code" => 2, "statusMsg" => "System Error", "data" => "");
            }

            $db->commit();

            $db->where("id",$clientID);
            $clientUsername = $db->getValue("client","username");

            unset($activityData);

            $activityData = array(
                "user" => $clientUsername,
            );



            $activityReturn = Activity::insertActivity("Purchase Package","T00034","L00054",$activityData,$clientID);

            if(!$activityReturn){
                return array("status" => "error", "code" => 2, "statusMsg" => $translations["E00144"][$language], "data" => "");
            }

            return array("status" => "ok", "code" => 0, "statusMsg" => "Purchase Package Successfully", "data" => "");
        }

        // public function buyPackageSendNotice($params){
        public function buyPackageSendNotice($packageIDAry, $email){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $memberSite = Setting::$configArray['memberSite'];
            $companyInfo = Setting::$systemSetting['companyInfo'];

            $socialDetail = json_decode($companyInfo, true);

            $recipient = $email;//recipient is email destination
            $sendType = 'email';

            $db->where("product_id", $packageIDAry, "IN");
            $db->where("name", "catalogue");
            $db->where("value", "1");
            $sendCatalogue = $db->getValue("mlm_product_setting", "id");

            if($sendCatalogue){
                $attachmentFlag = 1;
            }

            $db->where("product_id", $packageIDAry, "IN");
            $db->where("name", "bBasic");
            $db->where("value", "1");
            $sendBBasic = $db->getValue("mlm_product_setting", "id");

            if($sendBBasic){
                $attachmentFlag = 2;
            }

            if($sendCatalogue && $sendBBasic){
                $attachmentFlag = 3;
            }

            if($sendCatalogue || $sendBBasic){
                $subject = $translations['B00478'][$language];
                $content = '
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>'.$subject.'</title>
                        <style>
                            .loginBlock {
                                display: block;
                                width: 600px;
                                padding: 3rem 3rem;
                                max-width: 100%;
                                background-color: #f4f7fa;
                                background-size: cover;
                                background-repeat: no-repeat;
                                background-position: right 15%;
                                color: #141414;
                                font-family: Arial, Helvetica, sans-serif;
                            }

                            img.companyLogo {
                                display: block;
                                margin: 0 auto;
                            }

                            .companyMsgBox {
                                background-color: #fff;
                                border-radius: 8px;
                                margin-top: 2rem;
                                padding: 2rem;
                                box-shadow: 0 0 20px -10px #ccc;
                            }

                            .companyEmailIcon {
                                display: block;
                                margin: 1.5rem auto;
                                width: 70px;
                                height: auto;
                            }

                            .longLine {
                                display: block;
                                width: 100%;
                                height: 2px;
                                background-color: #e7e7e7;
                                clear: both;
                                margin: 2rem auto;
                            }

                            .companyTxt1 {
                                font-size: 18px;
                                color: #48545c;
                            }

                            .companyTxt2 {
                                font-size: 17px;
                            }

                            .companyTxt3 {
                                font-size: 14px;
                                padding: 0;
                                margin: 20px 0 15px 0;
                            }

                            .companyTxt4 {
                                font-size: 14px;
                                padding: 0;
                                margin: 0;
                            }

                            .companyTxt4Div {
                                list-style-type: circle;
                            }

                            .contentImage {
                                width: 100%;
                                height: auto;
                            }

                            .socialIcon {
                                margin: 5px;
                                width: 30px;
                                height: 30px;
                            }

                            a.companyLinkBtn {
                                display: block;
                                width: 100%;
                                background-color: #29abe2;
                                color: #fff;
                                text-decoration: none;
                                padding: 8px;
                                border-radius: 4px;
                                text-transform: uppercase;
                            }

                            a.companyLinkBtn:hover {
                                text-decoration: underline;
                            }

                            .alignMiddle {
                                display: -webkit-flex;
                                display: flex;
                                -webkit-align-items: center;
                                align-items: center;
                                height: auto;
                            }

                            .alignMiddle img {
                                margin-right: 10px;
                            }
                        </style>
                    </head>
                    <body>
                    ';

                    $content .= '
                        <div class="loginBlock">
                            <div class="companyMsgBox">
                                <img class="companyEmailIcon" src="'.$memberSite.'/images/project/favicon.png" alt="">
                                <h3 class="companyTxt1">'.$translations['B00460'][$language].'</h3>
                                <div class="longLine"></div>
                                <h3 class="companyTxt2">'.$translations['B00461'][$language].'</h3>
                                <p class="companyTxt3">'.$translations['B00462'][$language].'</p>
                                <p class="companyTxt3">'.$translations['B00463'][$language].'</p>
                                <p class="companyTxt3">'.$translations['B00464'][$language].'</p>
                                <p class="companyTxt3"><img class="contentImage" src="'.$memberSite.'/images/project/welcomeEmail.jpg" alt=""></p>
                                <p class="companyTxt3">'.$translations['B00465'][$language].'</p>
                                <ul class="companyTxt4Div">
                                    <li><p class="companyTxt4">'.$translations['B00466'][$language].'</p></li>
                                    <li><p class="companyTxt4">'.$translations['B00467'][$language].'</p></li>
                                    <li><p class="companyTxt4">'.$translations['B00468'][$language].'</p></li>
                                </ul>
                                <p class="companyTxt3">
                                    <p class="companyTxt4">'.$translations['B00469'][$language].'</p>
                                    <p class="companyTxt4"><a href="'.$memberSite.'">'.$memberSite.'</a></p>
                                    <p class="companyTxt4 alignMiddle"><img class="socialIcon" src="'.$memberSite.'/images/project/ins-icon.png" alt="Instagram">'.$socialDetail['socialAcc'].'</p>
                                    <p class="companyTxt4 alignMiddle"><img class="socialIcon" src="'.$memberSite.'/images/project/fb-icon.png" alt="Facebook">'.$socialDetail['socialAcc'].'</p>
                                    <p class="companyTxt4 alignMiddle"><img class="socialIcon" src="'.$memberSite.'/images/project/tiktok-icon.png" alt="TikTok">'.$socialDetail['socialAcc'].'</p>
                                    <p class="companyTxt4 alignMiddle"><img class="socialIcon" src="'.$memberSite.'/images/project/youtube-icon.png" alt="Youtube">'.$socialDetail['socialMedia'].'</p>
                                </p>
                                <p class="companyTxt3">
                                    <p class="companyTxt4"><i>'.$translations['B00470'][$language].'</i></p>
                                    <p class="companyTxt4">'.$translations['B00471'][$language].'</p>
                                    <p class="companyTxt4">'.$translations['B00472'][$language].'</p>
                                    <p class="companyTxt4">'.$socialDetail['phone'].'</p>
                                </p>
                                <p class="companyTxt3">
                                    <p class="companyTxt4">'.$translations['B00473'][$language].'</p>
                                    <p class="companyTxt4">'.$translations['B00474'][$language].'</p>
                                </p>
                                <p class="companyTxt3"><b>'.$translations['B00475'][$language].'</b></p>
                                <p class="companyTxt3">
                                    <p class="companyTxt4"><b>'.$translations['B00476'][$language].'</b></p>
                                    <p class="companyTxt4">'.$translations['B00477'][$language].'</p>
                                </p>
                            </div>
                        </div>
                    </body>
                    </html>
                ';

                $result = Message::createCustomizeMessageOut($recipient,$subject,$content,$sendType,'','','','',1, $attachmentFlag);
            }

            return array("status" => "ok", "code" => 0, "statusMsg" => "Purchase Package Successfully", "data" => "");
        }

        // -------- Supplier Module -------- //
        public function getSupplierListing($params, $type = false){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $searchData = $params['searchData'];
            $sortData       = $params['sortData'];
            $pageNumber = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll = $params['seeAll'] ? : 0;
            $limit = General::getLimit($pageNumber);

            if($seeAll) {
                $limit = NULL;
            }

            $clientID = $db->userID;
            $site = $db->userType;

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {

                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'supplierID':
                            $db->where('v.vendor_code', "%".$dataValue."%","LIKE");
                            break;

                        case 'name':
                            $db->where('v.name', "%" .$dataValue. "%" ,"LIKE");
                            break;

                        case 'number':
                            $db->where('v.mobile', "%".$dataValue."%","LIKE");
                            break;

                        case 'PIC':
                            $db->where('v.pic', "%" .$dataValue. "%" ,"LIKE");
                            break;

                        case 'operationHour':
                            $db->where('v.note', "%" .$dataValue. "%" ,"LIKE");
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $sortOrder = "DESC";
            $sortField = 'v.created_at';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'ASC')
                    $sortOrder = 'ASC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
                $db->orderBy($sortField, $sortOrder);
            }
            $copyDb = $db->copy();
            // $db->orderBy('v.created_at', 'DESC');
            // $db->where('v.deleted','0');

            $supplier = $db->get('vendor v', $limit, 'v.id as id, v.name as name, v.vendor_code as vendor_code, v.pic as pic, v.mobile as mobile, v.email as email, v.created_at as created_at, v.remark as remark, v.deleted as deleted, v.note');
            
            if(!$supplier){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }
            foreach($supplier as $key => $value){
                $supplierList[$key]['id'] = $value['id'];
                $supplierList[$key]['name'] = $value['name'];
                $supplierList[$key]['code'] = $value['vendor_code'];
                $supplierList[$key]['phone'] = $value['mobile'];
                $supplierList[$key]['email'] = $value['email'];
                $supplierList[$key]['remark'] = $value['remark'];
                $supplierList[$key]['pic'] = $value['pic'];
		        $supplierList[$key]['note'] = $value['note'];

                // $supplierList[$key]['address'] = $value['address'];
                if($value['deleted'] == 0)
                {
                    $supplierList[$key]['status'] = 'Active';
                }
                else
                {
                    $supplierList[$key]['status'] = 'Inactive';
                }
                $supplierList[$key]['createdAt'] = date('Y-m-d',strtotime($value['created_at']));

                // for app
                $appSupplierList[$key]['purchase_partner_id'] = $value['id'];
                $appSupplierList[$key]['purchase_order_name'] = $value['name'];
                $appSupplierList[$key]['purchase_order_date'] = $value['vendor_code'];
                $appSupplierList[$key]['purchase_order_amount'] = $value['mobile'];
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $data['supplierDetails'] = $supplierList;
            $data['appSupplierList'] = $appSupplierList;

            $totalRecord = $copyDb->getValue('vendor v', 'COUNT(*)');
            $data['pageNumber']          = $pageNumber;
            $data['totalRecord']         = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function getSupplierDetail($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");
            include('config.php');

            $clientID = $db->userID;
            $site = $db->userType;
            $type = $params['type'];

            $supplierID = $params['supplierID'];

            if($type == 'add'){
            
                $db->where("vendor_code LIKE 'GT%' ");
                $db->orderBy("CAST(SUBSTRING(vendor_code, 3) AS UNSIGNED)", "DESC");
                $lastVendorRecord = $db->getOne("vendor");

                if($lastVendorRecord) {
                $last_vendor_no = $lastVendorRecord["vendor_code"];
                } else {
                $last_vendor_no = "GT0000";
                }

                $last_vendor_no = substr($last_vendor_no, 2);
                $next_vendor_no = "GT".sprintf('%04d', ($last_vendor_no + 1));

                $data['code'] = $next_vendor_no; 

            }else{
                if(!$supplierID) {
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E01051'][$language] /* Invalid ID */, 'data' => "");
                }

                $db->where('id', $supplierID);
                $supplier = $db->getOne('vendor','name, vendor_code, note, pic, country_id, mobile, email, deleted');

                //$db->where('id', $supplier['country_id']);
                //$dialCode = $db->getValue('country','country_code');

                $db->where('vendor_id', $supplierID);
                $db->where('deleted', 0);
                $getAddress = $db->get('vendor_address',null, 'id, branch_name, address, address_line_1, address_line_2, name, mobile, city, state, zip, country');

                if(empty($supplier)){
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
                } else {
                    if($supplier['deleted'] == 0) {
                        $supplierStatus = "Active";
                    } else {
                        $supplierStatus = "Inactive";
                    }
                }

                if($getAddress) {
                    foreach($getAddress as $val) {
                        $address['addressID']       = $val['id'];
                        $address['branch_name']     = $val['branch_name'];
                        $address['address']         = $val['address'];
                        $address['address_line_1']  = $val['address_line_1'];
                        $address['address_line_2']  = $val['address_line_2'];
                        $address['name']            = $val['name'];
                        $address['mobile']          = $val['mobile'];
                        $address['city']            = $val['city'];
                        $address['state']           = $val['state'];
                        $address['zip']             = $val['zip'];
                        $address['country']         = $val['country'];

                        $addressList[] = $address;
                    }
                }
                $arrMobile = General::mobileNumberInfo($supplier["mobile"]);
                $dialCode = $arrMobile['countryCode'];
                $phone = substr($supplier["mobile"], strlen($dialCode));

                // Get Media List
                $db->where('deleted', 0);
                $db->where('reference_id', $supplierID);
                $vendorMedia = $db->get('vendor_media', null, 'id, type, url, reference_id');

                if($vendorMedia) {
                    foreach($vendorMedia as $val) {
                        if($val['type'] == 'video') {
                            $media['id'] = $val['id'];
                            $media['url'] = $val['url'];
                            $media['type'] = $val['type'];
                            $media['reference_id'] = $val['reference_id'];
                        } else {
                            $media['id']   = $val['id'];
                            $media['url']  = $val['url'];
                            $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                            $media['type'] = $val['type'];
                            $media['reference_id'] = $val['reference_id'];
                        }
                        $mediaList[] = $media;
                    }
                } else {
                    $mediaList = '';
                }
                $mediaArr = $mediaList;

                $db->where('vendor_id', $supplierID);
                $db->where('product_type', 'product');
                $db->where('is_published', 1);
                $db->where('is_archive', 0);
                $db->where('deleted', 0);
                $count = $db->getValue('product', 'COUNT(id)');

                $db->where('vendor_id', $supplierID);
                $db->where('product_type', 'package');
                $db->where('is_published', 1);
                $db->where('is_archive', 0);
                $db->where('deleted', 0);
                $count2 = $db->getValue('product', 'COUNT(id)');
                
                    

                $data['name']     = $supplier['name'];
                $data['code']     = $supplier['vendor_code'];
                $data['address']  = $addressList;
                $data['status']   = $supplierStatus;
                $data['dialCode'] = $dialCode;
                $data['phone']    = $phone;
                $data['email']    = $supplier['email'];
                $data['note']     = $supplier['note'];
                $data['pic']      = $supplier['pic'];
		        $data['debug']    = $arrMobile;
                $data['media']    = $mediaArr;
                $data['productUnitOnHandNumber'] = $count;
                $data['packageUnitOnHandNumber'] = $count2;

            }

            $db->where('delivery_country', '1');
            $countryList = $db->get('country',null,'id, name, iso_code2, country_code');
            $data['validCountry'] = $countryList;

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function verifySupplier($params, $type){
            $db         = MysqliDb::getInstance();
            $language   = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime   = date("Y-m-d H:i:s");
            $adminRoleList = Setting::$systemSetting['InvEditableRoles'];
            $adminRolesListAry = explode("#", $adminRoleList);

            $clientID   = $db->userID;
            $site       = $db->userType;

            $supplierID = trim($params['supplierID']);
            $name       = trim($params['name']);
            $code       = trim($params['code']);
            $address    = $params['address'];
            $dialCode   = trim($params['dialCode']);
            $contact    = trim($params['contact']);
            $status     = trim($params['status']);
            $email      = trim($params['email']);
            $pic        = trim($params['pic']);

            $db->where('role_id', $adminRolesListAry, 'IN');
            $availableAdminRes = $db->getValue('admin', 'id', null);

            if($type == 'add'){
                if(empty($name)){
                    $errorFieldArr[] = array(
                        'id'  => "nameError",
                        'msg' => $translations['E00635'][$language] /* Please Enter Name. */
                    );
                }
            }else{
                $db->where('id',$supplierID);
                $checkName = $db->getValue('vendor','name');

                if(!in_array($clientID, $availableAdminRes)){
                    if(empty($name) || $name != $checkName){

                        $errorFieldArr[] = array(
                            'id'  => "nameError",
                            'msg' => $translations['E01081'][$language] /* Name cannot be changed */
                        );
                    }
                }else{
                    if(empty($name)){
                        $errorFieldArr[] = array(
                            'id'  => "nameError",
                            'msg' => $translations['E00635'][$language] /* Please Enter Name. */
                        );
                    }

                    // $db->where('id', $supplierID, '!=');
                    // $db->where('code',$code);
                    // $checkDuplicateCodeRes = $db->getValue('vendor','code');
                    // if($checkDuplicateCodeRes){
                    //     $errorFieldArr[] = array(
                    //         'id'  => "codeError",
                    //         'msg' => $translations['E00929'][$language] /* Code Exists. */
                    //     );
                    // }
                }
            }

            if(empty($address)){
                $errorFieldArr[] = array(
                    'id'  => "addressError",
                    'msg' => $translations['E00943'][$language] /* Please Insert Address */
                );
            }

            if(empty($contact)){
                $errorFieldArr[] = array(
                    'id' => 'phoneError',
                    'msg' => $translations["E00305"][$language] /* Please fill in phone number */
                );
            }

            if(!preg_match("/^[0-9]*$/",$contact) || strlen($identityNumber) > 30){
                $errorFieldArr[] = array(
                    "id" => "billingPhoneNumberError",
                    "msg" => $translations["E00858"][$language] /* Only number is allowed */
                );
            }

            if(empty($email)) {
                $errorFieldArr[] = array(
                    'id' => 'emailError',
                    'msg' => $translations["E00318"][$language] /* Please fill in email */
                );
            }else {
                if ($email) {
                    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                        $errorFieldArr[] = array(
                            'id' => 'emailError',
                            'msg' => $translations["E00319"][$language] /* Invalid email format. */
                            );
                    }
                }
            }

            if(empty($pic)) {
                $errorFieldArr[] = array(
                    'id' => 'picError',
                    'msg' => $translations["E01164"][$language] /* Please fill in person in charge name */
                );
            }

            $statusAry = array('Active', 'Inactive');
            if(!$status || !in_array($status, $statusAry)) {
                $errorFieldArr[] = array(
                    'id'  => "statusError",
                    'msg' => $translations['E00671'][$language] /* Please Select Status. */
                );
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            return array('status'=>"ok", 'code'=>0, 'statusMsg'=>"", 'data'=>"");
        }

        public function addSupplier($params){
            $db         = MysqliDb::getInstance();
            $language   = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime   = date("Y-m-d H:i:s");

            $clientID   = $db->userID;
            $site       = $db->site;

            $name       = trim($params['name']);
            $code       = trim($params['code']);
            $address    = $params['address'];
            $contact    = trim($params['contact']);
            $email      = trim($params['email']);
            $dialCode   = trim($params['dialCode']);
            $pic        = trim($params['pic']);
	        $phone 	= trim($params['phone']);
            $uploadImage    = $params['uploadImage'];
            // $address    = trim($params['address']);
            $note       = trim($params['note']);
            // $address    = array_map('trim', $params['address']);
            
            if(!$clientID) {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['A01078'][$language] /* Access denied. */, 'data'=>'');
            } else {
                $db->where("id", $clientID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if($name=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01207"][$language] /* Vendor name cannot be empty */, 'data'=>'');
            }

            if($code=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01209"][$language] /* Vendor code cannot be empty */, 'data'=>'');
            }

            if($phone=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01208"][$language] /* Vendor number cannot be empty */, 'data'=>'');
            }

            if(!empty($email))
            {
                // Validate email format using a regular expression
                if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['E00121'][$language] /* Invalid email format */ , 'data'=>'');
                }
            }

	    if(count($address)==0) {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01162"][$language] /* Address cannot be empty */, 'data'=>'');
	    }

        foreach($address as $val) 
        {
            //handle for multi line address
            if(trim($val['address'])==""){
                if(trim($val['address_line_1'])=="" || trim($val['city'])=="" || trim($val['state'])=="" || trim($val['zip'])=="" || trim($val['country'])==""){
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01162"][$language] /* Address cannot be empty */, 'data'=>'');
                }
                else{
                    $val['address'] = $val['address_line_1'].', '.$val['address_line_2'].', '.$val['zip'].' '.$val['city'].', '.$val['state'].', '.$val['country'];
                }
            }

            if(!empty($val['branch_name']))
            {
                if(empty($val['address']))
                {
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['E01086'][$language] /* Invalid Address */ , 'data'=>'');
                }
            }
        }

            // $verify     = self::verifySupplier($params,'add');
            // if($verify['status'] != 'ok') return $verify;

            $db->where('mobile', $contact);
            $vendor = $db->get('vendor',null,'id, name, vendor_code, mobile');

            if($vendor){
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01190"][$language] /* Vendor exists */,'data'=>'');
            }

            //No need phone number verification yet.
            // $firstTwoDigits = substr($contact, 0, 2);
            // if ($firstTwoDigits !== '60') {
            //     return array('status'=>'error','code'=>1,'statusMsg'=> 'Invalid Phone Number','data'=>'');
            // }


            $db->where('country_code', $dialCode);
            $countryID = $db->getValue('country','id');

            // vendor_code + vendor name
            $vendorCodeName = '(' . $code . ') ' .$name;

            $insertVendorData = array(
                'name'        => $vendorCodeName,
                'vendor_code' => $code,
                'country_id'  => $countryID,
                'mobile'      => $contact,
                'email'       => $email,
                'pic'         => $pic,
                'note'        => $note,
                'deleted'     => '0',
                'created_at'  => $dateTime
            );
            $insertVendor = $db->insert('vendor', $insertVendorData);

            if(!$insertVendor) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01082"][$language] /* Failed to add supplier. */, 'data' => "");
            }
 
            if(!empty($uploadImage)) {
                foreach($uploadImage as $key => $val) {
                    //$imgSrc = json_decode($val['imgData'], true);
                    //$uploadParams['imgSrc'] = $imgSrc;
                    //$uploadRes = aws::awsUploadImage($uploadParams);

                    if (strpos($val['imgData'], 'https') !== false) {
                        $imageUrl = $val['imgData'];

                        // insert product_media
                        $insertImage = array(
                            "name" => $val['imgName'],
                            "type" => "Image",
                            "url" => $imageUrl,
                            "reference_id" => $insertVendor,
                            "created_at"   => $dateTime
                        );
        
                        $insertInvImage = $db->insert('vendor_media', $insertImage);

                        if(!$insertInvImage) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                        }
                    } //else {
                    //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    // }
                }
            }

            if(is_array($address)) {
                foreach($address as $val) {

                    if(!$val['address']){
                        if($val['address_line_2']){
                            $val['address'] = $val['address_line_1'].', '.$val['address_line_2'].', '.$val['zip'].' '.$val['city'].', '.$val['state'].', '.$val['country'];
                        }
                        else{
                            $val['address'] = $val['address_line_1'].', '.$val['zip'].' '.$val['city'].', '.$val['state'].', '.$val['country'];
                        }
                    }

                    $insertAddressData = array(
                        'branch_name'       => $val['branch_name'],
                        'mobile'            => $val['mobile'],
                        'address'           => $val['address'],
                        'address_line_1'    => $val['address_line_1'] ?: "",
                        'address_line_2'    => $val['address_line_2'] ?: "",
                        'city'              => $val['city'] ?: "",
                        'state'             => $val['state'] ?: "",
                        'zip'               => $val['zip'] ?: "",
                        'country'           => $val['country'] ?: "",
                        'vendor_id'         => $insertVendor,
                        'deleted'           => '0',
                        'created_at'        => $dateTime
                    );
                    $insertAddressDataList[] = $insertAddressData;
                }
                $insertAddress = $db->insertMulti('vendor_address', $insertAddressDataList);
            } 

            $activityData = array_merge(array('admin' => $checkAdmin), $insertData);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Add Supplier', 'T00056', 'L00076', $activityData, $clientID, $clientID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            $returnVendorID['vendorID'] = $insertVendor;

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $returnVendorID);
        }

        public function editSupplier($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTime = date("Y-m-d H:i:s");
            $adminRoleList = Setting::$systemSetting['InvEditableRoles'];
            $adminRolesListAry = explode("#", $adminRoleList);

            $clientID = $db->userID;
            $site = $db->userType;

            $supplierID  = trim($params['supplierID']);
            $name        = trim($params['name']);
            $code        = trim($params['code']);
            $address     = $params['address'];
            $uploadImage = $params['uploadImage'];
            $imageId     = $params['imageId'];
            $contact     = trim($params['contact']);
            $status      = trim($params['status']);
            $dialCode    = trim($params['dialCode']);
            $email       = trim($params['email']);
            $note        = trim($params['note']);
            $pic         = trim($params['pic']);

            if(!$clientID) {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['A01078'][$language] /* Access denied. */, 'data'=>'');
            } else {
                $db->where("id", $clientID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if(!$supplierID){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            if($name=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01207"][$language] /* Vendor name cannot be empty */, 'data'=>'');
            }

            if($contact=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01208"][$language] /* Vendor number cannot be empty */, 'data'=>'');
            }

            if($code=="") {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01209"][$language] /* Vendor code cannot be empty */, 'data'=>'');
            }

            if(count($address)==0) {
                return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01162"][$language] /* Address cannot be empty */, 'data'=>'');
            }

            foreach($address as $val) {
                if(trim($val['address'])==""){
                    if(trim($val['address_line_1'])=="" || trim($val['city'])=="" || trim($val['state'])=="" || trim($val['zip'])=="" || trim($val['country'])==""){
                        return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations["E01162"][$language] /* Address cannot be empty */, 'data'=>'');
                    }
                }
            }

            if(!empty($email))
            {
                // Validate email format using a regular expression
                if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=>$translations['E00121'][$language] /* Invalid email format */ , 'data'=>'');
                }
            }

            if(strtolower($status) == "inactive"){
                $delete = '1';
            } else {
                $delete = '0';
            }

            $db->where('country_code', $dialCode);
            $countryID = $db->getValue('country','id');

            // Currently no need phone number verification.
            // $firstTwoDigits = substr($contact, 0, 2);
    
            // if ($firstTwoDigits !== '60') {
            //     return array('status'=>'error','code'=>1,'statusMsg'=> $translations['E01093'][$language] /* Invalid phone number */,'data'=>'');
            // }

            $db->where('mobile', $contact);
            $vendor = $db->get('vendor',null,'id, name, vendor_code, mobile');

            foreach ($vendor as $array) {
                if (is_array($array)) {
                    $nestedCount++;
                    if ($nestedCount >= 2) {
                        return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01190"][$language] /* Vendor exists */,'data'=>$vendor);
                    }else if($nestedCount == 1){
                        if($code != $vendor[0]['vendor_code']){
                            return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01190"][$language] /* Vendor exists */,'data'=>$vendor);
                        }
                    }
                }
            }

            $updateData = array(
                "country_id" => $countryID,
                "name"       => $name,
                "email"      => $email,
                "updated_at" => $dateTime,
                "pic"        => $pic,
		        "note"	     => $note,
                "mobile"     => $contact,
                "deleted"    => $delete
            );

            $db->where('id', $supplierID);
            $update = $db->update('vendor', $updateData);

            if(is_array($address)){
                $address = Admin::filterAndRemoveDuplicates($address);

                $updateData = array(
                    "deleted"    => 1
                );

                $db->where('vendor_id', $supplierID);
                $update = $db->update('vendor_address', $updateData);

                foreach($address as $val) {

                    if(!$val['address']){
                        if($val['address_line_2']){
                            $val['address'] = $val['address_line_1'].', '.$val['address_line_2'].', '.$val['zip'].' '.$val['city'].', '.$val['state'].', '.$val['country'];
                        }
                        else{
                            $val['address'] = $val['address_line_1'].', '.$val['zip'].' '.$val['city'].', '.$val['state'].', '.$val['country'];
                        }
                    }
                    
                    if($val['branch_name']!="" || $val['address']!=""){

                        $insertAddressData = array(
                            'branch_name'       => $val['branch_name'],
                            'mobile'            => $val['mobile'],
                            'address'           => $val['address'],
                            'address_line_1'    => $val['address_line_1'] ?: "",
                            'address_line_2'    => $val['address_line_2'] ?: "",
                            'city'              => $val['city'] ?: "",
                            'state'             => $val['state'] ?: "",
                            'zip'               => $val['zip'] ?: "",
                            'country'           => $val['country'] ?: "",
                            'vendor_id'         => $supplierID,
                            'deleted'           => '0',
                            'created_at'        => $dateTime
                        );
                        $insertAddressDataList[] = $insertAddressData;
                    }
                }
                $insertAddress = $db->insertMulti('vendor_address', $insertAddressDataList);
            }else{
                $updateData = array(
                    "deleted"    => 1
                );

                $db->where('vendor_id', $supplierID);
                $update = $db->update('vendor_address', $updateData);
            }


            if(!empty($uploadImage)) {
                foreach($uploadImage as $key => $val) {

                    // if($val['imgData'] == '""')
                    // {
                    //     // remove image if imgData is empty
                    //     $db->where('id', $val['imgID']);
                    //     $db->where('deleted', '0');
                    //     $db->where('type', 'Image');
                    //     $editImage = $db->update('vendor_media', array('deleted' => 1));
                    // }

                    if($val['imgID'] == '') {
                        //$imgSrc = json_decode($val['imgData'], true);
                        //$uploadParams['imgSrc'] = $imgSrc;
                        //$uploadRes = aws::awsUploadImage($uploadParams);

                        if(strpos($val['imgData'], "https") !== false) {
                            $imageUrl = $val['imgData'];
                            // insert product_media
                            $insertImage[] = array(
                                "type" => "Image",
                                'name' => $val['imgName'],
                                "url" => $imageUrl,
                                'created_at' => $dateTime,
                                "reference_id" => $supplierID,
                            );
                        } else {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00899"][$language], 'data' => ''); //Uploaded file is not a valid image.
                        }
                     } //else {
                    //     $imgSrc = json_decode($val['imgData'], true);

                    //     if (strpos($imgSrc, "data:") !== false) {
                    //         $db->where('id', $val['imgID']);
                    //         $db->where('type', 'Image');
                    //         $editImage = $db->update('vendor_media', array('deleted' => 1));

                    //         $uploadParams['imgSrc'] = $imgSrc;
                    //         $uploadRes = aws::awsUploadImage($uploadParams);

                    //         if($uploadRes['status'] == 'ok') {
                    //             $imageUrl = $uploadRes['imageUrl'];
                    //             // insert product_media
                    //             $insertImage[] = array(
                    //                 "type" => "Image",
                    //                 "url" => $imageUrl,
                    //                 "reference_id" => $supplierID,
                    //             );
                    //         } else {
                    //             return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    //         }
                    //     }
                    // }
                }

                if(!empty($insertImage)) {
                    $insertInvImage = $db->insertMulti('vendor_media', $insertImage);

                    if(!$insertInvImage) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    }
                }
            }
            if($imageId) {
                $db->where('id', $imageId, 'IN');
                $db->where('type', 'Image');
                $db->where('reference_id', $supplierID);
                $editImageList = $db->update('vendor_media', array('deleted' => 1));
            }
            // if(empty($uploadImage))
            // {
            //     $db->where('reference_id', $supplierID);
            //     $db->where('deleted', '0');
            //     $db->where('type', 'Image');
            //     $editImage = $db->update('vendor_media', array('deleted' => 1, 'updated_at' => $dateTime));
            // }

            if(!$update) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00131"][$language] /* Update failed. */, 'data' => "");
            }

            $activityData = array_merge(array('admin' => $checkAdmin), $updateData);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Edit Supplier', 'T00063', 'L00086', $activityData, $clientID, $clientID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
        }

        // -------- Invoice / PO / DO -------- //
        public function getInvoiceListing($params, $type){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $tableName      = "inv_order";
            $column         = array("id","client_id","created_at","reference_number","po_number","delivery_option","status","total_pv","total_price", "courier_service", "payment_type");

            $searchData     = $params['searchData'];
            $sortData       = $params['sortData'];
            $offsetSecs     = trim($params['offsetSecs']);
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit          = General::getLimit($pageNumber);
            $decimalPlaces  = Setting::getSystemDecimalPlaces();
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $seeAll         = $params['seeAll'];

            $clientID = $db->userID;
            $site = $db->userType;

            if($seeAll == 1){
                $limit = null;
            }

            if($limit) $limitCond = "LIMIT ".implode(",", $limit);

            $cpDb = $db->copy();

            if (count($searchData) > 0) {

 

                foreach ($searchData as $k => $v) {

                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName) {
                        case 'invoiceNo':
                            $orderRules[] = "reference_number = '".$dataValue."'";
                            break;

                        case 'transactionDate':

                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if(intval($dateFrom) > intval($dateTo))
                            {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                            }

                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                // if($dateTo < $dateFrom){ 
                                //     $db->resetState();
                                //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                // }
                            }

                            $orderRules[] = "Date(created_at) >= '".date('Y-m-d', $dateFrom)."'";
                            $orderRules[] = "Date(created_at) <= '".date('Y-m-d', $dateTo)."'";

                            $pendingRules[] = "Date(created_at) >= '".date('Y-m-d', $dateFrom)."'";
                            $pendingRules[] = "Date(created_at) <= '".date('Y-m-d', $dateTo)."'";

                            unset($dateFrom);
                            unset($dateTo);
                            break;

                        case 'memberID':
                            $db->where('member_id', $dataValue);
                            $searchClientID = $db->getValue('client', "id");

                            $orderRules[] = "client_id = '".$searchClientID."'";
                            $pendingRules[] = "client_id = '".$searchClientID."'";

                            break;

                        case 'username':
                            $db->where('username', $dataValue);
                            $searchClientID = $db->getValue('client', "id");

                            $orderRules[] = "client_id = '".$searchClientID."'";
                            $pendingRules[] = "client_id = '".$searchClientID."'";

                            break;

                        case 'fullname':
                            if ($dataType == "like") {
                                $db->where('name', '%' . $dataValue . '%', "LIKE");
                                $fullnames = $db->getValue('client', "id", NULL);

                                $orderRules[] = "client_id IN ('".implode("', '", $fullnames)."')";
                                $pendingRules[] = "client_id IN ('".implode("', '", $fullnames)."')";
                            }else{
                                $db->where('name', $dataValue);
                                $fullname = $db->getOne('client', "id")['id'];

                                $orderRules[] = "client_id = '".$fullname."'";
                                $pendingRules[] = "client_id = '".$fullname."'";
                            }

                            break;

                        // filter for po listing
                        case 'deliveryOption':
                            $orderRules[] = "delivery_method = '".$dataValue."'";
                            break;

                        case 'status':
                            $orderRules[] = "status LIKE '%".$dataValue."%'";
                            $pendingRules[] = "status = '".$dataValue."'";
                            break;

                        case 'poNumber':
                            $orderRules[] = "id = '".$dataValue."'";
                            break;

                        case 'soNumber':
                            $orderRules[] = "so_no LIKE '%".$dataValue."%'";
                            break;

                        case 'doNumber':
                            $db->where('reference_number', $dataValue);
                            $invIDs = $db->getValue('inv_delivery_order', "inv_order_id", NULL);

                            $orderRules[] = "id IN ('".implode("', '", $invIDs)."')";
                            break;

                        case 'payment_method':
                            $orderRules[] = "payment_method LIKE '%".$dataValue."%'";
                            break;
    
                        case 'mobileNumber':
                            $db->where('username', '%' . $dataValue . '%', "LIKE");
                            $fullnames = $db->getValue('client', "id", NULL);

                            $orderRules[] = "client_id IN ('".implode("', '", $fullnames)."')";
                            $pendingRules[] = "client_id IN ('".implode("', '", $fullnames)."')";
                            break;
                        
                        case 'totalAmount':
                            $orderRules[] = "payment_amount LIKE '%".$dataValue."%'";
                            break;
                    }

                    unset($dataName);
                    unset($dataValue);
                }
            }


            if($site == "Member"){
                // $db->where("client_id",$clientID);
                $orderRules[] = "client_id = '".$clientID."'";
                $pendingRules[] = "client_id = '".$clientID."'";
            } else {
                $pendingRules[] = "status = 'Paid'" ;
            }

            $sortOrder = "DESC";
            $sortField = 'so_no';

            // Means the sort params is there
            if (!empty($sortData)) { 
                if($sortData['field']) {
                    $sortField = $sortData['field'];
                }
                        
                if($sortData['order'] == 'ASC')
                    $sortOrder = 'ASC';
            }

            // Sorting while switch case matched
            if ($sortField && $sortOrder) {
                $data['sortBy'] = array('field' => $sortField, 'order' => $sortOrder);
            }

            // $copyDB = $db->copy();
            // $db->orderBy("created_at", "DESC");
            $sort = "ORDER BY " .$sortField. " " .$sortOrder;
            if($orderRules) $orderRule = "WHERE ". implode(" AND ", $orderRules);

            $pendingRules[] = "status IN ('Draft', 'Pending', 'Expired', 'Waiting for Payment', 'Cancelled', 'Payment Verified')" ;
            if($pendingRules) $pendingRule = "WHERE ". implode(" AND ", $pendingRules);

            // $query = "SELECT id, client_id, created_at, 'order' FROM sale_order ".$orderRule. $sort;

            $pageSize = $limit[1]; 

            $offset = ($pageNumber - 1) * $pageSize;

            $query = "SELECT id, client_id, created_at, so_no, 'order' FROM sale_order ".$orderRule. $sort. " LIMIT ".$limit[1]." OFFSET ".$offset;

            $invoiceList = $db->rawQuery($query);

            if(empty($invoiceList)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            foreach ($invoiceList as $invoiceRow) {
                $invoiceIDAry[$invoiceRow['id']] = $invoiceRow['id'];

                if($invoiceRow["order"] == 'order'){
                    $invoiceOrderIDAry[$invoiceRow['id']] = $invoiceRow['id'];
                } else {
                    $invoicePendingIDAry[$invoiceRow['id']] = $invoiceRow['id'];
                }

                $clientIDAry[$invoiceRow['client_id']] = $invoiceRow['client_id'];
            }

            // print_r(json_encode($invoiceList));
            // exit;
            if($invoiceOrderIDAry){
                $db->where('id', $invoiceOrderIDAry, 'IN');
                $invData = $db->map('id')->get('sale_order', NULL, 'id, payment_amount, delivery_method, status, redeem_amount, payment_method, release_amount');
            }
           
            $data['debug0'] = $db->getLastQuery();
            $data['debug1'] = $invData;
            if($clientIDAry){
                if($clientRules) 
                {
                    $clientRule = implode(" AND ", $clientRules);
                    $db->where($clientRule);
                }
                else
                {
                    $db->where("id",$clientIDAry, "IN");
                }
                $clientInfoAry = $db->map("id")->get("client", NULL, "id, member_id, username, name");
                // return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $clientInfoAry);
            }

            if($invoicePendingIDAry){
                $db->where('id', $invoicePendingIDAry, 'IN');
                $pendingData = $db->map('id')->get('mlm_pending_payment', NULL, 'id, client_id, amount, status');
            }
                //          print_r("clientInfoAry:".json_encode($clientInfoAry)."\n\n");
                //                 exit;
            foreach ($invoiceList as $invoiceRow) {
                unset($invoice);
                $invoice['id'] = $invoiceRow['id'];
                if($clientInfoAry[$invoiceRow['client_id']]['member_id']){
                    $invoice['memberID'] = $clientInfoAry[$invoiceRow['client_id']]['member_id'];
                }else{
                    $invoice['memberID'] = '-';
                }

                if($clientInfoAry[$invoiceRow['client_id']]['username']){
                    $invoice['username'] = $clientInfoAry[$invoiceRow['client_id']]['username'];
                }else{
                    $invoice['username'] = '-';
                }

                if($clientInfoAry[$invoiceRow['client_id']]['name']){
                    $invoice['fullname'] = $clientInfoAry[$invoiceRow['client_id']]['name'];
                }else{
                    $invoice['fullname'] = '-';
                }
                $invoice['sono'] = $invoiceRow['so_no'];

                $invoice['created_at'] = date($dateTimeFormat, strtotime($invoiceRow['created_at']));
                // $invoice['invoiceNumber'] = $invData[$invoiceRow['id']]['reference_number'] ?: '-';
                $paymentMethod = !empty($invData[$invoiceRow['id']]['payment_method']) ? $invData[$invoiceRow['id']]['payment_method'] : "-";
                $invoice['paymentMethod'] = $paymentMethod;
                
                if($invoiceRow['order'] == 'order'){
                    $invoice['poNumber'] = $invoiceRow['id'];
                    $deliveryOption = !empty($invData[$invoiceRow['id']]['delivery_method']) ? $invData[$invoiceRow['id']]['delivery_method'] : "-";
                    $invoice['deliveryOption'] = strtolower($deliveryOption);
                    // $invoice['DONumber'] = $deliOrderNum[$invoiceRow['id']] ?: "-";
                    // $invoice['courierService'] = $invData[$invoiceRow['id']]['courier_service'];
                    $db->where('sale_id', $invoiceRow['id']);
                    $db->where('deleted', '0');
                    $db->where('type', 'shipping_fee');
                    $shippingFee = $db->getOne('sale_order_detail', 'subtotal');
                    // $invoicePaymentAmnount = Setting::setDecimal($invData[$invoiceRow['id']]['payment_amount']);
                    // $invoice["payment_amount"] = $invoicePaymentAmnount + $shippingFee['subtotal'];
                    $invoice["payment_amount"] = Setting::setDecimal($invData[$invoiceRow['id']]['release_amount']);
                    
                    $invoice["redeem_amount"] = Setting::setDecimal($invData[$invoiceRow['id']]['redeem_amount']);

                    $invoice['status'] = $invData[$invoiceRow['id']]['status'];
                    $invoice["statusDisplay"] = $invData[$invoiceRow['id']]['status'];
                }
                $invoiceListing[] = $invoice;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $params['exportType'] = $type;

                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            switch ($params['exportType']) {
                case 'invoice':
                    $data['newCommand'] = 'getInvoiceListing';
                    break;

                case 'apo':
                    $data['newCommand'] = 'getAdminOrderListing';
                    break;

                default:
                    break;
            }

            $db->groupBy("so.status");
            $arrSummaryDetail = $db->map("status")->get("sale_order so", null, "so.status, count(*) as total");

            $allCount = $draftCount = $pendingPaymentCount = $paidCount = $failedCount  = $cancelledCount = $orderProcessingCount = $packedCount = $outOfDeliveryCount = $deliveredCount  = $confirmedCount = $stockInCount = $doneCount = 0;
            foreach($arrSummaryDetail as $skey => $svalue) {
                if(strtolower($skey)=="draft") $draftCount = $svalue;
                if(strtolower($skey)=="pending payment approve") $pendingPaymentCount = $svalue;
                if(strtolower($skey)=="paid") $paidCount = $svalue;
                if(strtolower($skey)=="failed") $failedCount = $svalue;
                if(strtolower($skey)=="cancelled") $cancelledCount = $svalue;
                if(strtolower($skey)=="order processing") $orderProcessingCount = $svalue;
                if(strtolower($skey)=="packed") $packedCount = $svalue;
                if(strtolower($skey)=="out for delivery") $outOfDeliveryCount = $svalue;
                if(strtolower($skey)=="delivered") $deliveredCount = $svalue;
                $allCount += $svalue;
            }
            

            // SELECT DISTINCT status FROM sale_order
            $db->groupBy("status");
            $statusList = $db->get("sale_order",null, "status");

            $data['statusList'] = $statusList;

            $data['summary'] = array("all"=>$allCount, "draft"=>$draftCount, "pending_payment_approve"=>$pendingPaymentCount, "paid"=>$paidCount, "failed"=>$failedCount,  "cancelled"=>$cancelledCount, "order processing"=>$orderProcessingCount, "packed"=>$packedCount, "out_for_delivery"=>$outOfDeliveryCount, "delivered"=>$deliveredCount);


            $data['invoiceList'] = $invoiceListing;

            $totalRecordRes = $db->rawQuery("SELECT COUNT(id) AS totalRecord FROM (SELECT id FROM sale_order ".$orderRule.") x");
            $totalRecord = $totalRecordRes[0]['totalRecord'];

            $data["pageNumber"] = $pageNumber;
            $data["totalRecord"] = $totalRecord;
            if($seeAll == "1") {
                $data["totalPage"] = 1;
                $data["numRecord"] = $totalRecord;
            } else {
                $data["totalPage"] = ceil($totalRecord/$limit[1]);
                $data["numRecord"] = $limit[1];
            }

            if($type == "invoice"){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00111"][$language] /* Invoice List successfully retrieved. */, 'data' => $data);
            }else{
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00421"][$language] /* Purchase Order List successfully retrieved. */, 'data' => $data);
            }
        }

        public function getInvoiceDetailOld($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $invoiceID = trim($params['invOrderID']);

            if(!$invoiceID) {
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            // Company address
            $db->where('name', 'HQ');
            $db->where('type', 'companyAddress');
            $companyAddress = $db->getValue('system_settings', 'value');

            // Company Contact No/ Email/ Fax
            $db->where('type', 'companyContact');
            $res = $db->getValue('system_settings', 'value');
            $companyContactList = json_decode($res, true);

            // Invoice No, Transaction Date, Member ID, Full Name, Delivery Method, Shipping Address, Contact No, Email Address, Billing Address

            $db->where("id", $invoiceID);
            $invoiceDetail = $db->getOne("inv_order","id, client_id, reference_number AS referenceNo, created_at AS createdAt, delivery_option AS deliveryOption, delivery_add_id, billing_add_id, total_price AS subTotal, tax_charges AS taxCharges, delivery_fee AS deliveryFee, paid_amount AS paidAmount, total_pv AS totalPV");

            $invoiceDetail['createdAt'] = date($dateTimeFormat, strtotime($invoiceDetail["createdAt"]));
            $invoiceDetail['subTotal'] = Setting::setDecimal($invoiceDetail['subTotal']);
            $invoiceDetail['taxCharges'] = Setting::setDecimal($invoiceDetail['taxCharges']);
            $invoiceDetail['deliveryFee'] = Setting::setDecimal($invoiceDetail['deliveryFee']);
            $invoiceDetail['paidAmount'] = Setting::setDecimal($invoiceDetail['paidAmount']);
            $invoiceDetail['totalPV'] = Setting::setDecimal($invoiceDetail['totalPV']);

            // get delivery address, email, phone, from address table
            $db->where("address_type", "delivery");
            $db->where("id", $invoiceDetail['delivery_add_id']);
            $addressDetail= $db->getOne("address","address, street_name AS streetName, sub_district AS subDistrict, post_code AS postCode, city, state, country_id, email, phone");

            // get state from state table
            $db->where("id", $addressDetail["state"]);
            $stateRes = $db->getOne("state","name, translation_code");

             // get country from state table
            $db->where("id", $addressDetail["country_id"]);
            $countryRes = $db->getOne("country","name, translation_code");

            unset($addressDetail['country_id']);
            $addressDetail['state'] = $stateRes['name'];
            $addressDetail['stateDisplay'] = $translations[$stateRes['translation_code']][$language];
            $addressDetail['country'] = $countryRes['name'];
            $addressDetail['countryDisplay'] = $translations[$countryRes['translation_code']][$language];

            // get billing address from address table
            $db->where("address_type", "billing");
            $db->where("id", $invoiceDetail['billing_add_id']);
            $billingAddressDetail = $db->getOne("address","address, street_name AS streetName, sub_district AS subDistrict, post_code AS postCode, city, state, country_id");

            // get state from state table
            $db->where("id", $billingAddressDetail["state"]);
            $billingStateRes = $db->getOne("state","name, translation_code");

             // get country from state table
            $db->where("id", $billingAddressDetail["country_id"]);
            $billingCountryRes = $db->getOne("country","name, translation_code");

            unset($billingAddressDetail['country_id']);
            $billingAddressDetail['state'] = $billingStateRes['name'];
            $billingAddressDetail['stateDisplay'] = $translations[$billingStateRes['translation_code']][$language];
            $billingAddressDetail['country'] = $billingCountryRes['name'];
            $billingAddressDetail['countryDisplay'] = $translations[$billingCountryRes['translation_code']][$language];

            // client table:  Member ID, Full Name
            $db->where("id", $invoiceDetail['client_id']);
            $clientDetail = $db->getOne("client","member_id AS memberID, name");

            unset($invoiceDetail['delivery_add_id']);
            unset($invoiceDetail['billing_add_id']);
            unset($invoiceDetail['client_id']);

            $db->where("inv_order_id", $invoiceDetail['id']);
            $invOrderList = $db->get('inv_order_detail', NULL ,'mlm_product_id AS packageDisplay, inv_product_id AS productDisplay, price, weight, quantity, stock_quantity, left_stock_quantity AS quantityLeft');

            foreach ($invOrderList as $invOrderRow) {

                $invOrderRow['price'] = Setting::setDecimal($invOrderRow['price']);
                $invOrderRow['weight'] = Setting::setDecimal($invOrderRow['weight']);
                $invOrderRow['totalWeight'] = Setting::setDecimal($invOrderRow['weight'] * $invOrderRow['quantity'] * $invOrderRow['stock_quantity'] );
                $invOrderRow['quantity'] = Setting::setDecimal($invOrderRow['quantity']);
                $invOrderRow['quantityLeft'] = Setting::setDecimal($invOrderRow['quantityLeft']);

                $invOrder[$invOrderRow['packageDisplay']][$invOrderRow['productDisplay']] = $invOrderRow;
                $invProductIDAry[$invOrderRow["productDisplay"]] = $invOrderRow["productDisplay"];
                $mlmProductIDAry[$invOrderRow["packageDisplay"]] = $invOrderRow["packageDisplay"];
            }

            if($invProductIDAry){
                // product
                $db->where("module", "inv_product");
                $db->where("module_id", $invProductIDAry, "IN");
                $db->where("type", "name");
                $db->where("language", $language);
                $langRes = $db->get('inv_language', NULL ,'module_id, language, content');

                foreach ($langRes as $langRow) {
                    $lang[$langRow['module_id']] = $langRow['content'];
                }
            }

            if($mlmProductIDAry){
                // package
                $db->where("module", "mlm_product");
                $db->where("module_id", $mlmProductIDAry, "IN");
                $db->where("type", "name");
                $db->where("language", $language);
                $packageLangRes = $db->get('inv_language', NULL ,'module_id, language, content');

                foreach ($packageLangRes as $langRow) {
                    $packageLang[$langRow['module_id']] = $langRow['content'];
                }
            }

            foreach ($invOrder as $packageID => $packageValue) {
                foreach ($packageValue as $productID => $productValue) {
                    $invOrder[$packageID][$productID]['productDisplay'] = $lang[$productValue['productDisplay']];
                    $invOrder[$packageID][$productID]['packageDisplay'] = $packageLang[$productValue['packageDisplay']];
                }
            }

            // assign data into data
            $data['companyAddress'] = $companyAddress;
            $data['companyContact'] = $companyContactList;
            $data['invoiceDetail'] = $invoiceDetail;
            $data['deliveryAddressDetail'] = $addressDetail;
            $data['billingAddressDetail'] = $billingAddressDetail;
            $data['clientDetail'] = $clientDetail;
            $data['packageList'] =  $invOrder;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);
        }

        public function getInvoiceDetail($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $invoiceID = trim($params['invOrderID']);

            if(!$invoiceID) {
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            // Company address
            $db->where('name', 'pickUpOrigins');
            $companyAddress = $db->getValue('system_settings', 'reference');

            // Company Contact No/ Email/ Fax
            $db->where('type', 'companyContact');
            $res = $db->getValue('system_settings', 'value');
            $companyContactList = json_decode($res, true);

            $db->where("id", $invoiceID);
            $invoiceDetail = $db->getOne("inv_order","id, po_number AS purchaseOrderNo , client_id, reference_number AS referenceNo, created_at AS createdAt, delivery_option AS deliveryOption, delivery_add_id, billing_add_id, total_price AS subTotal, tax_charges AS taxCharges, delivery_fee AS deliveryFee, paid_amount AS paidAmount, total_pv AS totalPV, total_weight AS totalWeight, special_note as specialNote, remark, courier_service AS courierService, insurance_tax AS insuranceTax");

            $db->where("inv_order_id", $invoiceDetail['id']);
            $db->where("status",array("Cancel"),"NOT IN");
            $deliveryOrderRes = $db->get('inv_delivery_order', null, 'inv_order_id, tracking_number');
            foreach ($deliveryOrderRes as $deliveryOrderRow) {
                if($deliveryOrderRow['tracking_number']){
                    $trackingNo[] = $deliveryOrderRow['tracking_number'];
                }
            }

            $data['showInsuranceTax'] = 0;
            $invoiceDetail['insuranceTax'] = Setting::setDecimal($invoiceDetail['insuranceTax']);
            if($invoiceDetail['insuranceTax'] > 0) $data['showInsuranceTax'] = 1;

            $invoiceDetail['createdAt'] = date($dateTimeFormat, strtotime($invoiceDetail["createdAt"]));
            $invoiceDetail['subTotal'] = Setting::setDecimal($invoiceDetail['subTotal']);
            $invoiceDetail['taxCharges'] = Setting::setDecimal($invoiceDetail['taxCharges']);
            $invoiceDetail['deliveryFee'] = Setting::setDecimal($invoiceDetail['deliveryFee']);
            $invoiceDetail['paidAmount'] = Setting::setDecimal($invoiceDetail['paidAmount']);
            $invoiceDetail['totalPV'] = Setting::setDecimal($invoiceDetail['totalPV']);
            $invoiceDetail['trackingNo'] = $trackingNo ? implode(', ', $trackingNo) : '-';

            $addressIDAry = array($invoiceDetail['delivery_add_id'], $invoiceDetail['billing_add_id']);

            if($addressIDAry){
                $db->where("id", $addressIDAry, "IN" );
                $addressDetailAry= $db->map('id')->get("address", NULL,"id, name, address, district_id AS districtID, sub_district_id AS subDistrictID, post_code AS postCodeID, city AS cityID, state_id AS stateID, country_id AS countryID, email, phone, address_type");
            }

            foreach ($addressDetailAry as $addressRow) {
                $stateAry[$addressRow['stateID']] = $addressRow['stateID'];
                $countryAry[$addressRow['countryID']] = $addressRow['countryID'];
                $countyAry[$addressRow['districtID']] = $addressRow['districtID'];
                $subCountyAry[$addressRow['subDistrictID']] = $addressRow['subDistrictID'];
                $postCodeAry[$addressRow['postCodeID']] = $addressRow['postCodeID'];
                $cityAry[$addressRow['cityID']] = $addressRow['cityID'];
            }

            if($stateAry){
                $db->where("id", $stateAry, "IN");
                $stateRes = $db->map('id')->get("state", NULL,"id, name, translation_code");
            }

            if($countryAry){
                $db->where("id", $countryAry, "IN");
                $countryRes = $db->map('id')->get("country", NULL,"id, name, translation_code, country_code");
            }

            if($countyAry){
                $db->where("id", $countyAry, "IN");
                $countyRes = $db->map('id')->get("county", NULL,"id, name, translation_code");
            }

            if($subCountyAry){
                $db->where("id", $subCountyAry, "IN");
                $subCountyRes = $db->map('id')->get("sub_county", NULL,"id, name, translation_code");
            }

            if($postCodeAry){
                $db->where("id", $postCodeAry, "IN");
                $postCodeRes = $db->map('id')->get("zip_code", NULL,"id, name, translation_code");
            }

            if($cityAry){
                $db->where("id", $cityAry, "IN");
                $cityRes = $db->map('id')->get("city", NULL,"id, name, translation_code");
            }

            foreach ($addressDetailAry as $addressRow) {
                unset($addressDetail);
                $addressDetail['fullname'] = $addressRow['name'];
                $addressDetail['address'] = $addressRow['address'];
                $addressDetail['district'] = $countyRes[$addressRow['districtID']]['name'];
                $addressDetail['subDistrict'] = $subCountyRes[$addressRow['subDistrictID']]['name'];
                $addressDetail['postCode'] = $postCodeRes[$addressRow['postCodeID']]['name'];
                $addressDetail['city'] = $cityRes[$addressRow['cityID']]['name'];
                $addressDetail['email'] = $addressRow['email'];
                $addressDetail['phone'] = $addressRow['phone'];
                $addressDetail['state'] = $stateRes[$addressRow['stateID']]['name'];
                $addressDetail['stateDisplay'] = $stateRes[$addressRow['stateID']]['name'];
                $addressDetail['country'] = $countryRes[$addressRow['countryID']]['name'];
                $addressDetail['dialingArea'] = $countryRes[$addressRow['countryID']]['country_code'];
                $addressDetail['countryDisplay'] = $translations[$countryRes[$addressRow['countryID']]['translation_code']][$language];

                $addressDetailRes[$addressRow['id']] = $addressDetail;
            }

            $deliveryAddressData = $addressDetailRes[$invoiceDetail['delivery_add_id']];
            $billingAddressData = $addressDetailRes[$invoiceDetail['billing_add_id']];

            // client table:  Member ID, Full Name
            $db->where("id", $invoiceDetail['client_id']);
            $clientDetail = $db->getOne("client","member_id AS memberID, name");

            unset($invoiceDetail['delivery_add_id']);
            unset($invoiceDetail['billing_add_id']);
            unset($invoiceDetail['client_id']);

            $db->where("inv_order_id", $invoiceDetail['id']);
            $db->orderBy("mlm_product_id", "ASC");
            $invOrderList = $db->get('inv_order_detail', NULL ,'mlm_product_id AS packageDisplay, inv_product_id AS productDisplay, price AS packagePrice, weight, quantity, stock_quantity AS stockQuantity, left_stock_quantity AS quantityLeft, pv_price as orderPvPrice');

            foreach ($invOrderList as $invOrderRow) {
                $invProductIDAry[$invOrderRow["productDisplay"]] = $invOrderRow["productDisplay"]; // product
                $mlmProductIDAry[$invOrderRow["packageDisplay"]] = $invOrderRow["packageDisplay"]; // package

                $mlmInvOrderPv[$invOrderRow["packageDisplay"]] = $invOrderRow["orderPvPrice"] * $invOrderRow["quantity"];
            }

            if($invProductIDAry){
                // product
                $db->where("id", $invProductIDAry, "IN");
                $productNameRes = $db->map('id')->get('inv_product', NULL ,'id, name');
            }

            if($mlmProductIDAry){
                // package
                $db->where("module_id", $mlmProductIDAry, "IN");
                $db->where("module", "mlm_product");
                $db->where("type", "name");
                $db->where("language", $language);
                $packageLangRes = $db->get('inv_language', NULL ,'module_id, language, content');

                foreach ($packageLangRes as $langRow) {
                    $packageLang[$langRow['module_id']] = $langRow['content'];
                }

                // $db->where("product_id", $mlmProductIDAry, "IN");
                // $packagePriceAry = $db->map('product_id')->get('mlm_product_price', NULL ,'product_id,price'); // package price

                $db->where("id", $mlmProductIDAry, "IN");
                $pvPriceAry = $db->map("id")->get('mlm_product', NULL ,'id, weight, pv_price AS pvPrice');
            }

            unset($currentPackageID);
            foreach ($invOrderList as $invOrderRow) {
                unset($invOrderData);
                unset($productListData);
                if($currentPackageID != $invOrderRow['packageDisplay']){
                    unset($productList);
                    unset($totalProductWeight);
                }
                $invOrderData['package'] = $mlmProductIDAry[$invOrderRow['packageDisplay']];
                $invOrderData['packageDisplay'] = $packageLang[$mlmProductIDAry[$invOrderRow['packageDisplay']]];
                $invOrderData['packagePrice'] = Setting::setDecimal($invOrderRow['packagePrice']);
                $invOrderData['totalPackagePrice'] = Setting::setDecimal($invOrderRow['packagePrice'] * $invOrderRow['quantity']);
                //$invOrderData['pvPrice'] = Setting::setDecimal($pvPriceAry[$invOrderRow['packageDisplay']]["pvPrice"]);
                $invOrderData['pvPrice'] = Setting::setDecimal($mlmInvOrderPv[$invOrderRow['packageDisplay']]);


                $invOrderData['packageQuantity'] = Setting::setDecimal($invOrderRow['quantity']);
                $productListData['productDisplay'] = $productNameRes[$invOrderRow['productDisplay']];
                $productListData['productID'] = $invOrderRow['productDisplay'];

                if(($pvPriceAry[$invOrderRow["packageDisplay"]]["weight"] > 0)){
                    $invOrderData["totalProductWeight"] = Setting::setDecimal($invOrderRow["weight"] * $invOrderRow["quantity"]);
                }else{
                    $productListData["weight"] = Setting::setDecimal($invOrderRow["weight"] * $invOrderRow["stockQuantity"]); // stock quantity * weight
                    $productListData["singleWeight"] = Setting::setDecimal($invOrderRow["weight"]); // single weight
                    $totalProductWeight += $productListData['weight'];
                    $invOrderData['totalProductWeight'] = $totalProductWeight;
                }

                $productListData['stockQuantity'] = Setting::setDecimal($invOrderRow['stockQuantity']);
                $productListData['quantityLeft'] = Setting::setDecimal($invOrderRow['quantityLeft']);
                $productList[] = $productListData;
                $invOrderData["productList"] = $productList;
                $currentPackageID = $invOrderRow['packageDisplay'];
                $invOrder[$invOrderRow['packageDisplay']] = $invOrderData;

                $leftStockQuantity += $invOrderRow['quantityLeft'];
            }

            $issueDOFlag = 0;
            if($leftStockQuantity > 0){
                $issueDOFlag = 1;
            }

            $db->where("type","SST");
            $db->orderBy("created_at","DESC");
            $taxPercentage = $db->getValue("inv_tax_charges","rate");
            if(!$taxPercentage) $taxPercentage = 0;

            // assign data into data
            if($invoiceDetail['deliveryOption'] == "pickup"){
                $data['deliveryAddressDetail']['pickUpAddress'] = $companyAddress;
            }else{
                $data['deliveryAddressDetail'] = $deliveryAddressData;
            }

            $db->where("inv_order_id",$invoiceDetail["id"]);
            $voucherDataAry = $db->getOne("inv_order_voucher","inv_voucher_id,type,discount_type,discount_percentage,discount_amount,real_discount_amount");

            if($voucherDataAry){
                unset($voucherData);
                $db->where("id",$voucherDataAry["inv_voucher_id"]);
                $voucherData["voucherCode"] = $db->getValue("inv_voucher","code");
                $voucherData["voucherType"] = $voucherDataAry["type"];
                $voucherData["discountType"] = $voucherDataAry["discount_type"];
                switch($voucherDataAry["discount_type"]){
                    case "percentage":
                        $voucherData["discountPercentage"] = Setting::setDecimal($voucherDataAry["discount_percentage"]);
                        $voucherData["maxDiscountAmount"] = Setting::setDecimal($voucherDataAry["discount_amount"]);
                        break;

                    case "amount":
                        $voucherData["discountAmount"] = Setting::setDecimal($voucherDataAry["discount_amount"]);
                        break;
                }
                $voucherData["realDiscountAmount"] = Setting::setDecimal($voucherDataAry["real_discount_amount"]);
            }

            $data['billingAddressDetail'] = $billingAddressData;
            $data['companyAddress'] = $companyAddress;
            $data['companyContact'] = $companyContactList;
            $data['taxPercentage'] = $taxPercentage;
            $data['invoiceDetail'] = $invoiceDetail;
            $data['clientDetail'] = $clientDetail;
            $data['packageList'] =  $invOrder;
            $data['issueDOAllowed'] = $issueDOFlag;
            if($voucherData) $data["voucherData"] = $voucherData;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);
        }

        public function getSODetail($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $SaleID = trim($params['SaleID']);
            $doNo   = trim($params['doNo']);

            if(!$SaleID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> '');
            }

            // Company address
            $db->where('name', 'pickUpOrigins');
            $companyAddress = $db->getValue('system_settings', 'reference');
            
            // Company Contact No/ Email/ Fax
            $db->where('type', 'companyContact');
            $res = $db->getValue('system_settings', 'value');
            $companyContactList = json_decode($res, true);

            // Company Address
            $db->where('type', 'companyAddressActual');
            $res = $db->getValue('system_settings', 'value');
            $companyAddressList = json_decode($res, true);

            $db->where("id", $SaleID);
            $invoiceDetails = $db->getOne("sale_order","id, client_id, so_no, status,discount_amount,redeem_amount,
                                        created_at AS createdAt, payment_method AS paymentMethod, 
                                        delivery_method AS deliveryMethod, shipping_name, shipping_phone, shipping_address, billing_name, billing_phone, billing_address, payment_amount AS paymentAmount, payment_tax AS paymentTax, shipping_fee AS shippingfee, shipping_email AS shippingEmail,  billing_email AS billingEmail, is_gift");

            // $db->where("inv_order_id", $invoiceDetail['id']);
            // $db->where("status",array("Cancel"),"NOT IN");
            // $deliveryOrderRes = $db->get('inv_delivery_order', null, 'inv_order_id, tracking_number');
            // foreach ($deliveryOrderRes as $deliveryOrderRow) {
            //     if($deliveryOrderRow['tracking_number']){
            //         $trackingNo[] = $deliveryOrderRow['tracking_number'];
            //     }
            // }



            $db->where("origin",$invoiceDetails["so_no"]);
            $do_name = $db->get("stock_picking", null, "name");
            $invoiceDetail["do_name"] = $do_name;

            $invoiceDetail["id"]                = $invoiceDetails['id'];
            $invoiceDetail["status"]            = $invoiceDetails['status'];
            $invoiceDetail["so_no"]             = $invoiceDetails['so_no'];
            $invoiceDetail['orderDate']         = date($dateTimeFormat, strtotime($invoiceDetails["createdAt"]));
            $invoiceDetail['paymentAmount']     = Setting::setDecimal($invoiceDetails['paymentAmount'] + $invoiceDetails['shippingfee'] - $invoiceDetails['redeem_amount'] - $invoiceDetails['discount_amount']);
            $invoiceDetail['paymentTax']        = Setting::setDecimal($invoiceDetails['paymentTax']);
            $invoiceDetail['shippingfee']       = Setting::setDecimal($invoiceDetails['shippingfee']);
            $invoiceDetail['paymentMethod']     = $invoiceDetails['paymentMethod'];
            $invoiceDetail['deliveryMethod']    = $invoiceDetails['deliveryMethod'];


            $billingAddress = Cash::concateAddress($invoiceDetails['id'], 'sale_order_billing');
            $shippingAddress = Cash::concateAddress($invoiceDetails['id'], 'sale_order_shipping');


            $formattedBillingPhone = self::phoneNumberFormat($invoiceDetails['billing_phone']);
            $formattedShippingPhone = self::phoneNumberFormat($invoiceDetails['shipping_phone']);


            $invoiceDetail["shipping_name"]     = $invoiceDetails['shipping_name'];
            $invoiceDetail["shipping_phone"]    = $formattedShippingPhone;
            $invoiceDetail["shipping_address"]  = $shippingAddress;
            $invoiceDetail["billing_name"]      = $invoiceDetails['billing_name'];
            $invoiceDetail["billing_phone"]     = $formattedBillingPhone;
            $invoiceDetail["billing_address"]   = $billingAddress;
            $invoiceDetail["billing_email"]   = $invoiceDetails['billingEmail'];
            $invoiceDetail["shipping_email"]   = $invoiceDetails['shippingEmail'];
            $invoiceDetail["is_gift"]   = $invoiceDetails['is_gift'];


            $data['showInsuranceTax'] = 0;

            // client table:  Member ID, Full Name
            $db->where("id", $invoiceDetails['client_id']);
            $clientDetail = $db->getOne("client","member_id AS memberID, name");

            $db->where("a.deleted", 0);
            $db->where("a.sale_id", $invoiceDetails['id']);
            $db->orderBy("product_template_id", "ASC");
            $invOrderList = $db->get('sale_order_detail a', NULL ,'a.sale_id AS packageDisplay, a.product_template_id AS productDisplay, a.item_name, a.product_id, a.item_price AS packagePrice, a.quantity, a.subtotal as Total,a.type');


            $db->where("a.deleted", 0);
            $db->where("a.sale_id", $invoiceDetails['id']);
            $db->where("a.type", array('stock','', 'product', 'package'),'IN');
            $db->orderBy("product_template_id", "ASC");
            $deliveryOrderList = $db->get('sale_order_detail a', NULL ,'a.sale_id AS packageDisplay, a.product_template_id AS productDisplay, a.item_name, a.product_id, a.item_price AS packagePrice, a.quantity, a.subtotal as Total');

            $db->where('dod.disabled', '0');
            $db->where('ido.delivery_order_no', $doNo);
            $db->join('inv_delivery_order_detail dod', 'dod.inv_delivery_order_id = ido.id', 'INNER');
            $db->join('product p', 'p.id = dod.product_id', 'LEFT');
            $deliveryOrderListInfo = $db->get('inv_delivery_order ido');

            $product_attribute_value = $db->get('product_attribute_value a', null, 'id,name');

            $subTotal =0;
            foreach ($invOrderList as $invOrderRow) {
                $invProductIDAry[$invOrderRow["productDisplay"]] = $invOrderRow["productDisplay"]; // product
                $mlmProductIDAry[$invOrderRow["packageDisplay"]] = $invOrderRow["packageDisplay"]; // package
                $subTotal = bcadd($subTotal, $invOrderRow["Total"],2);
                $mlmInvOrderPv[$invOrderRow["packageDisplay"]] = $subTotal;
            }

            $invoiceDetail['subtotal'] = $invOrderList['Total'];

            if($invProductIDAry){
                // product_template
                $db->where("a.id", $invProductIDAry, "IN");
                $db->join('product b', 'a.product_id = b.id', 'LEFT');
                $productNameRes = $db->map('temp_id')->get('product_template a', NULL ,'a.id as temp_id, b.id as id, b.name');
            }

            if($mlmProductIDAry){
                // package
                $db->where("module_id", $mlmProductIDAry, "IN");
                $db->where("module", "mlm_product");
                $db->where("type", "name");
                $db->where("language", $language);
                $packageLangRes = $db->get('inv_language', NULL ,'module_id, language, content');

                foreach ($packageLangRes as $langRow) {
                    $packageLang[$langRow['module_id']] = $langRow['content'];
                }

                // $db->where("product_id", $mlmProductIDAry, "IN");
                // $packagePriceAry = $db->map('product_id')->get('mlm_product_price', NULL ,'product_id,price'); // package price

                $db->where("id", $mlmProductIDAry, "IN");
                $pvPriceAry = $db->map("id")->get('mlm_product', NULL ,'id, weight, pv_price AS pvPrice');
            }
            unset($currentPackageID);
            $index = 0;
            $productQuantity = 0;
            $deliveryAmt = 0;
            $indexdeliveryOrder = 0;

            // return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $invOrderList);

            foreach ($invOrderList as $invOrderRow) {
                $db->where("id", $invOrderRow['product_id']);
                $getBarcode = $db->getValue('product' ,'barcode');

                $db->where('disabled', '0');
                $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                $db->where('product_id', $invOrderRow['product_id']);
                $pricelist_detail = $db->getOne('pricelist_detail');

                if($pricelist_detail)
                {
                    // get product price
                    $db->where('id', $invOrderRow['product_id']);
                    $productInventoryDetail = $db->getOne('product');

                    if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                    }
                    if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($pricelist_detail['discount']);
                    }
                    $invOrderData['latestUnitPrice']   = $latestPrice;
                    $invOrderData['latestPrice']       = floatval($latestPrice) * (Setting::setDecimal($invOrderRow['quantity']));
                }
                else
                {
                    $invOrderData['latestPrice']       = 0;
                }

                $invOrderData['type'] = $invOrderRow['type'];
                if ($invOrderRow['type'] == "shipping_fee" || $invOrderRow['type'] == "redeem_point") {
                    if($invOrderRow['type'] == "redeem_point")$invOrderData['negativeValue'] = "true";
                    else $invOrderData['negativeValue'] = "false";
                    $invOrderData['packageDisplay'] = $invOrderRow['item_name'];
                }else if($invOrderRow['type'] == "promo_code"){
                    $invOrderData['negativeValue'] = "true";
                    $invOrderData['packageDisplay'] = "(Promo) ".$invOrderRow['item_name'];
                } else {
                    $invOrderData['packageDisplay'] = "(".$getBarcode.")" . " ".$invOrderRow['item_name'];
                    $invOrderData['negativeValue'] = "false";
                }
                
                if($invOrderRow['type'] == "redeem_point")$invOrderData['packagePrice'] = number_format($invOrderRow['packagePrice'],3);
                else $invOrderData['packagePrice'] = Setting::setDecimal($invOrderRow['packagePrice']);
                $invOrderData['packageQuantity'] = Setting::setDecimal($invOrderRow['quantity']);

                if($invOrderRow['item_name'] == 'Delivery Charges'){
                    $invOrderData['totalPackagePrice'] = number_format($invOrderRow['packagePrice'], 2);
                }else{
                    $invOrderData['totalPackagePrice'] = Setting::setDecimal($invOrderRow['Total']);
                }

                $string = $invOrderRow['product_attribute_value_id'];  
                $array = json_decode($string);
                $string = implode(",", $array);
                $invOrderRow['product_attribute_value_id'] = $string;

                $name_array = array();
                foreach ($array as $id) {
                    foreach ($product_attribute_value as $value) {
                        if ($value['id'] == $id) {
                        $name_array[] = $value['name']; // Store name in array
                        }
                    }
                }
                $name_string = implode(", ", $name_array);
                $invOrderData['product_attribute_name'] = $name_string;

                $db->where("reference_id", $invOrderRow['product_id']);
                $db->where("type", 'Image');
                $getImage = $db->getValue('product_media' ,'url');

                $invOrderData['image'] = $getImage;

                $invOrder[$index] = $invOrderData;
                $index++; 
            }

            foreach ($deliveryOrderList as $deliveryOrderRow) {
                $db->where("id", $deliveryOrderRow['product_id']);
                $getBarcode = $db->getValue('product' ,'barcode');

                if (strpos($deliveryOrderRow['item_name'], 'Delivery Charges') !== false) {
                    $deliveryOrderData['packageDisplay'] = $deliveryOrderRow['item_name'];
                    $deliveryAmt++;
                } else {
                    $deliveryOrderData['packageDisplay'] = "(".$getBarcode.")" . " ".$deliveryOrderRow['item_name'];
                }
                
                $deliveryOrderData['packagePrice'] = Setting::setDecimal($deliveryOrderRow['packagePrice']);
                $deliveryOrderData['packageQuantity'] = Setting::setDecimal($deliveryOrderRow['quantity']);

                if($deliveryOrderRow['item_name'] == 'Delivery Charges'){
                    $deliveryOrderData['totalPackagePrice'] = number_format($deliveryOrderRow['packagePrice'], 2);
                }else{
                    $deliveryOrderData['totalPackagePrice'] = Setting::setDecimal($deliveryOrderRow['Total']);
                }

                $productQuantity += $deliveryOrderRow['quantity'];

                $string = $deliveryOrderRow['product_attribute_value_id'];  
                $array = json_decode($string);
                $string = implode(",", $array);
                $deliveryOrderRow['product_attribute_value_id'] = $string;

                $name_array = array();
                foreach ($array as $id) {
                    foreach ($product_attribute_value as $value) {
                        if ($value['id'] == $id) {
                        $name_array[] = $value['name']; // Store name in array
                        }
                    }
                }
                $name_string = implode(", ", $name_array);
                $deliveryOrderData['product_attribute_name'] = $name_string;

                $db->where("reference_id", $deliveryOrderRow['product_id']);
                $db->where("type", 'Image');
                $getImage = $db->getValue('product_media' ,'url');

                $deliveryOrderData['image'] = $getImage;
                
                $packageListDelivery[$indexdeliveryOrder] = $deliveryOrderData;
                $indexdeliveryOrder++; 
            }

            foreach ($deliveryOrderListInfo as $item) {
                $delivery_order_no = $item['delivery_order_no'];
                $product_id = $item['product_id'];
                if($product_id == 0 || $product_id == null)
                {
                    $db->where('serial_number', $item['serial_number']);
                    $stockInfo = $db->getOne('stock');
                    $db->where('id', $stockInfo['product_id']);
                    $productInfo = $db->getOne('product');
                    $product_name = $productInfo['name'];
                }
                else
                {
                    $product_name = $item['name'];
                }
                $serial_number = $item['serial_number'];
                $delivery_partner = $item['delivery_partner'];
                $tracking_number = $item['tracking_number'];
                $status = $item['status'];

                $productQuantity = count($deliveryOrderListInfo);
                
                $key = $delivery_order_no . "_" . $product_id . "_" . $serial_number;

                $groups[] = array(
                    'packageDisplay' => $product_name,
                    'packageQuantity' => '1',
                    'product_id' => $product_id,
                    'serial_number' => $serial_number,
                    'product_attribute_name' => '',
                );
            }

            $productQuantity = $productQuantity - $deliveryAmt;

            $issueDOFlag = 0;
            if($leftStockQuantity > 0){
                $issueDOFlag = 1;
            }

            $db->where("type","SST");
            $db->orderBy("created_at","DESC");
            $taxPercentage = $db->getValue("inv_tax_charges","rate");
            if(!$taxPercentage) $taxPercentage = 0;

            // assign data into data
            // if($invoiceDetail['deliveryMethod'] == "pickup"){
            //     $data['deliveryAddressDetail']['pickUpAddress'] = $companyAddress;
            // }else{
                // $data['deliveryAddressDetail'] = $deliveryAddressData;
            // }

            $db->where("inv_order_id",$invoiceDetails["id"]);
            $voucherDataAry = $db->getOne("inv_order_voucher","inv_voucher_id,type,discount_type,discount_percentage,discount_amount,real_discount_amount");

            // if($voucherDataAry){
            //     unset($voucherData);
            //     $db->where("id",$voucherDataAry["inv_voucher_id"]);
            //     $voucherData["voucherCode"] = $db->getValue("inv_voucher","code");
            //     $voucherData["voucherType"] = $voucherDataAry["type"];
            //     $voucherData["discountType"] = $voucherDataAry["discount_type"];
            //     switch($voucherDataAry["discount_type"]){
            //         case "percentage":
            //             $voucherData["discountPercentage"] = Setting::setDecimal($voucherDataAry["discount_percentage"]);
            //             $voucherData["maxDiscountAmount"] = Setting::setDecimal($voucherDataAry["discount_amount"]);
            //             break;

            //         case "amount":
            //             $voucherData["discountAmount"] = Setting::setDecimal($voucherDataAry["discount_amount"]);
            //             break;
            //     }
            //     $voucherData["realDiscountAmount"] = Setting::setDecimal($voucherDataAry["real_discount_amount"]);
            // }

            // $data['deliveryAddressDetail'] = $deliveryAddressData;
            // check current SO status to generate order type "quotation" or "invoice" or "delivery order"
            $db->where('id', $SaleID);
            $saleOrderDetail = $db->getOne('sale_order');
            $saleOrderStatus = $saleOrderDetail['status'];

            if(!empty($saleOrderStatus))
            {
                if($saleOrderStatus == 'Pending')
                {
                    $data['type'][0] = 'quotation';
                }
                else if ($saleOrderStatus == 'Pending Payment Approve')
                {
                    $data['type'][0] = 'quotation';
                }
                else if ($saleOrderStatus == 'Paid')
                {
                    $data['type'][0] = 'invoice';
                }
                else if ($saleOrderStatus == 'Packed')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
                else if ($saleOrderStatus == 'Out of Delivery' || $saleOrderStatus == 'Out For Delivery')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
                else if ($saleOrderStatus == 'Delivered')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
            }

            $db->where('id', $SaleID);
            $isGift = $db->getOne('sale_order', 'is_gift');

            if($isGift['is_gift'] == '1')
            {
                $data['giftStatus'] = $isGift['is_gift'];
            }

            // Due date
            $expiredDate = $saleOrderDetail['payment_expired_date'];
            // Source
            $source = $saleOrderDetail['so_no'];

            // foreach ($groups as $group) {
            //     $transformedArray[] = $group;
            // }

            $data['accumulatedRewardPoint'] = $saleOrderDetail['rewarded_point'];
            $data['dueDate'] = $expiredDate;
            $data['source'] = $source;
            // $data['billingAddressDetail'] = $billingAddressData;
            $data['companyAddress'] = $companyAddress;
            $data['companyAddressAct'] = $companyAddressList;
            $data['companyContact'] = $companyContactList;
            $data['taxPercentage'] = $taxPercentage;
            $data['invoiceDetail'] = $invoiceDetail;
            $data['clientDetail'] = $clientDetail;
            $data['packageList'] =  $invOrder;
            $data['subtotal'] =  $mlmInvOrderPv;
            $data['issueDOAllowed'] = $issueDOFlag;
            $data['productQuantity'] =  $productQuantity;
            $data['invoiceDetailDelivery'] =  $packageListDelivery;
            $data['detailDeliveryOrder'] =  $groups;
            $data['deliveryOrderNo'] = $doNo;
            // if($voucherData) $data["voucherData"] = $voucherData;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);

        }

        public function getSaleOrderDetails($params){
            global $config;
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $SaleID = trim($params['SaleID']);

            if(!$SaleID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            if (strpos($SaleID, 'S') !== false) {
                // get sale id
                $db->where('so_no',$SaleID);
                $SaleID = $db->getOne('sale_order', 'id');
                if($SaleID)
                {
                    $SaleID = $SaleID['id'];
                }
            }

            $db->orderBy('so.product_id', 'DESC');      
            $db->where('so.sale_id', $SaleID);
            $db->where('deleted', '0');
            $db->join('sale_order s','s.id = so.sale_id', 'LEFT');
            $saleOrderDetail = $db->get('sale_order_detail so', null, 'so.id, so.product_id, so.item_name, so.item_price, so.quantity, so.subtotal, so.sale_id, s.delivery_method as delivery_method, s.payment_tax as payment_tax, s.status, so.type, s.shipping_fee,so.price_reduce');

            $deliveryFee = 0;
            $paymentTax = 0;
            $orderDetailsList = array();

            foreach($saleOrderDetail as $list)
            {
                $orderDetails['id']         = $list['id'];
                $orderDetails['product_id'] = $list['product_id'];
                $orderDetails['item_name']  = $list['item_name'];
                //$orderDetails['cost']       = (floatval($list['item_price']) > floatval($list["price_reduce"])) && floatval($list["price_reduce"]) != 0 ? floatval($list["price_reduce"]) : floatval($list['item_price']);
                if($list['type'] == 'redeem_point')
                {
                    $orderDetails['cost'] =     (floatval($list['item_price']));
                }
                else
                {
                    $orderDetails['cost']       = number_format(floatval($list['item_price']),2);
                }
                $orderDetails['quantity']   = $list['quantity'];
                $orderDetails['subtotal']   = floatval($list['subtotal']);
                $orderDetails['sale_id']    = $list['sale_id'];
                $orderDetails['type']       = $list['type'];
                // if($list['status'] == 'Pending Payment Approve' || $list['status'] == 'Paid' || $list['status'] == 'Draft')
                // {
                    $db->where('reference_id', $SaleID);
                    $db->where('deleted', '0');
                    $db->where('type', 'receipt');
                    $uploadReceipt = $db->getOne('uploads');
                    $uploadReceiptFileName = $uploadReceipt['file_name'];
                    $uploadReceipt = $uploadReceipt['data'];

                    if(strpos($uploadReceipt, "application/pdf") !== false) {
                    $fileType = "pdf";
                    } else {
                    $fileType = "image";
                    }
                // }

               
                $deliveryFee = $list['shipping_fee'];
                       
                $paymentTax = $list['payment_tax'];


                $orderDetailsList[] = $orderDetails;

            }
            $db->where('id', $SaleID);
            $checkSOStatus = $db->getOne('sale_order');
            if(strtolower($checkSOStatus['status']) == 'delivered' || strtolower($checkSOStatus['status']) == 'packed' || strtolower($checkSOStatus['status']) == 'out for delivery')
            {
                $db->where('so_id', $SaleID);
                $stockSerialList = $db->get('stock');
                foreach($stockSerialList as $serialDetail)
                {
                    $db->where('serial_number', $serialDetail['serial_number']);
                    $doDetail = $db->getOne('inv_delivery_order_detail');
                    if($doDetail)
                    {
                        $serialListDetail['deliveryOrder'] = '1';
                    }
                    else
                    {
                        $serialListDetail['deliveryOrder'] = '0';
                    }
                    $serialListDetail['product_id'] = $serialDetail['product_id'];
                    $serialListDetail['serial_number'] = $serialDetail['serial_number'];
                    
                    $serialDetailList[] = $serialListDetail;
                }
                $data['serial_number_list'] = $serialDetailList;
            }
            else
            {
                $data['serial_number_list'] = '';
            }
            if($checkSOStatus['remark']){
                $db->where('reference_id', $SaleID);
                $db->where('deleted', '0');
                $db->where('type', 'creditNote');
                $creditNoteReceipt = $db->getOne('uploads');
                $creditNoteFileName = $uploadReceipt['file_name'];
                $creditNoteReceipt = $uploadReceipt['data'];

                if(strpos($creditNoteReceipt, "application/pdf") !== false) {
                    $creditNoteFileType = "pdf";
                } else {
                    $creditNoteFileType = "image";
                }
            }


            // get sale order status
            $db->where('id', $SaleID);
            $soStatus = $db->getOne('sale_order');

            if($soStatus['client_id']){
                $db->where('id', $soStatus['client_id']);
                $clientDetail = $db->getOne('client', 'id,username,name');

                $db->where("client_id", $soStatus['client_id']);
                $db->where("disabled", 0);
                $getShippingAddress = $db->get("address",null, "id,name,email,phone,address,district_id,sub_district_id,post_code,city,state_id,country_id,address_type,remarks");
            }

            if($getShippingAddress){
                foreach($getShippingAddress as $key => $value){
                    $db->where('status',"Active");
                    $country = $db->getValue("country", "name");
    
                    $billingAddressList[$key]['id'] = $value['id'];
                    $billingAddressList[$key]['email'] = $value['email'];
                    $billingAddressList[$key]['phone'] = "60" . $value['phone'];
                    $billingAddressList[$key]['address'] = Cash::concateAddress($value['id'], 'address');
                    $billingAddressList[$key]['post_code'] = $value['post_code'];
                }
            }

            if(!$deliveryFee){
                $db->where('id', $SaleID);
                $getDeliveryFee = $db->getValue("sale_order", "delivery_method");

                if($getDeliveryFee == 'delivery'){
                    $db->where('name', 'deliveryFee');
                    $deliveryFee = $db->getValue('system_settings', 'value');
                }
            }


            if($billingAddressList){
                $billingAddr = Cash::concateAddress($SaleID, 'sale_order_billing');
                if($billingAddr){
                    $completedBillAddr = $billingAddr .' '. $country;
                }
                
                $shippingAddr = Cash::concateAddress($SaleID, 'sale_order_shipping');
                if($shippingAddr){
                    $completedShipAddr = $shippingAddr .' '. $country;
                }

                foreach($billingAddressList as $key => $value){
                    $changeFormatList = str_replace("\n", " ", $value['address']);
                    $changeFormatBill = str_replace("\n", " ", $completedBillAddr);
                    $changeFormatShip = str_replace("\n", " ", $completedShipAddr);

                    if($changeFormatList == $changeFormatBill){
                        $data['billingID']    = $value['id'];
                    }
                     if($changeFormatList == $changeFormatShip){
                        $data['shippingID']    = $value['id'];
                    }
                }
            }

            $db->where('status', 'active');
            $paymentArray = $db->get('gotasty_payment_method');

            $db->where('deleted', '0');
            $db->where('status', 'Active');
            $deliveryMethodList = $db->get("gotasty_delivery_method", null, "");

            foreach($deliveryMethodList as $key => $value){
                $db->where('type', 'shipping_fee');
                $db->where('deleted', '0');
                $db->where('sale_id', $SaleID);
                $deliveryMethod = $db->getOne('sale_order_detail');
                $deliveryList['check'] = 0;
                if($value['name'] == "Self Pickup"){
                    $deliveryList['value'] = 'pickup';
                    if($deliveryMethod['item_name'] == $value['name'])
                    {
                        $deliveryList['check'] = 1;
                    }
                    $deliveryList['name'] = $value['name'];
                    $newDeliveryList[] = $deliveryList;
                }else if($value['name'] == "Delivery Charges"){
                    $value['name'] = "Delivery";
                    $deliveryList['value'] = 'delivery';
                    if($deliveryMethod['item_name'] == $value['name'])
                    {
                        $deliveryList['check'] = 1;
                    }
                    $deliveryList['name'] = $value['name'];
                    $newDeliveryList[] = $deliveryList;
                }
            }
            // return array('status' => "error", 'code' => 110, 'statusMsg' => 'testing' , 'newDeliveryList' => $newDeliveryList);

            if(!$completedBillAddr){
                $completedBillAddr = $soStatus['billing_address'];
            }

            if(!$completedShipAddr){
                $completedShipAddr = $soStatus['shipping_address'];
            }

            $db->where('id', $soStatus['billing_state_id']);
            $billingStateName = $db->getOne('state');

            $billingAddress['address_name'] = $soStatus['billing_name'];
            $billingAddress['address_phone'] = $soStatus['billing_phone'];
            $billingAddress['address_line1'] = $soStatus['billing_address'];
            $billingAddress['address_line2'] = $soStatus['billing_address2'];
            $billingAddress['address_post_code'] = $soStatus['billing_post_code'];
            $billingAddress['address_state'] = $billingStateName['name'];
            $billingAddress['address_city'] = $soStatus['billing_city'];

            $db->where('id', $soStatus['shipping_state_id']);
            $shippingStateName = $db->getOne('state');

            $shippingAddress['address_name'] = $soStatus['shipping_name'];
            $shippingAddress['address_phone'] = $soStatus['shipping_phone'];
            $shippingAddress['address_line1'] = $soStatus['shipping_address'];
            $shippingAddress['address_line2'] = $soStatus['shipping_address2'];
            $shippingAddress['address_post_code'] = $soStatus['shipping_post_code'];
            $shippingAddress['address_state'] = $shippingStateName['name'];
            $shippingAddress['address_city'] = $soStatus['billing_city'];

            if(strtolower($checkSOStatus['status']) == 'out for delivery' || strtolower($checkSOStatus['status']) == 'delivered')
            {
                $db->where('so_id', $SaleID);
                $getTrackingDetail = $db->getOne('so_tracking');

                if($getTrackingDetail)
                {
                    $data['shippingMethod'] = $getTrackingDetail['delivery_partner'];
                    $data['trackingNo'] = $getTrackingDetail['tracking_no'];
                }
                else
                {
                    $data['shippingMethod'] = '';
                    $data['trackingNo'] = '';
                }
            }
            else
            {
                $data['shippingMethod'] = '';
                $data['trackingNo'] = '';
            }


            if(strtolower($checkSOStatus['status']) == 'cancelled'){



            }
            $soNStatus = $soStatus['status'];
            $data['SaleID'] = $SaleID;
            $data["soNo"] = $soStatus["so_no"];
            $data['so_status']    = $soNStatus;
            $data['orderDetails'] = $orderDetailsList;
            $data['shipping_fee'] = floatval($deliveryFee);
            $data['payment_tax']  = floatval($paymentTax);
            $data['receipt']      = $uploadReceipt;
            $data['receiptName']  = $uploadReceiptFileName;
	        $data['file_type'] 	  = $fileType;
            $data['billingAddr']  =  $completedBillAddr;
            $data['shippingAddr'] = $completedShipAddr;
            $data['billingEmail'] = $soStatus['billing_email'];
            $data['shippingEmail']= $soStatus['shipping_email'];
            $data['paymentArray'] = $paymentArray;
            $data['deliveryMethodList'] = $newDeliveryList;
            $data['deliveryMethod'] = strtolower(substr($soStatus['delivery_method'], 0, 1)) . substr($soStatus['delivery_method'], 1);;
            $data['remark'] = $soStatus['remark'];
            $data['billingAddress'] = $billingAddress;
            $data['shippingAddress'] = $shippingAddress;
            $data['appliedPromoCode'] = $soStatus['promotion_code'];

            $data['receipt']      = $uploadReceipt;
            $data['receiptName']  = $uploadReceiptFileName;
            $data['file_type']    = $fileType;

            $data['creditNoteReceipt']      = $creditNoteReceipt;
            $data['creditNoteFileName']  = $creditNoteFileName;
            $data['creditNoteFileType']    = $creditNoteFileType;

            $db->where('so_id', $SaleID);
            $trackingNo = $db->getOne('so_tracking');

            if($trackingNo)
            {
                $data['hawbNo'] = $trackingNo['tracking_no'];
            }
            else
            {
                $data['hawbNo'] = '';
            }
            
            if($soStatus['client_id']){
                $data['clientDetail'] = $clientDetail;
                $data['paymentMethod'] = $soStatus['payment_method'];

                if($billingAddressList){
                    $data['clientDetail']['addressList'] = $billingAddressList;
                }
            }

            $db->where('do.so_id', $SaleID);
            $db->where('dod.disabled', '0');
            $db->join('inv_delivery_order_detail dod', 'dod.inv_delivery_order_id = do.id', 'INNER');
            $deliveryOrderList = $db->get('inv_delivery_order do');


            $db->where('so_id', $SaleID);
            $deliveryOrderListInfo = $db->get('inv_delivery_order');

            $transformedArray = array();
            $groups = array(); // deliveryOrderDetails
            $groups2 = array(); // deliveryOrderDetails2
            
            foreach ($deliveryOrderList as $item) {
                $db->where('serial_number', $item['serial_number']);
                $productID = $db->getOne('stock');
                $db->where('id', $productID['product_id']);
                $productName = $db->getOne('product');
                $delivery_order_no = $item['delivery_order_no'];
                $product_id = $item['product_id'];
                $serial_number = $item['serial_number'];
                $product_name = $productName['name'];
                $delivery_partner = $item['delivery_partner'];
                $tracking_number = $item['tracking_number'];
                $status = $item['status'];
            
                $key = $delivery_order_no . "_" . $product_id . "_" . $serial_number;
                
                // Check if the group with the same 'do_no' already exists, if not create a new one
                if (isset($groups[$delivery_order_no])) {
                    $groups[$delivery_order_no]['data'][] = array(
                        'product_id' => $product_id,
                        'product_name' => $product_name,
                        'serial_number' => $serial_number,
                    );
                } else {
                    $groups[$delivery_order_no] = array(
                        'data' => array(
                            array(
                                'product_id' => $product_id,
                                'product_name' => $product_name,
                                'serial_number' => $serial_number,
                            ),
                        ),
                    );
                }
            }

            foreach($deliveryOrderListInfo as $detailInfo)
            {
                if($detailInfo['delivery_partner'] != null){
                    $db->where('name', $detailInfo['delivery_partner']);
                    $db->where('type', 'url');
                    $trackingURL = $db->getValue('provider_setting','value');
                    $doDetails2['viewDoURL'] = $config['memberSite']."viewInvoice?viewType=delivery+order&saleId=".$SaleID."&soNo=".$data["soNo"]."&doNo=".$detailInfo['delivery_order_no']."&admin=1";
                    $doDetails2['trackingURL'] = $trackingURL.$detailInfo['tracking_number'];
                }else{
                    $doDetails2['viewDoURL'] = $config['memberSite']."viewInvoice?viewType=delivery+order&saleId=".$SaleID."&soNo=".$data["soNo"]."&doNo=".$detailInfo['delivery_order_no']."&admin=1";
                    $doDetails2['trackingURL'] = '';
                }
                
                $doDetails2['do_no'] = $detailInfo['delivery_order_no'];
                $doDetails2['delivery_partner'] = $detailInfo['delivery_partner'];
                $doDetails2['tracking_number'] = $detailInfo['tracking_number'];
                $doDetails2['status'] = $detailInfo['status'];
                $doDetails2['created_at'] = $detailInfo['created_at'];
    
                $groups2[] = $doDetails2;
            }
            
            // Convert groups to the desired format
            foreach ($groups as $group) {
                $transformedArray[] = $group;
            }

            foreach ($groups2 as $group2) {
                $transformedArray2[] = $group2;
            }
            
            $data['deliveryOrderDetails'] = $transformedArray;
            $data['deliveryOrderDetails2'] = $transformedArray2;

            $warehouseList = $db->get('warehouse');
            $data['warehouseList'] = $warehouseList;

            return array("code" => 0, "status" => "ok", "statusMsg" => '', 'data' => $data);
        }

        public function getStockOutDetails($params)
        {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $saleID = $params['sale_id'];

            if (strpos($saleID, 'S') !== false) {
                // get sale id
                $db->where('so_no',$saleID);
                $saleID = $db->getOne('sale_order', 'id');
                if($saleID)
                {
                    $saleID = $saleID['id'];
                }
            }
            
            $db->where('id', $saleID);
            $saleOrderInfo = $db->getOne('sale_order');

            $db->where('so.so_no', $saleOrderInfo['so_no']);
            $db->where('so.deleted', '0');
            $db->orderBy("id","DESC");
            $db->join('product p' , 'p.id = so.product_id', 'LEFT');
            $saleOrderItem = $db->get('sale_order_item so', null, 'so.id, so.product_id, p.barcode as barcode,so.serial_number as serial_number, p.name as item_name, so.so_no, so.is_package, so.package_id, so.do_no');

            # get the product id
            $productIds = array();
            foreach ($saleOrderItem as $getStockData) {
                $productId = $getStockData['product_id'];

                if (!in_array($productId, $productIds)) {
                    if($productId != 0)
                    {
                        $productIds[] = $productId; 
                    }
                }
            }

            # get the suggested serial number
            $db->orderBy('id', 'ASC');
            $db->where('status', 'active');
            $db->where('product_id', $productIds, 'IN');
            $suggestedSerialNumber = $db->get('stock', null, 'id, product_id, serial_number');

            foreach ($saleOrderItem as $key => $detail) {
                if($detail['is_package'] == '1')
                {
                    $db->where('id', $detail['package_id']);
                    $productName = $db->getOne('product', 'name');
                    $productInfo['package_name'] = $productName['name'];
                }
                else
                {
                    $productInfo['package_name'] = '-';
                }

                # handle for barcode
                if(trim($detail['do_no']) == '' || $detail == null)
                {
                    # apply suggested serial_number
                    if($detail['product_id'] != 0)
                    {
                        foreach($suggestedSerialNumber as $key2 =>$detailBarcode)
                        {
                            if($detailBarcode['product_id'] == $detail['product_id'])
                            {
                                $suggestedSerial = $detailBarcode['serial_number'];
                                unset($suggestedSerialNumber[$key2]);
                                break;
                            }
                        }
                    }
                    else
                    {
                        $suggestedSerial = '';
                    }
                    if($detail['serial_number'] != '' || $detail['serial_number'] != null)
                    {
                        $barcode = str_replace('N', '', $detail['serial_number']);
                    }
                    else
                    {
                        $barcode = str_replace('N', '', $detail['barcode']);
                    }
                    if($suggestedSerial)
                    {
                        $productInfo['suggestedSerial'] = $suggestedSerial;
                        $productInfo['barcode'] = $barcode;
                    }
                    else
                    {
                        $productInfo['suggestedSerial'] = '';
                        $productInfo['barcode'] = $barcode;
                    }
                }
                else
                {
                    $barcode = str_replace('N', '', $detail['serial_number']);
                    $productInfo['barcode'] = $barcode;
                    $productInfo['suggestedSerial'] = '';
                }
                $productInfo['SKU_code'] = str_replace('N', '', $detail['barcode']);
                $productInfo['id'] = $detail['id'];
                if($detail['product_id'] == 0)
                {
                    $productInfo['item_name'] = 'Mystery Food';
                }
                else
                {
                    $productInfo['item_name'] = $detail['item_name'];
                }
                $productInfo['product_id'] = $detail['product_id'];
                $productInfo['product_type'] = 'product';
                $productInfo['quantity'] = 1;
                $productInfo['deliveryOrder'] = $detail['serial_number'] != "" ? 1 : 0;
                $data[] = $productInfo;
            }

            //$data = $saleOrderItem;
            

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);
        }

        public function issueDO($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $invOrderID = $params["invOrderID"];
            $productAry = $params["productAry"];
            $remark     = $params["remark"];
            $todayDate  = date("Y-m-d H:i:s");
            $subject    = "Pending";

            $userID = $db->userID;
            $site = $db->userType;


            if(!$invOrderID){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
            }else{
                $db->where('id', $invOrderID);
                $invOrder = $db->getOne('inv_order', 'id, client_id, delivery_option, delivery_add_id, courier_company, service_id, total_price,reference_number');

                if(!$invOrder){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
                }
            }

            $db->where('inv_order_id', $invOrderID);
            $invOrderDetail = $db->get('inv_order_detail', null, 'mlm_product_id, inv_product_id, left_stock_quantity, quantity, price');

            $priceDetail += 0;
            $quantityDetail += 0;

            foreach ($invOrderDetail as $detailRow) {
                $invProductAry[$detailRow['mlm_product_id']][$detailRow['inv_product_id']] = Setting::setDecimal($detailRow['left_stock_quantity']);

                $productIDAry[$detailRow['inv_product_id']] = $detailRow['inv_product_id'];

                $priceDetail += $detailRow['price'];
                $quantityDetail += $detailRow['quantity'];
            }

            if($productIDAry){
                $db->where('id', $productIDAry, 'IN');
                $productWeightAry = $db->map('id')->get('inv_product', null, 'id, weight');
            }

            foreach ($invProductAry as $packageID => $productDetail) {

                foreach ($productAry as $key => $paramsProduct) {
                    $key = $key+1;

                    if($paramsProduct['packageID'] == $packageID){

                        foreach ($productDetail as $productID => $detailRow) {

                            if(!$paramsProduct['productID']){
                                $errorFieldArr[] = array(
                                                'id'  => "product".$packageID.'_'.$productID."Error",
                                                'msg' => $translations['E00955'][$language] /* Invalid Product */
                                            );
                            }

                            if((!$paramsProduct['quantity'] || $paramsProduct['quantity'] <= 0 || !is_numeric($paramsProduct['quantity']) ) && ($paramsProduct['productID'] == $productID)) {
                                $errorFieldArr[] = array(
                                            'id'  => "quantity".$packageID.'_'.$productID."Error",
                                            'msg' => $translations['E00941'][$language] /* Quantity must be greater than 0 */
                                        );
                            }

                            if(($detailRow < $paramsProduct['quantity']) && ($paramsProduct['productID'] == $productID)){
                                $errorFieldArr[] = array(
                                            'id'  => "quantity".$packageID.'_'.$productID."Error",
                                            'msg' => $translations['E01120'][$language]
                                        );
                            }
                        }

                        $productWeight += $productWeightAry[$paramsProduct['productID']] * $paramsProduct['quantity'];

                    }
                }
            }

            foreach ($productAry as $productRow) {
                $product[$productRow['productID']] += $productRow['quantity'];

                $productRes[$productRow['packageID']][$productRow['productID']] = $productRow['quantity'];
            }

            $db->where('inv_product_id', array_keys($product), 'IN');
            $invStockRes = $db->get('inv_stock', null, '*');

            foreach ($invStockRes as $invStockRow) {
                $invStock[$invStockRow['inv_product_id']] += Setting::setDecimal($invStockRow['stock_in'] - $invStockRow['stock_out']);
            }

            unset($productID);
            foreach ($invStock as $invProductID => $stockBalance) {

                foreach ($productRes as $packageID => $productDetail) {

                    foreach ($productDetail as $productID => $quantity) {

                        if($invProductID == $productID && $stockBalance < $quantity){
                            $errorFieldArr[] = array(
                                                'id'  => "quantity".$packageID.'_'.$productID."Error",
                                                'msg' => $translations['E01089'][$language] /* Insufficient stock balance. */
                                            );
                        }
                    }
                }
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            if($invOrder['courier_company'] == "ONDELIVERY" && $invOrder['delivery_option'] == 'delivery'){
                $companyName    = Setting::$configArray["companyName"];
                $companyInfo    = Setting::$systemSetting["Company Contact"];
                $companyInfo    = json_decode($companyInfo, true);
                $companyContact = $companyInfo['contactNo'];

                $db->where('name', 'pickUpOrigins');
                $companyAddress = $db->getValue('system_settings', 'reference');

                $db->where('id', $invOrder['delivery_add_id']);
                $address = $db->getOne('address', '*');

                $db->where('id', $address['country_id']);
                $country = $db->getOne('country', 'name, country_code');

                $db->where('id', $address['state_id']);
                $state = $db->getValue('state', 'name');

                $db->where('id', $address['city_id']);
                $city = $db->getValue('city', 'name');

                $db->where('id', $address['district_id']);
                $district = $db->getValue('county', 'name');

                $db->where('id', $address['sub_district_id']);
                $subDistrict = $db->getValue('sub_county', 'name');

                $db->where('id', $address['post_code_id']);
                $zipCode = $db->getOne('zip_code', 'name, destination_id');

                $receiverAddress = $address['address'].','.$subDistrict.','.$district.','.$city.','.$state.','.$zipCode['name'].','.$country['name'];

                $productWeight = number_format($productWeight);

                $waybillParams = array(
                    'destID' => $zipCode['destination_id'],
                    'serviceID' => $invOrder['service_id'],
                    'senderName' => $companyName,
                    'senderPhone' => $country['country_code'].$companyContact,
                    'senderAddress' => $companyAddress,
                    'receiverName' => $address['name'],
                    'receiverPhone' => $country['country_code'].$address['phone'],
                    'receiverAddress' => $receiverAddress,
                    'goodsID' => 28,
                    'goodsWeight' => ($productWeight < 1) ? 1 : $productWeight,
                );

                $trackingNoRes = self::thirdPartyCreateWaybill($waybillParams);
                if($trackingNoRes['status'] != 'ok'){
                    return $trackingNoRes;
                }
                $trackingNo = $trackingNoRes['data']['trackingNo'];

            }elseif($invOrder['courier_company'] == 'JNE' && $invOrder['delivery_option'] == 'delivery'){
                $companyName    = Setting::$configArray["companyName"];
                $companyInfo    = Setting::$systemSetting["Company Contact"];
                $companyInfo    = json_decode($companyInfo, true);
                $companyContact = $companyInfo['contactNo'];

                $db->where('name', 'pickUpOrigins');
                $companyAddress = $db->getValue('system_settings', 'reference');

                $db->where('id', $invOrder['delivery_add_id']);
                $address = $db->getOne('address', '*');

                $db->where('id', $address['country_id']);
                $country = $db->getOne('country', 'name, country_code');

                $db->where('id', $address['state_id']);
                $state = $db->getValue('state', 'name');

                $db->where('id', $address['city_id']);
                $city = $db->getValue('city', 'name');

                $db->where('id', $address['district_id']);
                $district = $db->getValue('county', 'name');

                $db->where('id', $address['sub_district_id']);
                $subDistrict = $db->getValue('sub_county', 'name');

                $db->where('id', $address['post_code_id']);
                $zipCode = $db->getOne('zip_code', 'name, destination_id');

                $productWeight = number_format($productWeight);

                $waybillParams = array(
                    'invID' => $invOrder['reference_number'],
                    'totalAmount' => $invOrder['total_price'],
                    'quantity' => $quantityDetail,
                    'price' => $priceDetail,
                    'senderName' => $companyName,
                    'senderPhone' => $country['country_code'].$companyContact,
                    'senderAddress' => $companyAddress,
                    'receiverName' => $address['name'],
                    'receiverPhone' => $country['country_code'].$address['phone'],
                    'receiverAddress' => $address['address'],
                    'receiverSubDistrict' => $subDistrict,
                    'receiverDistrict' => $district,
                    'city' => $city,
                    'countryCode' => $zipCode['name'],
                    'countryName' => $country['name'],
                    'state' => $state,
                    'goodsID' => 28,
                    'goodsWeight' => ($productWeight < 1) ? 1 : $productWeight,

                );

                $trackingNoRes = self::thirdPartyCreateJneWaybill($waybillParams);
                if($trackingNoRes['status'] != 'ok'){
                    return $trackingNoRes;
                }
                $trackingNo = $trackingNoRes['data']['trackingNo'];
            }

            $db->startTransaction();

            try{
                $getDONumberFormat = DATE('y').'/DO/FIZ/'.DATE('m').'/';

                $db->where('reference_number', $getDONumberFormat.'%', 'LIKE');
                $maxID = $db->getValue('inv_delivery_order', 'MAX(id)');

                $db->where('id', $maxID);
                $getLatestNumber = $db->getValue('inv_delivery_order', "reference_number");
                if($getLatestNumber){
                    $getDONumber = explode("/", $getLatestNumber);
                    $doNumber = $getDONumberFormat.str_pad(end($getDONumber)+1, 4, '0', STR_PAD_LEFT);
                }else{
                    $doNumber = $getDONumberFormat.'0001';
                }
                // $doNumber = General::generateDynamicCode('DO', 8, 'inv_delivery_order', 'reference_number', true);
                $batchID = $db->getNewID();

                $insertDeliveryOrder = array(
                    'inv_order_id'      =>  $invOrderID,
                    'reference_number'  =>  $doNumber,
                    'tracking_number'   =>  $trackingNo ? : '',
                    'status'            =>  $subject,
                    'batch_id'          =>  $batchID,
                    'remark'            =>  $remark,
                    'created_at'        =>  $todayDate,
                    'creator_id'        =>  $userID
                );
                $invDeliveryOrderID = $db->insert('inv_delivery_order', $insertDeliveryOrder);

                $result = self::insertInvStockTransaction($productRes, $invOrder['client_id'], 'Issue DO', '', $batchID, '', $invOrder['delivery_option']);

                if(!$result){
                    $db->rollback();
                    $db->commit();
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01116"][$language], 'data' => $data);
                }

                unset($productDetail);
                foreach ($result as $packageID => $packageDetail) {

                    foreach ($packageDetail as $productID => $productDetail) {

                        foreach ($productDetail as $stockID => $quantity) {
                            $insertDeliveryOrderDetail = array(
                                'inv_delivery_order_id' => $invDeliveryOrderID,
                                'mlm_product_id'        => $packageID,
                                'inv_product_id'        => $productID,
                                'inv_stock_id'          => $stockID,
                                'quantity'              => $quantity,
                            );
                            $db->insert('inv_delivery_order_detail', $insertDeliveryOrderDetail);

                            $updateBalance = array(
                                'left_stock_quantity' => $db->dec($quantity)
                            );
                            $db->where('inv_order_id', $invOrderID);
                            $db->where('mlm_product_id', $packageID);
                            $db->where('inv_product_id', $productID);
                            $db->update('inv_order_detail', $updateBalance);
                        }
                    }
                }

                unset($invStockRes);
                unset($invStock);

                $db->where('inv_product_id', array_keys($product), 'IN');
                $invStockRes = $db->get('inv_stock', null, 'inv_product_id, stock_in, stock_out');

                $getQuantity = General::getSystemSettingAdmin('lowStockQuantity');
                $getLowQuantity = $getQuantity['lowStockQuantity']['value'];

                foreach ($invStockRes as $invStockRow) {
                    $invStock[$invStockRow['inv_product_id']] += Setting::setDecimal($invStockRow['stock_in'] - $invStockRow['stock_out']);
                }

                foreach($invStock as $idKey => $rowStock){
                    $db->where('id', $idKey);
                    $checkAlertDate = $db->getValue('inv_product', 'alert_at');
                    if($checkAlertDate < 0){
                        if($rowStock < $getLowQuantity && $rowStock > 0){
                            $insertInvProduct = array(
                                "alert_at" => $todayDate,
                            );
                            $db->where('id', $idKey);
                            $db->update('inv_product', $insertInvProduct);
                        }
                    }else{
                        if ($rowStock <= 0){
                            $insertInvProduct = array(
                                "alert_at" => $todayDate,
                            );
                            $db->where('id', $idKey);
                            $db->update('inv_product', $insertInvProduct);
                        }
                    }
                }

            }catch(Exception $e){
                $db->rollback();
                $db->commit();
                return array("status" => "error", "code" => 2, "statusMsg" => "System Error", "data" => "");
            }

            $db->commit();

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00370"][$language], 'data' => "");
        }

        public function cancelDO($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $deliveryOrderID = $params["deliveryOrderID"];
            $remark         = $params["remark"];
            $todayDate      = date("Y-m-d H:i:s");

            $userID = $db->userID;
            $site = $db->userType;

            if(!$deliveryOrderID){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
            }else{
                $db->where('id', $deliveryOrderID);
                $deliveryOrder = $db->getOne('inv_delivery_order', 'inv_order_id, tracking_number, status, batch_id');

                if(!$deliveryOrder){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
                }
            }

            $db->where('id', $deliveryOrder['inv_order_id']);
            $invOrder = $db->getOne('inv_order', 'client_id, delivery_option, courier_company');

            if($invOrder['courier_company'] == "ONDELIVERY" && in_array($deliveryOrder['status'], array('Pending'))){
                $waybillParams = array(
                    'trackingNo' => $deliveryOrder['tracking_number'],
                    'notes' => $remark,
                );

                $cancelDO = self::thirdPartyCancelWaybill($waybillParams);

                if($cancelDO != "success"){
                    $data["errorMsg"] = $cancelDO;
                    return array("status" => "error", "code" => 2, "statusMsg" => "Failed to cancel this DO", "data" => $data);
                }

                $db->where('inv_delivery_order_id', $deliveryOrderID);
                $deliveryDetailRes = $db->get('inv_delivery_order_detail', null, 'mlm_product_id, inv_product_id, inv_stock_id, quantity');

                foreach ($deliveryDetailRes as $deliveryDetailRow) {
                    $productRes[$deliveryDetailRow['mlm_product_id']][$deliveryDetailRow['inv_product_id']][$deliveryDetailRow["inv_stock_id"]] = $deliveryDetailRow['quantity'];
                }

                $batchID = $deliveryOrder['batch_id'];

                $updateDeliveryOrder = array(
                    'status' => 'Cancel',
                    'updated_at' => $todayDate,
                    'updater_id' => $userID,
                );
                $db->where('id', $deliveryOrderID);
                $invDeliveryOrderID = $db->update('inv_delivery_order', $updateDeliveryOrder);

                $result = self::insertInvStockTransaction($productRes, $invOrder['client_id'], 'Cancel DO', '', $batchID, $remark, 'cancelDelivery');

                if(!$result){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01116"][$language], 'data' => $data);
                }

                unset($productDetail);
                foreach ($result as $packageID => $packageDetail) {

                    foreach ($packageDetail as $productID => $productDetail) {

                        foreach ($productDetail as $stockID => $quantity) {
                            $updateBalance = array(
                                'left_stock_quantity' => $db->inc($quantity)
                            );
                            $db->where('inv_order_id', $deliveryOrder['inv_order_id']);
                            $db->where('mlm_product_id', $packageID);
                            $db->where('inv_product_id', $productID);
                            $db->update('inv_order_detail', $updateBalance);
                        }
                    }
                }

                return array('status' => "ok", 'code' => 0, 'statusMsg' => 'DO successfully cancel.', 'data' => "");

            }else{

                return array('status' => "error", 'code' => 2, 'statusMsg' => "This DO not allow to cancel", 'data' => "");
            }
        }

        public function updateDeliveryOrder($params) {
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');

            $userID = $db->userID;
            $site = $db->userType;

            $deliveryOrderID = trim($params['deliveryOrderID']);
            $trackingNo = trim($params['trackingNo']);

            if(!$deliveryOrderID){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
            }else{
                $db->where('id', $deliveryOrderID);
                $deliveryOrder = $db->getOne('inv_delivery_order', 'id, inv_order_id, tracking_number');

                if(!$deliveryOrder){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data' => "");
                }
            }

            $db->where('id', $deliveryOrder['inv_order_id']);
            $invOrder = $db->getOne('inv_order', 'courier_company, delivery_option');
            $courierCompany = $invOrder['courier_company'];
            $deliveryOption = $invOrder['delivery_option'];

            if($courierCompany == "ONDELIVERY"){
                $errorFieldArr[] = array(
                                            'id'  => "trackingNoError",
                                            'msg' => 'This order cannot be update'
                                        );
            }

            $currentTrackingNo = $deliveryOrder['tracking_number'];

            if(!$trackingNo){
                $errorFieldArr[] = array(
                                            'id'  => "trackingNoError",
                                            'msg' => $translations['E00953'][$language] /* Please fill in tracking number */
                                        );
            }elseif($currentTrackingNo){
                if(!$trackingNo){
                    $errorFieldArr[] = array(
                                            'id'  => "trackingNoError",
                                            'msg' => $translations['E00953'][$language] /* Please fill in tracking number */
                                        );
                }
            }else{
                $db->where('tracking_number', $trackingNo);
                $duplicatedTrackNo = $db->has('inv_delivery_order');

                if($duplicatedTrackNo){
                    $errorFieldArr[] = array(
                                                'id'  => "trackingNoError",
                                                'msg' => $translations['E01118'][$language]
                                            );
                }
            }

            if ($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            $updateData = array(
                "tracking_number"   =>  $trackingNo,
            );
            $db->where('id', $deliveryOrder['id']);
            $db->update('inv_delivery_order', $updateData);

            if(in_array($userID,$checkAdminRoleRes)){
                $invLog = array(
                        "module"                    =>  "inv_delivery_order",
                        "module_id"                 =>  $deliveryOrder['id'],
                        "title_transaction_code"    =>  "T00064",
                        "title"                     =>  "Update Delivery Order",
                        "transaction_code"          =>  "L00087",
                        "data"                      =>  json_encode(array("admin"=>$checkAdmin)),
                        "creator_type"              =>  $site,
                        "creator_id"                =>  $userID,
                        "created_at"                =>  $dateTime,
                );
                $db->insert("inv_log", $invLog);
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations['B00373'][$language] /* Update Successful. */, 'data' => "");
        }

        public function getDeliveryOrderListing($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $searchData     = $params['searchData'];
            $seeAll         = $params['seeAll'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit          = General::getLimit($pageNumber);
            $decimalPlaces  = Setting::getSystemDecimalPlaces();

            if($seeAll == 1){
                $limit = null;
            }

            //filter
            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName) {

                        case 'date':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if(intval($dateFrom) > intval($dateTo))
                            {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                            }

                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                $db->where('Date(created_at)', date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                // if($dateTo < $dateFrom){
                                //     $db->resetState();
                                //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                // }

                                $db->where('Date(created_at)', date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            break;
                        case 'invoiceNo':
                            $invoiceNoAry = $db->subQuery();
                            $invoiceNoAry->where("reference_number", $dataValue);
                            $invoiceNoAry->get("inv_order", null, "id");
                            $db->where("inv_order_id", $invoiceNoAry, "IN");

                            break;
                        case 'purchaseOrderNo':
                            $purchaseOrderAry = $db->subQuery();
                            $purchaseOrderAry->where("po_number", $dataValue);
                            $purchaseOrderAry->get("inv_order", null, "id");
                            $db->where("inv_order_id", $purchaseOrderAry, "IN");

                            break;
                        case 'memberID':
                            $sq1 = $db->subQuery();
                            $sq1->where('member_id', $dataValue);
                            $sq1->getOne('client', "id");

                            $sq2 = $db->subQuery();
                            $sq2->where('client_id', $sq1);
                            $sq2->get('inv_order', null, "id");
                            $db->where("inv_order_id", $sq2, "IN");

                            break;
                        case 'fullname':
                            if($dataType == "like"){
                                $sq = $db->subQuery();
                                $sq->where("name", "%".$dataValue."%","LIKE");
                                $sq->get("address", null, "client_id");
                            }else{
                                $sq = $db->subQuery();
                                $sq->where("name", $dataValue);
                                $sq->get("address", null, "client_id");
                            }

                            $sq2 = $db->subQuery();
                            $sq2->where("client_id", $sq, "IN");
                            $sq2->get("inv_order", null, "id");
                            $db->where("inv_order_id", $sq2, "IN");

                            break;
                        case 'deliveryOption':
                            $sq1 = $db->subQuery();
                            $sq1->where('delivery_option', $dataValue);
                            $sq1->get('inv_order', null, "id");
                            $db->where("inv_order_id", $sq1, "IN");

                            break;
                        case 'status':
                            $db->where("status", $dataValue);

                            break;

                        case 'deliveryOrderNo':
                            $db->where("reference_number", $dataValue);
                            break;
                    }

                    unset($dataName);
                    unset($dataValue);
                }
            }

            $copyDB = $db->copy();

            $db->orderBy("created_at", "DESC");
            $deliveryOrderList = $db->get("inv_delivery_order", $limit, "id, created_at AS date, inv_order_id, status, creator_id, remark, reference_number");

            if(empty($deliveryOrderList)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            foreach ($deliveryOrderList as $deliveryOrderRow) {
                $invOrderIDAry[$deliveryOrderRow['inv_order_id']] = $deliveryOrderRow['inv_order_id'];
                $creatorIDAry[$deliveryOrderRow['creator_id']] = $deliveryOrderRow['creator_id'];
            }

            if($invOrderIDAry){
                $db->where("id",$invOrderIDAry, "IN");
                $invOrderIDRes = $db->map("id")->get("inv_order", NULL, "id, reference_number AS invoiceNo, po_number AS purchaseOrderNo, (SELECT member_id FROM client WHERE id = client_id) AS memberID, (SELECT name FROM client WHERE id = client_id) AS fullName, client_id, delivery_option, courier_company, courier_service");

                foreach ($invOrderIDRes as $invOrderIDRow) {
                    $memberIDAry[] = $invOrderIDRow['client_id'];
                }

                $db->where("client_id",$memberIDAry, "IN");
                $addressAry = $db->map("client_id")->get("address", NULL,"client_id, name");

                $db->where("inv_order_id",$invOrderIDAry, "IN");
                $paymentIDAry = $db->map("inv_order_id")->get("inv_order_payment", NULL, "inv_order_id, credit_type");
                foreach ($paymentIDAry as $creditRow) {
                    $creditNameAry[$creditRow] = $creditRow;
                }
                if($creditNameAry){
                    $db->where("type",$creditNameAry, "IN");
                    $creditLang = $db->map("type")->get("credit", NULL, "type, translation_code");
                }
            }

            if($creatorIDAry){
                $db->where("id",$creatorIDAry, "IN");
                $creatorRes = $db->map("id")->get("admin", NULL, "id, username");
            }

            foreach ($deliveryOrderList as $deliveryOrderRow) {
                unset($tempDeliveryOrder);
                $courierCompany = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['courier_company'];

                $tempDeliveryOrder["doID"] = $deliveryOrderRow["id"];
                $tempDeliveryOrder["date"] = date($dateTimeFormat, strtotime($deliveryOrderRow["date"]));
                $tempDeliveryOrder["invoiceNo"] = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['invoiceNo'];
                $tempDeliveryOrder["purchaseOrderNo"] = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['purchaseOrderNo'];
                $tempDeliveryOrder['deliveryOrderNo'] = $deliveryOrderRow['reference_number']?:'-';
                $tempDeliveryOrder["memberID"] = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['memberID'];
                $tempDeliveryOrder["fullname"] = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['fullName'];
                $tempDeliveryOrder["paymentMethod"] = $paymentIDAry[$deliveryOrderRow["inv_order_id"]] ? $translations[$creditLang[$paymentIDAry[$deliveryOrderRow["inv_order_id"]]]][$language] : '-';
                $tempDeliveryOrder["deliveryOption"] = General::getTranslationByName($invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['delivery_option']);
                $tempDeliveryOrder["courierService"] = $invOrderIDRes[$deliveryOrderRow["inv_order_id"]]['courier_service'];
                $tempDeliveryOrder["status"] = $deliveryOrderRow["status"];
                $tempDeliveryOrder["statusDisplay"] = General::getTranslationByName($deliveryOrderRow["status"]);
                $tempDeliveryOrder["remark"] = $deliveryOrderRow["remark"]? $deliveryOrderRow["remark"]: "-";
                $tempDeliveryOrder["issuedBy"] = $creatorRes[$deliveryOrderRow["creator_id"]];

                $tempDeliveryOrder["cancelAllowed"] = 0;
                if($courierCompany == "ONDELIVERY" && (in_array($deliveryOrderRow["status"],array("Pending")))){
                    $tempDeliveryOrder["cancelAllowed"] = 1;
                }

                $deliveryOrderListing[] = $tempDeliveryOrder;
            }

            if($params['type'] == "export"){
                $params['command'] = __FUNCTION__;
                $data = Excel::insertExportData($params);
                return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $data['deliveryOrderListing'] =  $deliveryOrderListing;
            $totalRecord = $copyDB->getValue('inv_delivery_order', "count(*)");
            $data["pageNumber"] = $pageNumber;
            $data["totalRecord"] = $totalRecord;
            if($seeAll == "1") {
                $data["totalPage"] = 1;
                $data["numRecord"] = $totalRecord;
            } else {
                $data["totalPage"] = ceil($totalRecord/$limit[1]);
                $data["numRecord"] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved. */, 'data' => $data);
        }

        public function getDeliveryOrderDetail($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $adminRoleList = Setting::$systemSetting['InvEditableRoles'];
            $adminRolesListAry = explode("#", $adminRoleList);

            $userID = $db->userID;
            $site = $db->userType;

            $db->where('role_id',$adminRolesListAry, 'IN');
            $checkAdminRoleRes = $db->getValue('admin', 'id', null);


            $availableToEdit = 0;
            if(in_array($userID,$checkAdminRoleRes)){
                $availableToEdit = 1;
            }

            $deliveryOrderID = trim($params['deliveryOrderID']);

            if(!$deliveryOrderID) {
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            $db->where("id", $deliveryOrderID);
            $deliveryOrderDetail = $db->getOne("inv_delivery_order", "inv_order_id, created_at AS deliveryOrderDate, reference_number AS deliveryOrderNo, tracking_number AS trackingNumber ");

            if(!$deliveryOrderDetail){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            // Company address
            $db->where('name', 'pickUpOrigins');
            $companyAddress = $db->getValue('system_settings', 'reference');

            // Company Contact No/ Email/ Fax
            $db->where('type', 'companyContact');
            $res = $db->getValue('system_settings', 'value');
            $companyContactList = json_decode($res, true);

            $db->where("inv_delivery_order_id", $deliveryOrderID);
            $deliveryDetailAry = $db->get("inv_delivery_order_detail", null, "id, inv_delivery_order_id, mlm_product_id, inv_product_id, inv_stock_id, quantity, remark");

            foreach ($deliveryDetailAry as $deliveryDetailRow) {
                $packageIDAry[$deliveryDetailRow['mlm_product_id']] = $deliveryDetailRow['mlm_product_id']; // package
                $productIDAry[$deliveryDetailRow['inv_product_id']] = $deliveryDetailRow['inv_product_id']; // product
                $stockIDAry[$deliveryDetailRow['inv_stock_id']] = $deliveryDetailRow['inv_stock_id']; //stock
            }

            // get invoice date and invoice no,deliveryOrderDate and deliveryOrderNo
            $db->where("id", $deliveryOrderDetail["inv_order_id"]);
            $invoiceDetail = $db->getOne("inv_order", "client_id, reference_number AS invoiceNo, created_at AS createdAt, special_note, remark, delivery_option, billing_add_id, delivery_add_id, courier_company, courier_service");
            $invoiceDetail["createdAt"] = date($dateTimeFormat, strtotime($invoiceDetail["createdAt"]));

            // get memberID
            $db->where("id", $invoiceDetail['client_id']);
            $clientInfo = $db->getOne("client", "member_id, name");


            // get receiverName and phoneNumber, billing address, delivery address
            $addressIDAry = array($invoiceDetail['billing_add_id'],$invoiceDetail['delivery_add_id']);
            if($addressIDAry){
                $db->where("id", $addressIDAry, "IN");
                $db->where("client_id", $invoiceDetail['client_id']);
                $memberDetail= $db->map('id')->get("address", null, "id, name, phone, address, district_id, sub_district_id, post_code, city, state_id, country_id, email, phone, address_type");
            }

            foreach ($memberDetail as $memberDetailRow) {
                $stateAry[$memberDetailRow['state_id']] = $memberDetailRow['state_id'];
                $countryAry[$memberDetailRow['country_id']] = $memberDetailRow['country_id'];
                $countyAry[$memberDetailRow['district_id']] = $memberDetailRow['district_id'];
                $subCountyAry[$memberDetailRow['sub_district_id']] = $memberDetailRow['sub_district_id'];
                $postCodeAry[$memberDetailRow['post_code']] = $memberDetailRow['post_code'];
                $cityAry[$memberDetailRow['city']] = $memberDetailRow['city'];
            }

            if($stateAry){
                $db->where("id", $stateAry, "IN");
                $stateRes = $db->map('id')->get("state", NULL,"id, name");
            }

            if($countryAry){
                $db->where("id", $countryAry, "IN");
                $countryRes = $db->map('id')->get("country", NULL,"id, name, translation_code, country_code");
            }

            if($countyAry){
                $db->where("id", $countyAry, "IN");
                $countyRes = $db->map('id')->get("county", NULL,"id, name, translation_code");
            }

            if($subCountyAry){
                $db->where("id", $subCountyAry, "IN");
                $subCountyRes = $db->map('id')->get("sub_county", NULL,"id, name, translation_code");
            }

            if($postCodeAry){
                $db->where("id", $postCodeAry, "IN");
                $postCodeRes = $db->map('id')->get("zip_code", NULL,"id, name, translation_code");
            }

            if($cityAry){
                $db->where("id", $cityAry, "IN");
                $cityRes = $db->map('id')->get("city", NULL,"id, name, translation_code");
            }

            foreach ($memberDetail as $addressID => $memberDetailRow) {
                unset($addressValue);
                $addressValue["name"] = $memberDetailRow['name'];
                $addressValue["phone"] = $memberDetailRow['phone'];
                $addressValue["email"] = $memberDetailRow['email'];
                $addressValue["address"] = $memberDetailRow['address'];
                $addressValue["districtDisplay"] = $countyRes[$memberDetailRow['district_id']]['name'];
                $addressValue["subDistrictDisplay"] = $subCountyRes[$memberDetailRow['sub_district_id']]['name'];
                $addressValue["postCodeDisplay"] = $postCodeRes[$memberDetailRow['post_code']]['name'];
                $addressValue["cityDisplay"] = $cityRes[$memberDetailRow['city']]['name'];
                $addressValue["stateDisplay"] = $stateRes[$memberDetailRow['state_id']];
                $addressValue["countryDisplay"] = $translations[$countryRes[$memberDetailRow['country_id']]["translation_code"]][$language];
                $addressValue["dialCode"] = $countryRes[$memberDetailRow['country_id']]["country_code"];

                $addressAry[$memberDetailRow['id']] = $addressValue;
            }

            // DO summary
            $db->where("id", $packageIDAry, "IN");
            $mlmPackageRes = $db->map("id")->get("mlm_product", null,"id, name, code"); // map package id

            $db->where("id", $productIDAry, "IN");
            $mlmProductRes = $db->map("id")->get("inv_product", null,"id, name, code"); // map product id

            foreach ($deliveryDetailAry as $deliveryDetailRow) {
                unset($temp);
                $temp['stockCode'] = $mlmProductRes[$deliveryDetailRow['inv_product_id']]['code'];
                $temp['quantity'] = $deliveryDetailRow['quantity'];
                $deliveryOrderList[$deliveryDetailRow['mlm_product_id']][$deliveryDetailRow['inv_product_id']]['packageName'] = $mlmPackageRes[$deliveryDetailRow['mlm_product_id']]['name'];
                $deliveryOrderList[$deliveryDetailRow['mlm_product_id']][$deliveryDetailRow['inv_product_id']]['packageCode'] = $mlmPackageRes[$deliveryDetailRow['mlm_product_id']]['code'];
                $deliveryOrderList[$deliveryDetailRow['mlm_product_id']][$deliveryDetailRow['inv_product_id']]['product'] = $mlmProductRes[$deliveryDetailRow['inv_product_id']]['name'];
                  $deliveryOrderList[$deliveryDetailRow['mlm_product_id']][$deliveryDetailRow['inv_product_id']]['stockList'][$deliveryDetailRow['inv_stock_id']] = $temp;
            }

            if($invoiceDetail['courier_company'] == "ONDELIVERY" && (in_array($deliveryOrderRow["status"],array("Pending")))){
                $cancelAllowed = 1;
            }

            $data['companyAddress'] = $companyAddress;
            $data['companyContact'] = $companyContactList;
            $data['billingAddress'] = $addressAry[$invoiceDetail['billing_add_id']];
            $data['deliveryAddress'] = $addressAry[$invoiceDetail['delivery_add_id']];
            $data['invoiceNo'] = $invoiceDetail['invoiceNo'];
            $data['invoiceDate'] = $invoiceDetail['createdAt'];
            $data["specialNote"] = $invoiceDetail["special_note"];
            $data["remark"] = $invoiceDetail["remark"];
            $data["deliveryOption"] = $invoiceDetail["delivery_option"];
            $data["pickUpAddress"] = $companyAddress;
            $data['deliveryOrderDate'] = date($dateTimeFormat, strtotime($deliveryOrderDetail['deliveryOrderDate']));
            $data['deliveryOrderNo'] = $deliveryOrderDetail['deliveryOrderNo'];
            $data['courierCompany'] = $invoiceDetail['courier_company'];
            $data['courierService'] = $invoiceDetail['courier_service'];
            $data['memberID'] = $clientInfo['member_id'];
            $data['fullname'] = $deliveryAddressAry['name'] ? : $clientInfo['name'];
            $data['dialingArea'] = $deliveryAddressAry['dialCode'];
            $data['phoneNumber'] = $deliveryAddressAry['phone'];
            $data['trackingNumber'] = $deliveryOrderDetail['trackingNumber']? $deliveryOrderDetail['trackingNumber']: "-" ;
            $data['deliveryOrderList'] = $deliveryOrderList;
            $data['availableToEdit'] = $availableToEdit;
            $data['cancelAllowed'] = $cancelAllowed ? : 0;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);
        }

        // -------- PVP Listing (Admin) //PVP Transaction History (Member)-------- //

        public function getPVPListing($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $searchData     = $params['searchData'];
            $seeAll         = $params['seeAll'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit          = General::getLimit($pageNumber);
            $limits          = "LIMIT ".implode(",",General::getLimit($pageNumber))."";
            $decimalPlaces  = Setting::getSystemDecimalPlaces();

            $userID = $db->userID;
            $site = $db->userType;
            $cpDb = $db->copy();

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName) {
                        // case 'mainLeaderID':
                        //     $db ->where('member_id', $dataValue);
                        //     $mainLeaderID = $db ->getValue('client', 'id');
                        //     $mainDownlines = Leader::getLeaderDownlines($mainLeaderID);


                        //     if(empty($mainDownlines)) return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
                        //     $db->where('client_id', $mainDownlines, "IN");
                        //     $invOrderID = $db->getValue("inv_order", "id", null);
                        //     $db->where("inv_order_id", $invOrderID, "IN");

                        //     break;
                        case 'leaderID':
                            $cpDb->where('member_id', $dataValue);
                            $leaderID = $cpDb->getValue('client', "id");

                            // $downlines = Tree::getSponsorTreeDownlines($leaderID,true);
                            $downlines = Tree::getPlacementTreeDownlines($leaderID, true);

                            if (empty($downlines)){
                                $db->resetState();
                                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
                            }
                            $cpDb->where('client_id', $downlines, "IN");
                            $invOrderID = $cpDb->getValue("inv_order", "id", null);
                            $db->where("inv_order_id", $invOrderID, "IN");
                            break;

                        case 'mainLeaderID':
                            $mainLeaderSq = $cpDb->subQuery();
                            $mainLeaderSq->where("client_id = leader_id");
                            $mainLeaderSq->getValue('mlm_leader', 'client_id', null);
                            $cpDb->where('id', $mainLeaderSq, "IN");
                            $cpDb->where('member_id', $dataValue);
                            $mainLeaderID = $cpDb->getValue('client', 'id');

                            if ($mainLeaderID) {
                                $cpDb->where('trace_key', "%".$mainLeaderID."%", "LIKE");
                                $mainDownlines = $cpDb->map('client_id')->get('tree_placement',  null, 'client_id');

                                $cpDb->where('client_id', $mainDownlines, "IN");
                                $cpDb->where('client_id = leader_id');
                                $cpDb->where('client_id', $mainLeaderID, "!=");
                                $mainLeaders = $cpDb->getValue('mlm_leader', 'client_id', null);
                            }

                            if (!empty($mainLeaders)) {
                                $tempDownlines = array();
                                foreach ($mainLeaders as $leader) {
                                    $cpDb->where('trace_key', "%".$leader."%", "LIKE");
                                    $temp = $cpDb->map('client_id')->get('tree_placement', null, 'client_id');
                                    $tempDownlines = array_merge($tempDownlines, $temp);
                                    unset($temp);
                                }
                                $tempDownlines = array_unique($tempDownlines);

                                foreach ($tempDownlines as $downline) {
                                    unset($mainDownlines[$downline]);
                                }
                                unset($tempDownlines);
                            }

                            if (empty($mainDownlines)) {
                                $db->resetState();
                                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
                            }
                            $mainLeaderSq2 = $db->subQuery();
                            $mainLeaderSq2->where('client_id', $mainDownlines, "IN");
                            $mainLeaderSq2->getValue('inv_order', "id", null);
                            $db->where("inv_order_id", $mainLeaderSq2, "IN");
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            if (count($searchData) > 0) {

                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName) {
                        case 'dateRange':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if(strlen($dateFrom) > 0) {
                                $sq = $db->subQuery();
                                $sq->where("DATE(created_at)", date('Y-m-d', $dateFrom), '>=');
                                $sq->get("inv_order",null,"id");
                                $db->where("inv_order_id",$sq,"IN");
                            }
                            if(strlen($dateTo) > 1) {
                                $sq = $db->subQuery();
                                $sq->where("DATE(created_at)", date('Y-m-d', $dateTo), '<=');
                                $sq->get("inv_order",null,"id");
                                $db->where("inv_order_id",$sq,"IN");
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            break;

                        case 'memberID':
                            $sq = $db->subQuery();
                            $sq->where('member_id',$dataValue);
                            $sq->getOne('client','id');
                            $ioid = $db->subQuery();
                            $ioid->where('client_id',$sq);
                            $ioid->get("inv_order", null,"id");
                            $db->where("inv_order_id", $ioid, "IN");
                            break;

                        case 'fullname':
                            if($dataType == "like"){
                                $sq = $db->subQuery();
                                $sq->where('name', "%" .  $dataValue . "%", 'LIKE');
                                $sq->get('client',NULL,'id');
                                $name = $db->subQuery();
                                $name->where('client_id',$sq, "IN");
                                $name->get("inv_order", null,"id");
                                $db->where("inv_order_id", $name, "IN");
                            }else{
                                $sq = $db->subQuery();
                                $sq->where('name',$dataValue);
                                $sq->getOne('client','id');
                                $name = $db->subQuery();
                                $name->where('client_id',$sq);
                                $name->get("inv_order", null,"id");
                                $db->where("inv_order_id", $name, "IN");
                            }
                            break;

                        case 'package':
                            if ($dataType == "like") {
                                $sq = $db->subQuery();
                                $sq->where("content", "%".$dataValue . "%", "LIKE");
                                $sq->where("module","mlm_product");
                                $sq->where("type", "name");
                                $sq->get("inv_language", NULL, "module_id");
                                $db->where("mlm_product_id",$sq,"IN");
                            } else{
                                $sq = $db->subQuery();
                                $sq->where("content", $dataValue);
                                $sq->where("module","mlm_product");
                                $sq->getOne("inv_language", "module_id");
                                $db->where("mlm_product_id",$sq);
                            }

                            break;

                    }
                    unset($dataName);
                    unset($dataValue);
                    unset($dataType);
                }
            }

            if($site == 'Member'){
                $sq = $db->subQuery();
                $sq->where("client_id", $userID);
                $sq->get("inv_order",null,"id");
                $db->where("inv_order_id",$sq,"IN");
            }

            $db->groupBy("inv_order_id");
            $db->groupBy("mlm_product_id");

            $copyDb = $db->copy();

            if($seeAll == "1"){
                $limit = $limits = null;
            }

            $detailRes = $db->getValue('inv_order_detail','id',null);
            $pvpListingRes = $db->rawQuery("SELECT detail.id, detail.inv_order_id, detail.mlm_product_id, detail.inv_product_id, detail.price AS unitPrice, detail.pv_price AS pvPrice, detail.quantity, b.client_id, b.created_at AS date FROM inv_order_detail detail LEFT JOIN inv_order b ON detail.inv_order_id = b.id WHERE detail.id IN ('".implode("', '", $detailRes)."') ORDER BY b.created_at DESC ".$limits."");

            $totalRecord = count($copyDb->get('inv_order_detail', null, "id"));

            if (empty($pvpListingRes))return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["E00714"][$language], 'data' => "");

            foreach($pvpListingRes as $pvpListingRow){
                $memberIDAry[$pvpListingRow['client_id']] = $pvpListingRow['client_id'];
                $mlmProductIDAry[$pvpListingRow['mlm_product_id']] = $pvpListingRow['mlm_product_id']; //mlm product
            }

            if($memberIDAry){
                $db->where('id', $memberIDAry,'IN');
                $memberIDArr = $db->map('id')->get('client',null,'id, member_id, name, sponsor_id, state_id');

                $db->where('client_id', $memberIDAry, "IN");
                $db->where('address_type', 'billing');
                $city = $db->map('client_id')->get('address', null, 'client_id, city');
            }

            if($city){
                $db->where('id', $city, "IN");
                $cityName = $db->map('id')->get('city',  NULL, 'id, name');
            }


            if($mlmProductIDAry){
                $db->where('id',$mlmProductIDAry,'IN');
                $packageNameRes = $db->map('id')->get('mlm_product',null,'id, name');
            }

            $mainLeaderAry = array();

            foreach($pvpListingRes as $pvpListingRow){
                $pvpListRes['date'] = date($dateTimeFormat, strtotime($pvpListingRow['date']));
                $pvpListRes['memberID'] = $memberIDArr[$pvpListingRow['client_id']]['member_id']?:"-";
                $pvpListRes['fullName'] = $memberIDArr[$pvpListingRow['client_id']]['name']?:"-";
                $pvpListRes['package'] = $packageNameRes[$pvpListingRow['mlm_product_id']];
                $pvpListRes['quantity'] = Setting::setDecimal($pvpListingRow['quantity']);
                $pvpListRes['unitPrice'] = Setting::setDecimal($pvpListingRow['unitPrice']);
                $pvpListRes['totalPrice'] = Setting::setDecimal($pvpListingRow["quantity"] * $pvpListingRow["unitPrice"]);
                $pvpListRes['pv'] = Setting::setDecimal($pvpListingRow["quantity"] * $pvpListingRow["pvPrice"]);
                $pvpListRes['city'] = $cityName[$city[$pvpListingRow['client_id']]] ? $cityName[$city[$pvpListingRow['client_id']]] : "-";

                $sponsorID = $memberIDArr[$pvpListingRow['client_id']]['sponsor_id'];
                $db->where('id', $sponsorID);
                $sponsorDetails = $db->getOne('client', 'name, member_id');
                $pvpListRes['sponsorID'] = $sponsorDetails['member_id'];
                $pvpListRes['sponsorName'] = $sponsorDetails['name'];

                $client['clientID'] = $memberIDArr[$pvpListingRow['client_id']]['id'];
                $mainLeaderMemberID = Tree::getMainLeaderUsername($client);

                if (!$mainLeaderAry[$mainLeaderMemberID]){
                    $db->where("member_id", $mainLeaderMemberID);
                    $currentMainLeader = $db->getOne("client", "name, member_id, id");
                    $mainLeaderAry[$currentMainLeader["member_id"]] = $currentMainLeader;
                }

                $mainLeaderAry[$mainLeaderMemberID]['member_id'] ? $pvpListRes['mainLeaderID'] = $mainLeaderAry[$mainLeaderMemberID]['member_id']
                                                                        : $pvpListRes['mainLeaderID'] = "-";

                $mainLeaderAry[$mainLeaderMemberID]['name'] ?  $pvpListRes['mainLeaderName'] = $mainLeaderAry[$mainLeaderMemberID]['name']
                                                                   :  $pvpListRes['mainLeaderName'] = "-";

                $pvpList[] = $pvpListRes;
                unset($pvpListRes);

            }

            $data['list']   = $pvpList;

            if($params['type'] == "export") {
                 $params['command'] = __FUNCTION__;
                 $data = Excel::insertExportData($params);
                 return array('status' => "ok", 'code' => 0, 'statusMsg' =>$translations["E00716"][$language], 'data' => $data);
            }

            $data['pageNumber']  = $pageNumber;
            $data['totalRecord'] = $totalRecord;

            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved. */, 'data' => $data);
        }

        // -------- Low Stock Percentage -------- //
        public function getLowStockQuantity($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateFormat     = Setting::$systemSetting["systemDateFormat"];

            $db->where('name', 'lowStockQuantity');
            $db->orderBy('id', 'DESC');
            $getNewestQuantity = $db->get('system_settings_admin', null, 'value, status, created_at, creator_id');
            $currentQuantity = General::getSystemSettingAdmin('lowStockQuantity');

            if(empty($currentQuantity)) return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);

            foreach($getNewestQuantity as $getAdminID){
                $adminID[$getAdminID['creator_id']] = $getAdminID['creator_id'];
            }

            $db->where('id', $adminID, 'IN');
            $getName = $db->map('id')->get('admin', null, 'id, username');

            foreach($getNewestQuantity as $value){
                $getNewestQuantityList['date'] = date($dateFormat,strtotime($value['created_at']));
                $getNewestQuantityList['quantity'] = $value['value'];
                $getNewestQuantityList['status'] = $value['status'];
                $getNewestQuantityList['createdBy'] = $getName[$value['creator_id']];

                $getAllNewestQuantityList[] = $getNewestQuantityList;
            }
            $data['currentQuantity'] = $currentQuantity['lowStockQuantity']['value']?:0;
            $data['previousQuantity'] = $getAllNewestQuantityList;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function setLowStockQuantity($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $userID = $db->userID;
            $quantity     = $params['quantity'];

            $checkExists    = General::getSystemSettingAdmin('lowStockQuantity');

            if($checkExists){
                $updateData = array(
                    "status" => 'Inactive',
                );
                $db->where('type', 'lowStockQuantity');
                $db->update('system_settings_admin', $updateData);
            }

            $insertData = array(
                "name"      => 'lowStockQuantity',
                "type"      => 'lowStockQuantity',
                "value"     => $quantity,
                "created_at"=> date('Y-m-d H:i:s'),
                "creator_id"=> $userID,
                "status"    => 'Active',
                "active_at" => date('Y-m-d'),
            );
            $db->insert('system_settings_admin', $insertData);

            return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
        }

        // -------- Product Alert Module -------- //
        public function productAlertListing($params, $outOfStock = false){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $dateFormat     = Setting::$systemSetting["systemDateFormat"];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll         = $params['seeAll'];
            $limit          = $seeAll ? null : General::getLimit($pageNumber);

            $checkExists    = General::getSystemSettingAdmin('lowStockQuantity');

            if($checkExists){
                $lowInStock = $checkExists['lowStockQuantity']['value'] ? : 0;
            }

            $db->groupBy('inv_product_id');
            if($outOfStock){
                $db->having('SUM(stock_in)-SUM(stock_out)', 0,'<=');
            }else{
                $db->having('SUM(stock_in)-SUM(stock_out)', $lowInStock,'<');
                $db->having('SUM(stock_in)-SUM(stock_out)', 0,'>');
            }
            $allProductRes = $db->get('inv_stock', $limit, 'inv_product_id, SUM(stock_in) as stock_in, SUM(stock_out) as stock_out');

            if(empty($allProductRes) && !$outOfStock){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
            }

            foreach($allProductRes as $getTotalRecord){
                $ttlRecord[] = $getTotalRecord['inv_product_id'];
            }

            if($outOfStock && count($ttlRecord) < $limit[1]){
                $sq = $db->subQuery();
                $sq->groupBy('inv_product_id');
                $sq->get('inv_stock', null, 'inv_product_id');
                $db->where('id', $sq, 'NOT IN');
                $db->where('status', 'Active');
                $db->orderBy('created_at', 'DESC');
                $getAllProductRes = $db->get('inv_product', $limit[1]-count($ttlRecord), 'id, code, name, alert_at');

                if(empty($getAllProductRes)){
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
                }

                if($getAllProductRes){
                    foreach($getAllProductRes as $getRecordID){
                        $ttlRecord[] = $getRecordID['id'];
                    }
                }
            }

            if($ttlRecord) $db->where('id', $ttlRecord, 'IN');
            $totalRecord = $db->getValue('inv_product', 'COUNT(*)');

            $db->where('status', 'Active');
            $getListRes = $db->map('id')->get('inv_product', null, 'id, code, name, alert_at');

            if(empty($getListRes)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
            }

            foreach($allProductRes as $getDataRow){
                $getDataList['productID'] = $getDataRow['inv_product_id'];
                $getDataList['productCode'] = $getListRes[$getDataRow['inv_product_id']]['code'];
                $getDataList['productName'] = $getListRes[$getDataRow['inv_product_id']]['name'];
                if(!$outOfStock){
                    $getDataList['lowInStockDate'] = $getListRes[$getDataRow['inv_product_id']]['alert_at'] > 0 ? date($dateFormat, strtotime($getListRes[$getDataRow['inv_product_id']]['alert_at'])):'-';
                }else{
                    $getDataList['outOfStockDate'] = $getListRes[$getDataRow['inv_product_id']]['alert_at'] > 0 ? date($dateFormat, strtotime($getListRes[$getDataRow['inv_product_id']]['alert_at'])):'-';
                }

                $allGetDataList[$getDataRow['inv_product_id']] = $getDataList;
            }
            if($outOfStock && $getAllProductRes){
                foreach($getAllProductRes as $getNewDataRow){
                    $getDataList['productID'] = $getNewDataRow['id'];
                    $getDataList['productCode'] = $getNewDataRow['code'];
                    $getDataList['productName'] = $getListRes[$getNewDataRow['id']]['name'];
                    $getDataList['outOfStockDate'] = $getNewDataRow['alert_at'] > 0 ? date($dateFormat, strtotime($getNewDataRow['alert_at'])):'-';

                    $allGetDataList[$getNewDataRow['id']] = $getDataList;
                }
            }

            $data['result'] = $allGetDataList;
            $data['pageNumber']     = $pageNumber;
            $data['totalRecord']    = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage']  = 1;
                $data['numRecord']  = $totalRecord;
            }else{
                $data['totalPage']  = ceil($totalRecord/$limit[1]);
                $data['numRecord']  = $limit[1];
            }


            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        // -------- New Module -------- //

        public function getDiscountVoucherSetting($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateFormat     = Setting::$systemSetting["systemDateFormat"];

            $site = $db->userType;

            $searchData     = $params['searchData'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll         = $params['seeAll'];
            $limit          = $seeAll ? null : General::getLimit($pageNumber);

            if (count($searchData) > 0) {

                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName){
                        case 'date':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                $db->where('created_at', date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                if($dateTo < $dateFrom){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                }

                                $db->where('created_at', date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            break;

                        case 'voucherName':
                            $db->where('name', $dataValue);
                            break;

                        case 'voucherCode':
                            $db->where('code', $dataValue);
                            break;

                        case 'status':
                            $db->where('status', $dataValue);
                            break;

                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $copyDb = $db->copy();
            $db->orderBy('created_at', 'DESC');

            $getVoucher = $db->get('inv_voucher', $limit, 'id, name, code, total_balance, total_used, status, created_at, updated_at, updater_id');

            if(empty($getVoucher)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
            }

            foreach($getVoucher as $getVouchers){
                $updaterID[$getVouchers['updater_id']] = $getVouchers['updater_id'];
            }

            if($updaterID){
                $db->where('id', $updaterID, "IN");
                $updaterName = $db->map('id')->get('admin',  NULL, 'id, username');
            }

            $totalRecord = $copyDb->getValue('inv_voucher', 'count(id)');

            foreach($getVoucher as $getVouchers){

                $getVouc['id']      = $getVouchers['id'];
                $getVouc['name']    = $getVouchers['name'];
                $getVouc['code']    = $getVouchers['code'];
                $getVouc['totalBalance'] = Setting::setDecimal($getVouchers['total_balance']);
                $getVouc['totalUsed']    = Setting::setDecimal($getVouchers['total_used']);
                $getVouc['status']       = General::getTranslationByName($getVouchers['status']);
                $getVouc['updaterName']  = $updaterName[$getVouchers['updater_id']];
                $getVouc['createdAt']    = date($dateFormat, strtotime($getVouchers['created_at']));
                $getVouc['updatedAt']    = $getVouchers['updated_at'] >0 ? date('d-m-y', strtotime($getVouchers['updated_at'])) : '-';

                $getVoucherAry[] = $getVouc;
            }

            $data['voucherList']    = $getVoucherAry;
            $data['pageNumber']     = $pageNumber;
            $data['totalRecord']    = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage']  = 1;
                $data['numRecord']  = $totalRecord;
            }else{
                $data['totalPage']  = ceil($totalRecord/$limit[1]);
                $data['numRecord']  = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getCurrentDiscountVoucherSetting($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;

            $site = $db->userType;

            $id = $params['id'];

            $db->where('status', 'Active');
            $packageRes = $db->get('mlm_product', null, 'id, name, is_starter_kit');

            foreach ($packageRes as $packageRow) {
                $packageIDAry[$packageRow['id']] = $packageRow['id'];
            }

            if($packageIDAry){
                $db->where('module', 'mlm_product');
                $db->where('module_id', $packageIDAry, "IN");
                $db->where('type', 'name');
                $db->where('language', $language);
                $packageLang = $db->map('module_id')->get('inv_language', null, 'module_id, content');
            }

            foreach ($packageRes as $packageRow) {
                $packageType = ($packageRow['is_starter_kit'] == 1) ? 'starter' : 'normal';
                $packageDetail['packageID'] = $packageRow['id'];
                $packageDetail['packageName'] = $packageLang[$packageRow['id']];

                $packageList[$packageType][] = $packageDetail;
            }

            $data['packageLists'] = $packageList;

            if($id){
                $db->where('id', $id);
                $getVoucher = $db->getOne('inv_voucher', 'name, code, total_balance AS balance, status');
                $getVoucher['balance'] = Setting::setDecimal($getVoucher['balance']);

                $db->where('inv_voucher_id', $id);
                $getVoucherDetail = $db->get('inv_voucher_detail', null, 'name, value, type, reference');

                unset($packageArr);
                foreach ($getVoucherDetail as $value) {
                    if($value['name'] == "discountBy"){
                        if($value['type'] == "percentage"){
                            $values['type'] = "percentage";
                            $values["percentage"] = Setting::setDecimal($value['value']);
                            $values["maxAmount"] = Setting::setDecimal($value['reference']);
                        }else if($value['type'] == "amount"){
                            $values['type'] = "amount";
                            $values["amount"] = Setting::setDecimal($value['value']);
                        }
                        $voucherDet = $values;
                    }else if($value['type'] == "validPackage"){
                        $packageArr[$value['value']] = $value['value'];
                        continue;
                    }else if($value["type"] == "tieUpType"){
                        $tieUpType = $value["value"];
                    }
                }

                $data['voucher']['voucherLists'] = $getVoucher;
                $data['voucher']['discountBy'] = $voucherDet;
                $data['voucher']['isTieUpPackage'] = 0;
                if($packageArr){
                    $data['voucher']['packageList'] = $packageArr;
                    $data['voucher']['isTieUpPackage'] = 1;
                    $data["voucher"]["tieUpType"] = $tieUpType;
                }
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function verifyDiscountVoucherSetting($params, $type = "") {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $voucherID      = trim($params['voucherID']);
            $voucherName    = trim($params['voucherName']);
            $voucherCode    = trim($params['voucherCode']);
            $voucherBalance = trim($params['balance']);
            $voucherStatus  = trim($params['voucherStatus']);
            $statusAry      = array('Active', 'Inactive');

            //verify for inv_voucher_detail
            $packageIDAry   = $params['packageIDAry'];
            $discountBy     = trim($params['discountBy']);
            $discountByArr  = array("amount", "percentage");
            $discountPercentage  = trim($params['discountPercentage']);
            $discountMaxAmount   = trim($params['discountMaxAmount']);
            $discountAmount = trim($params['discountAmount']);
            $isTieUpPackage = $params['isTieUpPackage'];
            $tieUpType = trim($params["tieUpType"]);
            $isTieUp = array(0,1);

            if(!$voucherID && $type == "edit") {
                $errorFieldArr[] = array(
                    'id'  => "voucherError",
                    'msg' => $translations['E01130'][$language] /* Please Enter ID. */
                );
            }else if($type =="edit"){

                $db->where('id', $voucherID);
                $idResult = $db->getOne("inv_voucher", 'id');

                if(!$idResult) {
                    $errorFieldArr[] = array(
                        'id'  => 'voucherError',
                        'msg' => $translations["E01136"][$language] /* ID is not exist. */
                    );
                }

            }

            if(!$voucherName) {
                $errorFieldArr[] = array(
                    'id'  => "voucherNameError",
                    'msg' => $translations['E01131'][$language] /* Please Enter Name. */
                );
            }

            // Check Code Field
            if(!$voucherCode && $type == 'add') {
                $errorFieldArr[] = array(
                    'id'  => "voucherCodeError",
                    'msg' => $translations['E01132'][$language] /* Please Enter Code. */
                );
            } else if($type == 'add'){
                // check code avaibility
                $db->where('code', $voucherCode);
                $result = $db->getOne("inv_voucher", 'code');

                if($result) {
                    $errorFieldArr[] = array(
                        'id'  => 'voucherCodeError',
                        'msg' => $translations["E01133"][$language] /* Code Existed. */
                    );
                }
            } else if($type == "edit"){
                if($voucherCode){
                    $errorFieldArr[] = array(
                        "id"  => "voucherCodeError",
                        "msg" => "Code cannot be edited.",
                    );
                }
            }

            // Check balance Field
            if($type == 'edit'){
                /*$db->where('id', $id);
                $getIsUnlimited = $db->getValue("inv_voucher", 'is_unlimited');

                if($getIsUnlimited == "1") {*/
                    if($voucherBalance){
                        $errorFieldArr[] = array(
                            'id'  => 'balanceError',
                            'msg' => $translations["E01135"][$language] /* Balance Cannot Be Edited. */
                        );
                    }
            }else if($type == 'add' && $voucherBalance){
                if(!is_numeric($voucherBalance) || $voucherBalance < 0){
                    $errorFieldArr[] = array(
                        'id'  => "balanceError",
                        'msg' => $translations['E01134'][$language] /* Please Enter Balance. */
                    );
                }
            }

            // Check Status Field
            if(!$voucherStatus || !in_array($voucherStatus, $statusAry)) {
                $errorFieldArr[] = array(
                    'id'  => "statusError",
                    'msg' => $translations['E00671'][$language] /* Please Select Status. */
                );
            }

            // verify for inv_voucher_detail
            if(!in_array($isTieUpPackage, $isTieUp)){
                $errorFieldArr[] = array(
                    'id'  => "tieUpPackageError",
                    'msg' => $translations['E01143'][$language] /* Please Enter 1 or 0 for tie up Package. */
                );
            }

            if($isTieUpPackage == 1){
                if((!$tieUpType) || (!in_array($tieUpType,array("single","normal")))){
                    $errorFieldArr[] = array(
                        "id" => "tieUpTypeError",
                        "msg" => $translations["E00741"][$language],
                    );
                }

                if(!$packageIDAry) {
                    $errorFieldArr[] = array(
                        'id'  => "voucherError",
                        'msg' => $translations['E01137'][$language] /* Please Enter Package ID. */
                    );
                }else{
                    $db->where('status', 'Active');
                    $db->where('id', $packageIDAry, "IN");
                    $getPackageID = $db->map('id')->get('mlm_product', NULL, 'id');

                    foreach($packageIDAry as $packageId){
                        if(!$getPackageID[$packageId]){
                            $errorFieldArr[] = array(
                                'id'  => "package". $packageId. "Error",
                                'msg' => $translations['E01138'][$language] /* Inactive package. */
                            );
                        }
                    }
                }
            }

            if(!$discountBy || !in_array($discountBy, $discountByArr)) {
                $errorFieldArr[] = array(
                    'id'  => "discountByError",
                    'msg' => $translations['E01139'][$language] /* discountBy only can be percentage or amount. */
                );
            }

            if($discountBy == 'percentage'){
                if(!is_numeric($discountPercentage) || $discountPercentage < 0) {
                    $errorFieldArr[] = array(
                        'id'  => "percentageError",
                        'msg' => $translations['E01140'][$language] /* Please Enter correct discount precentage. */
                    );
                }

                if($discountMaxAmount){
                    if(!is_numeric($discountMaxAmount) || $discountMaxAmount < 0) {
                        $errorFieldArr[] = array(
                            'id'  => "maxAmountError",
                            'msg' => $translations['E01141'][$language] /* Please Enter Correct Discount Max Amount. */
                        );
                    }
                }

            }else if($discountBy == 'amount'){
                if(!is_numeric($discountAmount) || $discountAmount < 0) {
                    $errorFieldArr[] = array(
                        'id'  => "amountError",
                        'msg' => $translations['E01142'][$language] /* Please Enter Correct Discount Amount. */
                    );
                }
            }

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "" , 'data'=> "");
        }

        public function addDiscountVoucherSetting($params, $type) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $tableName      = "inv_voucher";
            $tableNames     = "inv_voucher_detail";
            $voucherName    = trim($params['voucherName']);
            $voucherCode    = trim($params['voucherCode']);
            $voucherBalance = trim($params['balance']);
            $voucherStatus  = trim($params['voucherStatus']);

            //insert into inv_voucher_detail
            $packageIDAry   = $params['packageIDAry'];
            $discountBy     = trim($params['discountBy']);
            $discountPercentage  = trim($params['discountPercentage']);
            $discountMaxAmount   = trim($params['discountMaxAmount']);
            $discountAmount = trim($params['discountAmount']);
            $isTieUpPackage = trim($params['isTieUpPackage']);
            $tieUpType = trim($params["tieUpType"]);
            $userID         = $db->userID;
            $site           = $db->userType;

            if($site != 'Admin'){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E00679'][$language] /*Invalid User*/, 'data' => "");
            }else{

                $db->where('id',$userID);
                $adminNames = $db->getValue('admin','username');
                if(!$adminNames){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E00679'][$language] /*Invalid User*/, 'data' => "");
                }
            }

            $verify = self::verifyDiscountVoucherSetting($params, "add");
            if($verify["status"] != "ok") return $verify;

            if($voucherBalance > 0){
                $isUnlimited = 0;
            }else{
                $isUnlimited = 1;
            }

            $insertVoucherData = array(

                "name" => $voucherName,
                "code" => $voucherCode,
                "total_balance" => $voucherBalance,
                "type" => "delivery",
                "status" => $voucherStatus,
                "is_unlimited" => $isUnlimited,
                "created_at" => $dateTime,
            );

            $insertNewVoucher = $db->insert($tableName, $insertVoucherData);

            if (!$insertNewVoucher)
                return array('status' => "error", 'code' => 1, 'statusMsg' => "Failed to add discount voucher" /* Failed to update data. */, 'data'=> "");

            if($discountBy == 'percentage'){
                $insertVoucherDetail = array(

                    "inv_voucher_id" => $insertNewVoucher,
                    "name" => "discountBy",
                    "value" => $discountPercentage,
                    "type" => $discountBy,
                    "reference" => $discountMaxAmount

                );

            }else if($discountBy == 'amount'){
                $insertVoucherDetail = array(
                    "inv_voucher_id" => $insertNewVoucher,
                    "name" => "discountBy",
                    "value" => $discountAmount,
                    "type" => $discountBy,
                );
            }

            $insertNewVoucherDetail = $db->insert($tableNames, $insertVoucherDetail);

            if($isTieUpPackage == 1){
                unset($insertVoucherDetail);
                $insertVoucherDetail = array(
                    "inv_voucher_id" => $insertNewVoucher,
                    "name" => "tieUpType",
                    "value" => $tieUpType,
                    "type" => "tieUpType",
                );
                $insertNewVoucherDetail = $db->insert($tableNames,$insertVoucherDetail);

                foreach($packageIDAry as $packageID){
                    unset($insertVoucherDetail);
                    $insertVoucherDetail = array(
                        "inv_voucher_id" => $insertNewVoucher,
                        "name" => "validPackage",
                        "value" => $packageID,
                        "type" => "validPackage",
                    );

                    $insertNewVoucherDetail = $db->insert($tableNames, $insertVoucherDetail);
                }

                $db->where("id",$packageIDAry,"IN");
                $packageCodeAry = $db->getValue("mlm_product","code",null);
                $packageCodeAry = implode(", ",$packageCodeAry);
            }

            if (!$insertNewVoucherDetail)
                return array('status' => "error", 'code' => 1, 'statusMsg' => "Failed to add voucher detail" /* Failed to update data. */, 'data'=> "");

            // insert activity log
            $titleCode      = 'T00070';
            $activityCode   = 'L00094';
            $title          = 'Add Discount Voucher';
            $activityData   = array(
                "admin"                     => $adminNames,
                "addedVoucherName"          => $voucherName,
                "voucherCode"               => $voucherCode,
                "voucherBalance"            => $voucherBalance ? $voucherBalance: '-',
                "voucherStatus"             => $voucherStatus,
                "packageName"               => $packageCodeAry ? $packageCodeAry : "-",
                "discountVoucherPercentage" => $discountPercentage ? $discountPercentage: '-',
                "discountVoucherType"       => $discountBy,
                "discountMaxAmounts"        => $discountMaxAmount ? $discountMaxAmount: '-',
                "discountAmounts"           => $discountAmount ? $discountAmount: '-'
            );

            $activityRes = Activity::insertActivity($title, $titleCode, $activityCode, $activityData, $userID);
            // Failed to insert activity
            if(!$activityRes)
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data'=> "");

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "Successfully added voucher data" , 'data'=> "");
        }

        public function editDiscountVoucherSetting($params, $type) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");
            $tableName      = "inv_voucher";
            $tableNames     = "inv_voucher_detail";
            $voucherID      = trim($params['voucherID']);
            $voucherName  = trim($params['voucherName']);
            $voucherBalance = trim($params['balance']);
            $voucherStatus  = trim($params['voucherStatus']);

            //insert into inv_voucher_detail
            $packageIDAry   = $params['packageIDAry'];
            $discountBy     = trim($params['discountBy']);
            $discountPercentage  = trim($params['discountPercentage']);
            $discountMaxAmount   = trim($params['discountMaxAmount']);
            $discountAmount = trim($params['discountAmount']);
            $isTieUpPackage = trim($params['isTieUpPackage']);
            $tieUpType = trim($params["tieUpType"]);
            $userID         = $db->userID;
            $site           = $db->userType;

            if($site != 'Admin'){
                return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E00679'][$language] /*Invalid User*/, 'data' => "");
            }else{

                $db->where('id',$userID);
                $adminNames = $db->getValue('admin','username');
                if(!$adminNames){
                    return array('status' => "error", 'code' => 2, 'statusMsg' => $translations['E00679'][$language] /*Invalid User*/, 'data' => "");
                }
            }

            $verify = self::verifyDiscountVoucherSetting($params, "edit");
            if($verify["status"] != "ok") return $verify;

            if($voucherBalance > 0){
                $isUnlimited = 0;
            }else{
                $isUnlimited = 1;
            }

            $db->where("id",$voucherID);
            $getVoucherCode = $db->getOne('inv_voucher', 'code');

            $updatedVoucherData = array(
                "name" => $voucherName,
                "status" => $voucherStatus,
                "updater_id" => $userID,
                "updated_at" => $dateTime,
            );

            $db->where("id",$voucherID);
            if (!$db->update($tableName, $updatedVoucherData))
                return array('status' => "error", 'code' => 1, 'statusMsg' => "Failed to update discount voucher" /* Failed to update data. */, 'data'=> "");

            unset($updatedVoucherDetail);
            if($discountBy == "percentage"){
                $updatedVoucherDetail = array(
                    "value" => $discountPercentage,
                    "type" => $discountBy,
                    "reference" => $discountMaxAmount,
                );
            }else if($discountBy == "amount"){
                $updatedVoucherDetail = array(
                    "value" => $discountAmount,
                    "type" => $discountBy,
                    "reference" => "",
                );
            }

            $db->where("inv_voucher_id", $voucherID);
            $db->where("name","discountBy");
            if (!$db->update($tableNames, $updatedVoucherDetail))
                return array('status' => "error", 'code' => 1, 'statusMsg' => "Failed to update voucher detail" /* Failed to update data. */, 'data'=> "");

            if($isTieUpPackage == 1){
                unset($updateDetail);
                $updateDetail = array(
                    "value" => $tieUpType,
                );
                $db->where("inv_voucher_id",$voucherID);
                $db->where("type","tieUpType");
                $db->update("inv_voucher_detail",$updateDetail);

                $db->where("inv_voucher_id",$voucherID);
                $db->where("type","validPackage");
                $oriPackageList = $db->map("value")->get("inv_voucher_detail",null,"value");

                unset($existingPackageIDAry);
                foreach($oriPackageList as $oriPackageID){
                    if((!in_array($oriPackageID,$packageIDAry))){
                        unset($updateDetail);
                        $updateDetail = array(
                            "type" => "invalidPackage",
                        );
                        $db->where("inv_voucher_id",$voucherID);
                        $db->where("type","validPackage");
                        $db->where("value",$oriPackageID);
                        $db->update("inv_voucher_detail",$updateDetail);
                    }else{
                        $existingPackageIDAry[$oriPackageID] = $oriPackageID;
                    }
                }

                foreach($packageIDAry as $packageID){
                    if(!$existingPackageIDAry[$packageID]){
                        unset($insertVoucherDetail);
                        $insertVoucherDetail = array(
                            "inv_voucher_id" => $voucherID,
                            "name" => "validPackage",
                            "value" => $packageID,
                            "type" => "validPackage",
                        );
                        $db->insert("inv_voucher_detail",$insertVoucherDetail);
                    }
                }

                $db->where("id",$packageIDAry,"IN");
                $packageCodeAry = $db->getValue("mlm_product","code",null);
                $packageCodeAry = implode(", ",$packageCodeAry);
            }else{
                $db->where("inv_voucher_id",$voucherID);
                $db->where("type","validPackage");
                $db->update("inv_voucher_detail",array("type" => "invalidPackage"));
            }

            // insert activity log
            $titleCode      = 'T00069';
            $activityCode   = 'L00093';
            $title          = 'Edit Discount Voucher';
            $activityData   = array(
                "admin"                         => $adminNames,
                "updatedVoucherName"            => $voucherName,
                "voucherCode"                   => $getVoucherCode['code'],
                "updatedVoucherStatus"          => $voucherStatus,
                "updatedPackageCode"            => $packageCodeAry ? $packageCodeAry : "-",
                "updatedDiscountVoucherPercentage" => $discountPercentage ? $discountPercentage: '-',
                "updatedDiscountVoucherType"    => $discountBy,
                "updatedDiscountMaxAmount"      => $discountMaxAmount ? $discountMaxAmount: '-',
                "updatedDiscountAmount"         => $discountAmount ? $discountAmount: '-'
            );

            $activityRes = Activity::insertActivity($title, $titleCode, $activityCode, $activityData, $userID);
            // Failed to insert activity
            if(!$activityRes)
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data'=> "");

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "Successfully update voucher data" , 'data'=> "");
        }

        public function getDiscountVoucherRedemptionListing($params){
            $db = MysqliDb::getInstance();
            $language = General::$currentLanguage;
            $translations = General::$translations;
            $dateFormat     = Setting::$systemSetting["systemDateFormat"];

            $site = $db->userType;

            $searchData     = $params['searchData'];
            $pageNumber     = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll         = $params['seeAll'];
            $limit          = $seeAll ? null : General::getLimit($pageNumber);

            if (count($searchData) > 0) {

                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName){

                        case 'date':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if(strlen($dateFrom) > 0) {
                                $sq = $db->subQuery();
                                $sq->where("DATE(created_at)", date('Y-m-d', $dateFrom), '>=');
                                $sq->get("inv_order",null,"id");
                                $db->where("inv_order_id",$sq,"IN");

                                if($dateFrom < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }
                            }
                            if(strlen($dateTo) > 0) {
                                $sq = $db->subQuery();
                                $sq->where("DATE(created_at)", date('Y-m-d', $dateTo), '<=');
                                $sq->get("inv_order",null,"id");
                                $db->where("inv_order_id",$sq,"IN");

                                if($dateTo < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                if($dateTo < $dateFrom){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>$data);
                                }
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            break;

                        case 'memberID':
                            $sq = $db->subQuery();
                            $sq->where("member_id", $dataValue);
                            $sq->getOne("client", "id");

                            $ssq = $db->subQuery();
                            $ssq->where('client_id',$sq);
                            $ssq->get('inv_order',null,'id');
                            $db->where("inv_order_id", $ssq, "IN");
                            break;

                        case 'fullName':
                            if ($dataType == "like") {
                                $sq = $db->subQuery();
                                $sq->where("name", "%" .  $dataValue . "%", "LIKE");
                                $sq->get("client",NULL, "id");

                                $ssq = $db->subQuery();
                                $ssq->where('client_id',$sq,'IN');
                                $ssq->get('inv_order',null,'id');
                                $db->where("inv_order_id", $ssq, "IN");
                            }else{
                                $sq = $db->subQuery();
                                $sq->where("name", $dataValue);
                                $sq->getOne("client", "id");

                                $ssq = $db->subQuery();
                                $ssq->where('client_id',$sq);
                                $ssq->get('inv_order',null,'id');
                                $db->where("inv_order_id", $ssq, "IN");
                            }
                            break;

                        case 'voucherCode':
                            $sq = $db->subQuery();
                            $sq->where("code", $dataValue);
                            $sq->get("inv_voucher", NULL, "id");
                            $db->where("inv_voucher_id", $sq, "IN");
                            break;

                        case 'invoiceNo':
                            $sq = $db->subQuery();
                            $sq->where("reference_number", $dataValue);
                            $sq->get("inv_order", NULL, "id");
                            $db->where("inv_order_id", $sq, "IN");
                            break;

                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $copyDb = $db->copy();

            $db->orderBy('inv_order_id', 'DESC');
            $getVoucherRedemList = $db->get('inv_order_voucher', $limit, 'inv_voucher_id, inv_order_id');

            if(empty($getVoucherRedemList)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00112"][$language] /* No Results Found. */, 'data' => "");
            }

            foreach($getVoucherRedemList as $getVoucherRedemptionList){
                $voucherID[$getVoucherRedemptionList['inv_voucher_id']] = $getVoucherRedemptionList['inv_voucher_id'];
                $invOrderID[$getVoucherRedemptionList['inv_order_id']]  = $getVoucherRedemptionList['inv_order_id'];
            }

            if($voucherID){
                $db->where('id', $voucherID, "IN");
                $voucherData = $db->map('id')->get('inv_voucher',  NULL, 'id, code');
            }

            if($invOrderID){
                $db->where('id', $invOrderID, "IN");
                $invOrderData = $db->map('id')->get('inv_order',  NULL, 'id, client_id, reference_number, created_at');
            }

            foreach($invOrderData as $invOrderRow){
                $clientData[$invOrderRow['client_id']] = $invOrderRow['client_id'];
            }

            if($clientData){
                $db->where('id', $clientData, "IN");
                $clientDatas = $db->map('id')->get('client',  NULL, 'id, member_id, name');
            }

            $totalRecord = $copyDb->getValue('inv_order_voucher', 'count(id)');

            foreach($getVoucherRedemList as $getVoucherRedemptionList){
                $getVoucherRedempList['date'] = date('d/m/Y H:i:s', strtotime($invOrderData[$getVoucherRedemptionList['inv_order_id']]['created_at']));
                $getVoucherRedempList['memberID'] = $clientDatas[$invOrderData[$getVoucherRedemptionList['inv_order_id']]['client_id']]['member_id'];
                $getVoucherRedempList['fullName'] = $clientDatas[$invOrderData[$getVoucherRedemptionList['inv_order_id']]['client_id']]['name'];
                $getVoucherRedempList['invoiceNo'] = $invOrderData[$getVoucherRedemptionList['inv_order_id']]['reference_number'];
                $getVoucherRedempList['voucherCode'] = $voucherData[$getVoucherRedemptionList['inv_voucher_id']];

                $getVoucherRedemptionAry[] = $getVoucherRedempList;
            }

            $data['voucherRedemptionList']    = $getVoucherRedemptionAry;
            $data['pageNumber']               = $pageNumber;
            $data['totalRecord']              = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage']  = 1;
                $data['numRecord']  = $totalRecord;
            }else{
                $data['totalPage']  = ceil($totalRecord/$limit[1]);
                $data['numRecord']  = $limit[1];
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }



        public function updateStarterpackEmailAttachment($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("YmdHis");


            $name  = trim($params['name']);
            $pdfpath  = trim($params['path']);
            $contenttype  = trim($params['contenttype']);


            if(empty($name)){
                 return array('status' => "error", 'code' => 1, 'statusMsg' => "name is empty");

            }

            if(empty($pdfpath)){
                 return array('status' => "error", 'code' => 2, 'statusMsg' => "Path is empty");

            }
                $db->where("pdfname",$name);
                $checkName =$db->getOne("pdffile");
                if(empty($checkName)){
                return array('status' => "Error", 'code' => 3, 'statusMsg' =>"pdf name not found" ,"data"=>"");

                }
                $updateIsActive = array(
                "isActive"   => "0"
                );
                $db->where("isActive","1");
                $db->update("pdffile",$updateIsActive);
                $inserpdfparams = array(
                    'path'                   => $pdfpath,
                    'isActive'               => 1,
                    );
            $db->where("pdfname",$name);
            $insertpdf = $db->update('pdffile', $inserpdfparams);
             return array('status' => "ok", 'code' => 0, 'statusMsg' =>"" ,"data"=>"");

        }

        public function checkStarterpackEmailAttachment($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            // $dateTime       = date("YmdHis");

            $db->where("isActive","1");
            $data=$db->getOne("pdffile");
            if(empty($data)){
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "Result Not Found" ,"data"=>"");
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "" ,"data"=>$data);

        }

        public function getProductInventoryList($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $pageNumber      = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll          = $params['seeAll'];
            $limit           = General::getLimit($pageNumber);
            $dateTimeFormat  = Setting::$systemSetting['systemDateTimeFormat'];

            if(!$seeAll){
                $limit = General::getLimit($pageNumber);
            }

            $db->where('deleted', '0');
            $db->orderBy('created_at', 'DESC');
            $copyDb = $db->copy();
            $productInv = $db->get("product", $limit, "id, barcode as skuCode, name, product_type, cost, sale_price");

            if(empty($productInv)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            foreach($productInv as $productInvRow){
                $productDetail['id']                = $productInvRow['id'];
                $productDetail['skuCode']           = $productInvRow['skuCode'];
                $productDetail['name']              = $productInvRow['name'];
                $productDetail['productType']       = $productInvRow['product_type'];
                $productDetail['cost']              = $productInvRow['cost'];
                $productDetail['salePrice']         = $productInvRow['sale_price'];
                $productDetail['image']             = '';

                $productInvList[] = $productDetail;
            }

            $totalRecord              = $copyDb->getValue("product p", "count(p.id)");
            $data['productInventory'] = $productInvList;
            $data['pageNumber']       = $pageNumber;
            $data['totalRecord']      = $totalRecord;
            if($seeAll) {
                $data['totalPage']    = 1;
                $data['numRecord']    = $totalRecord;
            } else {
                $data['totalPage']    = ceil($totalRecord/$limit[1]);
                $data['numRecord']    = $limit[1];
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }
        
        public function getProductDetailsBySN($params)
        {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date("Y-m-d H:i:s");

            $browserInfo    = General::getBrowserInfo();
            $browser        = $browserInfo['browser']?$browserInfo['browser']:"Unknown";
            $browserVer     = $browserInfo['browser_version']?$browserInfo['browser_version']:"Unknown";
            $osPlatform     = $browserInfo['os_platform']?$browserInfo['os_platform']:"Unknown";
            $device         = $browserInfo["device"]?$browserInfo["device"]:"Unknown";
            $ipAddress      = $browserInfo["ip"]?$browserInfo["ip"]:"Unknown";
            $userAgent      = $browserInfo["user_agent"]?$browserInfo["user_agent"]:"Unknown";
            $location       = General::ip_info($ipAddress);
            $country        = $location['country'];
            $userID         = $db->userID;

            $serialNumber = $params['serial_number'];
            $page_url     = $params['page_url'];
            $deviceID    = $params['device_id'];

            $db->where('s.serial_number', $serialNumber);
            $db->join('product p', 'p.id = s.product_id', 'LEFT');
            $productInv = $db->get('stock s', null, "p.id, p.barcode as skuCode, p.name, p.product_type, p.description, p.cost, p.sale_price, p.cooking_time, p.cooking_suggestion, p.full_instruction, p.full_instruction2, s.expiration_date");

            if(!$productInv)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01210"][$language] /* Invalid serial number, please try again */ , 'data' => '');
            }

            foreach($productInv as $productInvRow){
                $productDetail['id']                = $productInvRow['id'];
                $productDetail['skuCode']           = $productInvRow['skuCode'];
                $productDetail['name']              = $productInvRow['name'];
                $productDetail['productType']       = $productInvRow['product_type'];
                $productDetail['description']       = $productInvRow['description'];
                $productDetail['cost']              = $productInvRow['cost'];
                $productDetail['salePrice']         = $productInvRow['sale_price'];
                $productDetail['cookingTime']       = $productInvRow['cooking_time'];
                $productDetail['cookingSuggestion'] = $productInvRow['cooking_suggestion'];
                $productDetail['fullInstruction']   = $productInvRow['full_instruction'];
                $productDetail['fullInstruction2']  = $productInvRow['full_instruction2'];
                $productDetail['best_before_date']  = $productInvRow['expiration_date'];
                $productDetail['serial_number']     = $serialNumber;

                $productInvList[] = $productDetail;
            }

            $db->where('deleted', 0);
            $db->where('reference_id', $productDetail['id']);
            $productMedia = $db->get('product_media', null, 'id, type, url');

            if($productMedia) {
                foreach($productMedia as $val) {
                    if($val['type'] == 'video') {
                        if($val['url'] != '') {
                            $link = $val['url'];
                            $pattern = '/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/';
                            preg_match($pattern, $link, $matches);
                            $video_id = $matches[7];

                            $video['url'] = $video_id;
                        }
                        $videoList[] = $video;
                    }

                    if($val['type'] == 'Image') {
                        $media['url']  = $val['url'];
                        $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                        $mediaList[] = $media;
                    }
                }
            } else {
                $mediaList = '';
                $videoList = '';
            }
            $productInvList[0]['media'] = $mediaList;
            $productInvList[0]['video'] = $videoList;

            $db->where('product_id', $productDetail['id']);
            $productVar = $db->get('product_template', null, 'id, product_attribute_value_id');

            if(!empty($productVar)) {
                // get all attribute value id in product template
                $attrIdList = [];
                foreach($productVar as $attr) {
                    foreach($attr as $val) {
                        foreach(json_decode($val, true) as $v) {
                            if(empty($attrIdList)) {
                                $attrIdList[] = $v;
                            } else {
                                if(!in_array($v, $attrIdList)) {
                                    $attrIdList[] = $v;
                                }
                            }
                        }
                    }
                }

                if(!empty($attrIdList)) {
                    // use the id in $attrIdList to find the product attribute and product attribute value
                    $db->where('pav.deleted', 0);
                    $db->where('pav.id', $attrIdList, 'IN');
                    $db->join('product_attribute pa', 'pa.id = pav.product_attribute_id', 'LEFT');
                    $productAttr = $db->get('product_attribute_value pav', null, 'pav.id, pav.name, pav.product_attribute_id as attribute_id, pa.name as attribute_name');

                    foreach($productAttr as $val) {
                        $attr[] = $val['attribute_id'];

                        $attrVal[$val['attribute_id']]['attribute_id'] = $val['attribute_id'];
                        $attrVal[$val['attribute_id']]['attribute_name'] = $val['attribute_name'];

                        $attribute['id'] = $val['id'];
                        $attribute['name'] = $val['name'];

                        $attrVal[$val['attribute_id']][$val['attribute_name']][] = $attribute;
                    }

                    $db->where('product_attribute_id', $attr, 'IN');
                    $attribute = $db->get('product_attribute_value', null, 'id, name, product_attribute_id');
                }
                $data['attribute'] = $attrVal;
                $data['productTemplate'] = $productVar;
            } else {
                $data['attribute'] = '';
                $data['productTemplate'] = '';
            }

            $db->where('d.product_id',$productDetail['id']);
            $db->where('s.status', 'Active');
            $db->join('cooking_suggestion s', 's.id=d.suggestion_id', 'INNER');
            $cookingSuggestDetails = $db->get('cooking_suggestion_details d',null ,'d.id, d.url, d.remark, d.suggestion_id, s.name, s.cooking_time,s.description');

            // generate device id 
            if(empty($deviceID))
            {
                $characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
                $length = 10;
                $deviceID = '';
    
                for ($i = 0; $i < $length; $i++) {
                    $randomIndex = rand(0, strlen($characters) - 1);
                    $deviceID .= $characters[$randomIndex];
                }
            }
            $db->where('id', $userID);
            $clientDetail = $db->getOne('client', 'concat(dial_code, phone) as phone');
            $clientMobile = $clientDetail['phone'];
            // insert goTasty_utm_history
            unset($insertData);
            $insertData = array(
                'mobile_number'=> $clientMobile, 
                'action_type'  => 'Scan Product Barcode',
                'device'       => $device,
                'utm_campaign' => 'Product Detail Page',
                'user_agent'   => $userAgent,
                'device_id'    => $deviceID,
                'ip'           => $ipAddress,
                'country'      => $country,
                'url'          => $page_url,
                'tracking_site'=> 'GoTasty Member Site',
                'created_at'   => $dateTime,
                'serial_number'=> $serialNumber,
            );
            $db->insert('goTasty_utm_history', $insertData);

            // get current view count
            $db->where('serial_number', $serialNumber);
            $stockDetail = $db->getOne('stock');
            $db->where('id', $stockDetail['product_id']);
            $db->where('deleted', '0');
            $productView = $db->getOne('product', 'view_count');

            if (empty($productView['view_count'])) {
                $newViewCount = 1;
            } else {
                $newViewCount = intval($productView['view_count']) + 1;
            }

            unset($updateData);
            $updateData = array(
                'view_count' => $newViewCount,
                'updated_at' => $dateTime,
            );
            $db->where('id', $stockDetail['product_id']);
            $db->where('deleted', '0');
            $db->update('product', $updateData);

            $data['productInventory']   = $productInvList;
            $data['cookingDetail']      = $cookingSuggestDetails;
            $data['deviceID']           = $deviceID;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M00306"][$language] /* Search successful */ , 'data' => $data);
        }


        public function getProductDetails($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $productInvId   = $params['productInvId'];
            $language       = $params['language'];
            $dateTime       = date("Y-m-d H:i:s");
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $userID = $db->userID;
            include('config.php');

            if($language == 'chineseSimplified'){
                $productLang = 'chinese';
            }
            else if($language == 'english'){
                $productLang = 'english';
            }

            if(!$productInvId) {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }


            $db->where('deleted', '0');
            $db->where('id', $productInvId);
            $productInv = $db->get("product", $limit, "id, barcode as skuCode, name, product_type, description, cost, sale_price, cooking_time, cooking_suggestion, full_instruction, full_instruction2, delivery_method");

            $db->where('d.product_id',$productInv[0]['id']);
            $db->where('s.status', 'Active');
            $db->join('cooking_suggestion s', 's.id=d.suggestion_id', 'INNER');
            $cookingSuggestDetails = $db->get('cooking_suggestion_details d',null ,'d.id, d.url, d.remark, d.suggestion_id, s.name, s.cooking_time,s.description');


            if(empty($productInv)){
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $productInv);

            foreach($productInv as $productInvRow){

                $db->where('module', array('product','package'), 'IN');
                $db->where('module_id', $productInvRow['id']);
                $db->where('type', 'name');
                $db->where('language', $productLang);
                $getInvLan = $db->getOne('inv_language',null, 'module,module_id,type,language,content');


                $db->where('module', array('product','package'), 'IN');
                $db->where('module_id', $productInvRow['id']);
                $db->where('type', 'description');
                $db->where('language', $productLang);
                $getInvLanDesc = $db->getOne('inv_language',null, 'module,module_id,type,language,content');

                if($getInvLan['content']){
                    $productDetail['name']              = $getInvLan['content'];
                }else{
                    $productDetail['name']              = $productInvRow['name'];
                }

                if($getInvLanDesc['content']){
                    $productDetail['description']              = $getInvLanDesc['content'];
                }else{
                    $productDetail['description']              = $productInvRow['description'];
                }


                $productDetail['sales_description'] = $translations["M04074"][$language]; /* Free shipping with minimum spend RM280.00 */

                ## check if entitile free shipping, if yes no need show description 

                $db->where("delivery_method_id",$productInvRow['delivery_method']);
                $db->where("product_id",$productInvRow['id']);

                $res = $db->getOne("delivery_method_detail");
                if($res){
                    if($res["quantity"] == 0 && $res["amount"] == 0)$productDetail['sales_description'] = ""; //free delivery, no need description

                    else if($res["quantity"] && $res["delivery_method_id"] == 3){
                        $productDetail['sales_description'] = $translations["M04075"][$language]; /* Free shipping with minimum purchase of 6 quantities */
                    }
                    else $productDetail['sales_description'] = $translations["M04074"][$language]; /* Free shipping with minimum spend RM280.00 */
                }



                $productDetail['id']                = $productInvRow['id'];
                $productDetail['skuCode']           = $productInvRow['skuCode'];
                // $productDetail['name']              = $productInvRow['name'];
                $productDetail['productType']       = $productInvRow['product_type'];
                // $productDetail['description']       = $productInvRow['description'];
                $productDetail['cost']              = $productInvRow['cost'];
                $productDetail['salePrice']         = $productInvRow['sale_price'];
                $productDetail['cookingTime']       = $productInvRow['cooking_time'];
                $productDetail['cookingSuggestion'] = $productInvRow['cooking_suggestion'];
                $productDetail['fullInstruction']   = $productInvRow['full_instruction'];
                $productDetail['fullInstruction2']  = $productInvRow['full_instruction2'];

                $db->where('disabled', '0');
                $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                $db->where('product_id', $productInvRow['id']);
                $pricelist_detail = $db->getOne('pricelist_detail');
                if($pricelist_detail)
                {
                    // get product price
                    $db->where('id', $productInvRow['id']);
                    $productInventoryDetail = $db->getOne('product');

                    if(strtolower($pricelist_detail['discount_type']) == 'percentage')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($pricelist_detail['discount']) / 100));
                    }
                    if(strtolower($pricelist_detail['discount_type']) == 'fixed')
                    {
                        $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($pricelist_detail['discount']);
                    }
                    $productDetail['latestPrice']       = $latestPrice;
                }
                else
                {
                    $productDetail['latestPrice']       = 0;
                }


                if($userID)
                {
                    $db->where('product_id', $productInvRow['id']);
                    $db->where('client_id', $userID);
                    $db->where('deleted', '0');
                    $getFavouriteList = $db->getOne('product_favorite');
                    if($getFavouriteList)
                    {
                        $productDetail['favourite'] = 1;
                        $productDetail['fav_id'] = $getFavouriteList['id'];
                    }
                    else
                    {
                        $productDetail['favourite'] = 0;
                    }
                    $db->where('product_id', $productInvRow['id']);
                    $db->where('client_id', $userID);
                    $db->where('deleted', '0');
                    $getWishList = $db->getOne('product_wishlist');
                    
                    if($getWishList)
                    {
                        $productDetail['wishlist'] = 1;
                        $productDetail['wishlist_id'] = $getWishList['id'];
                    }
                    else
                    {
                        $productDetail['wishlist'] = 0;
                    }
                }
                else
                {
                    $productDetail['wishlist'] = 0;
                    $productDetail['favourite'] = 0;
                }


                $productInvList[] = $productDetail;
            }

            // check product type
            $db->where('deleted', '0');
            $db->where('id', $productInvId);
            $productType = $db->getOne('product', null, 'product_type');
            $productType = $productType['product_type'];

            $db->where('deleted', 0);
            $db->where('reference_id', $productInvId);
            $productMedia = $db->get('product_media', null, 'id, type, url');

            if($productMedia) {
                foreach($productMedia as $val) {
                    if($val['type'] == 'video') {
                        if($val['url'] != '') {
                            $link = $val['url'];
                            // $pattern = '/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/';
                            // preg_match($pattern, $link, $matches);
                            // $video_id = $matches[7];

                            // $video['url'] = $video_id;
                            $video['url'] = $val['url'];
                        }
                        $videoList[] = $video;
                    }

                    if($val['type'] == 'Image' || $val['type'] == 'coverImg' || $val['type'] == 'topImg' || $val['type'] == 'degreeImg') {
                        $media['url']  = $val['url'];
                        $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                        $media['type'] = $val['type'];
                        $mediaList[] = $media;
                    }
                }
                if (strtolower($productType) == 'package')
                {
                    $db->where('deleted', '0');
                    $db->where('package_id', $productInvId);
                    $db->where('type', 'product');
                    $getProductList = $db->get('package_item');
                    $ids = array();
    
                    foreach ($getProductList as $product) {
                        $ids[] = $product['product_id'];
                    }
                    $commaSeparated = implode(',', $ids);
                    $db->where('deleted', '0');
                    if (!empty($commaSeparated)) {
                        $commaSeparatedArray = explode(',', $commaSeparated);
                        $db->where('reference_id', $commaSeparatedArray, 'IN');
                    } 
    
                    $productMedia = $db->get('product_media');
    
                    if($productMedia) {
                        foreach($productMedia as $val) {
                            if($val['type'] == 'video') {
                                if($val['url'] != '') {
                                    // $link = $val['url'];
                                    // $pattern = '/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/';
                                    // preg_match($pattern, $link, $matches);
                                    // $video_id = $matches[7];
        
                                    // $video['url'] = $video_id;
                                    $video['url'] = $val['url'];

                                }
                                $videoList[] = $video;
                            }
        
                            if($val['type'] == 'Image' || $val['type'] == 'coverImg' || $val['type'] == 'topImg' || $val['type'] == 'degreeImg') {
                                $media['url']  = $val['url'];
                                $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                                $media['type'] = $val['type'];
                                $mediaList[] = $media;
                            }
                        }
                    }
                }
            } else {
                // get all the product id from the package
                $db->where('deleted', '0');
                $db->where('package_id', $productInvId);
                $db->where('type', 'product');
                $getProductList = $db->get('package_item');
                $ids = array();

                foreach ($getProductList as $product) {
                    $ids[] = $product['product_id'];
                }
                $commaSeparated = implode(',', $ids);
                $db->where('deleted', '0');
                if (!empty($commaSeparated)) {
                    $commaSeparatedArray = explode(',', $commaSeparated);
                    $db->where('reference_id', $commaSeparatedArray, 'IN');
                } 

                $productMedia = $db->get('product_media');

                if($productMedia) {
                    foreach($productMedia as $val) {
                        if($val['type'] == 'video') {
                            if($val['url'] != '') {
                                // $link = $val['url'];
                                // $pattern = '/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/';
                                // preg_match($pattern, $link, $matches);
                                // $video_id = $matches[7];
    
                                // $video['url'] = $video_id;
                                $video['url'] = $val['url'];
                            }
                            $videoList[] = $video;
                        }
    
                        if($val['type'] == 'Image' || $val['type'] == 'coverImg' || $val['type'] == 'topImg' || $val['type'] == 'degreeImg') {
                            $media['url']  = $val['url'];
                            $media['name'] = str_replace($config['tempMediaUrl'], '', $val['url']);
                            $media['type'] = $val['type'];
                            $mediaList[] = $media;
                        }
                    }
                }
            }

            usort($mediaList, function($a, $b) {
                $typeOrder = ['coverImg', 'degreeImg', 'topImg'];
                
                $aType = array_search($a['type'], $typeOrder);
                $bType = array_search($b['type'], $typeOrder);

                // If type not found in the order array, assign a high value to push it to the end
                if ($aType === false) $aType = PHP_INT_MAX;
                if ($bType === false) $bType = PHP_INT_MAX;

                return $aType - $bType;
            });
            $productInvList[0]['media'] = $mediaList;
            $productInvList[0]['video'] = $videoList;

            $db->where('product_id', $productInvId);
            $productVar = $db->get('product_template', null, 'id, product_attribute_value_id');

            if(!empty($productVar)) {
                // get all attribute value id in product template
                $attrIdList = [];
                foreach($productVar as $attr) {
                    foreach($attr as $val) {
                        foreach(json_decode($val, true) as $v) {
                            if(empty($attrIdList)) {
                                $attrIdList[] = $v;
                            } else {
                                if(!in_array($v, $attrIdList)) {
                                    $attrIdList[] = $v;
                                }
                            }
                        }
                    }
                }

                if(!empty($attrIdList)) {
                    // use the id in $attrIdList to find the product attribute and product attribute value
                    $db->where('pav.deleted', 0);
                    $db->where('pav.id', $attrIdList, 'IN');
                    $db->join('product_attribute pa', 'pa.id = pav.product_attribute_id', 'LEFT');
                    $productAttr = $db->get('product_attribute_value pav', null, 'pav.id, pav.name, pav.product_attribute_id as attribute_id, pa.name as attribute_name');

                    foreach($productAttr as $val) {
                        $attr[] = $val['attribute_id'];

                        $attrVal[$val['attribute_id']]['attribute_id'] = $val['attribute_id'];
                        $attrVal[$val['attribute_id']]['attribute_name'] = $val['attribute_name'];

                        $attribute['id'] = $val['id'];
                        $attribute['name'] = $val['name'];

                        $attrVal[$val['attribute_id']][$val['attribute_name']][] = $attribute;
                    }

                    $db->where('product_attribute_id', $attr, 'IN');
                    $attribute = $db->get('product_attribute_value', null, 'id, name, product_attribute_id');
                }
                $data['attribute'] = $attrVal;
                $data['productTemplate'] = $productVar;
            } else {
                $data['attribute'] = '';
                $data['productTemplate'] = '';
            }

            $data['productInventory']   = $productInvList;

            foreach($cookingSuggestDetails as $key => $value){
                $db->where('module', 'cookingSuggestionDetails');
                $db->where('module_id', $value['id']);
                $db->where('type', 'remark');
                $db->where('language', $productLang);
                $getInvLanDesc = $db->getValue('inv_language', 'content');

                if($getInvLanDesc){
                    $cookingSuggest['remark']       = $getInvLanDesc;
                }else{
                    $cookingSuggest['remark']       = $value['remark'];
                }

                $db->where('module', 'cookingSuggestion');
                $db->where('module_id', $value['suggestion_id']);
                $db->where('type', 'name');
                $db->where('language', $productLang);
                $getCSname = $db->getValue('inv_language', 'content');

                if($getCSname){
                    $cookingSuggest['name']       = $getCSname;
                }else{
                    $cookingSuggest['name']   = $value['name'];
                }

                $db->where('module', 'cookingSuggestion');
                $db->where('module_id', $value['suggestion_id']);
                $db->where('type', 'description');
                $db->where('language', $productLang);
                $getCSDesc = $db->getValue('inv_language', 'content');

                if($getCSname){
                    $cookingSuggest['description']       = $getCSDesc;
                }else{
                    $cookingSuggest['description']  = $value['description'];
                }

                $cookingSuggest['id']              = $value['id'];
                $cookingSuggest['url']         = $value['url'];
                // $cookingSuggest['remark']       = $value['remark'];
                $cookingSuggest['suggestion_id'] = $value['suggestion_id'];
                // $cookingSuggest['name']   = $value['name'];
                $cookingSuggest['cooking_time']  = $value['cooking_time'];
                // $cookingSuggest['description']  = $value['description'];


                $cookingSuggestList[] = $cookingSuggest;


            }

            unset($dataIn);
            $dataIn['product_id'] = $productInvId;
            $dataIn['quantity'] = 0;
            $dataIn['purchaseProduct'] = $dataIn;
            $dataOut = Inventory::checkStockQuantity($dataIn);
            
            $db->where('id', $productInvId);
            $db->where('deleted', '0');
            $productIgnoreCount = $db->getOne('product', 'ignore_stock_count');

            if($productIgnoreCount['ignore_stock_count'] == 1)
            {
                $dataOut['data'] = 9999;
            }

            if($dataOut){
                if($dataOut['data'][0]['finalAmount']){
                    $data['stockQuantity']      = $dataOut['data'][0]['finalAmount'];

                }else if($dataOut['data']){
                    $data['stockQuantity']      = $dataOut['data'];
                }
                else if($dataOut['data'] == ''  || $dataOut['data'][0]['finalAmount'] == ''){
                    $data['stockQuantity']      = 0;
                }
                
            }else{
                $data['stockQuantity']      = 0;
            }

            if($productDetail['stockQuantity'] <= 0){
                $productDetail['availability'] = 'no';
            }else{
                $productDetail['availability'] = 'yes';
            }
            // return array('status' => "error", 'code' => 1, 'statusMsg' => "", 'data' => $dataOut);

            $data['cookingDetail']      = $cookingSuggestList;
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function generateProductSKU($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $vendorId = trim($params['vendorId']);

            if($vendorId) {
                $db->where('deleted', 0);
                $db->where('id', $vendorId);
                $vendorCode = $db->getValue('vendor', 'vendor_code');

                $productSku = General::generateDynamicCode($vendorCode.'-',3,'product','barcode');

                if($productSku) {
                    $data['productSku'] = $productSku;
                } else {
                    $data['productSku'] = $vendorCode.'-001';
                }
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function getPackageProductList($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $type = trim($params['type']);

            if($type == 'Package') {
                $db->where('deleted', 0);
                // $db->where('is_published', '1');
                $db->where('is_archive', '0');
                $db->where('name', '', '!=');
                $productList = $db->get('product', null, 'id, name, cost, ignore_stock_count, product_type');
    
                $data['productList'] = $productList;
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function addAttribute($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $dateTime       = date("Y-m-d H:i:s");

            $attribute      = trim($params['attribute']);
            $attributeVal   = $params['attributeVal'];
            $status         = trim($params['status']);

            if($attribute) {
                $insetAttrData = array(
                    "name"       => $attribute,
                    "deleted"    => 0,
                    "created_at" => $dateTime,
                );
                $insertAttr = $db->insert('product_attribute', $insetAttrData);
            }

            if($attributeVal) {
                foreach ($attributeVal as $val) {
                    $insetAttrValData = array(
                        "name"                 => $val['name'],
                        "product_attribute_id" => $insertAttr,
                        "deleted"              => 0,
                        "created_at"           => $dateTime,
                    );
                    $insetAttrValDataList[] = $insetAttrValData;
                }
                $insertAttrVal = $db->insertMulti('product_attribute_value', $insetAttrValDataList);
            }

            if($insertAttr) {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> '');
            }
        }

        public function getAttributeDetail($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $dateTime       = date("Y-m-d H:i:s");
            $attrId         = $params['attrId'];
            $type           = trim($params['type']);
            $inputId        = trim($params['inputId']);
            
            if($attrId) {
                if($type != 'get') {
                    $db->where('pa.id', $attrId);
                    $db->join('product_attribute_value pav', 'pav.product_attribute_id = pa.id', 'LEFT');
                    $result = $db->get('product_attribute pa', null, 'pa.id as attribute_id, pa.name as attribute_name, pa.deleted as attr_delete, pav.id, pav.name, pav.deleted');

                    foreach ($result as $key => $val) {
                        $attributeID = $val['attribute_id'];

                        $attribute[$attributeID]['id']           = $val['attribute_id'];
                        $attribute[$attributeID]['name']         = $val['attribute_name'];

                        if ($val['attr_delete'] == 0) {
                            $attribute[$attributeID]['status']   = "Active";
                        } else {
                            $attribute[$attributeID]['status']   = "Inactive";
                        }
                        
                        $attribute[$attributeID]['value'][$key]['id']   = $val['id'];
                        $attribute[$attributeID]['value'][$key]['name'] = $val['name'];

                        if ($val['deleted'] == 0) {
                            $attribute[$attributeID]['value'][$key]['status'] = "Active";
                        } else {
                            $attribute[$attributeID]['value'][$key]['status'] = "Inactive";
                        }
                    }
                } else {
                    $db->where('product_attribute_id', $attrId);
                    $attribute = $db->get('product_attribute_value', null, 'id, name');

                    $data['inputId'] = $inputId;
                }
            }

            $data['attributeDetail'] = $attribute;

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> 'Get Attribute Successfully' , 'data'=> $data);
        }

        public function editAttribute($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $dateTime       = date("Y-m-d H:i:s");

            $attributeID     = trim($params['attrId']);
            $attributeName   = trim($params['attribute']);
            $attributeStatus = trim($params['status']);
            $attributeValue  = $params['attributeVal'];

            if($attributeID) {
                if($attributeStatus == "Active") {
                    $attributeStatus = 0;
                } else {
                    $attributeStatus = 1;
                }

                $attrData = array(
                    "name"       => $attributeName,
                    "deleted"    => $attributeStatus,
                    "updated_at" => $dateTime,
                );

                $db->where('id', $attributeID);
                $updateAttr = $db->update("product_attribute", $attrData);
            }

            if($attributeValue) {
                foreach($attributeValue as $val) {
                    if($val['status'] == "Active") {
                        $attrStatus = 0;
                    } else {
                        $attrStatus = 1;
                    }

                    $attrValData = array(
                        "name"       => $val['name'],
                        "deleted"    => $attrStatus,
                        "updated_at" => $dateTime,
                    );
                    $db->where('id', $val['id']);
                    $db->update("product_attribute_value", $attrValData);
                }
            }

            if($updateAttr) {
                return array('status' => 'ok', 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
            }
        }

        public function getAttributeList($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $searchData      = $params['searchData'];
            $pageNumber      = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $seeAll          = $params['seeAll'];
            $limit           = General::getLimit($pageNumber);        
            $dateTimeFormat  = Setting::$systemSetting['systemDateTimeFormat'];      

            $userID = $db->userID;
            $site = $db->userType;

            if(!$seeAll){
                $limit = General::getLimit($pageNumber);
            }

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);

                    switch($dataName) {
                        case 'createdAt':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);
                            if(strlen($dateFrom) > 0) {
                                $db->where('DATE(pa.created_at)', date('Y-m-d', $dateFrom), '>=');
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < $dateFrom)
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language], 'data'=>$data);

                                $db->where('DATE(pa.created_at)', date('Y-m-d', $dateTo), '<=');
                            }

                            unset($dateFrom);
                            unset($dateTo);
                            unset($columnName);
                            break;

                        case 'name':
                            $db->where('pa.name', "%".$dataValue."%", "LIKE");
                            break;
                        
                        case "status":
                            if($dataValue == "Active") {
                                $db->where("pa.deleted", 0);
                            } else if($dataValue == "Inactive") {
                                $db->where("pa.deleted", 1);
                            }
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }

            $db->join('product_attribute_value pav', 'pav.product_attribute_id = pa.id', 'LEFT');
            $copyDb = $db->copy();
            $getAttributeList = $db->get('product_attribute pa', null, 'pa.id as attribute_id, pa.name as attribute_name, pav.id, pav.name');
            if(empty($getAttributeList)) {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => '');
            }

            foreach ($getAttributeList as $val) {
                $attributeID = $val['attribute_id'];

                $attribute[$attributeID]['id']           = $val['attribute_id'];
                $attribute[$attributeID]['name']         = $val['attribute_name'];
                $attribute[$attributeID]['value_name'][] = $val['name'];
            }

            $totalRecord              = $copyDb->getValue("product_attribute pa", "count(pav.id)");
            $data['attributeList']    = $attribute;
            $data['pageNumber']       = $pageNumber;
            $data['totalRecord']      = $totalRecord;
            if($seeAll) {
                $data['totalPage']    = 1;
                $data['numRecord']    = $totalRecord;
            } else {
                $data['totalPage']    = ceil($totalRecord/$limit[1]);
                $data['numRecord']    = $limit[1];
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => "", 'data' => $data);
        }

        public function saleOrderProcess($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;

            $soID           = trim($params['saleID']);
            $status         = (!empty($params['status'])) ? $params['status'] : "";
            $adminID        = $db->userID;

            if(!$soID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            if(!$status) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00396"][$language], 'data'=> "");
            }

            $db->where('id', $soID);
            $sale = $db->getOne('sale_order');

            $db->where("id", $adminID);
            $adminUsername = $db->getValue("admin", 'username');

            $db->where("id", $sale['client_id']);
            $clientUsername = $db->getValue("client", 'name');

            $db->where('sale_id', $soID);
            $db->where('deleted', '0');
            $saleOrderDetail = $db->get('sale_order_detail');

            foreach($saleOrderDetail as $key => $value){
                $newProductArr[$key]['Product'] = $value['item_name'];
                $newProductArr[$key]['Quantity'] = $value['quantity'];
                $newProductArr[$key]['Price'] = $value['item_price'];
                $newProductArr[$key]['Total'] = $value['subtotal'];
            }

            $productList = '';
            foreach ($newProductArr as $orderDetail) {
                $lines = array();
                foreach ($orderDetail as $key => $value) {
                    $lines[] = "$key: $value";
                }
                $result .= implode("\n", $lines) . "\n\n";
            }

            $updateData = array(
                "status"            => $status,
                "updated_at"        => date('Y-m-d H:i:s'),
            );
            $db->where('id', $soID);
            $db->where('status', 'Paid');
            $db->update("sale_order", $updateData);

            $find = array("%%adminUsername%%", "%%soID%%", "%%clientName%%", "%%time%%", "%%deliveryOption%%", "%%paymentOption%%","%%status%%", "%%productList%%");
            $replace = array($adminUsername, $sale['so_no'], $clientUsername, date("Y-m-d H:i:s"),$sale['delivery_method'],$sale['payment_method'],$status, $result);
            $outputArray = Client::sendTelegramMessage('10026', NULL, NULL, $find, $replace,"","","telegramAdminGroup");
   
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
        }

        public function editOrderDetails($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $deliveryFee    = Setting::$systemSetting['deliveryFee'];
            $dateTime       = date('Y-m-d H:i:s');

            $SaleID                 = trim($params['saleID']);
            $SaleOrderDetail        = $params['orderDetailArray'];
            $orderServiceArray      = $params['orderServiceArray'];
            $payment_method         = $params['payment_method'];
            $delivery_method        = $params['delivery_method'];
            $billingAddr            = $params['billingAddr'];
            $shippingAddr           = $params['shippingAddr'];
            $statusSelect           = $params['statusSelect'];
            $adminID                = $db->userID;
            $deliveryCount          = 0;
            $payment_method         =  $params['payment_method'] ;
            $status                 = (!empty($params['status'])) ? $params['status'] : "";
            $payment_amount         = (!empty($params['payment_amount'])) ? $params['payment_amount'] : "";
            $shipping_fee           = (!empty($params['shipping_fee'])) ? $params['shipping_fee'] : "";
            $payment_tax            = (!empty($params['payment_tax'])) ? $params['payment_tax'] : "";

            // Receipt
            $receiptData            = $params['receiptData'];
            $receiptName            = $params['receiptName'];
            
            // Priority Checking
            if(!$SaleID) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> "");
            }

            $db->where('id', $SaleID);
            $sale = $db->getOne('sale_order');

            if(!$sale) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01187"][$language], 'data'=> "");
            }

            if(($sale['status'] == 'Paid' || $sale['status'] == 'Cancelled') && !$params['creditNoteReference']){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00396"][$language]/* Invalid status. */, 'data'=> "");
            }

            if(!$SaleOrderDetail) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01186"][$language], 'data'=> "");
            }

            if(!$delivery_method)
            {
                $delivery_method = 'delivery';
            }

            if ($status != "Cancelled"){
                foreach ($SaleOrderDetail as &$detailRow) {
                    if($detailRow['product_id'] != '0' || $detailRow['product_id'] != 0)
                    {
                        if(!$detailRow['product_id']) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01188"][$language] /* Invalid Product. */, 'data' => "");
                        }
                    }

                    if(!$detailRow['quantity'] || $detailRow['quantity'] < 1) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01188"][$language] /* Invalid Product. */, 'data' => "");
                    }
                    $product_idAry[$detailRow['product_id']] = $detailRow['product_id'];
                }
    
                if(!$status) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00396"][$language]/* Invalid status. */, 'data'=> "");
                }
    
                foreach ($SaleOrderDetail as $index => $item) {
                    if (strtolower($item['name']) == 'delivery'){
                        $delivery_method = "delivery";
                        $shipping_fee = $item["cost"];
                        $deliveryCount++;
                    }else if(strtolower($item['name']) == 'pickup'){
                        $delivery_method = "Pickup";
                        $shipping_fee = $item["cost"];
                        $deliveryCount++;
                        $shippingAddr = 1;
                    }else if(strtolower($item['name']) == 'drydelivery'){
                        $delivery_method = "delivery";
                        $shipping_fee = $item["cost"];
                        $deliveryCount++;
                    }
                }

                if($delivery_method != "Pickup"){
                    if(!$billingAddr) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01772"][$language]/* Please select a billing address */, 'data'=> "");
                    }
        
                    if(!$shippingAddr) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01773"][$language]/* Please select a shipping address */, 'data'=> "");
                    }
    
                }

                if($delivery_method == null){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03836"][$language] /* Select a Delivery Method. */, 'data'=> '');
                }
    
                // Checking when status is pending payment approve
                if ($status == "Pending Payment Approve" || $status == "Paid"){
                    if(!$payment_method) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01774"][$language]/* Please select a payment method */, 'data'=> "");
                    }
                }
    
                if ($status == "Paid"){
                    $db->where("reference_id", $SaleID);
                    $db->where("type", 'receipt');
                    $db->where("deleted", 0);
                    $getReceipt = $db->getOne("uploads");
    
                    if(!$getReceipt){
                        if(!$receiptData || !$receiptName){
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00533"][$language]/* Please Upload Receipt */, 'data'=> "");
                        }
                    }
                }
    
                if($product_idAry){
                    $db->where("id", $product_idAry, "IN" );
                    $productAry= $db->map('id')->get("product", NULL,"");
                }
    
                $updateData = array(
                    "deleted"    => 1
                );
                $db->where('deleted', 0);
                $db->where('sale_id', $SaleID);
                $db->update("sale_order_detail", $updateData);
               
                $billingDetail = Cash::getFullAddress($billingAddr);	
                $shippingDetail = Cash::getFullAddress($shippingAddr);	

                if(!$billingDetail){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00534"][$language]/* Missing billing address */, 'data'=> "");
                }

                if(!$shippingDetail){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00535"][$language]/* Missing shipping address */, 'data'=> "");
                }
    
                foreach ($SaleOrderDetail as &$detailRow) {
                    unset($newRecord);
                    $item_name = $detailRow['name'];
                    $item_cost = $detailRow['cost'];
                    $item_type = $detailRow['type'];
                    if ($detailRow['product_id'] != '0' || $detailRow['product_id'] != 0){
    
                        $db->where('id', $detailRow['product_id']);
                        $db->where('deleted', '0');
                        $productType = $db->getValue('product', 'product_type');
    
                        $newRecord = array(
                            "client_id"             =>  $sale['client_id'],
                            "product_id"            =>  $detailRow['product_id'],
                            "product_template_id"   =>  $detailRow['product_template_id'],
                            "item_name"             =>  $item_name,
                            "item_price"            =>  $productAry[$detailRow['product_id']]['sale_price'],
                            "discount"              =>  $detailRow['discount'],
                            "price_reduce"          =>  $detailRow['price_reduce'],
                            "quantity"              =>  $detailRow['quantity'],
                            "subtotal"              =>  Setting::setDecimal($productAry[$detailRow['product_id']]['sale_price']*$detailRow['quantity']),
                            "price_reduce_subtotal" =>  $detailRow['price_reduce_subtotal'],
                            "type"                  =>  $productType,
                            "sale_id"               =>  $sale['id'],
                            "deleted"               =>  0,
                            "created_at"            =>  $dateTime
                        );
    
                    }else if($item_type =='redeem_point'){
                        $redeemPointRate = Setting::$systemSetting['redeemPoint'];

                        $newRecord = array(
                            "client_id"             =>  $sale['client_id'],
                            "product_id"            =>  $detailRow['product_id'],
                            "product_template_id"   =>  $detailRow['product_template_id'],
                            "item_name"             =>  $item_name,
                            "item_price"            =>  -1 * $redeemPointRate,
                            "discount"              =>  $detailRow['discount'],
                            "price_reduce"          =>  $detailRow['price_reduce'],
                            "quantity"              =>  $detailRow['quantity'],
                            "subtotal"              =>  Setting::setDecimal(-1 * $redeemPointRate * $detailRow['quantity']),
                            "price_reduce_subtotal" =>  $detailRow['price_reduce_subtotal'],
                            "sale_id"               =>  $sale['id'],
                            "type"                  =>  'redeem_point',
                            "deleted"               =>  0,
                            "created_at"            =>  $dateTime
                        );
    
                    }else if($item_type =='shipping_fee'){
                        $newRecord = array(
                            "client_id"             =>  $sale['client_id'],
                            "product_id"            =>  $detailRow['product_id'],
                            "product_template_id"   =>  $detailRow['product_template_id'],
                            "item_name"             =>  $item_name,
                            "item_price"            =>  $detailRow['cost'],
                            "discount"              =>  $detailRow['discount'],
                            "price_reduce"          =>  $detailRow['price_reduce'],
                            "quantity"              =>  $detailRow['quantity'],
                            "subtotal"              =>  Setting::setDecimal($detailRow['cost']*$detailRow['quantity']),
                            "price_reduce_subtotal" =>  $detailRow['price_reduce_subtotal'],
                            "sale_id"               =>  $sale['id'],
                            "type"                  =>  $item_type,
                            "deleted"               =>  0,
                            "created_at"            =>  $dateTime
                        );
                    }else if($item_type == "promo_code"){
                        $newRecord = array(
                            "client_id"             =>  $sale['client_id'],
                            "product_id"            =>  $detailRow['product_id'],
                            "product_template_id"   =>  $detailRow['product_template_id'],
                            "item_name"             =>  $item_name,
                            "item_price"            =>  abs($item_cost),
                            "discount"              =>  $detailRow['discount'],
                            "price_reduce"          =>  $detailRow['price_reduce'],
                            "quantity"              =>  $detailRow['quantity'],
                            "subtotal"              =>  Setting::setDecimal(abs($item_cost)*$detailRow['quantity']),
                            "price_reduce_subtotal" =>  $detailRow['price_reduce_subtotal'],
                            "sale_id"               =>  $sale['id'],
                            "type"                  =>  'promo_code',
                            "deleted"               =>  0,
                            "created_at"            =>  $dateTime
                        );
                    }
                    $db->insert("sale_order_detail", $newRecord);
                }

                # calculate again so detail

                foreach ($SaleOrderDetail as $detailSO) {
                    if ($detailSO['type'] == 'package') {
                        $total += $detailSO['cost'] * $detailSO['quantity'];
                        $subTotal += $detailSO['cost'] * $detailSO['quantity'];
                    } elseif($detailSO['type'] == 'product') {
                        $total += $detailSO['cost'] * $detailSO['quantity'];
                        $subTotal += $detailSO['cost'] * $detailSO['quantity'];
                    } elseif ($detailSO['type'] == 'promo_code') {
                        $total -= abs($detailSO['cost']) * $detailSO['quantity'];
                    } elseif ($detailSO['type'] == 'shipping_fee') {
                        $total += $detailSO['cost'] * $detailSO['quantity'];
                    } elseif ($detailSO['type'] == 'redeem_point') {
                        $total -= abs($detailSO['cost']) * $detailSO['quantity'];
                    }
                }

                // Update Sale Order Table
                $updateData = array(
                    "status"                => $status,
                    "payment_amount"        => $subTotal,
                    "shipping_fee"          => $shipping_fee,
                    "payment_tax"           => $payment_tax,
                    "release_amount"        => $total,
                    "payment_method"        => $payment_method,
                    "delivery_method"       => $delivery_method,
                    "updated_at"            => $dateTime,
                    "billing_name"          => $billingDetail['name'],
                    "billing_phone"         => $billingDetail['phone'],
                    "billing_address"       => $billingDetail['address'],
                    "billing_address2"      => $billingDetail['address_2'],
                    "billing_post_code"     => $billingDetail['post_code'],
                    "billing_state_id"      => $billingDetail['state_id'],
                    "billing_city"          => $billingDetail['city'],
                    "billing_email"         => $billingDetail['email'],
                    "shipping_name"         => $shippingDetail['name'],
                    "shipping_phone"        => $shippingDetail['phone'],
                    "shipping_address"      => $shippingDetail['address'],
                    "shipping_address2"     => $shippingDetail['address_2'],
                    "shipping_post_code"    => $shippingDetail['post_code'],
                    "shipping_state_id"     => $shippingDetail['state_id'],
                    "shipping_city"         => $shippingDetail['city'],
                    "shipping_email"        => $shippingDetail['email'],
                );
                $db->where('id', $SaleID);
                $db->update("sale_order", $updateData);  
    
                // Upload receipt 
                if($receiptData && $receiptName) {
                    $db->where("reference_id", $SaleID);
                    $db->where("type", 'receipt');
                    $db->where("deleted", 0);
                    $getReceipt = $db->getOne("uploads");
    
                    if($getReceipt){
                        $removeReceipt = array(
                            "deleted"    => 1
                        );
                        $db->where("reference_id", $SaleID);
                        $db->where("type", 'receipt');
                        $db->where("deleted", 0);
                        $db->update("uploads", $removeReceipt);
                    }
    
                    $receiptParam['type']       = 'receipt';
                    $receiptParam['saleID']     = $SaleID;
                    $receiptParam['clientID']   = $sale['client_id'];
                    $receiptParam['fromPage']   = 'EditSaleOrderAdmin';
                    $receiptParam['fileName']   = $receiptName;
                    $receiptParam['data']       = $receiptData;
    
                    $uploadReceiptData = Cash::uploadReceipt($receiptParam);
    
                    if($uploadReceiptData['status'] != 'ok'){
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $uploadReceiptData['statusMsg'], 'data'=> $uploadReceiptData['data']);
                    }
                }
    
                $db->where("id", $adminID);
                $adminUsername = $db->getValue("admin", 'username');
    
                $db->where("id", $sale['client_id']);
                $clientUsername = $db->getValue("client", 'name');
    
                if($statusSelect){
                    $displayStatus = $statusSelect;
                }else{
                    $displayStatus = $status;
                }

                if ($status == "Paid"){                
                    $db->where("sale_id", $SaleID);
                    $result = $db->update("shopping_cart", array("disabled" => 1));
                }
    
            }else {
                // Update Sale Order Table
                $updateData = array(
                    "status"            => $status,
                    "updated_at"        => $dateTime,
                    "remark"            => $params['creditNoteReference'],
                );
                $db->where('id', $SaleID);
                $db->update("sale_order", $updateData);

                // When status is cancelled refund points redeemed by user
                $db->where("sale_id", $SaleID);
                $db->where("client_id", $sale['client_id']);
                $db->where("item_name", 'Redeemed Points');
                $pointDetail = $db->getOne('sale_order_detail');

                $dataIn['id']               = $sale['client_id'];
                $dataIn['creditType']       = 'bonusDef';
                $dataIn['adjustmentType']   = 'Adjustment In';
                $dataIn['adjustmentAmount'] = $pointDetail['quantity'];
                $dataIn['remark']           = 'Admin Refund Points';
                // $dataIn['isMember']         = '1';
                $creditOutput = Wallet::creditAdjustment($dataIn);


                // credit note
                if($params['creditNoteName']){
                    $creditNoteData            = $params['creditNoteData'];
                    $creditNoteName            = $params['creditNoteName'];

                    $file        = $creditNoteName;
                    $fileArray   = explode('.', $file);
                    $fileName    = $fileArray[0];
                    $fileExt     = $fileArray[1];
                    $newFileName = $fileName.".".$fileExt;

                    $fields = array("data", "type", "created_at", "reference_id", "file_type" ,"file_name", "deleted");
                    $values = array($creditNoteData, "creditNote", date("Y-m-d H:i:s"), $SaleID, $fileExt, $fileName, 0);
                    $arrayData = array_combine($fields, $values);

                    $uploadId = $db->insert("uploads", $arrayData);
                }

            }

            foreach($SaleOrderDetail as $key => $value){
                $newProductArr[$key]['Product'] = $value['name'];
                $newProductArr[$key]['Quantity'] = $value['quantity'];
                $newProductArr[$key]['Price'] = $value['cost'];
                $newProductArr[$key]['Total'] = number_format($value['cost']*$value['quantity'], 2);
            }

            $productList = '';
            foreach ($newProductArr as $orderDetail) {
                $lines = array();
                foreach ($orderDetail as $key => $value) {
                    $lines[] = "$key: $value";
                }
                $result .= implode("\n", $lines) . "\n\n";
            }

            $find = array("%%adminUsername%%", "%%soID%%", "%%clientName%%", "%%time%%", "%%deliveryOption%%", "%%paymentOption%%","%%status%%", "%%productList%%");
            $replace = array($adminUsername, $sale['so_no'], $clientUsername, date("Y-m-d H:i:s"),$sale['delivery_method'],$sale['payment_method'],$displayStatus, $result);
            $outputArray = Client::sendTelegramMessage('10026', NULL, NULL, $find, $replace,"","","telegramAdminGroup");
   
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => "");
        }

        public function editOrderDetails2($params) {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime       = date('Y-m-d H:i:s');

            $SaleID                 = trim($params['saleID']);
            $SaleOrderDetail        = $params['orderDetailArray'];
            $orderServiceArray      = $params['orderServiceArray'];
            $delivery_method        = $params['delivery_method'];
            $billingAddr            = $params['billingAddr'];
            $shippingAddr           = $params['shippingAddr'];
            $statusSelect           = $params['statusSelect'];
            $adminID                = $db->userID;
            $deliveryCount          = 0;
            $payment_method         =  $params['payment_method'] ;
            $status                 = (!empty($params['status'])) ? $params['status'] : "";
            $payment_amount         = (!empty($params['payment_amount'])) ? $params['payment_amount'] : "";
            $shipping_fee           = (!empty($params['shipping_fee'])) ? $params['shipping_fee'] : "";
            $payment_tax            = (!empty($params['payment_tax'])) ? $params['payment_tax'] : "";
            $promoCode              = $params['promoCode'];
            $shippingPostCode       = $params['shippingPostCode'];
            $soType                 = $params['soType'];
            $clientID               = $params['clientID'];

            // Receipt
            $receiptData            = $params['receiptData'];
            $receiptName            = $params['receiptName'];
            $uploadImage            = $params['uploadImage'];

            // Priority Checking
            if(!$clientID && $soType === 'add')
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00119"][$language] /* Client not found */, 'data'=> "");
            }
            if(!$billingAddr || !$shippingAddr)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00950"][$language] /* Please select address */, 'data'=> "");
            }

            if(!$soType)
            {
                if(!$SaleID) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language] /* Invalid ID */, 'data'=> "");
                }

                if (strpos($SaleID, 'S') !== false) {
                    // get sale id
                    $db->where('so_no',$SaleID);
                    $SaleID = $db->getOne('sale_order', 'id');
                    if($SaleID)
                    {
                        $SaleID = $SaleID['id'];
                    }
                }
    
                $db->where('id', $SaleID);
                $sale = $db->getOne('sale_order');
    
                if(!$sale) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01187"][$language] /* Sale order doest not exist */, 'data'=> "");
                }
    
                if(($sale['status'] == 'Paid' || $sale['status'] == 'Cancelled') && !$params['creditNoteReference']){
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00396"][$language]/* Invalid status. */, 'data'=> "");
                }
            }

            if(!$SaleOrderDetail) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01186"][$language] /* Sale order detail empty */, 'data'=> "");
            }

            # make sure product list have at least one product
            $allDeleted = true;
            foreach ($SaleOrderDetail as $product) {
                if ($product["product_id"] != 0) {
                    $allDeleted = false;
                    break; 
                }
            }

            if ($allDeleted) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01299"][$language] /* Must have at least one product in this PO */, 'data'=>"");
            }

            if($status == 'Paid')
            {
                if(!$payment_method)
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01774"][$language] /* Please select a payment method */, 'data'=> "");
                }

                if(!$uploadImage)
                {
                    $db->where('reference_id', $SaleID);
                    $db->where('deleted', '0');
                    $oldReceipt = $db->getOne('uploads');
                    if(!$oldReceipt)
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00533"][$language] /* Please Upload Receipt */, 'data'=> "");
                    }
                }
            }

            if(!$delivery_method)
            {
                $delivery_method = 'delivery';
            }

            if($delivery_method == 'Delivery Charges' || $delivery_method == 'Delivery')
            {
                $delivery_method = 'delivery';
            }
            else if($delivery_method == 'Self Pickup')
            {
                $delivery_method = 'Pickup';
            }

            if(!$soType)
            {
                # get Client ID from sale order
                $db->where('id', $SaleID);
                $saleOrderInfo = $db->getOne('sale_order');
                $clientID = $saleOrderInfo['client_id'];
    
                $db->orderBy('id', 'DESC');
                $db->where('sale_id', $SaleID);
                $oldToken = $db->getOne('guest_token');
            }
            if(!$oldToken)
            {
                // generate token
                $autoLoginTokenRes = General::generateAutoLoginToken($dateTime, $timeOut);
                if(!$dateTime) $dateTime = date('Y-m-d H:i:s');
                $wbToken = $autoLoginTokenRes['wbToken'];
                $bkendToken = $autoLoginTokenRes['bkendToken'];
                $expiredTS  = $autoLoginTokenRes['expiredTS'];
    
                // insert into guest_token table
                $insertData = array(
                    'token'         => $bkendToken,
                    'client_id'     => $clientID,
                    'sale_id'       => $SaleID,
                    'created_at'    => $dateTime,
                );
                $insertGuestToken = $db->insert('guest_token', $insertData);
            }
            else
            {
                $bkendToken = $oldToken['token'];
            }

            if(strtolower($status) != 'cancelled')
            {
                if(!$soType)
                {
                    # re insert shoppingcart
                    $updateData = array(
                        'disabled' => 1,
                    );
                    $db->where('token', $bkendToken);
                    $db->where('disabled', '0');
                    $db->update('shopping_cart', $updateData);
                }

                # Check Stock Availability
                foreach($SaleOrderDetail as $key => $value){
                    if($value['product_id'] != 0)
                    {
                        $db->where('id', $value['product_id']);
                        $db->where('deleted', '0');
                        $productIgnoreCount = $db->getOne('product', 'ignore_stock_count, product_type');
                        if($productIgnoreCount['ignore_stock_count'] != '1')
                        {
                            unset($dataIn);
                            $dataIn['product_id'] = $value['product_id'];
                            if(strtolower($productIgnoreCount['product_type'] == 'product'))
                            {
                                $dataIn['text'] = 'cart';
                            }
                            else
                            {
                                unset($dataIn['text']);
                            }
                            $dataIn['quantity'] = $value['quantity'];
                            $dataOut = Inventory::checkStockQuantity($dataIn);
                            if($dataOut['status'] != 'ok')
                            {
                                $outOfStockList = $dataOut['data'];
                                $totalOutOfStock = array_column($outOfStockList, 'product_name');
                                $combinedMsg = implode(', ', $totalOutOfStock);
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03005"][$language] /* Out Of Stock */ . '<br>' . $combinedMsg, 'data' => $dataOut['data']);
                            }
                        }
                    }
                }

                # Add Shopping Cart
                foreach($SaleOrderDetail as $key => $value){
                    unset($dataIn);

                    $addCartType = 'add';

                    if(($value['product_id'] != 0 || $value['product_id'] != '0') && $value['type'] != 'note')
                    {
                        $dataIn['adminResetClientID'] = $clientID;
                        $dataIn['packageID'] = $value['product_id'];
                        $dataIn['quantity'] = $value['quantity'];
                        $dataIn['type'] = $addCartType;
                        $dataIn['product_template'] = '';
                        $dataIn['bkend_token'] = $bkendToken; 
                        $dataIn['adminSaleID'] = $SaleID;
                        $dataIn['step'] = '1';
                        $addCart = Inventory::addShoppingCart($dataIn);
                        if(!$SaleID)
                        {
                            $SaleID = $addCart['data']['sale_id'];
                        }
                        if($addCart['status'] != 'ok')
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $addCart['statusMsg'] , 'data' => $addCart, 'dataIn' => $dataIn, 'value' => $value);
                        }
                    }
                }

                # Get Shopping Cart
                unset($dataIn);
                $dataIn['bkend_token'] = $bkendToken;
                $dataIn['promo_code'] = $promoCode;
                $dataIn['redeemAmount'] = '';
                $dataIn['deliveryMethod'] = $delivery_method;
                $dataIn['adminResetClientID'] = $clientID;
                $dataIn['postcode'] = $shippingPostCode;
                $getCartDetails = Inventory::getShoppingCart2($dataIn);
                if($getCartDetails['status'] != 'ok')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $getCartDetails['statusMsg'] , 'data' => $getCartDetails , 'dataIn' => $dataIn);
                }

                ## delivery not available 
                if($getCartDetails['data']['deliveryAvailability'] == '0'){
                    # Update Sale Order and prompt delivery error message
                    unset($dataIn);
                    $dataIn['saleID'] = $addCart['saleID']['data'];
                    $dataIn['promo_code'] = $promoCode;
                    $dataIn['adminResetClientID'] = $clientID;
                    $dataIn['paymentMethod'] = $payment_method;
                    $dataIn['adminSOStatus'] = $status;
                    $dataIn['paymentDelivery'] = $delivery_method;
                    $dataIn['total_price'] = '';
                    $dataIn['redeemAmount'] = '';
                    $dataIn['bkend_token'] = $bkendToken;
                    $dataIn['deliveryMethod'] = $delivery_method;
                    $dataIn['postcode'] = $shippingPostCode;
                    $updateSO = Cash::updateSaleOrder($dataIn);
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01284"][$language] /* Delivery is not available in your postcode area. */ , 'data' => $getCartDetails , 'dataIn' => $dataIn);
                }
                if($soType === 'add')
                {
                    # Update Sale Order
                    unset($dataIn);
                    $dataIn['saleID'] = $addCart['saleID']['data'];
                    $dataIn['promo_code'] = $promoCode;
                    $dataIn['adminResetClientID'] = $clientID;
                    $dataIn['paymentMethod'] = $payment_method;
                    $dataIn['adminSOStatus'] = 'Draft';
                    $dataIn['paymentDelivery'] = $delivery_method;
                    $dataIn['total_price'] = '';
                    $dataIn['redeemAmount'] = '';
                    $dataIn['bkend_token'] = $bkendToken;
                    $dataIn['deliveryMethod'] = $delivery_method;
                    $dataIn['postcode'] = $shippingPostCode;
                    $updateSO = Cash::updateSaleOrder($dataIn);
                }
                else
                {
                    # Update Sale Order
                    unset($dataIn);
                    $dataIn['saleID'] = $addCart['saleID']['data'];
                    $dataIn['promo_code'] = $promoCode;
                    $dataIn['adminResetClientID'] = $clientID;
                    $dataIn['paymentMethod'] = $payment_method;
                    $dataIn['adminSOStatus'] = $status;
                    $dataIn['paymentDelivery'] = $delivery_method;
                    $dataIn['total_price'] = '';
                    $dataIn['redeemAmount'] = '';
                    $dataIn['bkend_token'] = $bkendToken;
                    $dataIn['deliveryMethod'] = $delivery_method;
                    $dataIn['postcode'] = $shippingPostCode;
                    $updateSO = Cash::updateSaleOrder($dataIn);
                }
                if($updateSO['status'] != 'ok')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $updateSO['statusMsg'] , 'data' => $updateSO, 'dataIn' => $dataIn);
                }
            }

            # get Sale Order Info
            $db->where('id', $SaleID);
            $sale = $db->getOne('sale_order');

            # update Address to SO
            $billingDetail = Cash::getFullAddress($billingAddr);	
            $shippingDetail = Cash::getFullAddress($shippingAddr);	

            $updateData = array(
                'billing_name'          => $billingDetail['name'],
                'billing_phone'         => $billingDetail['phone'],
                'billing_address'       => $billingDetail['address'],
                'billing_address2'      => $billingDetail['address_2'],
                'billing_post_code'     => $billingDetail['post_code'],
                'billing_state_id'      => $billingDetail['state_id'],
                'billing_city'          => $billingDetail['city'],
                'billing_email'         => $billingDetail['email'],
                'shipping_name'         => $shippingDetail['name'],
                'shipping_phone'        => $shippingDetail['phone'],
                'shipping_address'      => $shippingDetail['address'],
                'shipping_address2'     => $shippingDetail['address_2'],
                'shipping_post_code'    => $shippingDetail['post_code'],
                'shipping_state_id'     => $shippingDetail['state_id'],
                'shipping_city'         => $shippingDetail['city'],
                'shipping_email'        => $shippingDetail['email'],
            );
            $db->where('id', $addCart['saleID']['data']);
            $db->update('sale_order', $updateData);

            # Upload receipt 

            if ($uploadImage){
                $db->where("reference_id", $SaleID);
                $db->where("type", 'receipt');
                $db->where("deleted", 0);
                $getReceipt = $db->getOne("uploads");

                if($getReceipt){
                    $removeReceipt = array(
                        "deleted"    => 1
                    );
                    $db->where("reference_id", $SaleID);
                    $db->where("type", 'receipt');
                    $db->where("deleted", 0);
                    $db->update("uploads", $removeReceipt);
                }
                foreach($uploadImage as $key => $val) {
                    if (strpos($val['imgData'], 'https') !== false) {
                        $imageUrl = $val['imgData'];
                        $fileType = pathinfo($val['imgName'], PATHINFO_EXTENSION);
                        $insertReceipt = array(
                            "file_name" => $val['imgName'],
                            "type" => "receipt",
                            "data" => $imageUrl,
                            "reference_id" => $SaleID,
                            "created_at"   => $dateTime,
                            "file_type" => $fileType,
                            "deleted"   => "0"
                        );
                        $insertReceipt = $db->insert('uploads', $insertReceipt);
                        if(!$insertReceipt) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00630"][$language], 'data' => ''); /* Upload attachment error */
                        }
                    }
                }

                $receiptParam['type']       = 'receipt';
                $receiptParam['saleID']     = $SaleID;
                $receiptParam['clientID']   = $sale['client_id'];
                $receiptParam['fromPage']   = 'EditSaleOrderAdmin';
                $receiptParam['fileName']   = $receiptName;
                $receiptParam['data']       = $receiptData;

                // $uploadReceiptData = Cash::uploadReceipt($receiptParam);

                // if($uploadReceiptData['status'] != 'ok'){
                //     return array('status' => "error", 'code' => 131, 'statusMsg' => $uploadReceiptData['statusMsg'], 'data'=> $uploadReceiptData['data']);
                // }
        }

            if(strtolower($status) == 'paid')
            {
                # update SO to paid
                $updateData = array(
                    'status' => 'Paid',
                    'updated_at' => $dateTime,
                );
                $db->where('id', $SaleID);
                $db->update('sale_order', $updateData);
            }

            if (strtolower($status) == "cancelled")
            {
                // Update Sale Order Table
                $updateData = array(
                    "status"            => $status,
                    "updated_at"        => $dateTime,
                    "remark"            => $params['creditNoteReference'],
                );
                $db->where('id', $SaleID);
                $db->update("sale_order", $updateData);

                // When status is cancelled refund points redeemed by user
                $db->where("sale_id", $SaleID);
                $db->where("client_id", $sale['client_id']);
                $db->where("item_name", 'Redeemed Points');
                $pointDetail = $db->getOne('sale_order_detail');

                $dataIn['id']               = $sale['client_id'];
                $dataIn['creditType']       = 'bonusDef';
                $dataIn['adjustmentType']   = 'Adjustment In';
                $dataIn['adjustmentAmount'] = $pointDetail['quantity'];
                $dataIn['remark']           = 'Admin Refund Points';
                // $dataIn['isMember']         = '1';
                $creditOutput = Wallet::creditAdjustment($dataIn);

                // credit note
                if($params['creditNoteName']){
                    $creditNoteData            = $params['creditNoteData'];
                    $creditNoteName            = $params['creditNoteName'];

                    $file        = $creditNoteName;
                    $fileArray   = explode('.', $file);
                    $fileName    = $fileArray[0];
                    $fileExt     = $fileArray[1];
                    $newFileName = $fileName.".".$fileExt;

                    $fields = array("data", "type", "created_at", "reference_id", "file_type" ,"file_name", "deleted");
                    $values = array($creditNoteData, "creditNote", date("Y-m-d H:i:s"), $SaleID, $fileExt, $fileName, 0);
                    $arrayData = array_combine($fields, $values);

                    $uploadId = $db->insert("uploads", $arrayData);

                    # deduct reward point
                    $dataIn['id']               = $sale['client_id'];
                    $dataIn['creditType']       = 'bonusDef';
                    $dataIn['adjustmentType']   = 'Adjustment Out';
                    $dataIn['adjustmentAmount'] = $sale['rewarded_point'];
                    $dataIn['remark']           = 'Admin Deduct Points';
                    // $dataIn['isMember']         = '1';
                    $creditOutput = Wallet::creditAdjustment($dataIn);
                }
            }

            # special insert note
            foreach($SaleOrderDetail as $detailNote)
            {
                if($detailNote['type'] == 'note')
                {
                    $insertNote = array(
                        'client_id'             => $clientID,
                        'product_id'            => '0',
                        'product_template_id'   => '0',
                        'item_name'             => $detailNote['name'],
                        'item_price'            => 0.00,
                        'discount'              => 0.00,
                        'price_reduce'          => 0.00,
                        'quantity'              => 1,
                        'subtotal'              => 0.00,
                        'price_reduce_subtotal' => '',
                        'sale_id'               => $SaleID,
                        'type'                  => 'note',
                        'deleted'               => '0',
                        'created_at'            => $dateTime,
                    );
                    $db->insert('sale_order_detail', $insertNote);
                }
            }

            # Telegram Notification
            foreach($SaleOrderDetail as $key => $value){
                $newProductArr[$key]['Product'] = $value['name'];
                $newProductArr[$key]['Quantity'] = $value['quantity'];
                $newProductArr[$key]['Price'] = $value['cost'];
                $newProductArr[$key]['Total'] = number_format($value['cost']*$value['quantity'], 2);
            }

            # get Info for telegram
            $displayStatus = $status;
            $db->where('id', $adminID);
            $adminInfo = $db->getOne('admin');
            $db->where('id', $clientID);
            $clientInfo = $db->getOne('client');
            $adminUsername = $adminInfo['name'];
            $clientUsername = $clientInfo['name'];

            $productList = '';
            foreach ($newProductArr as $orderDetail) {
                $lines = array();
                foreach ($orderDetail as $key => $value) {
                    $lines[] = "$key: $value";
                }
                $result .= implode("\n", $lines) . "\n\n";
            }

            $find = array("%%adminUsername%%", "%%soID%%", "%%clientName%%", "%%time%%", "%%deliveryOption%%", "%%paymentOption%%","%%status%%", "%%productList%%");
            $replace = array($adminUsername, $sale['so_no'], $clientUsername, date("Y-m-d H:i:s"),$sale['delivery_method'],$sale['payment_method'],$displayStatus, $result);
            $outputArray = Client::sendTelegramMessage('10026', NULL, NULL, $find, $replace,"","","telegramAdminGroup");

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $addCart, 'getCartDetails' => $getCartDetails);
        }

        public function applyPromoCode($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime       = date('Y-m-d H:i:s');

            $promoCode      = trim($params['promo_code']);
            $bkendToken     = trim($params['bkend_token']);

            $clientID = $db->userID;

            if(empty($bkendToken))
            {
                // get old token
                $db->orderBy('id', 'desc');
                $db->where('client_id', $clientID);
                $oldToken = $db->getOne('guest_token');
                if($oldToken)
                {
                    $bkendToken = $oldToken['token'];
                }
                else
                {
                    // generate token pass to frontend
                    $autoLoginTokenRes = General::generateAutoLoginToken($dateTime, $timeOut);
                    if(!$dateTime) $dateTime = date('Y-m-d H:i:s');
                    $wbToken = $autoLoginTokenRes['wbToken'];
                    $bkendToken = $autoLoginTokenRes['bkendToken'];
                    $expiredTS  = $autoLoginTokenRes['expiredTS'];
    
                    // check got existing token or not
                    if(empty($clientID))
                    {
                        // insert into guest_token table
                        $insertData = array(
                            'token'         => $bkendToken,
                            'client_id'     => $clientID,
                            'sale_id'       => '',
                            'created_at'    => $todayDate,
                        );
                        $insertGuestToken = $db->insert('guest_token', $insertData);
                    }
                    else
                    {
                        // check user have old token or not
                        $db->orderBy('id', 'desc');
                        $db->where('client_id', $clientID);
                        $oldToken = $db->getOne('guest_token');
                        $oldToken = $oldToken['token'];
    
                        // search existing token based on client ID
                        $db->where('client_id', $clientID);
                        $tokenExist = $db->get('guest_token');
    
                        if(!$tokenExist)
                        {
                            // insert into guest_token table
                            $insertData = array(
                                'token'         => $bkendToken,
                                'client_id'     => $clientID,
                                'sale_id'       => '',
                                'created_at'    => $todayDate,
                            );
                            $insertGuestToken = $db->insert('guest_token', $insertData);
                        }
                    }
                }
            }

            $db->where('code', $promoCode);
            $db->where('disabled', '0');
            $db->where('status', 'Active');
            $promoCodeResult = $db->getOne('mlm_promo_code');

            if(!$promoCodeResult)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
            }

            if($promoCode)
            {
                unset($dataIn);
                $dataIn['promo_code'] = $promoCode;
                $checkPromoCodeValidDate  = Inventory::checkPromoCodeValidDate($dataIn);
    
                if(!$checkPromoCodeValidDate || $checkPromoCodeValidDate['status'] != 'ok')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $checkPromoCodeValidDate['statusMsg'], 'data'=> "");
                }
            }

            $db->where('promo_code_id', $promoCodeResult['id']);
            $db->where('disabled', '0');
            $promoCodeDetail = $db->get('promo_code_detail');

            if(!$promoCodeDetail)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
            }

            if($bkendToken)
            {
                // get shopping cart detail
                $db->where('token', $bkendToken);
                $db->where('disabled', '0');
                $shoppingCart = $db->get('shopping_cart');
            }
            else if(empty($bkendToken))
            {
                $db->where('client_id', $clientID);
                $db->where('disabled', '0');
                $shoppingCart = $db->get('shopping_cart');
            }

            if($promoCodeResult['type'] == 'PWP')
            {
                $cartProductIds = array_column($shoppingCart, 'product_id');
                $promoProductIds = array_column($promoCodeDetail, 'product_id');
                if (count(array_diff($promoProductIds, $cartProductIds)) > 0) {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "", 'promoProductIds' => $promoProductIds, 'cartProductIds' => $cartProductIds);
                }
            }

            foreach ($shoppingCart as $cartDetail) {
                if ($promoCodeResult['type'] == 'PWP') {
                    $matchingDetail = null;
                    foreach ($promoCodeDetail as $codeDetail) {
                        if ($codeDetail['product_id'] == $cartDetail['product_id']) {
                            $matchingDetail = $codeDetail;
                            break;
                        }
                    }

                    if ($matchingDetail !== null && $matchingDetail['quantity'] != $cartDetail['quantity']) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "");
                    }
                }
            }

            $db->where('pcp.promo_code_id', $promoCodeResult['id']);
            $db->where('pcp.disabled', '0');
            $db->where('mpc.type', 'PWP');
            $db->join('mlm_promo_code mpc', 'mpc.id = pcp.promo_code_id');
            $promoCodeProduct = $db->get('promo_code_product pcp');
            if($promoCodeProduct)
            {
                foreach($promoCodeProduct as $promoProduct)
                {
                    $db->where('product_id', $promoProduct['product_id']);
                    $db->where('status', 'Active');
                    $stockAvailable = $db->get('stock');
                    if(!$stockAvailable)
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01233"][$language] /* Invalid Promo Code */, 'data' => "");
                    }
                    unset($dataIn);
                    $dataIn['clientID'] = $clientID;
                    $dataIn['packageID'] = $promoProduct['product_id'];
                    $dataIn['quantity'] = $promoProduct['quantity'];
                    $dataIn['type'] = 'add';
                    $dataIn['product_template'] = '';
                    $dataIn['bkend_token'] = $bkendToken;
                    $dataIn['promo_code'] = $promoCode;

                    unset($cartDetail);
                    $hasProduct = false;
                    foreach ($shoppingCart as $cartDetail) {
                        if ($cartDetail['product_id'] == $promoProduct['product_id']) {
                            $hasProduct = true;
                            // update quantity
                            $updateData = array(
                                'quantity'   => $promoProduct['quantity'],
                                'updated_at' => $dateTime,
                            );
                            $db->where('token', $bkendToken);
                            $db->where('disabled', '0');
                            $db->where('product_id', $promoProduct['product_id']);
                            $db->update('shopping_cart', $updateData);
                            break;
                        }
                    }

                    if ($hasProduct) {
                        return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => $result);
                    }
                    $result = inventory::addShoppingCart($dataIn);

                    if($result['status'] == 'error')
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $result['statusMsg'], 'data' => $result['data']);
                    }
                }
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00684"][$language] /* Update Successful */, 'data' => $result);
        }

        public function checkPromoCodeValidDate($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');

            $promoCode = $params['promo_code'];

            // check if date time is 0000-00-00 00:00:00
            $db->where('disabled', '0');
            $db->where('start_date', '0000-00-00 00:00:00');
            $db->where('end_date', '0000-00-00 00:00:00');
            $db->where('code', $promoCode);
            $db->where('status', 'Active');
            $foreverPromo = $db->getOne('mlm_promo_code');
            if(!$foreverPromo)
            {
                $db->where('disabled', '0');
                $db->where(" '".$dateTime."' BETWEEN start_date AND end_date " );
                // $db->where("(start_date >= ? OR end_date >= ?)", [$dateTime, $dateTime]);
                $db->where('code', $promoCode);
                $db->where('status', 'Active');
                $promo_code_valid = $db->getOne('mlm_promo_code');
    
                if(!count($promo_code_valid))
                {
                    // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01274"][$language] /* This promo code is expired. */, 'data'=> "");
                    return array('status' => "error", 'code' => 1, 'statusMsg' => 'This promo code is expired', 'data'=> "");
                }
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data'=> "");
        }

        public function updateStatusOnCheckout($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');
            $pointsToUse = $params['pointsToUse'];
            $bkendToken  = $params['bkend_token'];
            $promoCode   = trim($params['promo_code']);

            $userID = $db->userID;
            $site = $db->userType;

            // use token to find sale_id
            $db->where('token', $bkendToken);
            $saleID = $db->getOne('guest_token', 'sale_id');
            if($saleID)
            {
                $saleID = $saleID['sale_id'];
            }

            $db->where('sale_id', $saleID);
            $db->where('deleted', '0');
            $saleOrderDetail = $db->get('sale_order_detail');

            // check redeemAmount is enough or not
            if(intval($pointsToUse) != 0 || !empty($pointsToUse))
            {
                $creditBalance = Cash::getBalance($userID, 'gotastyCredit');
                $pointsToUse = number_format($pointsToUse, 2, '.', '');
                if($creditBalance < floatval($pointsToUse))
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01201"][$language] /* Insufficient Point Balance */, 'data' => $creditBalance, 'pointsToUse' => $pointsToUse);
                }
            }

            foreach($saleOrderDetail as $detailChecking)
            {
                unset($dataIn);
                if($detailChecking['product_id'] != '0')
                {
                    $dataIn['product_id'] = $detailChecking['product_id'];
                    $db->where('id', $detailChecking['product_id']);
                    $db->where('deleted', '0');
                    $productType = $db->getOne('product', 'product_type');
                    if(strtolower($productType == 'product'))
                    {
                        $dataIn['text'] = 'cart';
                    }
                    else
                    {
                        unset($dataIn['text']);
                    }
                    $db->where('id', $detailChecking['product_id']);
                    $db->where('deleted', '0');
                    $productIgnoreCount = $db->getOne('product', 'ignore_stock_count');
                    if($productIgnoreCount['ignore_stock_count'] != '1')
                    {
                        $dataIn['quantity'] = $detailChecking['quantity'];
                        $dataOut = Inventory::checkStockQuantity($dataIn);
                        if($dataOut['status'] != 'ok')
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03005"][$language] /* Out Of Stock */, 'data' => $dataOut['data']);
                        }
                    }
                }
            }

            if(!empty($promoCode))
            {
                unset($dataIn);
                $db->where('code', $promoCode);
                $getPromoCode = $db->get('mlm_promo_code');
                if(!$getPromoCode)
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
                }
            }

            if($promoCode)
            {
                unset($dataIn);
                $dataIn['promo_code'] = $promoCode;
                $checkPromoCodeValidDate  = Inventory::checkPromoCodeValidDate($dataIn);
    
                if(!$checkPromoCodeValidDate || $checkPromoCodeValidDate['status'] != 'ok')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $checkPromoCodeValidDate['statusMsg'], 'data'=> "");
                }
            }

            if(!$saleID){
                $db->where('client_id', $userID);
                $db->where('disabled', 0);
                $saleID = $db->getValue('shopping_cart', 'sale_id');

                $db->where('client_id', $userID);
                $db->where('disabled', 0);
                $guestToken = $db->getValue('shopping_cart', 'token');
            }

            if ($userID){
                // $db->where('disabled', 0);
                // $db->where('client_id', $userID);
                // $sale = $db->getOne('shopping_cart');

		        $db->where("invoice_id LIKE 'RECEIPT%' ");
                $db->orderBy("CAST(SUBSTRING(invoice_id, 8) AS UNSIGNED)", "DESC");
                $lastInvRecord = $db->getOne("sale_order");

                if($lastInvRecord) {
                   $last_inv_no = $lastInvRecord["invoice_id"];
                } else {
                   $last_inv_no = "RECEIPT0000";
                }

                $last_inv_no = substr($last_inv_no, 7);
                $next_inv_no = "RECEIPT".sprintf('%04d', ($last_inv_no + 1));


                if ($saleID){
                    $updateData = array(
                        "invoice_id" => $next_inv_no,
                        "invoice_date" => $dateTime, 
                        // "status"    => 'Pending',
                        "updated_at"    => $dateTime,
                    );
                    $db->where('id', $saleID);
                    $db->where('client_id', $userID);
                    $db->update("sale_order", $updateData);
                }
            }
            // use token to do clear cart action.
            // if(!empty($bkendToken))
            // {
            //     $updateData = array(
            //         'disabled'   => '1',
            //         'updated_at' => date('Y-m-d H:i:s'),
            //     );
            //     $db->where('token', $bkendToken);
            //     $db->update('shopping_cart', $updateData);
            // }
            // else
            // {
            //     $updateData = array(
            //         'disabled'   => '1',
            //         'updated_at' => date('Y-m-d H:i:s'),
            //     );
            //     $db->where('client_id', $userID);
            //     $db->update('shopping_cart', $updateData);
            // }

            // get sale order
            unset($saleOrderDetail);
            $db->where('sale_id', $saleID);
            $db->where('deleted', '0');
            $db->where('type', array('package', 'product'), "IN");
            // $db->where('type', 'note', '!=');
            // $db->where('type', 'shipping_fee', '!=');
            $saleOrderDetail = $db->get('sale_order_detail', null, 'subtotal');

            $db->where('id', $saleID);
            $saleOrder = $db->getOne('sale_order');

            if(!empty($promoCode))
            {
                unset($dataIn);
                $dataIn['promo_code'] = $promoCode;
                $dataIn['sale_id']    = $saleID;
                $promoCalculation = Cash::promoCodeCalculation($dataIn);
                if($promoCalculation['status'] == 'error')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01229"][$language] /* Promo Code not found, please check again */, 'data'=> "");
                }

                $data['promo_discount'] = $promoCalculation['data'];
                if(!empty($promoCalculation['data']))
                {
                    $data['total_amount'] = $saleOrder['payment_amount'] - $promoCalculation['data'];
                }
            }
            else
            {
                $data['total_amount'] = $saleOrder['payment_amount'];
                $data['promo_discount'] = 0;
            }

            $data['pointsToUse'] = $pointsToUse;
            if($guestToken){
                $data['guestToken'] = $guestToken;
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
        }

        public function ActiveSerialCheck($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');

            $serial             = $params['serial'];
            $serialProductId    = $params['serialProductId'];
            $po_id              = $params['po_id'];
            $rack_no            = $params['rack_no'];
            
            $adminID = $db->userID;

            if(!$po_id) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00527"][$language] /* Invalid po number */, 'data'=> "");
            }

            // if ($serial){
            //     foreach($serial as $serialDetail)
            //     {
            //         if(empty($serialDetail['serial_number']))
            //         {
            //             return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */, 'data'=> "");
            //         }
            //     }
            // }

            // check is all PO stock in the array
            foreach($serial as $checking)
            {
                $db->where('serial_number',$checking['serial_number']);
                $db->where('status', 'Inactive');
                $result = $db->getOne('stock',null,'id');

                if(!empty($result))
                {
                    $stockIdList[] = $result['id'];
                    // if(!in_array($result['id'],$stockIdList)) $stockIdList[] = $result['id'];
                }
            }

            // make sure no repeated serial number input
            $serialNumbers = array();

            foreach ($serial as $item) {
                $serialNumber = $item['serial_number'];

                if($item['serial_number'] != '')
                {
                    if (in_array($serialNumber, $serialNumbers)) {
                        return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations['E01215'][$language] /* Serial Number is repeated, please check again */, 'data' => $data);
                    }
                }

                $serialNumbers[] = $serialNumber;
            }

            // get the total length
            $db->where('purchase_order_id', $po_id);
            $resultTotal = $db->get('purchase_order_product', null, 'quantity');

            $total = 0;
            if(!empty($resultTotal))
            {
                foreach($resultTotal as $checkingTotal)
                {
                    $total = intval($checkingTotal['quantity']) + intval($total);
                }
            }

            // check serial number is match with the product id or not
            if($serialProductId)
            {
                foreach($serialProductId as $serialDetail)
                {
                    if($serialDetail['serial_number'] != '')
                    {
                        $db->where('serial_number', $serialDetail['serial_number']);
                        $db->where('product_id', $serialDetail['product_id']);
                        $db->where('status', 'Inactive');
                        $result = $db->getOne('stock');
    
                        if(!$result)
                        {
                            # check is this serial number under this PO or not
                            $db->where('po_id', $po_id);
                            $db->where('serial_number', $serialDetail['serial_number']);
                            $db->where('status', 'Active');
                            $existPO = $db->getOne('stock');
                            if(!$existPO)
                            {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */ , 'data' => $serialDetail);
                            }

                            if($existPO)
                            {
                                $repeatedSerialNumInput[] = $existPO['serial_number'];
                            }
                        }
                    }
                }
            }

            if($repeatedSerialNumInput)
            {
                $repeatedSerialOutput = implode(', ', $repeatedSerialNumInput);
                return array('status' => "error", 'code' => 1, 'statusMsg' =>  $translations["E01281"][$language] . ' :' . $repeatedSerialOutput , 'data' => $repeatedSerialOutput); /* The serial number you provided has already been used */
            }

            $db->where('po_id', $po_id);
            $db->where("status", 'Inactive');
            $serial_numberAry= $db->map('serial_number')->get("stock", NULL,"");

            foreach ($serial as $serialRow) {
                if(!$serial_numberAry[$serialRow['serial_number']]){
                    if($serialRow['serial_number'] != '')
                    {   
                        # check is this serial number under this PO or not
                        $db->where('po_id', $po_id);
                        $db->where('serial_number', $serialRow['serial_number']);
                        $db->where('status', 'Active');
                        $existPO = $db->getOne('stock');
                        if(!$existPO)
                        {
                            $serialNotInList[] = $serialRow['serial_number'];
                        }
                    }
                }
                else{
                    $serialInList[$serialRow['serial_number']] = $serialRow['serial_number'];
                }
            }

            $data['serialInList'] = $serialInList;
            $data['serialNotInList'] = $serialNotInList;

            foreach($serial as $serialNumber)
            {
                $number = $serialNumber['serial_number'];
                
                $serialList[] = $number;
            }

            if(!$serialNotInList){

                foreach($serialList as $updateRow)
                {
                    $updateData = array(
                        "status"            => 'Active',
                        "stock_in_datetime" => $dateTime,
                        "updated_at"        => $dateTime,
                        "rack_no"           => $rack_no,
                        "po_id"             => $po_id,
                        // "expiration_date"   => $expiration_date,
                    );

                    $db->where('serial_number', $updateRow);
                    $db->where('status', 'Inactive');
                    $db->update("stock", $updateData);
                }

                // check is there have any inactive status product in stock table or not
                // check the PO list
                $db->where('purchase_order_id', $po_id);
                $purchaseProduct = $db->get('purchase_order_product', null, 'product_id, quantity');

                if($purchaseProduct)
                {
                    foreach($purchaseProduct as $purchaseProductList)
                    {
                        $poProductDetail['product_id'] = $purchaseProductList['product_id'];
                        $poProductDetail['quantity']   = $purchaseProductList['quantity'];

                        $poProductList[] = $poProductDetail;
                    }
                }
                // get the detail full list from PO purchase product
                foreach ($poProductList as $poProduct) {
                    // Get the product ID and quantity
                    $iProductId = $poProduct['product_id'];
                    $iQuantity = $poProduct['quantity'];
                    
                    // Display the product ID and quantity
                    if ($iQuantity > 1) {
                        // If the quantity is greater than 1, display the product multiple times
                        for ($i = 1; $i <= $iQuantity; $i++) {
                            $iProductIdDetail['product_id'] = $iProductId;
                            $iProductIdDetail['quantity'] = '1';
                            $iProductIdList[] = $iProductIdDetail;
                        }
                    } else {
                        // If the quantity is 1, display the product once
                        $iProductIdDetail['product_id'] = $iProductId;
                        $iProductIdDetail['quantity'] = '1';
                        $iProductIdList[] = $iProductIdDetail;
                    }
                }
                // checking the serial number code is able to clear or not
                // if(count($iProductIdList) == count($serial))
                // {
                    // update PO status
                    $db->where('id', $po_id);
                    $poDetails = $db->get('purchase_order');

                    # check if all PO stock is active status
                    $db->where('po_id', $po_id);
                    $db->where('status', 'Inactive');
                    $poNotDoneList = $db->get('stock');

                    if(!$poNotDoneList)
                    {
                        if($poDetails)
                        {
                            $updatePoData = array(
                                "status"            => 'Done',
                                "updated_at"        => $dateTime,
                            );
    
                            try
                            {
                                $db->where('id', $po_id);
                                $poDetails = $db->update('purchase_order', $updatePoData);
                            }
                            catch(Exception $e)
                            {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00131"][$language] /* Update failed */ , 'data' => $data);
                            }
                        }
                    }

                // }
                ///jimmy vim 
                $db->where('purchase_order_id',$po_id);
                $db->update('serial_number',array('updated_at'=>$db->now()));


                // stock movement
                // Get Latest Transfer No + 1 
                $db->orderBy("transfer_no", "DESC");
                $transferNo = $db->getValue("stock_transfer", "transfer_no");

                $numericPart = (int)substr($transferNo, 1); 
                $newTransferValue = "T" . str_pad($numericPart + 1, strlen($transferNo) - 1, '0', STR_PAD_LEFT);

                $db->where('id', $po_id);
                $purchaseOrderDetail = $db->getOne('purchase_order');

                $db->where('id' , $purchaseOrderDetail['warehouse_id']);
                $warehouseDetail = $db->getOne('warehouse');

                $db->where('code', $warehouseDetail['warehouse_location']);
                $db->where('active', '1');
                $locationId = $db->getOne('stock_location');

                $insertStockTransfer = array(
                    'transfer_no'           => $newTransferValue,
                    'total_quantity'        => $purchaseOrderDetail['total_quantity'],
                    'location_id'           => '1',
                    'location_dest_id'      => $locationId['id'],
                    'partner_id'            => $adminID,
                    'created_at'            => $dateTime,
                );
                $insertSTID  = $db->insert('stock_transfer', $insertStockTransfer);

                $db->where("id", $locationId['id']);
                $db->where("active", 1);
                $locationDetails = $db->getOne("stock_location");

                if($locationDetails['usage'] == 'internal'){
                    $spName = $locationDetails['code'] . '/' . 'INT';
                }

                // Generate New Stock Picking Code
                $db->orderBy("id", "DESC");
                $db->where('name', "%" . $spName . "%", 'LIKE');
                $spBackValue = $db->getValue("stock_picking", "name");

                if(!$spBackValue){
                    $spBackValue = $locationDetails['code'] . '/' . 'INT' . '/' . '00000';
                }

                $prefix = substr($spBackValue, 0, 7); 
                $numericPart = (int)substr($spBackValue, 7); 
                $newNumericPart = $numericPart + 1; 
                $newspBackValue = $prefix . str_pad($newNumericPart, 5, '0', STR_PAD_LEFT);

                $insertStockPick = array(
                    'name'                  => $newspBackValue,
                    'origin'                => $newTransferValue,
                    'scheduled_at'          => $dateTime,
                    'date_done'             => $dateTime,
                    'state'                 => 'done',
                    'location_id'           => '1',
                    'location_dest_id'      => $locationId['id'],
                    'partner_id'            => $adminID,
                    'created_at'            => $dateTime,
                );
                $stockPickID  = $db->insert('stock_picking', $insertStockPick);

                $db->where('po_id', $po_id);
                $stockTransferList = $db->get('stock');

                foreach($stockTransferList as $key => $value){

                    $insertMoveline = array(
                        'picking_id'            => $stockPickID,
                        'stock_id'              => $value['id'],
                        'state'                 => 'done',
                        'created_at'            => $dateTime,
                    );
                    $moveLineID  = $db->insert('stock_move_line', $insertMoveline);
                }

                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);

            }else if($serialNotInList){
                $serialNotInList = $data['serialNotInList'];
                $serialNotInListString = implode(', ', $serialNotInList);
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00528"][$language] . $serialNotInListString/* The serial number is not listed in the PO item, and its status is inactive. */, 'data' => $data);
            }
        }

        public function updateStatusOnPacking($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');

            $serial    = $params['serial'];
            $sale_id   = $params['sale_id'];
            $step      = trim($params['step']);
            $serialProductId    = $params['serialProductId'];

            $db->where('id', $sale_id);
            $sale = $db->getOne('sale_order');

            $db->where('so.deleted', '0');
            $db->where('so.so_no', $sale['so_no']);
            $db->join('sale_order_item so', 'a.so_no = so.so_no', 'LEFT');
            $db->join('product p', 'so.product_id = p.id', 'LEFT');
            $getSaleList = $db->get('sale_order a', null, 'a.id, so.product_id, p.name as item_name, p.product_type, a.delivery_method');

            if(!$getSaleList) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01187"][$language] /* Sale order doest not exits */, 'data'=> "");
            }

            if (!$serial){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */, 'data'=> "");
            }

            // check got duplicate serial number or not
            foreach ($serial as $item) {
                if (!in_array($item['serial_number'], $uniqueSerials)) {
                    $uniqueSerials[] = $item['serial_number'];
                } else {
                    $duplicateSerials[] = $item['serial_number'];
                }
            }

            if(!empty($duplicateSerials))
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */ , 'data' => $data);
            }

            $getSaleListProductIds = [];
            foreach ($getSaleList as $saleItem) {
                $getSaleListProductIds[] = $saleItem['product_id'];
            }

            $getSerialIds = [];
            foreach ($serial as $item) {
                $getSerialIds[] = $item['serial_number'];
            }

            $db->orderBy('expiration_date', ASC);
            $db->where("serial_number", $getSerialIds, 'in');
            $serialAry= $db->map('serial_number')->get("stock", NULL,"");

            $existingSerialNumbers = [];
            $nonExistingSerialNumbers = [];

            foreach ($getSerialIds as $serialNumber) {
                if (array_key_exists($serialNumber, $serialAry)) {
                    $existingSerialNumbers[] = $serialNumber;
                } else {
                    $nonExistingSerialNumbers[] = $serialNumber;
                }
            }

            if($nonExistingSerialNumbers){
                $data['existingSerialNumbers'] = $existingSerialNumbers;
                $data['nonExistingSerialNumbers'] = $nonExistingSerialNumbers;

                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01199"][$language] /* Serial number not exist in database */, 'data'=> $data);
            }

            $serialNotInSODetailList = [];
            $productInList = [];
            // Loop through the productid_ary array
            foreach ($serialAry as $productId => $productItem) {
                // Check if the current productId is not in the $getSaleListProductIds array
                if (!in_array($productItem["product_id"], $getSaleListProductIds)) {
                    foreach($serialProductId as $detailSerialChecking)
                    {
                        if($detailSerialChecking['serial_number'] == $productId) // match serial number
                        {
                            if($detailSerialChecking["product_id"] != 0) // check is it mystery product or not
                            {
                                $serialNotInSODetailList[] = $productId;
                            }
                        }
                    }
                }else{
                    $productInList[] = $productItem["product_id"];
                }
            }

            if ($serialNotInSODetailList){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01198"][$language] /* Product not in SO Detail list */, 'data'=> $serialNotInSODetailList);
            }

            $serialNotInStatusActive = [];
            foreach ($serialAry as $serialObj) {
                // Check the "status" value of the object
                if (strtolower($serialObj['status']) !== "active") {
                    $serialNotInStatusActive[] = $serialObj['serial_number'];
                }
            }

            if ($serialNotInStatusActive){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01197"][$language] /* Serial number not in status active */, 'data'=> $serialNotInStatusActive);
            }

            // check serial number is match with the product id or not
            if($serialProductId)
            {
                foreach($serialProductId as $serialDetail)
                {
                    $db->where('serial_number', $serialDetail['serial_number']);
                    if($serialDetail['product_id'] != 0)
                    {
                        $db->where('product_id', $serialDetail['product_id']);
                    }
                    $db->where('status', 'Active');
                    $result = $db->getOne('stock');

                    if(!$result)
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */ , 'data' => $result);
                    }
                }
            }
            if($productInList)
            {
                $db->orderBy('expiration_date', ASC);
                $db->where("product_id", $productInList, 'in');
                $db->where("status", 'Active');
                $serial_numberAry= $db->get("stock", NULL,"");
            }

            $serialGotExtraStock = [];
            $serialtemp = [];
            foreach ($serialAry as $serialObj) {
                $filteredSerialNumberAry = array_filter($serial_numberAry, function($serial) use ($serialObj) {
                    return $serial['product_id'] ==  $serialObj['product_id'];
                });

                foreach ($filteredSerialNumberAry as $filterObj) {
                    if($filterObj['expiration_date'] >= $serialObj['expiration_date'] && !in_array($filterObj['id'], $serialtemp)){
                        $serialtemp[$filterObj['id']] = $filterObj['id'];
                        break;
                    }else{
                        if(!in_array($filterObj['id'], $serialtemp)){
                            $serialGotExtraStock[$serialObj['serial_number']] = $serialObj['serial_number'];
                            // get the product_id
                            $db->where('serial_number', $serialObj['serial_number']);
                            $db->where('status', 'Active');
                            $stockDetails = $db->getOne('stock', 'product_id');
                            if(!empty($stockDetails))
                            {
                                $productId = $stockDetails['product_id'];

                                // use the product id to get the earliest date from stock table
                                $db->orderBy('expiration_date', 'ASC');
                                $db->where('product_id', $productId);
                                $db->where('status', 'Active');
                                $earlierProduct = $db->get('stock', null, 'product_id, serial_number, expiration_date');

                                if(!empty($earlierProduct))
                                {
                                    // display the product
                                    foreach($earlierProduct as $earlierListing)
                                    {
                                        // filter until the issue product
                                        if($earlierListing['serial_number'] != $serialObj['serial_number'])
                                        {
                                            $earlierStock['serial_number']   = $earlierListing['serial_number'];
                                            $earlierStock['product_id']      = $earlierListing['product_id'];
                                            $earlierStock['expiration_date'] = $earlierListing['expiration_date'];
                                        }
             
                                        if (!in_array($earlierStock, $earlierStockList))
                                        {
                                            $earlierStockList[] = $earlierStock;
                                        }
                                    }
                                }
                            }
                            $dataDetail['serial_number'] = $serialObj['serial_number'];
                            $dataDetail['product_id']    = $productId;
                            if (!in_array($dataDetail, $details))
                            {
                                $details[] = $dataDetail;
                            }
                        }
                    }
                }
            }

            // check serial number is belong to the product or not
            foreach($serial as $productDetail)
            {
                // get product id
                $db->where('name', $productDetail['item_name']);
                $productID = $db->getOne('product','id');
                if($productID)
                {
                    $productID = $productID['id'];
                    // check stock table with product id and serial number
                    $db->where('product_id', $productID);
                    $db->where('serial_number', $productDetail['serial_number']);
                    $productMatch = $db->get('stock');

                    if(empty($productMatch))
                    {
                        $notMatchSerialNumberDetail['product_name'] = $productDetail['item_name'];
                        $notMatchSerialNumberDetail['serial_number'] = $productDetail['serial_number'];
                        $notMatchList[] = $productDetail['item_name'];
                    }
                }
            }

            $data['notMatchList'] = $notMatchList;
            if(!empty($notMatchList))
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01195"][$language] /* The serial number is not belong to the product, please check again */, 'data'=> $data);
            }

            if($step != '1')
            {
                if ($serialGotExtraStock){

                    usort($earlierStockList, function($a, $b) {
                        return strtotime($a['expiration_date']) - strtotime($b['expiration_date']);
                    });

                    $data['Issue_Stock'] = $details;
                    $data['Earlier_Stock_List'] = $earlierStockList;
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01196"][$language] /* There is extra stock inside the refrigerator */, 'data'=> $data);
                }
            }
            if($existingSerialNumbers){

                $updateData = array(
                    "status"                => 'Sold',
                    "so_id"                 => $sale_id,
                    "updated_at"            => $dateTime,
                );
                $db->where('serial_number', $existingSerialNumbers, "in");
                $db->update("stock", $updateData);

                // check is the SO finish stock in or not
                
                // 1. get all product_id from sale_order_item
                // 2. do a checking for each product_id
                foreach($getSaleList as $checkSoDetails)
                {
                    // 3. check every product_id got so_id in stock table
                    $db->where('product_id', $checkSoDetails['product_id']);
                    $db->where('so_id', $sale_id);
                    $db->where('status', 'Active');
                    $checkingResult = $db->get('stock');

                    // 4. check all DO finish
                    $db->where('do.so_id', $sale_id);
                    $db->join('inv_delivery_order_detail dod', 'dod.inv_delivery_order_id = do.id', 'LEFT');
                    $deliveryOrderList = $db->get('inv_delivery_order do');
                    
                    $notCompleteDO = array();
                    $db->where('id', $sale_id);
                    $saleOrderInfo = $db->getOne('sale_order');
                    if(strtolower($saleOrderInfo['delivery_method']) != 'pickup')
                    {
                        foreach($deliveryOrderList as $detailCheck)
                        {
                            if(strtolower($detailCheck['status']) != 'pending for pickup')
                            {
                                $notCompleteDO[] = $detailCheck;
                            }
                        }
                    }
                    
                    // 5. check all item in SO are stock out
                    $db->where('so.so_no', $sale['so_no']);
                    $db->where('so.deleted', '0');
                    $saleOrderDetail = $db->get('sale_order_item so');

                    $db->where('so_id', $sale_id);
                    $db->where('status', 'sold');
                    $stockListDetail = $db->get('stock');

                    if((count($stockListDetail) == count($saleOrderDetail)) && (count($notCompleteDO) == 0))
                    {
                        if(empty($checkingResult))
                        {
                            // 6. update SO to packaging status.
                            $updateData = array(
                                "status"                => 'Packed',
                                "updated_at"            => $dateTime,
                            );
    
                            $db->where('id', $sale_id);
                            try
                            {
                                $updateSo = $db->update('sale_order', $updateData);
                            }
                            catch (Exception $e)
                            {
                                // failed to update SO status
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00143"][$language] /* Update failed */, 'data'=> "");
                            }
                        }
                    }
                }

		        //keep stock tracking
                $db->where("active", 1);
                $db->where("name", "Customers");
                $new_location_id = $db->getValue("stock_location", "id") ?? 0;

		        $location_code = "KL";//temp define

                $db->where("active", 1);
                $db->where("name", "Stock");
		        $db->where("code", $location_code);
                $location_id = $db->getValue("stock_location", "id") ?? 0;

                //$db->where("id", $stock_location);
                //$location_code = $db->getValue("stock_location", "code");

                $db->where("name LIKE '".$location_code."/OUT/%'");
                $db->orderBy("CAST(SUBSTRING(name, 8) AS UNSIGNED)", "DESC");
                $lastPickRecord = $db->getOne("stock_picking");

                if($lastPickRecord) {
                   $last_picking_no = $lastPickRecord["name"];
                } else {
                   $last_picking_no = $location_code."/OUT/00000";
                }

                $arrPickingItem = explode("/", $last_picking_no);
                $last_running_no = $arrPickingItem[count($arrPickingItem)-1];
                $next_running_no = sprintf('%05d', ($last_running_no + 1));
                $next_picking_no = $location_code."/OUT/".$next_running_no;

                $db->where("id", $sale_id);
                $soDetail = $db->getOne("sale_order");
                $so_no = $soDetail["so_no"] ?? "";
                $vendorID = $soDetail["client_id"] ?? 0;

                $pickingData["name"] = $next_picking_no;
                $pickingData["origin"] = $so_no;
                $pickingData["state"] = "done";
                $pickingData["scheduled_at"] = date("Y-m-d H:i:s", strtotime($dateTime));
                $pickingData["date_done"] = date("Y-m-d H:i:s", strtotime($dateTime));
                $pickingData["location_id"] = $location_id;
                $pickingData["location_dest_id"] = $new_location_id;
                $pickingData["partner_id"] = $vendorID;
                $pickingData["created_at"] = date("Y-m-d H:i:s", strtotime($dateTime));
                $pickingData["updated_at"] = date("Y-m-d H:i:s", strtotime($dateTime));
                $pickID = $db->insert("stock_picking", $pickingData);

                $db->where("so_id", $sale_id);
                $db->where("status", "Sold");
                $arrSoldStock = $db->get("stock");

                foreach($arrSoldStock as $key => $value) {
                    $moveLineData["picking_id"] = $pickID;
                            $moveLineData["stock_id"] = $value["id"];
                            $moveLineData["state"] = "done";
                            $moveLineData["created_at"] = date("Y-m-d H:i:s", strtotime($dateTime));
                    $db->insert("stock_move_line", $moveLineData);
		        }

                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
            }
        }

        public function updatePackageStatusOnPacking($params){
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];
            $dateTime = date('Y-m-d H:i:s');

            $serial    = $params['serial'];
            $sale_id   = $params['sale_id'];
            $step      = trim($params['step']);

            $sale = $db->getOne('sale_order');

            $db->where('b.deleted', 0);
            $db->where('a.id', $sale_id);
            $db->where('b.product_id', 0, '!=');
            $db->where('b.product_id', null, 'IS NOT');
            $db->join('sale_order_detail b', 'a.id = b.sale_id', 'LEFT');
            $db->join('product p', 'b.product_id = p.id', 'LEFT');
            $getSaleList = $db->get('sale_order a', null, 'a.id, b.product_id, b.item_name, p.product_type');

            if(!$getSaleList) {
                return array('status' => "error", 'code' => 23, 'statusMsg' => $translations["E01187"][$language] /* Sale order doest not exits */, 'data'=> "");
            }

            if (!$serial){
                return array('status' => "error", 'code' => 15, 'statusMsg' => $translations["B00526"][$language] /* Invalid serial number */, 'data'=> "");
            }

            // use getSaleList to retrieve package detail
            foreach($getSaleList as $salePackageDetail)
            {
                if(strtolower($salePackageDetail['product_type']) == 'package')
                {
                    $db->where('package_id', $salePackageDetail['product_id']);
                    $db->where('deleted', 0);
                    $getPackageDetail = $db->get('package_item');
                }
            }

            // check is the data in match all of the item in SO
            $db->where('sale_id', $sale_id);
            $db->where('deleted', '0');
            $db->where('product_id', 0, '!=');
            $db->where('product_id', null, 'IS NOT');
            $soDetail = $db->get('sale_order_detail',null,'product_id,quantity');

 
   
            // get the product from the package
            foreach ($soDetail as $item) 
            {
                if($item['product_id'] != '0')
                {
                    $db->where('package_id', $item['product_id']);
                    $db->where('deleted', 0);
                    $packageDetail = $db->get('package_item', null, 'product_id, quantity');
                    foreach($packageDetail as $detail)
                    {
                        for ($j = 0; $j < intval($detail['quantity']); $j++) {
                            $packageData['product_id'] = $detail['product_id'];
                            $packageData['quantity']   = '1';
                            $PackageList[] = $packageData;
                        }
                    }
                }
            }

            // check count match or not
            // if(count($PackageList) != count($serial))
            // {
            //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01192"][$language] /* Please key in serial number for all stock */ , 'data' => $PackageList, 'serial' => $serial);
            // }

            $getSaleListProductIds = [];
            foreach ($getPackageDetail as $saleItem) {
                $getSaleListProductIds[] = $saleItem['product_id'];
            }

            $getSerialIds = [];
            foreach ($serial as $item) {
                $getSerialIds[] = $item['serial_number'];
            }

            $db->orderBy('expiration_date', ASC);
            $db->where("serial_number", $getSerialIds, 'in');
            $serialAry= $db->map('serial_number')->get("stock", NULL,"");

            $existingSerialNumbers = [];
            $nonExistingSerialNumbers = [];

            foreach ($getSerialIds as $serialNumber) {
                if (array_key_exists($serialNumber, $serialAry)) {
                    $existingSerialNumbers[] = $serialNumber;
                } else {
                    $nonExistingSerialNumbers[] = $serialNumber;
                }
            }
            // print_r(json_encode($getSerialIds)."\n\n");
            // exit;
            if($nonExistingSerialNumbers){
                $data['existingSerialNumbers'] = $existingSerialNumbers;
                $data['nonExistingSerialNumbers'] = $nonExistingSerialNumbers;

                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01199"][$language] /* Serial number not exist in database */, 'data'=> $data);
            }

            $serialNotInSODetailList = [];
            $productInList = [];
            // Loop through the productid_ary array

            foreach ($serialAry as $productId => $productItem) {
                // Check if the current productId is not in the $getSaleListProductIds array and 0 is not present in the array
                if (!in_array($productItem["product_id"], $getSaleListProductIds) && !in_array(0, $getSaleListProductIds)) {
                    // echo "ID {$productItem['product_id']} (serial number: $productId) is not in the getSaleList array. \n";
                    $serialNotInSODetailList[] = $productId;
                } else {
                    $productInList[] = $productItem["product_id"];
                }
            }
                        
            if ($serialNotInSODetailList){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01198"][$language] /* Product not in SO Detail list */, 'data'=> $serialNotInSODetailList);
            }

            $serialNotInStatusActive = [];
            foreach ($serialAry as $serialObj) {
                // Check the "status" value of the object
                if (strtolower($serialObj['status']) !== "active") {
                    $serialNotInStatusActive[] = $serialObj['serial_number'];
                }
            }

            if ($serialNotInStatusActive){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01197"][$language] /* Serial number not in status active */, 'data'=> $serialNotInStatusActive);
            }
            try
            {
                $db->orderBy('expiration_date', 'ASC');
                $db->where("product_id", $productInList, 'in');
                $db->where("status", 'Active');
                $serial_numberAry= $db->get("stock", NULL,"");
            }
            catch (Exception $e) {
                return array('status' => "error", 'code' => 110, 'statusMsg' => $e->getMessage() , 'data' => $lq, 'productInList' => $productInList);
            }

            $serialGotExtraStock = [];
            $serialtemp = [];
            foreach ($serialAry as $serialObj) {
                $filteredSerialNumberAry = array_filter($serial_numberAry, function($serial) use ($serialObj) {
                    return $serial['product_id'] ==  $serialObj['product_id'];
                });

                foreach ($filteredSerialNumberAry as $filterObj) {
                    // print_r(json_encode($serialtemp)."\n\n");
                    // print_r($serialObj['id']. " .:. ". $serialObj['product_id']." .:. ". $serialObj['serial_number']." .:. ".($serialObj['expiration_date']).
                    //         " || ".$filterObj['id']." .:. ". $filterObj['product_id']." .:. ". $filterObj['serial_number']." .:. ".($filterObj['expiration_date'])."\n\n");
                    if($filterObj['expiration_date'] >= $serialObj['expiration_date'] && !in_array($filterObj['id'], $serialtemp)){
                        // print_r("aaa"."\n");
                        // print_r(json_encode($serial_numberAry)."\n\n");
                        // unset($serial_numberAry[$key]);
                        $serialtemp[$filterObj['id']] = $filterObj['id'];
                        break;
                    }else{
                        // print_r("test:".$filterObj['id']."\n");
                        if(!in_array($filterObj['id'], $serialtemp)){
                            // print_r($serialObj['id']. " .:. ". $serialObj['product_id']." .:. ". $serialObj['serial_number']." .:. ".($serialObj['expiration_date']).
                            // " || ".$filterObj['id']." .:. ". $filterObj['product_id']." .:. ". $filterObj['serial_number']." .:. ".($filterObj['expiration_date'])."\n\n");
                            // print_r('bbb \n');
                            $serialGotExtraStock[$serialObj['serial_number']] = $serialObj['serial_number'];
                            // get the product_id
                            $db->where('serial_number', $serialObj['serial_number']);
                            $db->where('status', 'Active');
                            $stockDetails = $db->getOne('stock', 'product_id');
                            if(!empty($stockDetails))
                            {
                                $productId = $stockDetails['product_id'];

                                // use the product id to get the earliest date from stock table
                                $db->orderBy('expiration_date', 'ASC');
                                $db->where('product_id', $productId);
                                $db->where('status', 'Active');
                                $earlierProduct = $db->get('stock', null, 'product_id, serial_number, expiration_date');

                                if(!empty($earlierProduct))
                                {
                                    // display the product
                                    foreach($earlierProduct as $earlierListing)
                                    {
                                        // filter until the issue product
                                        if($earlierListing['serial_number'] != $serialObj['serial_number'])
                                        {
                                            $earlierStock['serial_number']   = $earlierListing['serial_number'];
                                            $earlierStock['product_id']      = $earlierListing['product_id'];
                                            $earlierStock['expiration_date'] = $earlierListing['expiration_date'];
                                        }
             
                                        if (!in_array($earlierStock, $earlierStockList))
                                        {
                                            $earlierStockList[] = $earlierStock;
                                        }
                                    }
                                }
                            }
                            $dataDetail['serial_number'] = $serialObj['serial_number'];
                            $dataDetail['product_id']    = $productId;
                            if (!in_array($dataDetail, $details))
                            {
                                $details[] = $dataDetail;
                            }
                        }
                    }
                }
            }

            // check serial number is belong to the product or not
            foreach($serial as $productDetail)
            {
                // get product id
                $db->where('name', $productDetail['item_name']);
                $productID = $db->getOne('product','id');
                if($productID)
                {
                    $productID = $productID['id'];
                    // check stock table with product id and serial number
                    $db->where('product_id', $productID);
                    $db->where('serial_number', $productDetail['serial_number']);
                    $productMatch = $db->get('stock');

                    if(empty($productMatch))
                    {
                        $notMatchSerialNumberDetail['product_name'] = $productDetail['item_name'];
                        $notMatchSerialNumberDetail['serial_number'] = $productDetail['serial_number'];
                        $notMatchList[] = $productDetail['item_name'];
                    }
                }
            }

            $data['notMatchList'] = $notMatchList;
            if(!empty($notMatchList))
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01195"][$language] /* The serial number is not belong to the product, please check again */, 'data'=> $data);
            }

            if($step != '1')
            {
                if ($serialGotExtraStock){

                    usort($earlierStockList, function($a, $b) {
                        return strtotime($a['expiration_date']) - strtotime($b['expiration_date']);
                    });

                    $data['Issue_Stock'] = $details;
                    $data['Earlier_Stock_List'] = $earlierStockList;
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["E01196"][$language] /* There is extra stock inside the refrigerator */, 'data'=> $data);
                }
            }
            if($existingSerialNumbers){

                // $updateData = array(
                //     "status"                => 'Sold',
                //     "so_id"                 => $sale_id,
                //     "updated_at"            => $dateTime,
                // );
                // $db->where('serial_number', $existingSerialNumbers, "in");
                // $db->update("stock", $updateData);

                // check is the SO finish stock in or not
                
                // 1. get all product_id from sale_order_detail
                // 2. do a checking for each product_id
                foreach($getSaleList as $checkSoDetails)
                {
                    // 3. check every product_id got so_id in stock table
                    $db->where('product_id', $checkSoDetails['product_id']);
                    $db->where('so_id', $sale_id);
                    $db->where('status', 'Active');
                    $checkingResult = $db->get('stock');

                    if(empty($checkingResult))
                    {
                        // // 4. update SO to packaging status.
                        // $updateData = array(
                        //     "status"                => 'Packed',
                        //     "updated_at"            => $dateTime,
                        // );

                        // $db->where('id', $sale_id);
                        // try
                        // {
                        //     $updateSo = $db->update('sale_order', $updateData);
                        // }
                        // catch (Exception $e)
                        // {
                            // failed to update SO status
                            // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00143"][$language] /* Update failed */, 'data'=> "");
                        // }
                    }
                }

                return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $data);
            }
        }

        public function updateStatusOnTracking($params)
        {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date('Y-m-d H:i:s');

            $sale_id        = $params['sale_id'];

            // Check is the sale id existing or not
            $db->where('id', $sale_id);
            $sale = $db->getOne('sale_order');

            $db->where('b.deleted', 0);
            $db->where('status', 'Packed');
            $db->where('a.id', $sale_id);
            $db->join('sale_order_detail b', 'a.id = b.sale_id', 'LEFT');
            $getSaleList = $db->get('sale_order a', null, 'a.id, b.product_id, b.item_name');
            
            if(!$getSaleList) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01187"][$language] /* Sale order doest not exits */, 'data'=> "");
            }

            $db->where('do.so_id', $sale_id);
            $db->join('inv_delivery_order_detail dod', 'dod.inv_delivery_order_id = do.id', 'LEFT');
            $deliveryOrderList = $db->get('inv_delivery_order do');
            
            $notCompleteDO = array();
            foreach($deliveryOrderList as $detailCheck)
            {
                if(strtolower($detailCheck['status']) != 'pending for pickup' && strtolower($detailCheck['status']) != 'cancelled')
                {
                    $notCompleteDO[] = $detailCheck;
                }
            }

            $db->where('so_no', $sale['so_no']);
            $db->where('deleted', '0');
            $saleOrderDetail = $db->get('sale_order_item');

            $db->where('so_id', $sale_id);
            $db->where('status', 'sold');
            $stockListDetail = $db->get('stock');

            if((count($stockListDetail) == count($saleOrderDetail)) && (count($notCompleteDO) == 0))
            {
                $updateData = array(
                    "status"                => "Out For Delivery",
                    "updated_at"            => $dateTime,
                );
    
                $db->where('id', $sale_id);
                $result = $db->update('sale_order', $updateData);

                $updateData = array(
                    'status' => 'In Transit',
                    "updated_at"            => $dateTime,
                );
                $db->where('so_id', $sale_id);
                $db->where('status', 'Pending for Pickup');
                $db->update('inv_delivery_order', $updateData);
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => '', 'data' => $result);
        }

        public function updateStatusOnDelivered($params)
        {
            $db             = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTime       = date('Y-m-d H:i:s');

            $saleID         = trim($params['saleID']);

            if(empty($saleID))
            {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
            }

            $db->where('id', $saleID);
            $result = $db->get('sale_order');

            if(empty($result))
            {
                return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00101"][$language] /* No Results Found */, 'data' => $data);
            }

            // get sale id detail
            $db->where('id', $saleID);
            $saleDetails = $db->getOne('sale_order', 'client_id, (release_amount - shipping_fee) AS net_amount, status, delivery_method');

            $updateData = array(
                'status' => 'Delivered',
                'updated_at' => $dateTime
            );

            if(strtolower($saleDetails['delivery_method']) == 'pickup')
            {
                $db->where('id', $saleID);
                $db->where('status', array('Packed'), 'IN');
                $db->update('sale_order', $updateData);
            }
            else
            {
                $db->where('id', $saleID);
                $db->where('status', array('Out of Delivery', 'Out For Delivery'), 'IN');
                $db->update('sale_order', $updateData);
            }

            $updateData = array(
                'status' => 'Delivered',
                'updated_at' => $dateTime
            );
            if(strtolower($saleDetails['delivery_method']) == 'pickup')
            {
                $db->where('status', 'Pending for Pickup');
            }
            else
            {
                $db->where('status', 'In Transit');
            }
            $db->where('so_id', $saleID);
            $db->update('inv_delivery_order', $updateData);

            // if update successfull, assign point to member
            unset($dataIn);
            $dataIn['id']               = $saleDetails['client_id'];
            $dataIn['creditType']       = 'memberDef';
            $dataIn['adjustmentType']   = 'Adjustment In';
            $dataIn['adjustmentAmount'] = $saleDetails['net_amount'];
            $dataIn['isMember']         = '1';

            $clientID = $saleDetails['client_id'];
            $adjustAmount =  floor($saleDetails['net_amount']);
            $batchID = $db->getNewID();

            $updateData = array(
                'rewarded_point' => $adjustAmount
            );

            $db->where('id', $saleID);
            $db->update('sale_order', $updateData);
            try
            {
                //Wallet::creditAdjustment($dataIn);
		        Cash::insertTAccount(9,$clientID, 'bonusDef', $adjustAmount, 'Sales Reward', $batchID, $saleID, $db->now(), $batchID, $clientID, $remark);
                Inventory::calculatePaySponsor($clientID,$saleID,$adjustAmount,$batchID);
            }
            catch(Exception $e)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00131"][$language] /* Update failed. */, 'data' => "");
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00123"][$language] /* Confirm */, 'data' => '');
        }

        public function calculatePaySponsor ($clientID,$saleID,$adjustAmount,$belongID) {
            $db = MysqliDb::getInstance();
            $dateTime = date("Y-m-d H:i:s");
            $batchID = $db->getNewID();
            $sponsorAmount = 2000;
            $tableName = 'mlm_bonus_direct_sponsor';

            if ($adjustAmount < 100) return false;

            $db->where('id',$clientID);
            $uplineUsername = $db->getValue('client','sponsor_id'); //sponsor username

            if ($uplineUsername == 0) return false;
            $db->where('username',$uplineUsername);
            $uplineID = $db->getValue('client','id');

            $db->where('client_id',$uplineID);
            if ($db->has($tableName)) return false;

            $insertArray = array(
                'client_id' => $uplineID,
                'bonus_date' => $dateTime,
                'from_sales_id' => $saleID,
                'from_id' => $clientID,
                'from_amount' => $adjustAmount,
                'calculated_amount' => $sponsorAmount,
                'unit_price' => 1,
                'payable_amount' => $sponsorAmount,
                'paid' => 1,
                'batch_id' => $batchID,
                'created_at' => $dateTime,
            );
            $bool = $db->insert($tableName,$insertArray);

            if ($bool) Cash::insertTAccount(9,$uplineID, 'bonusDef', $sponsorAmount, 'Sponsor Bonus', $batchID, "", $dateTime, $batchID, $uplineID);

            return true;
        }

        public function getVideoURL($params) {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $imageGroupUniqueChar   = self::generateUniqueChar();
            $dateTime               = date("Y-m-d H:i:s");

            $templateValue         = $params['templateValue'];
            // $type                  = $params['type'];
            // $templateValue2         = $params['templateValue2'];

            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["A01078"][$language] /* Access denied. */,'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if($templateValue){
                $data['video'] = $templateValue;
            }
            // if($templateValue1){
            //     $data['video1'] = $templateValue1;
            // }
            // if($templateValue2){
            //     $data['video2'] = $templateValue2;
            // }

            foreach($data as $key => $value){
                $db->where("name", $value);
                $db->where("status", 'Active');
                $getID = $db->getValue("cooking_suggestion", "id");

                $db->where("name", $value);
                $db->where("status", 'Active');
                $getURL = $db->getValue("cooking_suggestion", "defaultURL");

                $db->where("name", $value);
                $db->where("status", 'Active');
                $getCookingTime = $db->getValue("cooking_suggestion", "cooking_time");

                $db->where("name", $value);
                $db->where("status", 'Active');
                $getDesc = $db->getValue("cooking_suggestion", "description");

                if ($key === "video") {
                    $output['video'] = $getURL; 
                    $output['cookingTime'] = $getCookingTime; 
                    $output['description'] = $getDesc; 
                }
                
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00123"][$language] /* Confirm */, 'data' => $output);
        }

        public function getPrintSerial($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;

            $productID = $params['product_id'];

            $db->where('product_id', $productID);
            $db->where('status', 'inactive', '!=');
            $getStockList = $db->get('stock', null, 'product_id, serial_number, expiration_date');

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00123"][$language] /* Confirm */, 'data' => $getStockList);
        }

        public function addFavouriteList($params) {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;

            $productId              = $params['product_id'];
            
            if(empty($productId))
            {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00955"][$language] /* Invalid Product */,'data'=>'');
            }

            // use product id to get categ id
            $db->where('id', $productId);
            $db->where('deleted', '0');
            $productDetail = $db->getOne('product');

            if(empty($productDetail))
            {
                return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00955"][$language] /* Invalid Product */,'data'=>'');
            }

            $insertData = array(
                'categ_id'      => $productDetail['categ_id'],
                'product_id'    => $productId,
                'client_id'     => $userID,
                'disabled'      => 0,
                'created_at'    => $dateTime,
            );

            $db->insert('favourite_list', $insertData);

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["M04110"][$language] /* Added Favourite List */, 'data' => '');
        }

        public function editFavouriteList($params) {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;

            $id                     = $params['id'];
            $action                 = $params['action'];

            if(strtolower($action) == 'delete')
            {
                $editData = array(
                    'disabled'  => 1,
                );

                $db->where('client_id', $userID);
                $db->where('disabled', '0');
                $db->where('id', $id);
                $db->update('favourite_list', $editData);
            }

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00370"][$language] /* Sucessfully Updated */, 'data' => '');
        }

        public function addPackageInventory($params) {
            include('config.php');
        
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $imageGroupUniqueChar   = self::generateUniqueChar();
            $dateTime               = date("Y-m-d H:i:s");
        
            $productType    = trim($params['productType']);
            $description    = trim($params['description']);
            $name           = $params['invPackageName'];
            $skuCode        = trim($params['skuCode']);
            $salePrice      = trim($params['salePrice']);
            $vendorId       = trim($params['vendorId']);
            $category       = $params['category'];
            $uploadImage    = $params['uploadImage'];
            $uploadVideo    = $params['uploadVideo'];
            $isPublish      = $params['isPublish'];
            $isArchive      = $params['isArchive'];
            $isIgnore       = $params['isIgnore'];
            $package        = $params['package'];
            $packageDesc    = $params['packageDesc'];
            $cookingSuggestInput     = $params['cookingSuggestionName'];
            $cookingSuggestUrl       = $params['cookingSuggestionUrl'];
            $cookingSuggestRemark    = $params['cookingSuggestionRemark'];
            $remarkArr               = $params['remarkArray'];
            $deliveryMethod          = $params['deliveryMethod'];
            $foc                     = $params['foc'];
            $cost                    = $params['cost'];

            // Variant
            // $isVariant      = trim($params["isVariant"]) ? 1 : 0;
            // $variant        = $params["variants"];
        
            //Package
            $packageList    = $params['packageProduct'];

            // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["B00370"][$language] /* Sucessfully Updated */, 'data' => $cookingSuggestRemark);
        
            $userID = $db->userID;
            $site = $db->userType;
        
            if(!$userID) {
                return array('status'=>'error','code'=>2,'statusMsg'=> $translations["A01078"][$language] /* Access denied. */,'data'=>'');
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");
        
                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid Admin */,'data'=>'');
                }
            }

            if(empty($name))
            {
                $errorFieldArr[] = array(
                    'id'  => "nameError",
                    'msg' => $translations['E01211'][$language] /* Package name cannot be empty. */
                );
            }

            if(!$category) {
                $errorFieldArr[] = array(
                    'id'  => "categoryError",
                    'msg' => $translations['E01206'][$language] /* Please select Category. */
                );
                $category = '[""]';
            }
            else
            {
                $category = json_encode($category);
            }

            if(!$deliveryMethod) {
                $errorFieldArr[] = array(
                    'id'  => "deliveryMethodError",
                    'msg' => $translations['A01782'][$language] /* Please select a delivery method */
                );
            }

            if(!$salePrice)
            {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01212'][$language] /* Sales Price cannot be empty. */
                );
            }

            if ($cost > $salePrice) {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01314'][$language] /* Sales Price cannot be empty. */
                );
            }

            // if($salePrice <= 0)
            // {
            //     $errorFieldArr[] = array(
            //         'id'  => "salePriceError",
            //         'msg' => $translations['E01212'][$language] /* Please enter a valid sale price */
            //     );
            // }
            if(empty($description))
            {
                $errorFieldArr[] = array(
                    'id'  => "descriptionError",
                    'msg' => $translations['E01213'][$language] /* Description cannot be empty. */
                );
            }

            if(empty($packageList))
            {
                $errorFieldArr[] = array(
                    'id'  => "packageError",
                    'msg' => $translations['E01224'][$language] /* Must have at least one product in this package. */
                );
            }

            if(empty($vendorId))
            {
                $errorFieldArr[] = array(
                    'id'  => "vendorIdError",
                    'msg' => $translations['E00986'][$language] /* Please Select Vendor. */
                );
            }

            if(!$uploadImage) {
                if($imageId){
                    //If not upload Image and got delete Image => need to check if got any image left, if no prompt error.
                    $db->where('id', $imageId, 'NOT IN');
                    $db->where('type', 'video', '!=');
                    $db->where('type', 'otherVid', '!=');
                    $db->where('deleted', '0');
                    $db->where('reference_id', $productInvId);
                    $checkImageLeft = $db->getValue('product_media', 'id');
                    if(!$checkImageLeft){
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        );
                    }
                }
                
                $db->where('reference_id', $productInvId);
                $db->where('deleted', '0');
                $db->where('type', 'video', '!=');
                $db->where('type', 'otherVid', '!=');
                $uploadImageList = $db->getOne('product_media');
                if(!$uploadImageList)
                {
                    $errorFieldArr[] = array(
                        'id'  => "imgError",
                        'msg' => $translations["E01069"][$language] /* Please upload image. */
                    );

                    
                    // return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01012"][$language] /* Please upload image */, 'data'=>'');
                }    
            }

            if (is_array($uploadImage)) {

                foreach ($uploadImage as $key => $value) {

                    if (!$value['uploadType']) {
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        
                        );
                    }
                }
            }

            if(!empty($packageList))
            {
                foreach($packageList as $checkPackageQuantity)
                {
                    if(empty($checkPackageQuantity['quantity']) || intval($checkPackageQuantity['quantity']) < 0)
                    {
                        $errorFieldArr[] = array(
                            'id'  => "packageError",
                            'msg' => $translations['E01224'][$language] /* Must have at least one product in this package. */
                        );
                    }
                }
            }

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }

            $insertInv = array(
                "name"               => $name,
                "product_type"       => 'package',
                "description"        => $description,
                "barcode"            => $skuCode,
                "cost"               => $cost,
                "sale_price"         => $salePrice,
                "vendor_id"          => $vendorId,
                "categ_id"           => $category,
                "delivery_method"    => $deliveryMethod,
                "is_published"       => $isPublish,
                "is_archive"         => $isArchive,
                "ignore_stock_count" => $isIgnore,
                "created_at"         => $dateTime
            );
            
            $productInvId = $db->insert('product', $insertInv);

            // Get System Languages
            $db->where("disabled", 0);
            $languages = $db->map("language_code")->get("languages", NULL, "language_code, language");

            if($package){
                foreach($package as $key => $value){
                    $insertInvLan = array(
                        "module"               => 'package',
                        "module_id"            => $productInvId,
                        "type"                 => 'name',
                        "language"             => $value['language'],
                        "content"              => $value['name'],
                        "updated_at"           => $dateTime
                    );
                    $invLanID = $db->insert('inv_language', $insertInvLan);
                }
            }

            if($packageDesc){
                foreach($packageDesc as $key => $value){
                    $insertInvLan2 = array(
                        "module"               => 'package',
                        "module_id"            => $productInvId,
                        "type"                 => 'description',
                        "language"             => $value['language'],
                        "content"              => $value['description'],
                        "updated_at"           => $dateTime
                    );
                    $invLanID = $db->insert('inv_language', $insertInvLan2);
                }
            }

            $cookingSuggestArr = array();
            for ($i = 0; $i < count($cookingSuggestInput); $i++) {
                $cookingSuggestArr[] = array(
                    'name' => $cookingSuggestInput[$i]['content'],
                    'url' => $cookingSuggestUrl[$i]['content'],
                    'remark' => $cookingSuggestRemark[$i]['content']
                );
            }

            foreach($cookingSuggestArr as $key => $value){
                $db->where('name',  $cookingSuggestArr[$key]['name']);
                $getCookingSuggestID = $db->getValue('cooking_suggestion','id');

                $editCookingDetail = array(
                    "url"               => $cookingSuggestArr[$key]['url'],
                    "remark"            => $cookingSuggestArr[$key]['remark'],
                    "product_id"        => $productInvId,
                    "suggestion_id"     => $getCookingSuggestID,
                    "created_at"        => $dateTime,
                );
                $editCookingSuggestDetail = $db->insert("cooking_suggestion_details", $editCookingDetail);
                $remarkIDList[$key] = $editCookingSuggestDetail;
            }


            if ($remarkArr) {
                foreach ($remarkArr as $key1 => $value1) {
                    if (is_array($value1)) {
                        foreach ($value1 as $key2 => $value2) {

                            $editCookingSuggestDetail = $remarkIDList[$key1];
                            if (is_array($value2) && count($value2) === 2) {
                                $insertInvLan3 = array(
                                    "module"       => 'cookingSuggestionDetails',
                                    "module_id"    => $editCookingSuggestDetail,
                                    "type"         => 'remark',
                                    "language"     => $value2['language'],
                                    "content"      => $value2['name'],
                                    "updated_at"   => $dateTime
                                );
                                $invLanID = $db->insert('inv_language', $insertInvLan3);
                            }
                        }
                    }
                }
            }



        
            $db->where('id', $vendorId);
            $checkVendor = $db->getValue('vendor','id');
        
            if(!$checkVendor) {
                return array('status'=>'error','code'=>2,'statusMsg'=> "Invalid Vendor", 'data'=>'');
            }
        
            if(!empty($uploadImage)) {
                foreach($uploadImage as $key => $val) {
                    //$imgSrc = json_decode($val['imgData'], true);
                    //$uploadParams['imgSrc'] = $imgSrc;

                    //$uploadRes = aws::awsUploadImage($uploadParams);

                    //if($uploadRes['status'] == 'ok') {
                        $imageUrl = $val['imgData'];

                        if($val['uploadType'] != '')
                        {
                            $uploadType = $val['uploadType'];
                        }
                        else
                        {
                            $uploadType = 'otherImg';
                        }
                        // insert product_media
                        $insertImage = array(
                            "name" => $val['imgName'],
                            "type" => $uploadType,
                            "url" => $imageUrl,
                            "reference_id" => $productInvId,
                            "created_at"   => $dateTime
                        );
        
                        $insertInvImage = $db->insert('product_media', $insertImage);
        
                        if(!$insertInvImage) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                        }
                    // } else {
                    //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    // }
                }
            }

            if(!empty($uploadVideo)) {
                foreach($uploadVideo as $key => $val) {

                    // $vidSrc = json_decode($val['vidData'], true);
                    // $uploadVidParams['videoSrc'] = $vidSrc;
                    // $uploadRes = aws::awsUploadVideo($uploadVidParams);

                    // if($uploadRes['status'] == 'ok') {
                        $videoUrl = $val['vidData'];

                        if($val['uploadType'] != '')
                        {
                            $uploadType = $val['uploadType'];
                        }
                        else
                        {
                            $uploadType = 'otherVid';
                        }
                        // insert product_media
                        $insertVideo = array(
                            "name" => $val['imgName'],
                            "type" => $uploadType,
                            "url" => $videoUrl,
                            "reference_id" => $productInvId,
                            "created_at"   => $dateTime
                        );

                        $insertInvVideo = $db->insert('product_media', $insertVideo);

                        if(!$insertInvVideo) {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                        }
                    // } else {
                    //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                    // }
                }
            }
        
            if(!empty($packageList)) {
                foreach($packageList as $val) {
                    // check the type
                    if($val['type'] != 'mystery')
                    {
                        $db->where("id", $val['product_id']);
                        $cost = $db->getValue('product', 'cost');
                        $insertPackageItemData[] = array(
                            'package_id' => $productInvId,
                            'product_id' => $val['product_id'],
                            'quantity'   => $val['quantity'],
                            'cost'       => $cost,
                            'type'       => 'product',
                            'deleted'    => 0,
                            'created_at' => $dateTime
                        );
                    }
                    else
                    {
                        $insertPackageItemData[] = array(
                            'package_id' => $productInvId,
                            'product_id' => 0,
                            'quantity'   => $val['quantity'],
                            'cost'       => $val['cost'],
                            'type'       => 'mystery',
                            'deleted'    => 0,
                            'created_at' => $dateTime
                        );
                    }
                }
        
                if($insertPackageItemData) {
                    $insertPackageItem = $db->insertMulti('package_item', $insertPackageItemData);
                }
            }
            # record FOC setting in delivery_method_detail
            $updateData = array(
                'deleted' => '1',
                'updated_at' => $dateTime
            );
            $db->where('product_id', $productInvId);
            $db->where('deleted', '0');
            $db->update('delivery_method_detail', $updateData);
            if($foc == 1)
            {
                $db->where('id', $productInvId);
                $productDetail = $db->getOne('product');
                $insertData = array(
                    'delivery_method_id' => $productDetail['delivery_method'],
                    'product_id' => $productInvId,
                    'quantity' => '0',
                    'amount' => '0',
                    'deleted' => '0',
                    'created_at' => $dateTime
                );
                $db->insert('delivery_method_detail', $insertData);
            }
        
            // Insert Activity Log
            $activityRes = Activity::insertActivity('Add Package', 'T00032', 'L00052', $activityData, $userID, $userID, $site);
        
            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }
        
            $data['packageID'] = $productInvId;
            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00102"][$language] /* Successfully Added */ , 'data'=> $data);
        }

        public function editPackageInventory($params) {
            $db              = MysqliDb::getInstance();
            $language        = General::$currentLanguage;
            $translations    = General::$translations;
            $dateTime        = date("Y-m-d H:i:s");

            $packageInvId    = ($params['packageInvId']);
            $name           = trim($params['invPackageName']);
            $status         = trim($params['status']);
            $category       = $params['category'];

            $productType    = trim($params['productType']);
            $description    = trim($params['description']);
            $salePrice      = trim($params['salePrice']);
            $vendorId       = trim($params['vendorId']);
            $fullInstruc    = $params['fullInstruc'];
            $uploadImage    = $params['uploadImage'];
            $uploadVideo    = $params['uploadVideo'];
            $imageId        = $params['imageId'];
            $videoId        = $params['videoId'];
            $isPublish      = $params['isPublish'];
            $isArchive      = $params['isArchive'];
            $isIgnore       = $params['isIgnore'];
            $package        = $params['package'];
            $packageDesc    = $params['packageDesc'];
            $deliveryMethod = $params['deliveryMethod'];
            $skuCode        = $params['skuCode'];
            $foc            = $params['foc'];
            $cost           = $params['cost'];
            $packageProduct = $params['packageProduct'];

            $cookingSuggestInput = $params['cookingSuggestionName'];
            $cookingSuggestUrl = $params['cookingSuggestionUrl'];
            $cookingSuggestRemark = $params['cookingSuggestionRemark'];
            $descriptionArr       = $params['descriptionArr'];
            $remarkArray       = $params['remarkArray'];
            $productNameArr       = $params['productNameArr'];
            $invTranslationList       = $params['invTranslationList'];

            if(empty($name))
            {
                $errorFieldArr[] = array(
                    'id'  => "nameError",
                    'msg' => $translations['E01211'][$language] /* Package name cannot be empty. */
                );
            }

            if(!$category) {
                $errorFieldArr[] = array(
                    'id'  => "categoryError",
                    'msg' => $translations['E01206'][$language] /* Please select Category. */
                );
                $category = '[""]';
            }
            else
            {
                $category = json_encode($category);
            }

            if(empty($salePrice))
            {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01212'][$language] /* Sales Price cannot be empty. */
                );
            }

            if ($cost > $salePrice) {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01314'][$language] /* Sales Price cannot be empty. */
                );
            }

            if(empty($description))
            {
                $errorFieldArr[] = array(
                    'id'  => "descriptionError",
                    'msg' => $translations['E01213'][$language] /* Description cannot be empty. */
                );
            }

            if ($salePrice <= 0)
            {
                $errorFieldArr[] = array(
                    'id'  => "salePriceError",
                    'msg' => $translations['E01212'][$language] /* Please enter a valid sale price */
                );
            }

            if(!$deliveryMethod) {
                $errorFieldArr[] = array(
                    'id'  => "deliveryMethodError",
                    'msg' => $translations['A01782'][$language] /* Please select a delivery method */
                );
            }

            if(empty($vendorId))
            {
                $errorFieldArr[] = array(
                    'id'  => "vendorIdError",
                    'msg' => $translations['E00986'][$language] /* Please Select Vendor. */
                );
            }

            if(!$uploadImage) {
                if($imageId){
                    //If not upload Image and got delete Image => need to check if got any image left, if no prompt error.
                    $db->where('id', $imageId, 'NOT IN');
                    $db->where('type', 'video', '!=');
                    $db->where('type', 'otherVid', '!=');
                    $db->where('deleted', '0');
                    $db->where('reference_id', $packageInvId);
                    $checkImageLeft = $db->getValue('product_media', 'id');
                    if(!$checkImageLeft){
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        );
                    }
                }
                
                $db->where('reference_id', $packageInvId);
                $db->where('deleted', '0');
                $db->where('type', 'video', '!=');
                $db->where('type', 'otherVid', '!=');
                $uploadImageList = $db->getOne('product_media');
                if(!$uploadImageList)
                {
                    $errorFieldArr[] = array(
                        'id'  => "imgError",
                        'msg' => $translations["E01069"][$language] /* Please upload image. */
                    );

                    
                    // return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E01012"][$language] /* Please upload image */, 'data'=>'');
                }    
            }

            if (is_array($uploadImage)) {

                foreach ($uploadImage as $key => $value) {

                    if (!$value['uploadType']) {
                        $errorFieldArr[] = array(
                            'id'  => "imgError",
                            'msg' => $translations["E01069"][$language] /* Please upload image. */
                        
                        );
                    }
                }
            }

            if(empty($packageProduct))
            {
                $errorFieldArr[] = array(
                    'id'  => "packageError",
                    'msg' => $translations['E01224'][$language] /* Must have at least one product in this package. */
                );
            }

            if($packageProduct)
            {
                foreach($packageProduct as $checkPackageQuantity)
                {
                    if(empty($checkPackageQuantity['quantity']) || intval($checkPackageQuantity['quantity']) < 0)
                    {
                        $errorFieldArr[] = array(
                            'id'  => "packageError",
                            'msg' => $translations['E01224'][$language] /* Must have at least one product in this package. */
                        );
                    }
                    if($checkPackageQuantity['product_id'] == null || $checkPackageQuantity['product_id'] == 0){
                        if(empty($checkPackageQuantity['cost']) || intval($checkPackageQuantity['cost']) < 0){
                            $errorFieldArr[] = array(
                                'id'  => "packageError",
                                'msg' => $translations['E01280'][$language] /* Must have cost for msytery food. */
                            );
                        }
                    }

                    $productIDAry[$checkPackageQuantity["product_id"]] = $checkPackageQuantity["product_id"];
                }

                if(count($productIDAry)){
                    $db->where("id",$productIDAry,"IN");
                    $dbRes = $db->get("product");
                    foreach($dbRes as $tempData){
                        $product_info[$tempData["id"]] = $tempData;
                    }

                }
            }

            //---

            if($errorFieldArr) {
                $data['field'] = $errorFieldArr;
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00130"][$language] /* Data does not meet requirements */, 'data' => $data);
            }


            $cookingSuggest = [];

            foreach ($cookingSuggestInput as $key => $value) {
                $cookingSuggest[$key] = [
                    'name' => $value['content']
                ];
                $cookingSuggest[$key]['url'] = $cookingSuggestUrl[$key]['content'];
                $cookingSuggest[$key]['remark'] = $cookingSuggestRemark[$key]['content'];
            }

            $cookingSuggestArr = array();
            for ($i = 0; $i < count($cookingSuggestInput); $i++) {

                // get their suggestion id
                $db->where('name', $cookingSuggestInput[$i]['content']);
                $db->where('status', 'Active');
                $suggestionId = $db->getValue('cooking_suggestion','id');

                $cookingSuggestArr[] = array(
                    'name' => $cookingSuggestInput[$i]['content'],
                    'url' => $cookingSuggestUrl[$i]['content'],
                    'remark' => $cookingSuggestRemark[$i]['content'],
                    'suggestion_id' => $suggestionId
                );
            }

            //Package

            $imageGroupUniqueChar = self::generateUniqueChar();

            $userID = $db->userID;
            $site = $db->userType;

            if(!$userID) {
            } else {
                $db->where("id", $userID);
                $checkAdmin = $db->getValue("admin", "username");

                if(!$checkAdmin) {
                    return array('status'=>'error','code'=>1,'statusMsg'=> $translations["E00118"][$language] /* Invalid admin */,'data'=>'');
                }
            }

            $db->where('id', $vendorId);
            $checkVendor = $db->getValue('vendor','id');

            if(!$checkVendor) {
                $vendorId = 0;
                // return array('status'=>'error','code'=>1,'statusMsg'=> "Invalid Vendor", 'data'=>'');
            }

            $db->where('id', $category);
            $checkCategory = $db->getValue('product_category','id');

            if(!$checkCategory) {
                // return array('status'=>'error','code'=>2,'statusMsg'=> "Invalid Category", 'data'=>'');
                $checkCategory = '[]';
            }

            if(!$packageInvId) {
                return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E00284"][$language] /* Package not found */, 'data' => '');
            }

            // if(!$packageProduct)
            // {
            //     return array('status' => 'error', 'code' => 1, 'statusMsg' => $translations["E01224"][$language] /* Must have at least one product in this package. */, 'data' => '');
            // }

            $db->where("id", $packageInvId);
            $productInvRecord = $db->getOne("product", "id");

            $editInv = array(
                "name"               => $name,
                "product_type"       => 'package',
                "description"        => $description,
                "cost"               => $cost,
                "sale_price"         => $salePrice,
                "vendor_id"          => $vendorId,
                "barcode"            => $skuCode,
                "categ_id"           => $category,
                "full_instruction"   => $fullInstruc[0],
                "full_instruction2"  => $fullInstruc[1],
                "is_published"       => $isPublish,
                "is_archive"         => $isArchive,
                "ignore_stock_count" => $isIgnore,
                "delivery_method"    => $deliveryMethod,
                "deleted"            => $delete,
                "updated_at"         => $dateTime,
            );

            $db->where("id", $packageInvId);
            $editInvRes = $db->update("product", $editInv);


            $db->where('product_id', $packageInvId);
            $existData = $db->get('cooking_suggestion_details');
            if($existData)
            {
                // delete the existing data
                $db->where('product_id', $packageInvId);
                $db->delete('cooking_suggestion_details');
            }


            foreach($existData as $key => $value){

                $db->where('module', 'cookingSuggestionDetails');
                $db->where('type', 'remark');
                $db->where('module_id', $value['id']);
                $existDataLan = $db->get('inv_language');

                if($existDataLan)
                {
                    // delete the existing data
                    $db->where('module_id', $value['id']);
                    $db->where('type', 'remark');
                    $db->where('module', 'cookingSuggestionDetails');
                    $db->delete('inv_language');
                }
                
            }

            if($cookingSuggestArr){

                foreach($cookingSuggestArr as $key => $details){

                    // insert new data
                    $insertData = array(
                        'url'           => $details['url'],
                        'remark'        => $details['remark'],
                        'product_id'    => $packageInvId,
                        'suggestion_id' => $details['suggestion_id'],
                        'created_at'    => $dateTime,
                    );
    
                    $editCookingSuggestDetail = $db->insert('cooking_suggestion_details', $insertData);
                    $remarkIDList[$key] = $editCookingSuggestDetail;
                }
            }

            if ($remarkArray) {
                foreach ($remarkArray as $key1 => $value1) {
                    if (is_array($value1)) {
                        foreach ($value1 as $key2 => $value2) {

                            $editCookingSuggestDetail = $remarkIDList[$key1];
                            if (is_array($value2) && count($value2) === 2) {
                                $insertInvLan3 = array(
                                    "module"       => 'cookingSuggestionDetails',
                                    "module_id"    => $editCookingSuggestDetail,
                                    "type"         => 'remark',
                                    "language"     => $value2['language'],
                                    "content"      => $value2['name'],
                                    "updated_at"   => $dateTime
                                );
                                $invLanID = $db->insert('inv_language', $insertInvLan3);
                            }
                        }
                    }
                }
            }

            if($packageDesc){
                foreach($packageDesc as $key => $value){
                    // return array('status'=>'error','code'=>2,'statusMsg'=> $translations["E00118"][$language] /* Invalid admin */,'data'=>$value['language']);


                    $db->where("module_id", $packageInvId);
                    $db->where("module", 'package');
                    $db->where("type", 'description');
                    $db->where("language", $value['language']);
                    $getDesc = $db->get('inv_language');

                    if(!$getDesc){
                        $insertInvLanDesc = array(
                            "module"               => 'package',
                            "module_id"            => $packageInvId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['description'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanDesc2 = $db->insert('inv_language', $insertInvLanDesc);
                    }else{
                        $insertInvLan2 = array(
                            "module"               => 'package',
                            "module_id"            => $packageInvId,
                            "type"                 => 'description',
                            "language"             => $value['language'],
                            "content"              => $value['description'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $packageInvId);
                        $db->where("module", 'package');
                        $db->where("type", 'description');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan2);
                    }   
                }
            }

            if($package){
                foreach($package as $key => $value){

                    $db->where("module_id", $packageInvId);
                    $db->where("module", 'package');
                    $db->where("type", 'name');
                    $db->where("language", $value['language']);
                    $getName = $db->get('inv_language');

                    if(!$getName){
                        $insertInvLanName = array(
                            "module"               => 'package',
                            "module_id"            => $packageInvId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $insertInvLanName2 = $db->insert('inv_language', $insertInvLanName);
                    }else{
                        $insertInvLan = array(
                            "module"               => 'package',
                            "module_id"            => $packageInvId,
                            "type"                 => 'name',
                            "language"             => $value['language'],
                            "content"              => $value['name'],
                            "updated_at"           => $dateTime
                        );
                        $db->where("module_id", $packageInvId);
                        $db->where("module", 'package');
                        $db->where("type", 'name');
                        $db->where("language", $value['language']);
                        $invLanID = $db->update('inv_language', $insertInvLan);
                    }
                }
            }

            $urlCount=0;

            if (!$editInvRes) {
                return array('status' => 'error', 'code' => 1,'statusMsg' => $translations["E00934"][$language] /* Failed to update product. */, 'data' => '');
            }

            if(!empty($videoList)) {
                $db->where('deleted', 0);
                $db->where('reference_id', $packageInvId);
                $proVideo = $db->get('product_media', null, 'url');

                if(empty($proVideo)) {
                    $proVideo = array();
                }
            }

            if(!empty($uploadImage)) {
                foreach($uploadImage as $key => $val) {

                    if (strpos($val['imgData'], 'https') !== false) {
                        $imageUrl = $val['imgData'];

                        if($val['uploadType'] != '')
                        {
                            $uploadType = $val['uploadType'];
                        }
                        else
                        {
                            $uploadType = 'otherImg';
                        }

                        $insertImage[] = array(
                            "name" => $val['imgName'],
                            "type" => $uploadType,
                            "url" => $imageUrl,
                            "reference_id" => $packageInvId,
                            "created_at"   => $dateTime,
                        );
                    }
                }

                /*foreach($uploadImage as $key => $val) {
                    $db->where('reference_id', $packageInvId);
                    $db->where('deleted', 0);
                    $db->where('type', 'image');
                    $imageDetail = $db->getOne('product_media');
                    if($imageDetail)
                    {
                        $val['imgID'] = $imageDetail['id'];
                    }
                    else
                    {
                        $val['imgID'] = '';
                    }

                    if($val['imgID'] == '') {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                        $imgSrc = json_decode($val['imgData'], true);
                        if (strpos($imgSrc, "data:") !== false) {
                            $uploadParams['imgSrc'] = $imgSrc;
                            $uploadRes = aws::awsUploadImage($uploadParams);

                            if($uploadRes['status'] == 'ok') {
                                $imageUrl = $uploadRes['imageUrl'];

                                if($val['uploadType'] != '')
                                {
                                    $uploadType = $val['uploadType'];
                                }
                                else
                                {
                                    $uploadType = 'otherImg';
                                }
                                // insert product_media
                                $insertImage[] = array(
                                    "name" => $val['imgName'],
                                    "type" => $uploadType,
                                    "url" => $imageUrl,
                                    "reference_id" => $packageInvId,
                                    "created_at"   => $dateTime,
                                );
                            } else {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        }
                    } else {
                        $imgSrc = json_decode($val['imgData'], true);

                        if (strpos($imgSrc, "data:") !== false) {
                            $db->where('id', $val['imgID']);
                            // $db->where('type', 'Image');
                            $db->where('reference_id', $packageInvId);
                            $editImage = $db->update('product_media', array('deleted' => 1));

                            $uploadParams['imgSrc'] = $imgSrc;
                            $uploadRes = aws::awsUploadImage($uploadParams);

                            if($uploadRes['status'] == 'ok') {
                                $imageUrl = $uploadRes['imageUrl'];

                                if($val['uploadType'] != '')
                                {
                                    $uploadType = $val['uploadType'];
                                }
                                else
                                {
                                    $uploadType = 'otherImg';
                                }
                                // insert product_media
                                $insertImage[] = array(
                                    "name" => $val['imgName'],
                                    "type" => $uploadType,
                                    "url" => $imageUrl,
                                    "reference_id" => $packageInvId,
                                    "created_at"   => $dateTime,
                                );

                            } else {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        }
                    }
                }*/

                if(!empty($insertImage)) {
                    $insertInvImage = $db->insertMulti('product_media', $insertImage);

                    if(!$insertInvImage) {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01226"][$language], 'data' => ''); //Failed to upload profile image.
                    }
                }
            }
            
            if($imageId) {
                $db->where('id', $imageId, 'IN');
                $db->where('type', 'video','!=');
                $db->where('reference_id', $packageInvId);
                $editImageList = $db->update('product_media', array('deleted' => 1));
            }

            if($videoId) {
                $db->where('id', $videoId, 'IN');
                $db->where('type', 'video');
                $db->where('reference_id', $packageInvId);
                $editImageList = $db->update('product_media', array('deleted' => 1));
            }

            if(!empty($uploadVideo)) {
                foreach($uploadVideo as $key => $val) {
                    // $vidSrc = json_decode($val['vidData'], true);
                    // $uploadVidParams['videoSrc'] = $vidSrc;
                    if (strpos($val['vidData'], 'https') !== false) {
                        // $uploadRes = aws::awsUploadVideo($uploadVidParams);

                        // if($uploadRes['status'] == 'ok') {
                            $videoUrl = $uploadRes['vidData'];

                            if($val['uploadType'] != '')
                            {
                                $uploadType = $val['uploadType'];
                            }
                            else
                            {
                                $uploadType = 'otherVid';
                            }
                            // insert product_media
                            $insertVideo = array(
                                "name" => $val['vidName'],
                                "type" => $uploadType,
                                "url" => $videoUrl,
                                "reference_id" => $packageInvId,
                                "created_at"   => $dateTime
                            );

                            $insertInvVideo = $db->insert('product_media', $insertVideo);

                            if(!$insertInvVideo) {
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                            }
                        // } else {
                        //     return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01308"][$language], 'data' => ''); //Failed to upload profile image.
                        // }
                    }
                }
            }

            // if(empty($uploadImage))
            // {
            //     $db->where('type', 'video', '!=');
            //     $db->where('deleted', '0');
            //     $db->where('reference_id', $packageInvId);
            //     $editImageList = $db->update('product_media', array('deleted' => 1));
            // }



            if(!empty($packageProduct)) {
                $updatePackageData = array(
                    "deleted"    => 1,
                    "updated_at" => $dateTime
                );
                $db->where('product_id', $packageProduct, 'NOT IN');
                $db->where('deleted', 0);
                $db->where('package_id', $packageInvId);
                $updatePackage = $db->update('package_item', $updatePackageData);

                foreach($packageProduct as $val) {
                    $db->where('product_id', $val['product_id']);
                    $db->where('package_id', $packageInvId);
                    $db->where('deleted', 0);
                    $checkPackage = $db->getOne('package_item', 'id');

                    if($val['type'] == 'mystery')
                    {
                        $type = 'mystery';
                    } 
                    else
                    {
                        $type = 'product';
                    }
                    if(!$checkPackage) {
                        // clear all
                        $db->where('package_id', $packageInvId);
                        $db->where('deleted', 0);
                        $updateData = array(
                            'deleted'    => 1,
                            'updated_at' => $dateTime,
                        );

                        $db->update('package_item', $updateData);
                        $insertPackageItemData[] = array(
                            'package_id' => $packageInvId,
                            'product_id' => $val['product_id'],
                            'quantity'   => $val['quantity'],
                            'cost'       => $type == "mystery"? number_format($val['cost']/$val['quantity'],2) : $product_info[$val['product_id']]["cost"],
                            'type'       => $type,
                            'deleted'    => 0,
                            'created_at' => $dateTime
                        );
                    } else {
                        $db->where('package_id', $packageInvId);
                        $db->where('deleted', 0);
                        $updateData = array(
                            'deleted'    => 1,
                            'updated_at' => $dateTime,
                        );
                        $db->update('package_item', $updateData);

                        $insertPackageItemData[] = array(
                            'package_id' => $packageInvId,
                            'product_id' => $val['product_id'],
                            'quantity'   => $val['quantity'],
                            'cost'       => $type == "mystery"? number_format($val['cost']/$val['quantity'],2) : $product_info[$val['product_id']]["cost"],
                            'type'       => $type,
                            'deleted'    => 0,
                            'created_at' => $dateTime
                        );
                    }
                }
                
                if($insertPackageItemData) {
                    $insertPackageItem = $db->insertMulti('package_item', $insertPackageItemData);
                }
            }
            # record FOC setting in delivery_method_detail
            $updateData = array(
                'deleted' => '1',
                'updated_at' => $dateTime
            );
            $db->where('product_id', $packageInvId);
            $db->where('deleted', '0');
            $db->update('delivery_method_detail', $updateData);
            if($foc == 1)
            {
                $db->where('id', $packageInvId);
                $productDetail = $db->getOne('product');
                $insertData = array(
                    'delivery_method_id' => $productDetail['delivery_method'],
                    'product_id' => $packageInvId,
                    'quantity' => '0',
                    'amount' => '0',
                    'deleted' => '0',
                    'created_at' => $dateTime
                );
                $db->insert('delivery_method_detail', $insertData);
            }

            $activityData = array_merge(array('admin' => $checkAdmin), $editInv, $updateTranslationList, $updateDescrTranslationList);

            // Insert Activity Log
            $activityRes = Activity::insertActivity('Edit Product', 'T00033', 'L00053', $activityData, $userID, $userID, $site);

            if(!$activityRes) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00144"][$language] /* Failed to insert activity. */, 'data' => "");
            }


            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$updatePackage);
        }

        public function insertDeliveryOrder($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;

            $saleID                 = $params['sale_id'];
            $doNo                   = $params['do_no'];
            $type                   = $params['type'];

            $db->where("delivery_order_no LIKE 'DO%'");
            $db->orderBy("CAST(SUBSTRING(delivery_order_no, 3) AS UNSIGNED)", "DESC");
            $lastDORecord = $db->getOne("inv_delivery_order");

            if($lastDORecord) {
                $last_do_no = $lastDORecord["delivery_order_no"];
            } else {
                $last_do_no = "DO00000";
            }

            $last_do_no = substr($last_do_no, 2);
            $next_do_no = "DO".sprintf('%05d', ($last_do_no + 1));

            $db->where('so_id', $saleID);
            if($type != 'startDO')
            {
                $db->where('status', array('Draft', 'Pending for Pickup', 'Delivered'), 'IN');
            }
            else
            {
                $db->where('status', 'Draft');
            }
            if($doNo)
            {
                $db->where('delivery_order_no', $doNo);
            }
            $existingDO = $db->getOne('inv_delivery_order');

            if($existingDO && $type != 'startDO')
            {
                $db->where('so.deleted', 0);
                $db->where('do_no', $existingDO['id']);
                $db->join('product p', 'p.id = so.product_id', 'LEFT'); // use left for handle mystery food (product_id = 0)
                $existingDODetail = $db->get('sale_order_item so', null, 'p.id as productID, p.name as productName, so.serial_number as serialNo, p.barcode as skuCode, so.id as soItemID');

                $newDODetail = [];
                foreach($existingDODetail as $detailExistDO)
                {
                    if($detailExistDO['productID'] == 0 || $detailExistDO['productID'] == null)
                    {
                        $doProductID = 0;
                    }
                    else
                    {
                        $doProductID = $detailExistDO['productID'];
                    }

                    if($detailExistDO['productName'] == null)
                    {
                        $doProductName = 'Mystery Food';
                    }
                    else
                    {
                        $doProductName = $detailExistDO['productName'];
                    }
                    $detailDO['productID'] = $doProductID;
                    $detailDO['productName'] = $doProductName;
                    $detailDO['serialNo'] = $detailExistDO['serialNo'];
                    $detailDO['skuCode'] = $detailExistDO['skuCode'];
                    $detailDO['soItemID'] = $detailExistDO['soItemID'];
                    $newDODetail[] = $detailDO;
                }
                $data['deliveryOrderID'] = $existingDO['delivery_order_no'];
                $data['existingDODetail'] = $newDODetail;
                $data['existingDO'] = $existingDO;
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$data);
            }
            else if($type === 'startDO')
            {
                $db->where('so_id', $saleID);
                $db->where('status', 'Draft');
                $pendingDelivery = $db->getOne('inv_delivery_order');

                $db->where('id', $saleID);
                $saleOrderInfo = $db->getOne('sale_order');

                // if(strtolower($saleOrderInfo['delivery_method']) != 'pickup')
                // {
                    # check delivery order detail is empty or not
                    $db->where('disabled', '0');
                    $db->where('inv_delivery_order_id', $pendingDelivery['id']);
                    $doDetail = $db->get('inv_delivery_order_detail');
                    if($pendingDelivery && $doDetail)
                    {
                        return array('status'=>'error', 'code'=> 1, 'statusMsg'=> "There still have previous DO haven't finish yet, please complete it before proceed to next DO" , 'data'=>$data);
                    }
                    else if($pendingDelivery && !$doDetail)
                    {
                        $data['deliveryOrderID'] = $existingDO['delivery_order_no'];
                        return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$data);
                    }
                // }
                $insertData = array(
                    'so_id' => $saleID,
                    'delivery_order_no' => $next_do_no,
                    'tracking_number' => '',
                    'status' => 'Draft',
                    'batch_id' => '',
                    'remark' => '',
                    'created_at' => $dateTime,
                    'creator_id' => $userID,
                    'reference_number' => '',
                );
        
                $deliveryOrderID  = $db->insert('inv_delivery_order', $insertData);
            }

            $data['deliveryOrderID'] = $next_do_no;

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$data);
        }

        public function DeliveryOrderUpdate($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;
        
            $saleID                 = $params['sale_id'];
            $trackingNo             = $params['trackingNo'];
            $deliveryPartner        = $params['deliveryPartner'];
            $boxDetails             = $params['boxDetails'];
            $doNO                   = $params['deliveryOrderNO'];
            $action                 = $params['action'];
        
            $serial                 = $params['serial'];
            $step                   = trim($params['step']);
            $serialProductId        = $params['serialProductId'];

            if(!$doNO)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01803"][$language] /* Invalid Delivery Order, please click Start DO button */, 'data' => $checkSerial);
            }

            if(count($boxDetails) < 1)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01791"][$language] /* Must have at least one stock in this Delivery Order */, 'data' => $checkSerial);
            }

            foreach($boxDetails as $checkSerial)
            {
                $db->where('serial_number', $checkSerial['serial_number']);
                $stockDetail = $db->getOne('stock');
        
                if(!$stockDetail)
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => 'Invalid Data, please check is serial_number exist.' . '<br>' . $checkSerial['serial_number'], 'data' => $checkSerial);
                }
                
                if($checkSerial['product_id'] != $stockDetail['product_id'] && $checkSerial['product_id'] != 0)
                {
                    $notMatchList[] = $checkSerial;
                }
            }

            $db->where('id', $saleID);
            $getSaleNo = $db->getOne('sale_order');
            if(count($notMatchList) > 0)
            {
                return array('status' => "error", 'code' => 2, 'statusMsg' => 'Invalid Data, please check is serial_number exist.', 'data' => $notMatchList);
            }
            
            if(!$action || $action == '')
            {
                $status = 'Draft';
            }
            else if(strtolower($action) == 'closedo')
            {
                $db->where('id', $saleID);
                $saleOrderInfo = $db->getOne('sale_order');
                if(strtolower($saleOrderInfo['delivery_method']) == 'pickup')
                {
                    $status = 'Pending for Pickup';
                }
                else
                {
                    $status = 'Draft';
                }

                # check the different between current box (do)
                $db->where('dod.disabled', '0');
                $db->where('ido.delivery_order_no', $doNO);
                $db->join('inv_delivery_order ido', 'ido.id = dod.inv_delivery_order_id', 'INNER');
                $currentDODetail = $db->get('inv_delivery_order_detail dod');

                if($currentDODetail)
                {
                    $currentSerialNumbers = array_column($currentDODetail, 'serial_number');
                    $boxSerialNumbers = array_column($boxDetails, 'serial_number');
    
                    $serialNumbersNotInBox = array_diff($currentSerialNumbers, $boxSerialNumbers); // need to change stock status back to Active
    
                    $serialNumbersNotInCurrent = array_diff($boxSerialNumbers, $currentSerialNumbers); // need to stock out

                    $missingSerialNumbers = [];
                    foreach ($serialNumbersNotInCurrent as $serialNumber) {
                        $missingSerialNumbers[] = ['serial_number' => $serialNumber];
                    }

                    if($missingSerialNumbers)
                    {
                        $serial = $missingSerialNumbers;
                    }
                    else
                    {
                        $serial = '';
                        $serialProductId = '';
                    }
                }

                // Extract the serial numbers from both arrays
                $serialNumbers = array_column($serial, 'serial_number');
                $serialProductIdNumbers = array_column($serialProductId, 'serial_number');

                // Check if any serial numbers in $serial exist in $serialProductId
                $intersect = array_intersect($serialNumbers, $serialProductIdNumbers);

                // If there is an intersection, keep only the items with matching serial numbers in $serialProductId
                if (!empty($intersect)) {
                    $serialProductId = array_filter($serialProductId, function ($item) use ($intersect) {
                        return in_array($item['serial_number'], $intersect);
                    });
                }

                if($serial && $serialProductId)
                {
                    // proceed stock out
                    $dataIn['serial'] = $serial;
                    $dataIn['sale_id'] = $saleID;
                    $dataIn['step'] = $step;
                    $dataIn['serialProductId'] = $serialProductId;
                    $result = Inventory::updateStatusOnPacking($dataIn);
                    if($result['status'] != 'ok')
                    {
                        $notActiveSerial = $result['data'];
                        $combinedSerialNumbers = implode(', ', $notActiveSerial);
                        if($result['data']['Issue_Stock'])
                        {
                            $issueStockList = $result['data']['Issue_Stock'];
                            $issueSerialNumbers = array_column($issueStockList, 'serial_number');
                            $combinedMsg = implode(', ', $issueSerialNumbers);
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $result['statusMsg'] ."<br>". $combinedMsg, 'data' => $result['data']);
                        }
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $result['statusMsg'] ."<br>". $combinedSerialNumbers, 'data' => $result['data'], 'combinedSerialNumbers' => $combinedSerialNumbers, 'notActiveSerial' => $notActiveSerial, 'dataIn' => $dataIn);
                    }
                }

                # change stock that not in box back to active status
                foreach($serialNumbersNotInBox as $revertSN)
                {
                    $updateData = array(
                        'so_id'         => '',
                        'status'        => 'Active',
                        'updated_at'    => $dateTime
                    );
                    $db->where('serial_number', $revertSN);
                    $db->update('stock', $updateData);
                    
                    # remove serial number from sale order item
                    $updateData = array(
                        'serial_number' => '',
                        'updated_at'    => $dateTime,
                        'updated_by'    => $userID,
                        'do_no'         => ''
                    );
                    $db->where('serial_number',$revertSN);
                    $db->where('deleted', '0');
                    $db->update('sale_order_item', $updateData);
                }
            }
            else
            {
                $status = 'Draft';
            }
        
            $updateData = array(
                'so_id' => $saleID,
                // 'tracking_number' => $trackingNo,
                'status' => $status,
                'batch_id' => '',
                'remark' => '',
                'updater_id' => $userID,
                'updated_at' => $dateTime,
                'reference_number' => '',
                // 'delivery_partner' => $deliveryPartner,
            );
            $db->where('delivery_order_no', $doNO);
            $deliveryOrderID  = $db->update('inv_delivery_order', $updateData);
        
            $db->where('delivery_order_no', $doNO);
            $deliveryOrderDetail = $db->getOne('inv_delivery_order');
        
            $updateData = array(
                'disabled' => '1'
            );
            $db->where('inv_delivery_order_id', $deliveryOrderDetail['id']);
            $db->where('disabled', '0');
            $db->update('inv_delivery_order_detail', $updateData);

            foreach($boxDetails as $keys => $detailProcess)
            {
                $insertData = array(
                    'inv_delivery_order_id'     => $deliveryOrderDetail['id'],
                    'product_id'                => $detailProcess['product_id'],
                    'serial_number'             => $detailProcess['serial_number'],
                    'disabled'                  => '0',
                    'remark'                    => '',
                );
                $db->insert('inv_delivery_order_detail', $insertData);
            }
            foreach($serialProductId as $keys => $detailProcess)
            {
                $updateSOItem = array(
                    'do_no' => $deliveryOrderDetail['id'],
                    'serial_number' => $detailProcess['serial_number'],
                    'deleted' => '0',
                );
                $db->where('do_no', '');
                $db->where('serial_number', '');
                $db->where('deleted', '0');
                $db->where('product_id', $detailProcess['product_id']);
                $db->where('so_no', $getSaleNo['so_no']);
                $db->update('sale_order_item', $updateSOItem, 1);
            }
            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00123"][$language] /* Confirm */, 'data' => $data);
        }

        public function getDeliveryOrder($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $userID                 = $db->userID;

            $saleID                 = $params['sale_id'];
            $doNO                   = $params['delivery_order_no'];

            $db->where('so_id', $saleID);
            $deliveryOrder = $db->get('inv_delivery_order');

            $db->where('delivery_order_no', $doNO);
            $deliveryOrderDetail = $db->getOne('inv_delivery_order');

            $db->where('inv_delivery_order_id', $deliveryOrderDetail['id']);
            $db->where('disabled', '0');
            $deliveryOrderDetail = $db->get('inv_delivery_order_detail');

            $data['deliveryOrderList'] = $deliveryOrder;
            $data['deliveryOrderDetail'] = $deliveryOrderDetail;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["A00123"][$language] /* Confirm */, 'data' => $data);
        }

        public function getProductAndCategory($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");

            $condition              = $params['condition'];
            $categoryId               = $params['category_id'];

            if(strtolower($condition) == 'product')
            {
                $db->orderBy("barcode", "ASC");
                $db->where("deleted", "0");
                $db->where('is_archive', '0');
                // $db->where("product_type", "product");
                $productList = $db->get("product",null, "id, name, barcode, sale_price");

                $data['productList'] = $productList;
            }
            else if(strtolower($condition) == 'productcategory')
            {
                $categoryRes = $db->get("product_category a", null, "a.id as id, a.name as name, a.parent_id as parent_id, a.deleted as deleted, a.created_at as created_at");

                foreach($categoryRes as $checkParentCategory)
                {
                    if($checkParentCategory['parent_id'] != '0')
                    {
                        $parentCategoryIdExists = false;
                        $checkParentCategoryId = $checkParentCategory['parent_id'];
                        foreach ($parentCategory as $existingCategory) {
                            if ($existingCategory['parent_id'] === $checkParentCategoryId) {
                                $parentCategoryIdExists = true;
                                break;
                            }
                        }
                        
                        if (!$parentCategoryIdExists) {
                            $parentCategory[] = $checkParentCategory;
                        }
                    }
                }

                foreach ($categoryRes as $key => $deleteCategory) {
                    foreach($parentCategory as $checkDeleteCategory)
                    {
                        if ($checkDeleteCategory['parent_id'] === $deleteCategory['id']) {
                            unset($categoryRes[$key]);
                        }
                    }
                }
                $data['categoryList'] = $categoryRes;
            }

            if($categoryId)
            {
                $db->orderBy("barcode", "ASC");
                $db->where("deleted", "0");
                $db->where('categ_id', '%"' . $categoryId . '"%', 'LIKE');
                $productList = $db->get("product",null, "id, name, barcode, sale_price");

                $data['productList'] = $productList;
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["B00370"][$language] /* Successfully Updated */ , 'data'=>$data);
        }

        public function checkStockQuantity($params)
        {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");

            $purchaseProduct = $params['purchaseProduct'];
            $product_id = $params['product_id'];
            $quantity = $params['quantity'];
            $text = $params['text'];

            $db->where("id", $product_id);
            $product_type = $db->getValue("product", "product_type");

            if(strtolower($product_type)=="package" && !$text) {
                $db->where('package_id', $product_id);
                $db->where('deleted', '0');
                $packageProduct = $db->get('package_item');

                foreach($packageProduct as $detailPackageCheck)
                {
                    unset($dataIn);
                    if($detailPackageCheck['product_id'] != '0')
                    {
                        $dataIn['product_id'] = $detailPackageCheck['product_id'];
                        $dataIn['quantity']   = intval($detailPackageCheck['quantity']) * $quantity;
                        $dataIn['text']       = 'cart';
                        $dataOut = self::checkStockQuantity($dataIn);
                    }
                    if($dataOut['status'] != 'ok')
                    {
                        return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03005"][$language] /* Out Of Stock */, 'data' => $dataOut['data'], 'dataIn' => $dataIn);
                    }
                    unset($newDetailPackage);
                    $newDetailPackage['id'] = $detailPackageCheck['id'];
                    $newDetailPackage['package_id'] = $detailPackageCheck['package_id'];
                    $newDetailPackage['product_id'] = $detailPackageCheck['product_id'];
                    $newDetailPackage['quantity'] = $detailPackageCheck['quantity'];
                    $newDetailPackage['type'] = $detailPackageCheck['type'];
                    if($dataOut['status'] == 'ok')
                    {
                        if($dataOut['data'] == 0)
                        {
                            $newDetailPackage['stock_quantity'] = $dataOut['availableStock'];
                        }
                        else
                        {
                            $newDetailPackage['stock_quantity'] = $dataOut['data'];
                        }
                    }

                    $detailPackageList[] = $newDetailPackage;
                }
                $packageStock = PHP_INT_MAX;
                foreach ($detailPackageList as $item) {
                    $availableStockPerUnit = $item['stock_quantity'] / $item['quantity'];
                    if ($availableStockPerUnit < $packageStock) {
                        $packageStock = $availableStockPerUnit;
                    }
                }
                $packageStock = floor($packageStock);
                $dataOut['data'] = $packageStock;

                if($detailPackageList)
                {
                    foreach($detailPackageList as $checkDetailPackage)
                    {
                        if(intval($checkDetailPackage['stock_quantity']) < intval($checkDetailPackage['quantity']))
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03005"][$language] /* Out Of Stock */, 'data' => $dataOut['data']);
                        }
                    }
                    return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $dataOut['data']);
                }
                else
                {
                    return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $dataOut['data']);
                }
            }

            // get the total stock amount available
            $db->where('product_id', $product_id);
            $db->where('status', 'Active');
            //$db->where('so_id', '');
            $availableStock = $db->getValue('stock', 'count(*)') ?? 0;


            $db->where('product_id', $product_id);
            $db->where('deleted', 0);
            $wishListStock = $db->getValue('product_wishlist', 'count(*)') ?? 0;

            $db->where("so.status", array("Pending","Pending Payment Approve", "Paid"),"IN");
            $db->where("sod.deleted", 0);
            $db->where("sod.product_id", $product_id);
            $db->join("sale_order so", "sod.sale_id=so.id", "INNER");
            $lockStock = $db->getValue("sale_order_detail sod", "SUM(sod.quantity)") ?? 0;

            // check package product lock stock
            $db->where('product_id', $product_id);
            $db->where('deleted', '0');
            $packageProductList = $db->get('package_item');

            foreach($packageProductList as $packageDetails)
            {
                $db->where("so.status", array("Pending","Pending Payment Approve", "Paid"),"IN");
                $db->where("sod.deleted", 0);
                $db->where("sod.product_id", $packageDetails['package_id']);
                $db->join("sale_order so", "sod.sale_id=so.id", "INNER");
                $packageLockStock = $db->getValue("sale_order_detail sod", "SUM(sod.quantity)") ?? 0;
            }
            $lockStock = $lockStock + $packageLockStock;

            // check is the stock amount enough or not
            $result = intval($availableStock) - intval($quantity) - intval($lockStock);
            if($result < 0)
            {
                $noStockDetails['product_id'] = $product_id;
                $noStockDetails['availableStock'] = $availableStock;
                $noStockDetails['lockStock'] = $lockStock;
                $noStockDetails['wishListStock'] = $wishListStock;
                $noStockDetails['quantity'] = $quantity;
                $noStockDetails['finalAmount'] = $result;
                $db->where('id', $product_id);
                $productInfo = $db->getOne('product');
                $noStockDetails['product_name'] = $productInfo['name'];

                $outOfStock[] = $noStockDetails;
            }           

            if (!empty($outOfStock)){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["M03454"][$language] /* Out of stock */, 'data' => $outOfStock);
            } else {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $result, 'availableStock' => $availableStock, 'lockStock' => $lockStock, 'quantity' => $quantity);
	        }
        }

        // getSODetail
        public function orderDetailCheck($params){
            $db = MysqliDb::getInstance();
            $language       = General::$currentLanguage;
            $translations   = General::$translations;
            $dateTimeFormat = Setting::$systemSetting['systemDateTimeFormat'];

            $SaleID     = trim($params['SaleID']);
            $passphrase = trim($params['passphrase']);
            $soID       = trim($params['soID']);
            $step       = trim($params['step']);
            $clientID   = $db->userID;

            if($language == 'chineseSimplified'){
                $productLang = 'chinese';
            }  

            ## check if soID valid 
            if($soID){
                $db->where('so_no', $soID);
                $saleOrder = $db->getOne("sale_order","id, client_id, so_no, status,
                                        created_at AS createdAt, payment_method AS paymentMethod, rewarded_point,
                                        delivery_method AS deliveryMethod, shipping_name, shipping_phone, shipping_address, billing_name, billing_phone, billing_address, payment_amount AS paymentAmount, payment_tax AS paymentTax, release_amount as releaseAmount, shipping_fee AS shippingfee, shipping_email AS shippingEmail,  billing_email AS billingEmail"); 
            }else{
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> '');
            }

            if(!$saleOrder){
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> '');
            }

            // Check if login user is owner, if not, check if passphase is correct
            if($clientID != $saleOrder["client_id"]){
                if(!$passphrase){
                    return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["E01267"][$language], 'data'=> 'ShowPage');
                }else{
                    $db->where("id",$saleOrder["client_id"]);
                    $ownerPhoneNumber = $db->getValue("client","username");
                    if(substr($ownerPhoneNumber, -4) != $passphrase){
                        $returnData['field'][] = array('id' => 'insertPassPhraseError', 'msg' => $translations["E01270"][$language]);
                        return array("status" => "error", "code" => 1, "statusMsg" => $translations["E00305"][$language], "data" => $returnData);
                    }
                }
            }            

            // Company address
            $db->where('name', 'pickUpOrigins');
            $companyAddress = $db->getValue('system_settings', 'reference');
            
            // Company Contact No/ Email/ Fax
            $db->where('type', 'companyContact');
            $res = $db->getValue('system_settings', 'value');
            $companyContactList = json_decode($res, true);

            // Company Address
            $db->where('type', 'companyAddressActual');
            $res = $db->getValue('system_settings', 'value');
            $companyAddressList = json_decode($res, true);


            $invoiceDetails = $saleOrder;


            $shippingAddress = Cash::concateAddress($invoiceDetails["id"], 'sale_order_shipping');
            $billingAddress = Cash::concateAddress($invoiceDetails["id"], 'sale_order_billing');


            
            $db->where("origin",$invoiceDetails["so_no"]);
            $do_name = $db->get("stock_picking", null, "name");
            $invoiceDetail["do_name"] = $do_name;

            $invoiceDetail["id"]                = $invoiceDetails['id'];
            $invoiceDetail["status"]            = $invoiceDetails['status'];
            $invoiceDetail["so_no"]             = $invoiceDetails['so_no'];
            $invoiceDetail['orderDate']         = date($dateTimeFormat, strtotime($invoiceDetails["createdAt"]));
            $invoiceDetail['paymentAmount']     = Setting::setDecimal($invoiceDetails['paymentAmount']);
            $invoiceDetail['paymentTax']        = Setting::setDecimal($invoiceDetails['paymentTax']);
            $invoiceDetail['shippingfee']       = Setting::setDecimal($invoiceDetails['shippingfee']);
            $invoiceDetail['paymentMethod']     = $invoiceDetails['paymentMethod'];
            $invoiceDetail['deliveryMethod']    = $invoiceDetails['deliveryMethod'];
            $invoiceDetail['releaseAmount']     = Setting::setDecimal($invoiceDetails['releaseAmount']);

            $formattedBillingPhone = self::phoneNumberFormat($invoiceDetails['billing_phone']);
            $formattedShippingPhone = self::phoneNumberFormat($invoiceDetails['shipping_phone']);

            $invoiceDetail["shipping_name"]     = $invoiceDetails['shipping_name'];
            $invoiceDetail["shipping_phone"]    = $formattedShippingPhone;
            $invoiceDetail["shipping_address"]  = $shippingAddress;
            $invoiceDetail["billing_name"]      = $invoiceDetails['billing_name'];
            $invoiceDetail["billing_phone"]     = $formattedBillingPhone;
            $invoiceDetail["billing_address"]   = $billingAddress;
            $invoiceDetail["billing_email"]   = $invoiceDetails['billingEmail'];
            $invoiceDetail["shipping_email"]   = $invoiceDetails['shippingEmail'];
            $data['showInsuranceTax'] = 0;

            // client table:  Member ID, Full Name
            $db->where("id", $invoiceDetails['client_id']);
            $clientDetail = $db->getOne("client","member_id AS memberID, name");

            $db->where("a.deleted", 0);
            $db->where("a.sale_id", $invoiceDetails['id']);
            $db->orderBy("product_template_id", "ASC");
            $invOrderList = $db->get('sale_order_detail a', NULL ,'a.sale_id AS packageDisplay, a.product_template_id AS productDisplay, a.item_name, a.product_id, a.item_price AS packagePrice, a.quantity, a.subtotal as Total,a.price_reduce, a.type');

            $product_attribute_value = $db->get('product_attribute_value a', null, 'id,name');

            $subTotal =0;
            foreach ($invOrderList as $invOrderRow) {
                $invProductIDAry[$invOrderRow["productDisplay"]] = $invOrderRow["productDisplay"]; // product
                $mlmProductIDAry[$invOrderRow["packageDisplay"]] = $invOrderRow["packageDisplay"]; // package
                $productIds[$invOrderRow["product_id"]] = $invOrderRow["product_id"];
                $subTotal = bcadd($subTotal, $invOrderRow["Total"],2);
                $mlmInvOrderPv[$invOrderRow["packageDisplay"]] = $subTotal;
            }

            $invoiceDetail['subtotal'] = $invOrderList['Total'];

            if($invProductIDAry){
                // product_template
                $db->where("a.id", $invProductIDAry, "IN");
                $db->join('product b', 'a.product_id = b.id', 'LEFT');
                $productNameRes = $db->map('temp_id')->get('product_template a', NULL ,'a.id as temp_id, b.id as id, b.name');
            }

            if($productIds){
                // package
                $db->where('module', array('product','package'), 'IN');
                $db->where("module_id", $productIds, "IN");
                $db->where("type", "name");
                $db->where("language", $productLang);
                $packageLangRes = $db->get('inv_language', NULL ,'module_id, language, content');

                foreach ($packageLangRes as $langRow) {
                    $packageLang[$langRow['module_id']] = $langRow['content'];
                }

                $db->where("id", $mlmProductIDAry, "IN");
                $pvPriceAry = $db->map("id")->get('mlm_product', NULL ,'id, weight, pv_price AS pvPrice');
            }
            unset($currentPackageID);
            $index = 0;
            $productQuantity = 0;
            $deliveryAmt = 0;

            $loop = 0;

            foreach ($invOrderList as $invOrderRow) {
                $db->where("id", $invOrderRow['product_id']);
                $getBarcode = $db->getValue('product' ,'barcode');

                $invOrderData['type'] = $invOrderRow['type'];    

                     
                if($invOrderRow['price_reduce'])
                {
                    $invOrderData['latestUnitPrice']   = $invOrderRow['item_price'];
                    $invOrderData['latestPrice']       = floatval($invOrderRow['item_price']) * (Setting::setDecimal($invOrderRow['quantity']));
                }
                else if(!$invOrderRow['price_reduce'])
                {
                    $invOrderData['latestPrice']       = 0;
                }
                if($invOrderRow['type'] != 'shipping_fee')
                {
                    if($invOrderRow['type'] == 'promo_code')
                    {
                        $invOrderData['packageDisplay'] = "(Promo) ".$invOrderRow['item_name'];
                    }
                    else
                    {

                        if($invOrderRow['type'] == "product" || $invOrderRow['type'] == "package"){
                            $invOrderRow['item_name'] = $packageLang[$invOrderRow['product_id']]?$packageLang[$invOrderRow['product_id']]:$invOrderRow['item_name'];  
                        }  
                        if(!$getBarcode) {
                            $invOrderData['packageDisplay'] = $invOrderRow['item_name'];
                        }
                        else {
                            $invOrderData['packageDisplay'] = "(".$getBarcode.")" . " ".$invOrderRow['item_name'];
                        }
                        $deliveryAmt++;
                    }
                }

                else if(strtolower($invOrderRow['type']) == 'promo_code')
                {
                    if(strtolower($invOrderRow['item_name'] == 'firstTimePurchase'))
                    {
                        $invOrderData['packageDisplay'] = 'First Time Purchase Discount';

                        $db->where('sale_id', $SaleID);
                        $db->where('disabled', '0');
                        $soServiceDetail = $db->getOne('so_service');

                        $db->where('id', $soServiceDetail['promo_code_id']);
                        $db->where('disabled', '0');
                        $mlmPromoCode = $db->getOne('mlm_promo_code');
                        
                        if(strtolower($mlmPromoCode['type']) == 'firsttimepurchase')
                        {
                            $db->where('promo_code_id', $soServiceDetail['so_service']);
                            $db->where('disabled', '0');
                            $promoCodeDetail = $db->get('promo_code_detail');
                        }
                        // foreach()
                    }
                }else{
                    $invOrderData['packageDisplay'] = $invOrderRow['item_name'];
                }
                $invOrderData['packagePrice'] = Setting::setDecimal($invOrderRow['packagePrice']);
                $invOrderData['packageQuantity'] = Setting::setDecimal($invOrderRow['quantity']);

                $productQuantity += $invOrderRow['quantity'];

                if($invOrderRow['type'] == 'shipping_fee'){

                    if($invOrderRow['item_name'] == 'Dry Delivery Charges'){
                        $invOrderData['packageDisplay'] = $translations['M04101'][$language]; /* Dry Delivery Charges */
                    }else{
                        $invOrderData['packageDisplay'] = $translations['M04100'][$language]; /* Delivery Charges */
                    }

                    $invOrderData['totalPackagePrice'] = number_format($invOrderRow['packagePrice'], 2);
                }else if($invOrderRow['item_name'] == 'Redeemed Points'){
                    $invOrderData['totalPackagePrice'] = sprintf("%.2f", abs($invOrderRow['Total']));
                }else if($invOrderRow['type'] == 'promo_code'){
                    $invOrderData['totalPackagePrice'] = sprintf("%.2f", abs($invOrderRow['Total']));
                }
                else{
                    $invOrderData['totalPackagePrice'] = Setting::setDecimal($invOrderRow['Total']);
                }

                $string = $invOrderRow['product_attribute_value_id'];  
                $array = json_decode($string);
                $string = implode(",", $array);
                $invOrderRow['product_attribute_value_id'] = $string;

                $name_array = array();
                foreach ($array as $id) {
                    foreach ($product_attribute_value as $value) {
                        if ($value['id'] == $id) {
                        $name_array[] = $value['name']; // Store name in array
                        }
                    }
                }
                $name_string = implode(", ", $name_array);
                $invOrderData['product_attribute_name'] = $name_string;

                $db->where("reference_id", $invOrderRow['product_id']);
                $db->where("type", 'Image');
                $getImage = $db->getValue('product_media' ,'url');

                $invOrderData['image'] = $getImage;

                $invOrder[$index] = $invOrderData;
                $index++; 
            }

            $db->where('id', $SaleID);
            $isGift = $db->getOne('sale_order', 'is_gift');

            if($isGift['is_gift'] == '1')
            {
                $data['giftStatus'] = $isGift['is_gift'];
            }

            $productQuantity = $productQuantity - $deliveryAmt;

            $issueDOFlag = 0;
            if($leftStockQuantity > 0){
                $issueDOFlag = 1;
            }

            $db->where("type","SST");
            $db->orderBy("created_at","DESC");
            $taxPercentage = $db->getValue("inv_tax_charges","rate");
            if(!$taxPercentage) $taxPercentage = 0;

            $db->where("inv_order_id",$invoiceDetails["id"]);
            $voucherDataAry = $db->getOne("inv_order_voucher","inv_voucher_id,type,discount_type,discount_percentage,discount_amount,real_discount_amount");

            // check current SO status to generate order type "quotation" or "invoice" or "delivery order"
            $db->where('id', $SaleID);
            $saleOrderDetail = $db->getOne('sale_order');
            $saleOrderStatus = $saleOrderDetail['status'];

            if(!empty($saleOrderStatus))
            {
                if($saleOrderStatus == 'Pending')
                {
                    $data['type'][0] = 'quotation';
                }
                else if ($saleOrderStatus == 'Pending Payment Approve')
                {
                    $data['type'][0] = 'quotation';
                }
                else if ($saleOrderStatus == 'Paid')
                {
                    $data['type'][0] = 'invoice';
                }
                else if ($saleOrderStatus == 'Packed')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
                else if ($saleOrderStatus == 'Out of Delivery' || $saleOrderStatus == 'Out For Delivery')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
                else if ($saleOrderStatus == 'Delivered')
                {
                    $data['type'][0] = 'invoice';
                    $data['type'][1] = 'delivery_order';
                }
            }

            // Due date
            $expiredDate = $saleOrderDetail['payment_expired_date'];
            // Source
            $source = $saleOrderDetail['so_no'];

            $data['accumulatedRewardPoint'] = $saleOrder['rewarded_point'];
            $data['dueDate'] = $expiredDate;
            $data['source'] = $source;
            $data['companyAddress'] = $companyAddress;
            $data['companyAddressAct'] = $companyAddressList;
            $data['companyContact'] = $companyContactList;
            $data['taxPercentage'] = $taxPercentage;
            $data['invoiceDetail'] = $invoiceDetail;
            $data['clientDetail'] = $clientDetail;
            $data['packageList'] =  $invOrder;
            $data['subtotal'] =  $mlmInvOrderPv;
            $data['issueDOAllowed'] = $issueDOFlag;
            $data['productQuantity'] =  $productQuantity;

            return array('status' => "ok", 'code' => 0, 'statusMsg' => $translations["B00425"][$language] /* Successfully retrieved */, 'data' => $data);
            // return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01051"][$language], 'data'=> $shippingPhone);
        }

        // phoneNumberFormat
        function phoneNumberFormat($number) {
            // Check if the first character is 0
            if (substr($number, 0, 1) == "0") {
            // Pad the number with 6 until it has 11 digits
            $number = str_pad($number, 11, "6", STR_PAD_LEFT);
            }
            // Check if the first 4 characters are 6060
            elseif (substr($number, 0, 4) == "6060") {
            // Remove the first 2 characters
            $number = substr($number, 2);
            }
            // Check if the first 2 characters are 60
            elseif (substr($number, 0, 2) == "60") {
            // Do nothing
            }
            else {
            // Pad the number with 60 until it has 11 digits
            $number = str_pad($number, 11, "60", STR_PAD_LEFT);
            }
            
            return $number;
        }
            
        public function addPriceList($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $clientID               = $db->userID;

            $pricelistName          = $params['pricelist_name'];
            $productList            = $params['product_list'];
            $website                = 'GoTasty';

            if(!$pricelistName)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01266"][$language] /* Pricelist cannot be empty */, 'data' => $outOfStock);
            }

            try
            {
                $insertData = array(
                    'pricelist_name'        => $pricelistName,
                    'website'               => $website,
                    'disabled'              => '0',
                    'created_at'            => $dateTime,
                    'created_by'            => $clientID
                );
    
                $insertPricelist = $db->insert('pricelist', $insertData);
            }
            catch (Exception $e) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $e->getMessage() , 'data' => $lq);
            }

            foreach($productList as $checkProduct)
            {
                // get product price
                $db->where('id', $checkProduct['product_id']);
                $productInventoryDetail = $db->getOne('product');

                if(strtolower($checkProduct['discount_type']) == 'percentage')
                {
                    $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($checkProduct['discount_amount']) / 100));
                }
                if(strtolower($checkProduct['discount_type']) == 'fixed')
                {
                    $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($checkProduct['discount_amount']);
                }
                if($latestPrice < 0)
                {
                    $updateData = array(
                        'disabled' => '1'
                    );
                    $db->where('id', $insertPricelist);
                    $db->update('pricelist', $updateData);
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=> $translations["E01271"][$language] /* Discount Price cannot be more than Product Price */ , 'data'=> $latestPrice);
                }
                unset($insertData);

                $insertData = array(
                    'pricelist_id'          => $insertPricelist,
                    'product_id'            => $checkProduct['product_id'],
                    'discount_type'         => $checkProduct['discount_type'],
                    'discount'              => $checkProduct['discount_amount'],
                    'latest_price'          => $latestPrice,
                    'condition'             => $checkProduct['condition'],
                    'disabled'              => '0',
                    'start_date'            => $checkProduct['start_date'],
                    'end_date'              => $checkProduct['end_date'],
                    'created_at'            => $dateTime,
                    'created_by'            => $clientID
                );

                $db->insert('pricelist_detail', $insertData);
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $latestPrice);
        }

        public function editPriceList($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $clientID               = $db->userID;

            $pricelistId            = $params['pricelist_id'];
            $pricelistName          = $params['pricelist_name'];
            $productList            = $params['product_list'];
            $activeStatus           = $params['activeStatus'];
            $website                = 'GoTasty';

            $db->where('id', $pricelistId);
            $pricelist = $db->getOne('pricelist');

            if(!$pricelist)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01272"][$language] /* Invalid pricelist */, 'data' => $outOfStock);
            }

            if(!$pricelistName)
            {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01266"][$language] /* Pricelist cannot be empty */, 'data' => $outOfStock);
            }

            try
            {
                $updateData = array(
                    'pricelist_name'        => $pricelistName,
                    'website'               => $website,
                    'disabled'              => $activeStatus,
                    'updated_at'            => $dateTime,
                );
                $db->where('id', $pricelistId);
                $updatePricelist = $db->update('pricelist', $updateData);
            }
            catch (Exception $e) {
                return array('status' => "error", 'code' => 1, 'statusMsg' => $e->getMessage() , 'data' => $lq);
            }
            unset($updateData);
            $updateData = array(
                'disabled'  =>  '1'
            );
            $db->where('pricelist_id', $pricelistId);
            $db->update('pricelist_detail', $updateData);

            foreach($productList as $checkProduct)
            {
                // get product price
                $db->where('id', $checkProduct['product_id']);
                $productInventoryDetail = $db->getOne('product');

                if(strtolower($checkProduct['discount_type']) == 'percentage')
                {
                    $latestPrice = floatval($productInventoryDetail['sale_price']) - (floatval($productInventoryDetail['sale_price']) * (floatval($checkProduct['discount_amount']) / 100));
                }
                if(strtolower($checkProduct['discount_type']) == 'fixed')
                {
                    $latestPrice = floatval($productInventoryDetail['sale_price']) - floatval($checkProduct['discount_amount']);
                }
                if($latestPrice < 0)
                {
                    $updateData = array(
                        'disabled' => '1'
                    );
                    $db->where('id', $pricelistId);
                    $db->update('pricelist', $updateData);
                    return array('status'=>'error', 'code'=>1, 'statusMsg'=> $translations["E01271"][$language] /* Discount Price cannot be more than Product Price */ , 'data'=> $latestPrice);
                }

                unset($insertData);
                $insertData = array(
                    'pricelist_id'          => $pricelistId,
                    'product_id'            => $checkProduct['product_id'],
                    'discount_type'         => $checkProduct['discount_type'],
                    'discount'              => $checkProduct['discount_amount'],
                    'latest_price'          => $latestPrice,
                    'condition'             => $checkProduct['condition'],
                    'disabled'              => 0,
                    'start_date'            => $checkProduct['start_date'],
                    'end_date'              => $checkProduct['end_date'],
                    'created_at'            => $dateTime,
                    'created_by'            => $clientID
                );
                $db->insert('pricelist_detail', $insertData);
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $latestPrice);
        }

        public function viewPriceList($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $pageNumber             = $params['pageNumber'] ? $params['pageNumber'] : 1;
            $limit                  = General::getLimit($pageNumber);
            $searchData             = $params['searchData'];
            $seeAll                 = $params['seeAll'] ? : 0;
            $dateTime               = date("Y-m-d H:i:s");

            $clientID               = $db->userID;
            $site                   = $db->userType;

            if($seeAll) {
                $limit = NULL;
            }

            if (count($searchData) > 0) {
                foreach ($searchData as $k => $v) {
                    $dataName = trim($v['dataName']);
                    $dataValue = trim($v['dataValue']);
                    $dataType = trim($v['dataType']);

                    switch($dataName) {
                        case 'pricelistName':
                            $db->where('p.pricelist_name', "%" . $dataValue . "%" , 'LIKE');
                            break;
                        case 'dateRange':
                            $dateFrom = trim($v['tsFrom']);
                            $dateTo = trim($v['tsTo']);

                            if(intval($dateFrom) > intval($dateTo))
                            {
                                $db->resetState();
                                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                            }
                            
                            if(strlen($dateFrom) > 0) {
                                if($dateFrom < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }
                            }
                            if(strlen($dateTo) > 0) {
                                if($dateTo < 0){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00156"][$language] /* Invalid date. */, 'data'=>"");
                                }

                                if($dateTo < $dateFrom){
                                    $db->resetState();
                                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E00158"][$language] /* Date from cannot be later than date to. */, 'data'=>"");
                                }
                            }
                            $db->where("(pd.start_date >= ? OR pd.end_date <= ?)", [date('Y-m-d', $dateFrom), date('Y-m-d', $dateTo)]);
                            unset($dateFrom);
                            unset($dateTo);
                            break;
                    }
                    unset($dataName);
                    unset($dataValue);
                }
            }
            $db->where('p.website', 'GoTasty');
            $db->join('pricelist_detail pd', 'p.id = pd.pricelist_id', 'LEFT');
            $db->where('pd.disabled', '0');
            $db->groupBy('p.id');
            $db->orderBy('p.created_at','DESC');
            $copyDb = $db->copy();
            $priceListing = $db->get('pricelist p', $limit, 'p.id, p.pricelist_name, pd.start_date, pd.end_date, p.created_at, p.updated_at, p.created_by');

            $totalRecord = $copyDb->getValue('pricelist p', 'COUNT(*)');
            $data['pageNumber']          = $pageNumber;
            $data['totalRecord']         = $totalRecord;
            if($seeAll == "1"){
                $data['totalPage'] = 1;
                $data['numRecord'] = $totalRecord;
            }else{
                $data['totalPage'] = ceil($totalRecord/$limit[1]);
                $data['numRecord'] = $limit[1];
            }

            if($priceListing)
            {
                $data['pricelist'] = $priceListing;
            }
            else
            {
                return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M00030"][$language] /* No Results Found */ , 'data'=> $data);
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $data);
        }

        public function viewPricelistDetail($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");

            $pricelistId            = $params['pricelist_id'];

            $db->where('id', $pricelistId);
            $pricelist = $db->getOne('pricelist');

            $db->where('pricelist_id', $pricelistId);
            $db->where('disabled', '0');
            $priceListDetail = $db->get('pricelist_detail');

            $db->orderBy("barcode", "ASC");
            $db->where("deleted", "0");
            $db->where('is_archive', '0');
            // $db->where("product_type", "product");
            $productList = $db->get("product",null, "id, name, barcode, sale_price");

            $data['pricelist'] = $pricelist;
            $data['pricelistDetail'] = $priceListDetail;
            $data['productList'] = $productList;

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $data);
        }

        public function deletePO($params)
        {
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $adminID                = $db->userID;

            $poID                   = $params['poID'];

            $updateData = array(
                'deleted'           => '1',
                'updated_at'        => $dateTime,
            );
            $db->where('id', $poID);
            $db->update('purchase_order', $updateData);

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $data);
        }

        public function poBatchAction($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $adminID                = $db->userID;

            $checkList              = $params['checkList'];
            $action                 = $params['action'];

            $poList = array();
            foreach($checkList as $detailPO)
            {
                if($detailPO != '')
                {
                    # check PO status
                    $db->where('id', $detailPO);
                    $db->where('status', 'RFQ', '!=');
                    $notValidPO = $db->getOne('purchase_order');

                    $poList[] = $detailPO;
                    if($notValidPO)
                    {
                        $notInPOList[] = $notValidPO['order_number'];
                    }
                }
            }

            if($notInPOList)
            {
                $notValidPOList = implode(', ', $notInPOList);
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["A01711"][$language] /* Purchase Order is not able to edit */ . $notValidPOList, 'data'=>"");
            }
            
            if($action == 'delete')
            {
                # check admin permission
                $permissionDataIn['type'] = 'action';
                $permissionDataIn['module'] = 'PO';
                $permissionDataIn['user_id'] = $adminID;

                $adminPermission = Permission::checkActionPermission($permissionDataIn);
                if($adminPermission['status'] != 'ok')
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $adminPermission['statusMsg'], 'data'=>$adminPermission);
                }

                $arrPermission = $adminPermission['data'];

                if($arrPermission['remove'] != 1)
                {
                    return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01307"][$language] /* You do not have permission to delete Purchase Orders. Please contact your administrator for assistance */ , 'data' => '');
                }

                for ($i = 0; $i < count($poList); $i++) {
                    if($poList[$i] != '')
                    {
                        $dataIn['poID'] = $poList[$i];
                        $deleteResult = Inventory::deletePO($dataIn);
                        if($deleteResult['status'] != 'ok')
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $deleteResult['statusMsg'], 'data'=>$deleteResult);
                        }
                    }
                }
            }
            else if($action == 'approved')
            {
                for ($i = 0; $i < count($poList); $i++) {
                    if($poList[$i] != '')
                    {
                        $dataIn['id'] = $poList[$i];
                        $dataIn['status'] = 'Approved';
                        $dataIn['module'] = 'PO';
                        $dataIn['permissionType'] = 'action';
                        $dataIn['batchAction'] = 'action';
                        $approveStatus = admin::approvePurchaseOrder($dataIn);
                        if($approveStatus['status'] != 'ok')
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $approveStatus['statusMsg'], 'data'=>$approveStatus);
                        }
                    }
                }
            }
            else if($action == 'cancelled')
            {
                for ($i = 0; $i < count($poList); $i++) {
                    if($poList[$i] != '')
                    {
                        $dataIn['id'] = $poList[$i];
                        $dataIn['module'] = 'PO';
                        $dataIn['permissionType'] = 'action';
                        $approveStatus = admin::cancelledPurchaseOrder($dataIn);
                        if($approveStatus['status'] != 'ok')
                        {
                            return array('status' => "error", 'code' => 1, 'statusMsg' => $approveStatus['statusMsg'], 'data'=>$approveStatus);
                        }
                    }
                }
            }

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $data);
        }

        public function changeSOItem($params){
            $db                     = MysqliDb::getInstance();
            $language               = General::$currentLanguage;
            $translations           = General::$translations;
            $dateTime               = date("Y-m-d H:i:s");
            $clientID               = $db->userID;
            
            $saleID                 = $params['saleID'];
            $originalItemID         = $params['originalItemID'];
            $changeItemProductID    = $params['changeItemProductID'];

            if(!$saleID)
            {
                # prompt error for invalid sale id
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01187"][$language] /* Sale order doest not exist */, 'data'=>"");
            }

            $db->where('id', $saleID);
            $db->where('status', 'paid');
            $saleInfo = $db->getOne('sale_order');

            if(!$saleInfo)
            {
                # prompt error if status is not Paid
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01285"][$language] /* This operation can only be performed on sale orders with a 'Paid' status */, 'data'=>"");
            }

            $db->where('deleted', '0');
            $db->where('so_no', $saleInfo['so_no']);
            $db->where('id', $originalItemID);
            $saleOrderItemInfo = $db->getOne('sale_order_item');
            if(!$saleOrderItemInfo)
            {
                # prompt error if cannot find from sale_order_item table
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01286"][$language] /* Couldn't find any sales order item associated with the product ID. Please reach out to an engineer for further assistance */, 'data'=>"");
            }

            if(!$changeItemProductID)
            {
                # prompt error if no product id
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01188"][$language] /* Invalid Product */, 'data'=>"");
            }            

            # check the product is valid or not.
            $db->where('id', $changeItemProductID);
            $db->where('deleted', '0');
            $db->where('product_type', 'product');
            $productDetail = $db->getOne('product');
            
            if(!$productDetail)
            {
                # prompt error for invalid product
                return array('status' => "error", 'code' => 1, 'statusMsg' => $translations["E01188"][$language] /* Invalid Product */, 'data'=>"");
            }
            
            $remark = 'Change Product ID from ' . $saleOrderItemInfo['product_id'] . ' to ' . $changeItemProductID;
            # insert change_item_request
            $insertData = array(
                'product_id'        => $changeItemProductID,
                'package_id'        => '0',
                'is_package'        => '0',
                'serial_number'     => '',
                'remark'            => $remark,
                'updated_by'        => $clientID,
                'updated_at'        => $dateTime,
                'deleted'           => '0',
            );
            $changeRequestID = $db->insert('change_item_request', $insertData);
            
            # update disabled for original item
            $updateData = array(
                'deleted'       => '1',
                'updated_at'    => $dateTime,
                'updated_by'    => $clientID,
                'reference_id'  => $changeRequestID,
            );
            $db->where('id', $originalItemID);
            $db->update('sale_order_item', $updateData);
            
            # inserted new row
            $insertData = array(
                'so_no'          => $saleInfo['so_no'],
                'do_no'          => '',
                'so_details_id'  => '',
                'product_id'     => $changeItemProductID,
                'package_id'     => '0',
                'is_package'     => '0',
                'serial_number'  => '',
                'remark'         => '',
                'deleted'        => '0',
                'reference_id'   => $changeRequestID,
                'updated_at'     => $dateTime,
                'updated_by'     => $clientID,
            );
            $db->insert('sale_order_item', $insertData);

            return array('status'=>'ok', 'code'=>0, 'statusMsg'=> $translations["M03692"][$language] /* Successfully */ , 'data'=> $data);
        }
    }
?>
